--- DUMP DO PROJETO THECLINIC ---
Raiz: /workspaces/theclinic

============================================================
ARQUIVO: raio_x.py
============================================================
import os

# --- CONFIGURAÇÕES ---
NOME_ARQUIVO_SAIDA = 'projeto_completo.txt'

# Extensões que queremos ler (Backend e Frontend)
EXTENSOES_PERMITIDAS = {'.py', '.js', '.jsx', '.html', '.css', '.json'}

# Pastas para IGNORAR COMPLETAMENTE
IGNORAR_PASTAS = {
    'venv', '.venv', 'env',          # Ambientes virtuais
    'node_modules',                  # Dependências Node
    '.git', '.idea', '.vscode',      # Configurações de IDE/Git
    '__pycache__',                   # Cache do Python
    'build', 'dist',                 # Builds do Frontend
    'migrations',                    # Migrações do Django (muito arquivo inútil)
    'media', 'static', 'assets',     # Arquivos estáticos/imagens
    'public'                         # Pasta public do React (geralmente só tem ícones)
}

# Arquivos específicos para IGNORAR
IGNORAR_ARQUIVOS = {
    'package-lock.json', 'yarn.lock', 'pnpm-lock.yaml', # Travas de versão (muito grandes)
    'db.sqlite3',                                       # Banco de dados binário
    'gerar_documento.py',                               # Este script
    NOME_ARQUIVO_SAIDA                                  # O próprio arquivo de saída
}

def salvar_projeto():
    caminho_raiz = os.getcwd()
    print(f"Iniciando varredura em: {caminho_raiz}")
    print("Isso pode levar alguns segundos...")

    arquivos_processados = 0

    with open(NOME_ARQUIVO_SAIDA, 'w', encoding='utf-8') as arquivo_saida:
        arquivo_saida.write(f"--- DUMP DO PROJETO THECLINIC ---\n")
        arquivo_saida.write(f"Raiz: {caminho_raiz}\n\n")

        for root, dirs, files in os.walk(caminho_raiz):
            # 1. Modifica a lista 'dirs' in-place para impedir que o os.walk entre em pastas ignoradas
            # Isso faz o script ser muito rápido pois nem entra em node_modules ou venv
            dirs[:] = [d for d in dirs if d not in IGNORAR_PASTAS]

            for file in files:
                if file in IGNORAR_ARQUIVOS:
                    continue

                # Verifica a extensão
                _, extensao = os.path.splitext(file)
                if extensao.lower() not in EXTENSOES_PERMITIDAS:
                    continue

                caminho_completo = os.path.join(root, file)
                caminho_relativo = os.path.relpath(caminho_completo, caminho_raiz)

                # Escreve no arquivo final
                try:
                    with open(caminho_completo, 'r', encoding='utf-8') as f:
                        conteudo = f.read()
                        
                        arquivo_saida.write(f"{'='*60}\n")
                        arquivo_saida.write(f"ARQUIVO: {caminho_relativo}\n")
                        arquivo_saida.write(f"{'='*60}\n")
                        arquivo_saida.write(conteudo + "\n\n")
                        
                        arquivos_processados += 1
                        print(f"Lido: {caminho_relativo}")

                except Exception as e:
                    print(f"Erro ao ler {caminho_relativo}: {e}")

    print(f"\n--- SUCESSO! ---")
    print(f"Total de arquivos processados: {arquivos_processados}")
    print(f"Todo o código foi salvo em: {NOME_ARQUIVO_SAIDA}")
    print("Agora você pode copiar o conteúdo desse arquivo e colar no chat.")

if __name__ == "__main__":
    salvar_projeto()

============================================================
ARQUIVO: manage.py
============================================================
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'clinica_core.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()


============================================================
ARQUIVO: criar_admin.py
============================================================
import os
import django
from django.contrib.auth import get_user_model

# Configura o ambiente Django
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "clinica_core.settings")
django.setup()

User = get_user_model()

username = os.environ.get("DJANGO_SUPERUSER_USERNAME", "admin")
email = os.environ.get("DJANGO_SUPERUSER_EMAIL", "admin@admin.com")
password = os.environ.get("DJANGO_SUPERUSER_PASSWORD", "admin123")

if not User.objects.filter(username=username).exists():
    print(f"Criando superusuário: {username}")
    User.objects.create_superuser(username, email, password)
else:
    print(f"Superusuário {username} já existe. Ignorando criação.")

============================================================
ARQUIVO: profissionais/models.py
============================================================
from django.db import models

class Especialidade(models.Model):
    nome = models.CharField(max_length=100, unique=True)

    def __str__(self):
        return self.nome
    
    class Meta:
        verbose_name = "Especialidade"
        verbose_name_plural = "Especialidades"
        ordering = ['nome']

class Profissional(models.Model):
    nome = models.CharField(max_length=255)
    cpf = models.CharField(max_length=14, unique=True)
    data_nascimento = models.DateField()
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.nome
    
    class Meta:
        verbose_name = "Profissional"
        verbose_name_plural = "Profissionais"
        ordering = ['nome']

class ProfissionalEspecialidade(models.Model):
    """ Tabela intermediária para vincular Profissional <-> Especialidade com dados do Conselho """
    profissional = models.ForeignKey(Profissional, related_name='especialidades_vinculo', on_delete=models.CASCADE)
    especialidade = models.ForeignKey(Especialidade, on_delete=models.PROTECT)
    
    # --- NOVOS CAMPOS SOLICITADOS ---
    sigla_conselho = models.CharField(max_length=10)    # Ex: CRM, COREN, CRO, CRP
    registro_conselho = models.CharField(max_length=20) # Ex: 123456
    uf_conselho = models.CharField(max_length=2)        # Ex: SP
    
    class Meta:
        unique_together = ('profissional', 'especialidade')

============================================================
ARQUIVO: profissionais/apps.py
============================================================
from django.apps import AppConfig


class ProfissionaisConfig(AppConfig):
    name = 'profissionais'


============================================================
ARQUIVO: profissionais/admin.py
============================================================
from django.contrib import admin
from .models import Profissional, Especialidade, ProfissionalEspecialidade

# 1. Configura a "tabela filha" (Vínculo + CRM) para aparecer dentro do Médico
class ProfissionalEspecialidadeInline(admin.TabularInline):
    model = ProfissionalEspecialidade
    extra = 1  # Deixa uma linha em branco pronta para preencher
    autocomplete_fields = ['especialidade'] # Opcional: Ajuda se tiver muitas especialidades

@admin.register(Especialidade)
class EspecialidadeAdmin(admin.ModelAdmin):
    list_display = ('id', 'nome')
    search_fields = ('nome',)

@admin.register(Profissional)
class ProfissionalAdmin(admin.ModelAdmin):
    # Campos que realmente existem no Profissional
    list_display = ('id', 'nome', 'cpf', 'created_at') 
    search_fields = ('nome', 'cpf')
    
    # Aqui a mágica acontece: colocamos o vínculo do conselho dentro da tela do médico
    inlines = [ProfissionalEspecialidadeInline] 

# Opcional: Se quiser ver a tabela de vínculos separada também
@admin.register(ProfissionalEspecialidade)
class ProfissionalEspecialidadeAdmin(admin.ModelAdmin):
    list_display = ('profissional', 'especialidade', 'sigla_conselho', 'registro_conselho', 'uf_conselho')
    list_filter = ('sigla_conselho', 'uf_conselho')
    search_fields = ('profissional__nome', 'registro_conselho')

============================================================
ARQUIVO: profissionais/tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARQUIVO: profissionais/views.py
============================================================
from rest_framework import viewsets, permissions, filters
from rest_framework.response import Response
from rest_framework_simplejwt.authentication import JWTAuthentication
from .models import Especialidade, Profissional
from .serializers import EspecialidadeSerializer, ProfissionalSerializer

class EspecialidadeViewSet(viewsets.ModelViewSet):
    queryset = Especialidade.objects.all().order_by('nome')
    serializer_class = EspecialidadeSerializer
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [filters.SearchFilter]
    search_fields = ['nome']

    def list(self, request, *args, **kwargs):
        # Se vier nopage=true, ignora paginação e retorna tudo
        if request.query_params.get('nopage'):
            queryset = self.filter_queryset(self.get_queryset())
            serializer = self.get_serializer(queryset, many=True)
            return Response(serializer.data)
        
        return super().list(request, *args, **kwargs)

class ProfissionalViewSet(viewsets.ModelViewSet):
    queryset = Profissional.objects.all().order_by('nome')
    serializer_class = ProfissionalSerializer
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [filters.SearchFilter]
    search_fields = ['nome', 'cpf']

============================================================
ARQUIVO: profissionais/urls.py
============================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import EspecialidadeViewSet, ProfissionalViewSet

router = DefaultRouter()
router.register(r'especialidades', EspecialidadeViewSet)
router.register(r'profissionais', ProfissionalViewSet)

urlpatterns = [
    path('', include(router.urls)),
]

============================================================
ARQUIVO: profissionais/serializers.py
============================================================
from rest_framework import serializers
from .models import Especialidade, Profissional, ProfissionalEspecialidade

class EspecialidadeSerializer(serializers.ModelSerializer):
    class Meta:
        model = Especialidade
        fields = ['id', 'nome']

class ProfissionalEspecialidadeSerializer(serializers.ModelSerializer):
    nome_especialidade = serializers.CharField(source='especialidade.nome', read_only=True)
    
    # CAMPO DE ESCRITA (Mantém como está)
    especialidade_id = serializers.PrimaryKeyRelatedField(
        queryset=Especialidade.objects.all(), source='especialidade', write_only=True
    )

    # --- NOVO CAMPO PARA CORRIGIR O ERRO ---
    # Esse campo garante que o ID da especialidade seja enviado para o frontend na leitura
    especialidade_leitura = serializers.PrimaryKeyRelatedField(source='especialidade', read_only=True)

    class Meta:
        model = ProfissionalEspecialidade
        # Adicione 'especialidade_leitura' na lista de fields
        fields = [
            'id', 
            'especialidade_id', 
            'especialidade_leitura', 
            'nome_especialidade', 
            'sigla_conselho', 
            'registro_conselho', 
            'uf_conselho'
        ]

class ProfissionalSerializer(serializers.ModelSerializer):
    # ... (o resto do arquivo continua igual)
    especialidades = ProfissionalEspecialidadeSerializer(source='especialidades_vinculo', many=True)

    class Meta:
        model = Profissional
        fields = ['id', 'nome', 'cpf', 'data_nascimento', 'especialidades']

    # ... (métodos create e update continuam iguais)
    def create(self, validated_data):
        especialidades_data = validated_data.pop('especialidades_vinculo')
        profissional = Profissional.objects.create(**validated_data)
        for spec in especialidades_data:
            ProfissionalEspecialidade.objects.create(profissional=profissional, **spec)
        return profissional

    def update(self, instance, validated_data):
        especialidades_data = validated_data.pop('especialidades_vinculo', None)
        instance.nome = validated_data.get('nome', instance.nome)
        instance.cpf = validated_data.get('cpf', instance.cpf)
        instance.data_nascimento = validated_data.get('data_nascimento', instance.data_nascimento)
        instance.save()
        if especialidades_data is not None:
            instance.especialidades_vinculo.all().delete()
            for spec in especialidades_data:
                ProfissionalEspecialidade.objects.create(profissional=instance, **spec)
        return instance

============================================================
ARQUIVO: profissionais/__init__.py
============================================================


============================================================
ARQUIVO: agendamento/models.py
============================================================
from django.db import models
from django.db.models import Q
from profissionais.models import Profissional, Especialidade
from pacientes.models import Paciente 
from configuracoes.models import Convenio 

class BloqueioAgenda(models.Model):
    # ... (Mantenha o BloqueioAgenda como estava) ...
    TIPO_CHOICES = [
        ('feriado', 'Feriado'),
        ('bloqueio', 'Bloqueio Manual (Férias/Reunião)'),
    ]
    profissional = models.ForeignKey(Profissional, on_delete=models.CASCADE, null=True, blank=True)
    data_inicio = models.DateField()
    data_fim = models.DateField()
    hora_inicio = models.TimeField(default='00:00')
    hora_fim = models.TimeField(default='23:59')
    motivo = models.CharField(max_length=255)
    tipo = models.CharField(max_length=20, choices=TIPO_CHOICES, default='bloqueio')
    recorrente = models.BooleanField(default=False)
    criado_em = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.motivo}"

class Agendamento(models.Model):
    class Status(models.TextChoices):
        AGENDADO = 'agendado', 'Agendado'
        AGUARDANDO = 'aguardando', 'Aguardando Atendimento'
        EM_ATENDIMENTO = 'em_atendimento', 'Em Atendimento'
        FINALIZADO = 'finalizado', 'Finalizado'
        CANCELADO = 'cancelado', 'Cancelado'
        FALTOU = 'faltou', 'Faltou'

    profissional = models.ForeignKey(Profissional, on_delete=models.CASCADE)
    especialidade = models.ForeignKey(Especialidade, on_delete=models.CASCADE)
    paciente = models.ForeignKey(Paciente, on_delete=models.CASCADE)
    convenio = models.ForeignKey(Convenio, on_delete=models.SET_NULL, null=True, blank=True)
    
    data = models.DateField()
    horario = models.TimeField()
    is_encaixe = models.BooleanField(default=False)
    
    valor = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    observacoes = models.TextField(blank=True, null=True)
    
    status = models.CharField(max_length=20, choices=Status.choices, default=Status.AGENDADO)
    criado_em = models.DateTimeField(auto_now_add=True)
    atualizado_em = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['data', 'horario']
        constraints = [
            models.UniqueConstraint(
                # AQUI: Garante que O MESMO PACIENTE não tenha dois agendamentos iguais
                fields=['profissional', 'data', 'horario', 'paciente'], 
                condition=Q(status__in=['agendado', 'aguardando', 'em_atendimento']),
                name='unique_paciente_horario' # Nome diferente do anterior para forçar recriação
            )
        ]

    def __str__(self):
        return f"{self.paciente} - {self.data} {self.horario}"

============================================================
ARQUIVO: agendamento/apps.py
============================================================
from django.apps import AppConfig


class AgendamentoConfig(AppConfig):
    name = 'agendamento'


============================================================
ARQUIVO: agendamento/admin.py
============================================================
from django.contrib import admin
from .models import Agendamento

@admin.register(Agendamento)
class AgendamentoAdmin(admin.ModelAdmin):
    # Exibe quem é o paciente, médico, data e status
    list_display = ('paciente', 'profissional', 'data', 'horario', 'status', 'valor')
    
    # Filtros laterais úteis
    list_filter = ('status', 'data', 'profissional', 'convenio')
    
    # Busca por nome do paciente ou do médico
    search_fields = ('paciente__nome', 'profissional__nome', 'observacoes')
    
    # Permite editar a data direto na lista (opcional, cuidado!)
    # list_editable = ('status',)

============================================================
ARQUIVO: agendamento/tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARQUIVO: agendamento/views.py
============================================================
from rest_framework import viewsets, permissions, status, filters
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework_simplejwt.authentication import JWTAuthentication
from django.db.models import Case, When, Value, IntegerField
from django.db import transaction # <--- IMPORTANTE
from datetime import date

from .models import BloqueioAgenda, Agendamento
from .serializers import BloqueioAgendaSerializer, AgendamentoSerializer

# Tenta importar o modelo de Fatura
try:
    from financeiro.models import Fatura
except ImportError:
    Fatura = None

class BloqueioAgendaViewSet(viewsets.ModelViewSet):
    queryset = BloqueioAgenda.objects.all().order_by('-data_inicio')
    serializer_class = BloqueioAgendaSerializer
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]

    # Endpoint para checar conflitos antes de criar
    @action(detail=False, methods=['post'])
    def verificar_conflitos(self, request):
        data = request.data
        prof_id = data.get('profissional')
        d_ini = data.get('data_inicio')
        d_fim = data.get('data_fim')
        h_ini = data.get('hora_inicio', '00:00')
        h_fim = data.get('hora_fim', '23:59')

        # Filtra agendamentos no período
        conflitos = Agendamento.objects.filter(
            data__range=[d_ini, d_fim],
            horario__gte=h_ini,
            horario__lte=h_fim,
            status__in=['agendado', 'aguardando']
        )

        if prof_id:
            conflitos = conflitos.filter(profissional_id=prof_id)

        if not conflitos.exists():
            return Response({'conflito': False, 'total': 0, 'pacientes': []})

        # Serializa os dados para o relatório PDF
        dados_pacientes = []
        for c in conflitos:
            dados_pacientes.append({
                'id': c.id,
                'paciente_nome': c.paciente.nome,
                'paciente_cpf': c.paciente.cpf,
                'paciente_nascimento': c.paciente.data_nascimento,
                'paciente_telefone': c.paciente.telefone,
                'medico': c.profissional.nome,
                'data': c.data,
                'horario': c.horario
            })

        return Response({
            'conflito': True, 
            'total': len(dados_pacientes), 
            'pacientes': dados_pacientes
        })

    # Sobrescreve o create para lidar com a ação escolhida (cancelar ou manter)
    def create(self, request, *args, **kwargs):
        acao_conflito = request.data.pop('acao_conflito', 'manter') # manter | cancelar
        
        # Cria o bloqueio
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        bloqueio = serializer.save()

        # Se escolheu cancelar, cancela os agendamentos afetados
        if acao_conflito == 'cancelar':
            prof_id = bloqueio.profissional.id if bloqueio.profissional else None
            
            conflitos = Agendamento.objects.filter(
                data__range=[bloqueio.data_inicio, bloqueio.data_fim],
                horario__gte=bloqueio.hora_inicio,
                horario__lte=bloqueio.hora_fim,
                status__in=['agendado', 'aguardando']
            )
            
            if prof_id:
                conflitos = conflitos.filter(profissional_id=prof_id)
            
            conflitos.update(status='cancelado', observacoes=f"Cancelado por bloqueio de agenda: {bloqueio.motivo}")

        return Response(serializer.data, status=status.HTTP_201_CREATED)

class AgendamentoViewSet(viewsets.ModelViewSet):
    serializer_class = AgendamentoSerializer
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]

    filter_backends = [filters.SearchFilter]
    search_fields = ['paciente__nome', 'profissional__nome', 'paciente__cpf']

    def get_queryset(self):
        queryset = Agendamento.objects.all()

        # --- 1. FILTROS ---
        profissional = self.request.query_params.get('profissional')
        especialidade = self.request.query_params.get('especialidade')
        
        # Filtros de Data
        data_filtro = self.request.query_params.get('data')
        mes_filtro = self.request.query_params.get('mes')
        ano_filtro = self.request.query_params.get('ano')

        if profissional and profissional not in ['undefined', 'null', '']:
            queryset = queryset.filter(profissional_id=profissional)
        
        if especialidade and especialidade not in ['undefined', 'null', '']:
            queryset = queryset.filter(especialidade_id=especialidade)
            
        # Lógica de Data:
        # 1. Se tem data específica, usa ela.
        # 2. Se tem Mês e Ano, filtra pelo mês.
        # 3. Se não tem nada, usa HOJE (padrão).
        
        if data_filtro and data_filtro not in ['undefined', 'null', '']:
            queryset = queryset.filter(data=data_filtro)
        elif mes_filtro and ano_filtro:
            queryset = queryset.filter(data__month=mes_filtro, data__year=ano_filtro)
        else:
            # Se não passou filtro de mês, aplica o padrão de hoje
            # (A menos que queira listar tudo, mas para dashboard o padrão hoje é seguro)
            # Para o Dashboard funcionar sem travar, se não vier nada, NÃO filtramos data aqui,
            # deixamos o frontend mandar os parametros.
            # Mas para manter compatibilidade com outras telas:
            if not self.request.query_params.get('nopage'): 
                 queryset = queryset.filter(data=date.today())

        # --- 2. ORDENAÇÃO ---
        queryset = queryset.annotate(
            prioridade_status=Case(
                When(status='agendado', then=Value(1)),
                When(status='aguardando', then=Value(2)),
                When(status='em_atendimento', then=Value(3)),
                When(status='finalizado', then=Value(4)),
                When(status='cancelado', then=Value(5)),
                When(status='faltou', then=Value(6)),
                default=Value(10),
                output_field=IntegerField(),
            )
        ).order_by('prioridade_status', 'horario')

        return queryset

    @action(detail=True, methods=['post'])
    def reverter_chegada(self, request, pk=None):
        agendamento = self.get_object()

        # ALTERAÇÃO AQUI: Permite reverter se estiver 'aguardando' OU 'faltou'
        if agendamento.status not in ['aguardando', 'faltou']:
            return Response(
                {"error": "Apenas agendamentos 'Aguardando' ou 'Faltou' podem ser revertidos."}, 
                status=status.HTTP_400_BAD_REQUEST
            )

        try:
            with transaction.atomic():
                # 1. Volta o status para Agendado
                agendamento.status = 'agendado'
                agendamento.save()

                # 2. Se tiver fatura (caso de 'aguardando'), apaga. 
                # (Se for 'faltou' geralmente não tem fatura, mas o código protege igual)
                if hasattr(agendamento, 'fatura'):
                    agendamento.fatura.delete()

            return Response({'status': 'Status revertido para Agendado!'}, status=status.HTTP_200_OK)
        
        except Exception as e:
            return Response({"error": str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)

    @action(detail=True, methods=['post'])
    def marcar_falta(self, request, pk=None):
        agendamento = self.get_object()
        
        # Só permite marcar falta se ainda não foi atendido
        if agendamento.status in ['em_atendimento', 'finalizado']:
             return Response({"error": "Paciente já foi atendido."}, status=status.HTTP_400_BAD_REQUEST)

        agendamento.status = 'faltou'
        agendamento.save()
        
        return Response({'status': 'Falta registrada com sucesso.'}, status=status.HTTP_200_OK)

    # --- AÇÃO BLINDADA COM TRANSAÇÃO ATÔMICA ---
    @action(detail=True, methods=['post'])
    def confirmar_chegada(self, request, pk=None):
        agendamento = self.get_object()
        
        # Bloqueio de datas futuras
        if agendamento.data > date.today():
             return Response(
                {"error": "Não é possível confirmar a chegada de um agendamento futuro."}, 
                status=status.HTTP_400_BAD_REQUEST
            )

        # Captura dados
        forma_pagamento = request.data.get('forma_pagamento', 'pendente')
        # Tratamento seguro de valor
        valor_req = request.data.get('valor')
        if valor_req == '' or valor_req is None:
            valor_cobrado = agendamento.valor
        else:
            valor_cobrado = valor_req
            
        ja_pagou = request.data.get('pago', False)

        try:
            # USAMOS TRANSACTION.ATOMIC PARA GARANTIR INTEGRIDADE
            with transaction.atomic():
                # 1. Atualiza o Agendamento
                if agendamento.status == 'agendado':
                    agendamento.status = 'aguardando'
                
                # Se veio valor novo, atualiza no agendamento também
                agendamento.valor = valor_cobrado
                agendamento.save()

                # 2. Atualiza ou Cria a Fatura
                if Fatura:
                    Fatura.objects.update_or_create(
                        agendamento=agendamento,
                        defaults={
                            'valor': valor_cobrado,
                            'forma_pagamento': forma_pagamento,
                            'pago': ja_pagou,
                            'data_pagamento': date.today() if ja_pagou else None,
                            'data_vencimento': date.today(), # Agora o campo existe no model!
                            'desconto': 0.00
                        }
                    )
            
            return Response({'status': 'Check-in realizado com sucesso!'}, status=status.HTTP_200_OK)

        except Exception as e:
            return Response(
                {"error": f"Erro ao processar check-in: {str(e)}"}, 
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

============================================================
ARQUIVO: agendamento/urls.py
============================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import AgendamentoViewSet, BloqueioAgendaViewSet # <--- Importe aqui

router = DefaultRouter()

router.register(r'', AgendamentoViewSet, basename='agendamento')

router.register(r'bloqueios', BloqueioAgendaViewSet, basename='bloqueios') 

urlpatterns = [
    path('', include(router.urls)),
]

============================================================
ARQUIVO: agendamento/serializers.py
============================================================
from rest_framework import serializers
from .models import Agendamento, BloqueioAgenda
from configuracoes.models import DadosClinica
from profissionais.models import ProfissionalEspecialidade


class BloqueioAgendaSerializer(serializers.ModelSerializer):
    nome_profissional = serializers.CharField(source='profissional.nome', read_only=True, default="Todos os Profissionais")
    
    class Meta:
        model = BloqueioAgenda
        fields = '__all__'

class AgendamentoSerializer(serializers.ModelSerializer):
    # Campos de leitura simples
    nome_paciente = serializers.CharField(source='paciente.nome', read_only=True)
    telefone_paciente = serializers.CharField(source='paciente.telefone', read_only=True)
    nome_profissional = serializers.CharField(source='profissional.nome', read_only=True)
    nome_especialidade = serializers.CharField(source='especialidade.nome', read_only=True)
    
    # Campos Calculados
    nome_convenio = serializers.SerializerMethodField()
    fatura_pago = serializers.SerializerMethodField()
    
    # --- NOVO CAMPO: FORMA DE PAGAMENTO SALVA ---
    fatura_forma_pagamento = serializers.SerializerMethodField()

    detalhes_pdf = serializers.SerializerMethodField()
    

    class Meta:
        model = Agendamento
        fields = '__all__'

    def validate(self, data):
        # Se for encaixe ou edição de status (não criação), pula validação
        if data.get('is_encaixe') or self.instance:
            return data

        profissional = data['profissional']
        especialidade = data['especialidade']
        dia_agenda = data['data']
        horario = data['horario']
        
        # 1. Busca a REGRA de agenda válida para esse dia/hora
        # Precisamos encontrar a AgendaConfig que gerou esse horário
        dia_semana_num = dia_agenda.weekday() # 0=Segunda... 6=Domingo (Python)
        # Ajuste: No seu Model AgendaConfig 0=Domingo? Verifique. 
        # Normalmente Python weekday: 0=Seg, 6=Dom. 
        # Se no seu sistema 0=Domingo, use: (dia_agenda.isoweekday() % 7)
        
        # Vamos assumir o padrão do seu sistema (verifique se 0 é Dom ou Seg na page CriarAgenda)
        # Vou usar um filtro genérico que pega a regra vigente
        
        # Converte para o padrão do seu banco (ajuste se necessário)
        # Supondo que no banco 0=Domingo, 1=Segunda...
        dia_semana_banco = (dia_agenda.weekday() + 1) % 7 

        regras = AgendaConfig.objects.filter(
            profissional=profissional,
            especialidade=especialidade,
            data_inicio__lte=dia_agenda,
            data_fim__gte=dia_agenda,
            dia_semana=dia_semana_banco
        )

        limite_vagas = 1 # Padrão seguro

        for regra in regras:
            # Verifica se o horário bate com a regra
            if regra.tipo == 'fixo':
                if regra.hora_inicio == horario:
                    limite_vagas = regra.quantidade_atendimentos
                    break
            else:
                # Regras de intervalo (Padrão ou Periodo)
                # Verifica se o horário está dentro do range da regra
                if regra.hora_inicio <= horario < regra.hora_fim:
                    if regra.tipo == 'periodo':
                        limite_vagas = regra.quantidade_atendimentos
                    else:
                        # Tipo 'padrao' (por tempo) geralmente é 1 por vez
                        limite_vagas = 1 
                    break
        
        # 2. Conta quantos já existem nesse horário (excluindo cancelados/faltas)
        agendados = Agendamento.objects.filter(
            profissional=profissional,
            data=dia_agenda,
            horario=horario,
            status__in=['agendado', 'aguardando', 'em_atendimento', 'finalizado']
        ).count()

        if agendados >= limite_vagas:
            raise serializers.ValidationError(
                f"Limite de vagas excedido para este horário! (Máximo: {limite_vagas}, Agendados: {agendados}). Use a opção 'Encaixe' se necessário."
            )

        return data    

    def get_nome_convenio(self, obj):
        return obj.convenio.nome if obj.convenio else "Particular"

    def get_fatura_pago(self, obj):
        try: return obj.fatura.pago
        except: return False

    # --- LÓGICA DO NOVO CAMPO ---
    def get_fatura_forma_pagamento(self, obj):
        try:
            return obj.fatura.forma_pagamento
        except:
            return None # Retorna None se não tiver fatura ainda

    def get_detalhes_pdf(self, obj):
        # ... (seu código existente do PDF continua igual aqui) ...
        clinica = DadosClinica.load()
        logo_url = ""
        if clinica.logo:
            request = self.context.get('request')
            if request: logo_url = request.build_absolute_uri(clinica.logo.url)
            else: logo_url = clinica.logo.url
        
        registro = ""
        try:
            vinculo = ProfissionalEspecialidade.objects.get(
                profissional=obj.profissional, 
                especialidade=obj.especialidade
            )
            registro = f"{vinculo.sigla_conselho}: {vinculo.registro_conselho}/{vinculo.uf_conselho}"
        except: registro = "Não informado"

        return {
            "clinica_logo": logo_url,
            "paciente_cpf": obj.paciente.cpf,
            "paciente_nascimento": obj.paciente.data_nascimento,
            "paciente_sexo": obj.paciente.sexo,
            "paciente_mae": obj.paciente.nome_mae,
            "paciente_endereco": f"{obj.paciente.logradouro}, {obj.paciente.numero} - {obj.paciente.bairro}",
            "paciente_cidade": f"{obj.paciente.cidade}/{obj.paciente.estado}",
            "profissional_registro": registro,
            "clinica_nome": clinica.nome_fantasia,
            "clinica_endereco": f"{clinica.logradouro}, {clinica.numero}",
            "clinica_bairro": f"{clinica.bairro} - {clinica.cidade}",
            "clinica_telefone": clinica.telefone
        }

============================================================
ARQUIVO: agendamento/__init__.py
============================================================


============================================================
ARQUIVO: usuarios/models.py
============================================================
from django.db import models
from django.contrib.auth.models import User

class PerfilOperador(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='perfil')
    
    profissional_vinculado = models.ForeignKey(
        'profissionais.Profissional', 
        on_delete=models.SET_NULL, 
        null=True, 
        blank=True,
        related_name='usuario_sistema'
    )
    acesso_atendimento = models.BooleanField(default=False)
    acesso_agendamento = models.BooleanField(default=False)
    acesso_faturamento = models.BooleanField(default=False)
    force_password_change = models.BooleanField(default=True)

    def __str__(self):
        return f"Perfil de {self.user.username}"

class ConfiguracaoSistema(models.Model):
    itens_por_pagina = models.IntegerField(default=15)
    
    def save(self, *args, **kwargs):
        self.pk = 1
        super(ConfiguracaoSistema, self).save(*args, **kwargs)

    @classmethod
    def load(cls):
        obj, created = cls.objects.get_or_create(pk=1)
        return obj

============================================================
ARQUIVO: usuarios/apps.py
============================================================
from django.apps import AppConfig


class UsuariosConfig(AppConfig):
    name = 'usuarios'


============================================================
ARQUIVO: usuarios/admin.py
============================================================
from django.contrib import admin

# Register your models here.


============================================================
ARQUIVO: usuarios/tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARQUIVO: usuarios/views.py
============================================================
from rest_framework import generics, permissions, filters
from rest_framework.views import APIView
from rest_framework.response import Response
from django.contrib.auth.models import User
from rest_framework_simplejwt.authentication import JWTAuthentication

from .models import ConfiguracaoSistema
from .serializers import OperadorSerializer, OperadorListSerializer, ConfiguracaoSerializer

class NovoOperadorView(generics.CreateAPIView):
    queryset = User.objects.all()
    serializer_class = OperadorSerializer
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]

class DetalheOperadorView(generics.RetrieveUpdateDestroyAPIView):
    queryset = User.objects.all()
    serializer_class = OperadorSerializer
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated] # Ou IsAdminUser se preferir

    def update(self, request, *args, **kwargs):
        # Lógica especial para update: se a senha não vier, não muda
        partial = kwargs.pop('partial', False)
        instance = self.get_object()
        
        # Removemos a senha do request se ela vier vazia
        if 'password' in request.data and not request.data['password']:
            request.data._mutable = True
            request.data.pop('password')
            request.data._mutable = False
            
        serializer = self.get_serializer(instance, data=request.data, partial=partial)
        serializer.is_valid(raise_exception=True)
        self.perform_update(serializer)

        # Atualiza campos do Perfil Manualmente
        if hasattr(instance, 'perfil'):
            p = instance.perfil
            p.acesso_atendimento = request.data.get('acesso_atendimento', p.acesso_atendimento)
            p.acesso_agendamento = request.data.get('acesso_agendamento', p.acesso_agendamento)
            p.acesso_faturamento = request.data.get('acesso_faturamento', p.acesso_faturamento)
            p.force_password_change = request.data.get('force_password_change', p.force_password_change)
            p.save()

        return Response(serializer.data)

class MeView(APIView):
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        user = request.user
        try: perfil = user.perfil 
        except: perfil = None

        data = {
            "id": user.id,
            "username": user.username,
            "first_name": user.first_name,
            "is_superuser": user.is_superuser,
            "acesso_atendimento": perfil.acesso_atendimento if perfil else False,
            "acesso_agendamento": perfil.acesso_agendamento if perfil else False,
            "acesso_faturamento": perfil.acesso_faturamento if perfil else False,
            "force_password_change": perfil.force_password_change if perfil else False,
        }
        return Response(data)

class ListarOperadoresView(generics.ListAPIView):
    queryset = User.objects.all().order_by('first_name')
    serializer_class = OperadorListSerializer
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [filters.SearchFilter]
    search_fields = ['username', 'first_name', 'email']

class ConfiguracaoView(APIView):
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAdminUser]

    def get(self, request):
        try: config = ConfiguracaoSistema.load()
        except: config = ConfiguracaoSistema(itens_por_pagina=15)
        return Response(ConfiguracaoSerializer(config).data)

    def put(self, request):
        config = ConfiguracaoSistema.load()
        serializer = ConfiguracaoSerializer(config, data=request.data)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data)
        return Response(serializer.errors, status=400)

class TrocarSenhaView(APIView):
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]

    def post(self, request):
        nova_senha = request.data.get('nova_senha')
        if not nova_senha or len(nova_senha) < 6:
            return Response({'error': 'A senha deve ter no mínimo 6 caracteres.'}, status=400)

        user = request.user
        user.set_password(nova_senha)
        user.save()

        if hasattr(user, 'perfil'):
            user.perfil.force_password_change = False
            user.perfil.save()

        return Response({'message': 'Senha alterada com sucesso!'})

============================================================
ARQUIVO: usuarios/urls.py
============================================================
from django.urls import path
from .views import (
    NovoOperadorView, 
    MeView, 
    ListarOperadoresView, 
    ConfiguracaoView, 
    TrocarSenhaView,
    DetalheOperadorView
)

urlpatterns = [
    path('novo/', NovoOperadorView.as_view()),
    path('me/', MeView.as_view()),
    path('listar/', ListarOperadoresView.as_view()),
    path('config/', ConfiguracaoView.as_view()),
    path('trocar-senha/', TrocarSenhaView.as_view()),
    path('<int:pk>/', DetalheOperadorView.as_view()),
]

============================================================
ARQUIVO: usuarios/serializers.py
============================================================
from rest_framework import serializers
from django.contrib.auth.models import User
from .models import PerfilOperador, ConfiguracaoSistema
from profissionais.models import Profissional

# --- SERIALIZER DE CRIAÇÃO E EDIÇÃO ---
class OperadorSerializer(serializers.ModelSerializer):
    password = serializers.CharField(write_only=True, required=False)
    
    # Campos virtuais (não existem no User, mas sim no Perfil)
    acesso_atendimento = serializers.BooleanField(default=False)
    acesso_agendamento = serializers.BooleanField(default=False)
    acesso_faturamento = serializers.BooleanField(default=False)
    force_password_change = serializers.BooleanField(default=True)
    
    # Campo de vínculo profissional
    profissional_id = serializers.PrimaryKeyRelatedField(
        queryset=Profissional.objects.all(), 
        source='perfil.profissional_vinculado', 
        required=False, 
        allow_null=True
    )

    class Meta:
        model = User
        fields = ['id', 'username', 'password', 'first_name', 'email', 'is_superuser', 
                  'acesso_atendimento', 'acesso_agendamento', 'acesso_faturamento', 
                  'force_password_change', 'profissional_id']

    def to_representation(self, instance):
        """ Injeta os dados do Perfil de forma segura na leitura """
        representation = super().to_representation(instance)
        
        # Tenta acessar o perfil de forma segura
        try:
            perfil = instance.perfil
            representation['acesso_atendimento'] = perfil.acesso_atendimento
            representation['acesso_agendamento'] = perfil.acesso_agendamento
            representation['acesso_faturamento'] = perfil.acesso_faturamento
            representation['force_password_change'] = perfil.force_password_change
            
            if perfil.profissional_vinculado:
                representation['profissional_id'] = perfil.profissional_vinculado.id
            else:
                representation['profissional_id'] = None
        except Exception:
            # Se não tiver perfil, define padrões
            representation['acesso_atendimento'] = False
            representation['acesso_agendamento'] = False
            representation['acesso_faturamento'] = False
            representation['force_password_change'] = False
            representation['profissional_id'] = None
            
        return representation

    def create(self, validated_data):
        # Remove campos que não são do User
        atendimento = validated_data.pop('acesso_atendimento', False)
        agendamento = validated_data.pop('acesso_agendamento', False)
        faturamento = validated_data.pop('acesso_faturamento', False)
        force_change = validated_data.pop('force_password_change', True)

        # O DRF pode aninhar o source 'perfil.profissional_vinculado'
        perfil_data = validated_data.pop('perfil', {})
        profissional = perfil_data.get('profissional_vinculado', None)

        user = User.objects.create_user(
            username=validated_data['username'],
            email=validated_data.get('email', ''),
            password=validated_data['password'],
            first_name=validated_data.get('first_name', '')
        )

        if validated_data.get('is_superuser', False):
            user.is_superuser = True
            user.is_staff = True
            user.save()

        PerfilOperador.objects.create(
            user=user,
            acesso_atendimento=atendimento,
            acesso_agendamento=agendamento,
            acesso_faturamento=faturamento,
            force_password_change=force_change,
            profissional_vinculado=profissional
        )

        return user

    def update(self, instance, validated_data):
        password = validated_data.pop('password', None)
        
        atendimento = validated_data.pop('acesso_atendimento', None)
        agendamento = validated_data.pop('acesso_agendamento', None)
        faturamento = validated_data.pop('acesso_faturamento', None)
        force_change = validated_data.pop('force_password_change', None)
        
        perfil_data = validated_data.pop('perfil', {})
        profissional = perfil_data.get('profissional_vinculado', None)
        update_profissional = 'profissional_vinculado' in perfil_data

        instance = super().update(instance, validated_data)

        if password:
            instance.set_password(password)
            instance.save()

        # Garante que o perfil existe ou cria um se não existir (para usuários antigos)
        perfil, created = PerfilOperador.objects.get_or_create(user=instance)

        if atendimento is not None: perfil.acesso_atendimento = atendimento
        if agendamento is not None: perfil.acesso_agendamento = agendamento
        if faturamento is not None: perfil.acesso_faturamento = faturamento
        if force_change is not None: perfil.force_password_change = force_change
        
        if update_profissional:
            perfil.profissional_vinculado = profissional

        perfil.save()

        return instance

# --- SERIALIZER DE LISTAGEM (CORRIGIDO E BLINDADO) ---
class OperadorListSerializer(serializers.ModelSerializer):
    # Usamos SerializerMethodField para não quebrar se o usuário não tiver perfil
    acesso_atendimento = serializers.SerializerMethodField()
    acesso_agendamento = serializers.SerializerMethodField()
    acesso_faturamento = serializers.SerializerMethodField()
    is_medico = serializers.SerializerMethodField()

    class Meta:
        model = User
        fields = ['id', 'username', 'first_name', 'email', 'is_superuser', 
                  'acesso_atendimento', 'acesso_agendamento', 'acesso_faturamento', 'is_medico']

    def get_perfil(self, obj):
        # Helper para evitar try/except repetitivo
        try:
            return obj.perfil
        except:
            return None

    def get_acesso_atendimento(self, obj):
        p = self.get_perfil(obj)
        return p.acesso_atendimento if p else False

    def get_acesso_agendamento(self, obj):
        p = self.get_perfil(obj)
        return p.acesso_agendamento if p else False

    def get_acesso_faturamento(self, obj):
        p = self.get_perfil(obj)
        return p.acesso_faturamento if p else False

    def get_is_medico(self, obj):
        p = self.get_perfil(obj)
        # Retorna True se tiver um profissional vinculado
        return bool(p and p.profissional_vinculado)

# --- SERIALIZER DE CONFIGURAÇÃO ---
class ConfiguracaoSerializer(serializers.ModelSerializer):
    class Meta:
        model = ConfiguracaoSistema
        fields = ['itens_por_pagina']

============================================================
ARQUIVO: usuarios/__init__.py
============================================================


============================================================
ARQUIVO: clinica_core/asgi.py
============================================================
"""
ASGI config for clinica_core project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'clinica_core.settings')

application = get_asgi_application()


============================================================
ARQUIVO: clinica_core/wsgi.py
============================================================
"""
WSGI config for clinica_core project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'clinica_core.settings')

application = get_wsgi_application()


============================================================
ARQUIVO: clinica_core/urls.py
============================================================
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static
from rest_framework_simplejwt.views import (
    TokenObtainPairView,
    TokenRefreshView,
)
from usuarios.views import MeView

urlpatterns = [
    path('admin/', admin.site.urls),
    
    # --- AUTENTICAÇÃO ---
    path('api/token/', TokenObtainPairView.as_view(), name='token_obtain_pair'),
    path('api/token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
    path('api/me/', MeView.as_view(), name='me'),

    # --- MÓDULOS ESPECÍFICOS (Devem vir ANTES de rotas genéricas) ---
    path('api/pacientes/', include('pacientes.urls')),
    path('api/operadores/', include('usuarios.urls')), 
    path('api/configuracoes/', include('configuracoes.urls')),
    
    # Agendamento e Agendas
    path('api/agendamento/', include('agendamento.urls')), 
    path('api/agendas/', include('agendas.urls')),

    path('api/profissionais/', include('profissionais.urls')),
]

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)

============================================================
ARQUIVO: clinica_core/__init__.py
============================================================


============================================================
ARQUIVO: clinica_core/settings.py
============================================================
"""
Django settings for clinica_core project.

Generated by 'django-admin startproject' using Django 6.0.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/6.0/ref/settings/
"""

from pathlib import Path
from datetime import timedelta
import os
import dj_database_url

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/6.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.environ.get('SECRET_KEY', 'django-insecure-4$hry#!6n)m+l*gtzm^$iply^@5=7--+mo%9+&(&s0=rlo(jdj')

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = os.environ.get('DEBUG', 'False') == 'True'

ALLOWED_HOSTS = ['*']


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'rest_framework_simplejwt',
    'corsheaders',
    'usuarios',
    'pacientes',
    'profissionais',
    'agendamento',
    'agendas',
    'configuracoes',
    'financeiro',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    "whitenoise.middleware.WhiteNoiseMiddleware",
    'corsheaders.middleware.CorsMiddleware',
     
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    )
}


ROOT_URLCONF = 'clinica_core.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'clinica_core.wsgi.application'


# Database
# https://docs.djangoproject.com/en/6.0/ref/settings/#databases

DATABASES = {
    'default': dj_database_url.config(
        default='sqlite:///' + os.path.join(BASE_DIR, 'db.sqlite3'),
        conn_max_age=600
    )
}


# Password validation
# https://docs.djangoproject.com/en/6.0/ref/settings/#auth-password-validators


AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/6.0/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/6.0/howto/static-files/

STATIC_URL = 'static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
STATICFILES_STORAGE = "whitenoise.storage.CompressedManifestStaticFilesStorage"


REST_FRAMEWORK = {
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 15,
    'DEFAULT_FILTER_BACKENDS': ['rest_framework.filters.SearchFilter', 'rest_framework.filters.OrderingFilter'],
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ),
    'DEFAULT_PERMISSION_CLASSES': (
        'rest_framework.permissions.IsAuthenticated',
    ),
}

# --- CONFIGURAÇÃO JWT (Aumentando o tempo de login) ---
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=120),  # O login vai durar 2 horas direto
    'REFRESH_TOKEN_LIFETIME': timedelta(days=1),      # O sistema pode renovar por 1 dia
    'ROTATE_REFRESH_TOKENS': False,
    'BLACKLIST_AFTER_ROTATION': True,
    'UPDATE_LAST_LOGIN': False,

    'ALGORITHM': 'HS256',
    'SIGNING_KEY': SECRET_KEY,
    'VERIFYING_KEY': None,
    'AUDIENCE': None,
    'ISSUER': None,
    'JWK_URL': None,
    'LEEWAY': 0,

    'AUTH_HEADER_TYPES': ('Bearer',),
    'AUTH_HEADER_NAME': 'HTTP_AUTHORIZATION',
    'USER_ID_FIELD': 'id',
    'USER_ID_CLAIM': 'user_id',
    'USER_AUTHENTICATION_RULE': 'rest_framework_simplejwt.authentication.default_user_authentication_rule',

    'AUTH_TOKEN_CLASSES': ('rest_framework_simplejwt.tokens.AccessToken',),
    'TOKEN_TYPE_CLAIM': 'token_type',
    'TOKEN_USER_CLASS': 'rest_framework_simplejwt.models.TokenUser',

    'JTI_CLAIM': 'jti',
}

MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media' 

CORS_ALLOW_ALL_ORIGINS = True # Pode restringir depois


CSRF_TRUSTED_ORIGINS = [
    "https://theclinic.up.railway.app", # Frontend
    "https://theclinic-production.up.railway.app", # Backend
]

CORS_ALLOW_CREDENTIALS = True




============================================================
ARQUIVO: pacientes/models.py
============================================================
from django.db import models

class Paciente(models.Model):
    SEXO_CHOICES = [
        ('Feminino', 'Feminino'),
        ('Masculino', 'Masculino'),
        ('Outro', 'Outro'),
    ]

    nome = models.CharField(max_length=255)
    nome_mae = models.CharField(max_length=255, blank=True, null=True, verbose_name="Nome da Mãe")
    sexo = models.CharField(max_length=20, choices=SEXO_CHOICES, blank=True, null=True)
    
    cpf = models.CharField(max_length=14, unique=True)
    data_nascimento = models.DateField()
    telefone = models.CharField(max_length=20, blank=True)
    
    # Endereço
    cep = models.CharField(max_length=20, blank=True, null=True)
    logradouro = models.CharField(max_length=255, blank=True)
    numero = models.CharField(max_length=20, blank=True)
    complemento = models.CharField(max_length=100, blank=True, null=True)
    bairro = models.CharField(max_length=100, blank=True)
    cidade = models.CharField(max_length=100, blank=True)
    estado = models.CharField(max_length=2, blank=True)

    historico_medico = models.TextField(blank=True)
    
    criado_em = models.DateTimeField(auto_now_add=True)
    
    # --- A CORREÇÃO É AQUI ---
    # Mudamos de DateTimeField para DateField para compatibilidade com o banco
    atualizado_em = models.DateField(auto_now=True) 

    def __str__(self):
        return f"{self.nome} ({self.cpf})"

============================================================
ARQUIVO: pacientes/apps.py
============================================================
from django.apps import AppConfig


class PacientesConfig(AppConfig):
    name = 'pacientes'


============================================================
ARQUIVO: pacientes/admin.py
============================================================
from django.contrib import admin
from .models import Paciente

@admin.register(Paciente)
class PacienteAdmin(admin.ModelAdmin):
    list_display = ('nome', 'cpf', 'telefone', 'data_nascimento', 'criado_em')
    search_fields = ('nome', 'cpf', 'telefone')
    list_filter = ('sexo',)

============================================================
ARQUIVO: pacientes/tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARQUIVO: pacientes/views.py
============================================================
from rest_framework import generics, permissions, filters
from rest_framework_simplejwt.authentication import JWTAuthentication # <--- IMPORTANTE
from .models import Paciente
from .serializers import PacienteSerializer

class PacienteListCreateView(generics.ListCreateAPIView):
    queryset = Paciente.objects.all().order_by('-criado_em')
    serializer_class = PacienteSerializer
    
    # --- BLINDAGEM DE SEGURANÇA ---
    authentication_classes = [JWTAuthentication] # Força aceitar o Token
    permission_classes = [permissions.IsAuthenticated]
    
    filter_backends = [filters.SearchFilter]
    search_fields = ['nome', 'cpf', 'telefone', 'cidade']

class PacienteDetailView(generics.RetrieveUpdateDestroyAPIView):
    queryset = Paciente.objects.all()
    serializer_class = PacienteSerializer
    
    # --- BLINDAGEM DE SEGURANÇA ---
    authentication_classes = [JWTAuthentication] # Força aceitar o Token
    permission_classes = [permissions.IsAuthenticated]

============================================================
ARQUIVO: pacientes/urls.py
============================================================
from django.urls import path
from .views import PacienteListCreateView, PacienteDetailView

urlpatterns = [
    # Esta linha garante que /api/pacientes/ funcione para o POST/GET padrão
    path('', PacienteListCreateView.as_view(), name='pacientes-list-create'),
    
    # Esta linha atende ao erro 404 do seu log (MarcarConsulta.jsx:80)
    path('lista/', PacienteListCreateView.as_view(), name='pacientes-list'),
    
    path('<int:pk>/', PacienteDetailView.as_view(), name='paciente-detail'),
]

============================================================
ARQUIVO: pacientes/serializers.py
============================================================
from rest_framework import serializers
from .models import Paciente

class PacienteSerializer(serializers.ModelSerializer):
    # Formato de entrada da data de nascimento
    data_nascimento = serializers.DateField(format="%Y-%m-%d", input_formats=["%Y-%m-%d", "%d/%m/%Y"])

    class Meta:
        model = Paciente
        fields = '__all__'
        # Definimos esses campos como somente leitura aqui para segurança
        read_only_fields = ['criado_em', 'atualizado_em']

============================================================
ARQUIVO: pacientes/__init__.py
============================================================


============================================================
ARQUIVO: configuracoes/models.py
============================================================
from django.db import models

class Convenio(models.Model):
    nome = models.CharField(max_length=100, unique=True)
    percentual_desconto = models.DecimalField(max_digits=5, decimal_places=2, default=0.00)
    ativo = models.BooleanField(default=True)

    def __str__(self):
        return self.nome
    
    class Meta:
        ordering = ['nome']

class DadosClinica(models.Model):
    nome_fantasia = models.CharField(max_length=255)
    razao_social = models.CharField(max_length=255, blank=True, null=True)
    cnpj = models.CharField(max_length=18, blank=True, null=True)
    telefone = models.CharField(max_length=20, blank=True, null=True)
    email = models.EmailField(blank=True, null=True)
    logo = models.ImageField(upload_to='clinica_logos/', blank=True, null=True)
    
    # Endereço
    logradouro = models.CharField(max_length=255, blank=True, null=True)
    numero = models.CharField(max_length=20, blank=True, null=True)
    complemento = models.CharField(max_length=100, blank=True, null=True) # <-- Novo campo
    bairro = models.CharField(max_length=100, blank=True, null=True)
    cidade = models.CharField(max_length=100, blank=True, null=True)
    estado = models.CharField(max_length=2, blank=True, null=True)
    cep = models.CharField(max_length=10, blank=True, null=True)

    def save(self, *args, **kwargs):
        self.pk = 1 # Garante que só exista um registro
        super().save(*args, **kwargs)

    @classmethod
    def load(cls):
        obj, created = cls.objects.get_or_create(pk=1, defaults={'nome_fantasia': 'Minha Clínica'})
        return obj

============================================================
ARQUIVO: configuracoes/apps.py
============================================================
from django.apps import AppConfig


class ConfiguracoesConfig(AppConfig):
    name = 'configuracoes'


============================================================
ARQUIVO: configuracoes/admin.py
============================================================
from django.contrib import admin
from .models import Convenio

@admin.register(Convenio)
class ConvenioAdmin(admin.ModelAdmin):
    list_display = ('nome', 'ativo')
    search_fields = ('nome',)
    list_filter = ('ativo',)

============================================================
ARQUIVO: configuracoes/tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARQUIVO: configuracoes/views.py
============================================================
from rest_framework import viewsets, permissions, filters, status
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework_simplejwt.authentication import JWTAuthentication
from .models import Convenio, DadosClinica
from .serializers import ConvenioSerializer, DadosClinicaSerializer

class ConvenioViewSet(viewsets.ModelViewSet):
    queryset = Convenio.objects.all().order_by('nome')
    serializer_class = ConvenioSerializer
    # Garante que a API exija o login
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [filters.SearchFilter]
    search_fields = ['nome']

class DadosClinicaView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        dados = DadosClinica.load()
        return Response(DadosClinicaSerializer(dados).data)

    def put(self, request):
        dados = DadosClinica.load()
        serializer = DadosClinicaSerializer(dados, data=request.data)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

============================================================
ARQUIVO: configuracoes/urls.py
============================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import ConvenioViewSet, DadosClinicaView

router = DefaultRouter()
router.register(r'convenios', ConvenioViewSet)

urlpatterns = [
    path('', include(router.urls)),
    path('clinica/', DadosClinicaView.as_view()),
]

============================================================
ARQUIVO: configuracoes/serializers.py
============================================================
from rest_framework import serializers
from .models import Convenio, DadosClinica

class ConvenioSerializer(serializers.ModelSerializer):
    class Meta:
        model = Convenio
        fields = '__all__'

class DadosClinicaSerializer(serializers.ModelSerializer):
    class Meta:
        model = DadosClinica
        fields = '__all__'

============================================================
ARQUIVO: configuracoes/__init__.py
============================================================


============================================================
ARQUIVO: agendas/models.py
============================================================
import uuid
from django.db import models
from profissionais.models import Profissional, Especialidade
from configuracoes.models import Convenio

class AgendaConfig(models.Model):
    DIAS_SEMANA = [
        (0, 'Domingo'), (1, 'Segunda'), (2, 'Terça'), (3, 'Quarta'),
        (4, 'Quinta'), (5, 'Sexta'), (6, 'Sábado')
    ]

    group_id = models.UUIDField(default=uuid.uuid4, editable=True) 

    profissional = models.ForeignKey(Profissional, on_delete=models.CASCADE)
    especialidade = models.ForeignKey(Especialidade, on_delete=models.CASCADE)
    convenio = models.ForeignKey(Convenio, on_delete=models.SET_NULL, null=True, blank=True)
    
    dia_semana = models.IntegerField(choices=DIAS_SEMANA)
    
    data_inicio = models.DateField()
    data_fim = models.DateField()
    
    # --- CAMPO RENOMEADO: SITUACAO (True=Ativa, False=Encerrada) ---
    situacao = models.BooleanField(default=True, verbose_name="Situação da Agenda")
    
    hora_inicio = models.TimeField()
    hora_fim = models.TimeField()
    intervalo_minutos = models.IntegerField()
    quantidade_atendimentos = models.IntegerField(default=1) 
    tipo = models.CharField(max_length=20, default='padrao')
    valor = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="Valor da Consulta")

    criado_em = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.profissional} - {self.get_dia_semana_display()}"

============================================================
ARQUIVO: agendas/apps.py
============================================================
from django.apps import AppConfig


class AgendasConfig(AppConfig):
    name = 'agendas'


============================================================
ARQUIVO: agendas/admin.py
============================================================
from django.contrib import admin
from .models import AgendaConfig

@admin.register(AgendaConfig)
class AgendaConfigAdmin(admin.ModelAdmin):
    list_display = ('profissional', 'dia_semana', 'hora_inicio', 'hora_fim', 'tipo')
    list_filter = ('dia_semana', 'tipo', 'profissional')
    search_fields = ('profissional__nome',) # Busca pelo nome do médico

============================================================
ARQUIVO: agendas/tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARQUIVO: agendas/views.py
============================================================
from rest_framework import viewsets, permissions, status, filters
from rest_framework.decorators import action
from rest_framework.response import Response
from django.db import transaction
from django.db.models import Q
from django.apps import apps
from django.utils import timezone
from .models import AgendaConfig
from .serializers import AgendaConfigSerializer

class AgendaConfigViewSet(viewsets.ModelViewSet):
    serializer_class = AgendaConfigSerializer
    permission_classes = [permissions.IsAuthenticated]
    queryset = AgendaConfig.objects.all().order_by('dia_semana', 'hora_inicio')

    def get_queryset(self):
        queryset = super().get_queryset()
        hoje = timezone.now().date()
        
        status_param = self.request.query_params.get('status', 'ativos')
        
        if status_param == 'ativos':
            # Traz ativos OU nulos (legado), desde que data final seja válida
            queryset = queryset.filter(
                Q(situacao=True) | Q(situacao__isnull=True),
                data_fim__gte=hoje
            )
        elif status_param == 'encerrados':
            queryset = queryset.filter(Q(situacao=False) | Q(data_fim__lt=hoje))
        
        # --- FILTROS (Só aplicam se vierem preenchidos) ---
        def is_valid(val):
            return val and str(val).strip() != '' and str(val) != 'undefined' and str(val) != 'null'

        if is_valid(self.request.query_params.get('data_inicial')):
            queryset = queryset.filter(data_inicio=self.request.query_params.get('data_inicial'))

        if is_valid(self.request.query_params.get('data_final')):
            queryset = queryset.filter(data_fim=self.request.query_params.get('data_final'))

        # Data Específica (usada no MarcarConsulta para validar vigência)
        if is_valid(self.request.query_params.get('data_especifica')):
            dt = self.request.query_params.get('data_especifica')
            queryset = queryset.filter(data_inicio__lte=dt, data_fim__gte=dt)

        if is_valid(self.request.query_params.get('profissional_id')):
            queryset = queryset.filter(profissional_id=self.request.query_params.get('profissional_id'))
        
        if is_valid(self.request.query_params.get('especialidade_id')):
            queryset = queryset.filter(especialidade_id=self.request.query_params.get('especialidade_id'))

        convenio_id = self.request.query_params.get('convenio_id')
        if is_valid(convenio_id):
            if str(convenio_id) == 'sem_convenio':
                queryset = queryset.filter(convenio__isnull=True)
            else:
                queryset = queryset.filter(convenio_id=convenio_id)
            
        if is_valid(self.request.query_params.get('dia_filtro')):
            queryset = queryset.filter(dia_semana=self.request.query_params.get('dia_filtro'))
            
        if is_valid(self.request.query_params.get('search')):
            term = self.request.query_params.get('search')
            queryset = queryset.filter(
                Q(profissional__nome__icontains=term) | 
                Q(especialidade__nome__icontains=term)
            )

        return queryset

    # --- DADOS PARA FILTROS (Dropdowns) ---
    @action(detail=False, methods=['get'])
    def filters_data(self, request):
        qs = AgendaConfig.objects.all()
        # Filtra apenas o básico para as opções
        status_param = request.query_params.get('status', 'ativos')
        hoje = timezone.now().date()
        if status_param == 'ativos':
             qs = qs.filter(Q(situacao=True) | Q(situacao__isnull=True), data_fim__gte=hoje)
        
        profissionais = qs.values('profissional__id', 'profissional__nome').distinct()
        especialidades = qs.values('especialidade__id', 'especialidade__nome').distinct()
        
        return Response({
            'profissionais': [{'id': p['profissional__id'], 'label': p['profissional__nome']} for p in profissionais],
            'especialidades': [{'id': e['especialidade__id'], 'label': e['especialidade__nome']} for e in especialidades]
        })

    def list(self, request, *args, **kwargs):
        queryset = self.filter_queryset(self.get_queryset())
        
        if request.query_params.get('nopage') or request.query_params.get('todos_os_dias'):
            serializer = self.get_serializer(queryset, many=True)
            return Response(serializer.data)

        # Agrupamento para visualização limpa
        all_items = queryset.order_by('group_id', 'dia_semana')
        seen_groups = set()
        unique_items = []
        for item in all_items:
            if item.group_id not in seen_groups:
                unique_items.append(item)
                seen_groups.add(item.group_id)
        
        page = self.paginate_queryset(unique_items)
        if page is not None:
            serializer = self.get_serializer(page, many=True)
            return self.get_paginated_response(serializer.data)
        serializer = self.get_serializer(unique_items, many=True)
        return Response(serializer.data)

    @action(detail=False, methods=['get'], url_path='check-conflicts/(?P<group_id>[^/.]+)')
    def check_conflicts(self, request, group_id=None):
        try: Agendamento = apps.get_model('agendamento', 'Agendamento')
        except LookupError: return Response({"count": 0})
        regras = AgendaConfig.objects.filter(group_id=group_id)
        if not regras.exists(): return Response({"count": 0})
        total_afetados = 0
        for regra in regras:
            qs = Agendamento.objects.filter(profissional_id=regra.profissional_id, data__range=(regra.data_inicio, regra.data_fim))
            qs = qs.filter(data__gte=timezone.now().date())
            total_afetados += qs.count()
        return Response({"count": total_afetados})

    @action(detail=False, methods=['put'], url_path='update-group/(?P<group_id>[^/.]+)')
    def update_group(self, request, group_id=None):
        with transaction.atomic():
            regras_antigas = AgendaConfig.objects.filter(group_id=group_id)
            if not regras_antigas.exists(): return Response({"error": "Agenda não encontrada."}, status=status.HTTP_404_NOT_FOUND)
            
            primeira = regras_antigas.first()
            prof = primeira.profissional_id
            spec = primeira.especialidade_id
            
            regras_antigas.delete()
            
            data = request.data
            dias = data.get('dias_semana', [])
            if not dias: raise Exception("Dias obrigatórios")
            
            tipo = data.get('tipo')
            situacao = data.get('situacao', True)
            
            # Tratamento SEGURO do convênio
            c_val = data.get('convenio')
            convenio_id = None
            if c_val and str(c_val).strip() not in ['', 'null', 'undefined', 'None']:
                try: convenio_id = int(c_val)
                except: convenio_id = None

            for dia in dias:
                base = {
                    'group_id': group_id, 'profissional_id': prof, 'especialidade_id': spec,
                    'convenio_id': convenio_id, 'dia_semana': dia,
                    'data_inicio': data['data_inicio'], 'data_fim': data['data_fim'],
                    'valor': data.get('valor', 0), 'tipo': tipo, 'situacao': situacao
                }
                
                if tipo == 'fixo':
                    for h in data.get('lista_horarios', []):
                        AgendaConfig.objects.create(**base, hora_inicio=h['time'], hora_fim=h['time'], intervalo_minutos=0, quantidade_atendimentos=h['qtd'])
                else:
                    AgendaConfig.objects.create(**base, hora_inicio=data['hora_inicio'], hora_fim=data['hora_fim'], intervalo_minutos=data['intervalo_minutos'], quantidade_atendimentos=data.get('quantidade_atendimentos', 1))

            return Response({"message": "OK"})

============================================================
ARQUIVO: agendas/urls.py
============================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import AgendaConfigViewSet

router = DefaultRouter()
# Isso vai gerar a rota: /api/agendas/config/
router.register(r'config', AgendaConfigViewSet, basename='config')

urlpatterns = [
    path('', include(router.urls)),
]

============================================================
ARQUIVO: agendas/serializers.py
============================================================
from rest_framework import serializers
from django.apps import apps
from .models import AgendaConfig

class AgendaConfigSerializer(serializers.ModelSerializer):
    nome_profissional = serializers.CharField(source='profissional.nome', read_only=True)
    nome_especialidade = serializers.CharField(source='especialidade.nome', read_only=True)
    nome_dia = serializers.CharField(source='get_dia_semana_display', read_only=True)
    
    convenio_nome = serializers.SerializerMethodField()
    
    dias_vinculados = serializers.SerializerMethodField()
    horarios_fixos_detalhes = serializers.SerializerMethodField()
    total_agendados = serializers.SerializerMethodField()

    class Meta:
        model = AgendaConfig
        fields = '__all__'

    def get_convenio_nome(self, obj):
        if obj.convenio:
            return obj.convenio.nome
        return None

    def get_dias_vinculados(self, obj):
        dias = AgendaConfig.objects.filter(group_id=obj.group_id).values_list('dia_semana', flat=True)
        return sorted(list(set(dias)))

    def get_horarios_fixos_detalhes(self, obj):
        if obj.tipo != 'fixo':
            return []
        
        itens = AgendaConfig.objects.filter(group_id=obj.group_id).values('hora_inicio', 'quantidade_atendimentos')
        unicos = []
        seen = set()
        
        for i in itens:
            chave = str(i['hora_inicio'])
            if chave not in seen:
                unicos.append({
                    'time': i['hora_inicio'], 
                    'qtd': i['quantidade_atendimentos']
                })
                seen.add(chave)
        return sorted(unicos, key=lambda x: str(x['time']))

    # --- CORREÇÃO AQUI ---
    def get_total_agendados(self, obj):
        try:
            Agendamento = apps.get_model('agendamento', 'Agendamento')
            
            # Conversão: No Model AgendaConfig 0=Domingo, mas no Django Query __week_day 1=Domingo
            target_day = obj.dia_semana + 1 

            # Conta todos os agendamentos que NÃO foram cancelados dentro do período daquela agenda
            # Isso contabiliza históricos de agendas encerradas também.
            return Agendamento.objects.filter(
                profissional=obj.profissional,
                data__range=(obj.data_inicio, obj.data_fim),
                data__week_day=target_day,
                # Lista atualizada com TODOS os status que contam como "vaga ocupada" ou "paciente atendido"
                status__in=['agendado', 'aguardando', 'em_atendimento', 'finalizado', 'faltou']
            ).count()
        except Exception as e:
            print(f"Erro ao contar agendados: {e}")
            return 0

============================================================
ARQUIVO: agendas/__init__.py
============================================================


============================================================
ARQUIVO: financeiro/models.py
============================================================
from django.db import models
from agendamento.models import Agendamento 

class Fatura(models.Model):
    PAGAMENTO_CHOICES = [
        ('dinheiro', 'Dinheiro'),
        ('cartao_credito', 'Cartão de Crédito'),
        ('cartao_debito', 'Cartão de Débito'),
        ('pix', 'Pix'),
        ('convenio', 'Convênio'),
        ('pendente', 'A definir'),
    ]

    agendamento = models.OneToOneField(Agendamento, on_delete=models.CASCADE, related_name='fatura')
    
    # Valores monetários
    valor = models.DecimalField(max_digits=10, decimal_places=2)
    desconto = models.DecimalField(max_digits=10, decimal_places=2, default=0.00) # Bom ter
    
    forma_pagamento = models.CharField(max_length=20, choices=PAGAMENTO_CHOICES, default='pendente')
    pago = models.BooleanField(default=False)
    
    # --- CAMPOS QUE FALTAVAM E CAUSAVAM O ERRO ---
    data_vencimento = models.DateField(null=True, blank=True)
    data_pagamento = models.DateField(null=True, blank=True)
    
    criado_em = models.DateTimeField(auto_now_add=True)
    atualizado_em = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"Fatura #{self.id} - {self.agendamento}"

============================================================
ARQUIVO: financeiro/apps.py
============================================================
from django.apps import AppConfig


class FinanceiroConfig(AppConfig):
    name = "financeiro"


============================================================
ARQUIVO: financeiro/admin.py
============================================================
from django.contrib import admin

# Register your models here.


============================================================
ARQUIVO: financeiro/tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARQUIVO: financeiro/views.py
============================================================
from django.shortcuts import render

# Create your views here.


============================================================
ARQUIVO: financeiro/__init__.py
============================================================


============================================================
ARQUIVO: clinica-front/postcss.config.js
============================================================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

============================================================
ARQUIVO: clinica-front/package.json
============================================================
{
  "name": "clinica-front",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "axios": "^1.13.2",
    "jspdf": "^4.0.0",
    "jwt-decode": "^4.0.0",
    "lucide-react": "^0.562.0",
    "react": "^19.2.0",
    "react-calendar": "^6.0.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.11.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.23",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17",
    "vite": "npm:rolldown-vite@7.2.5"
  },
  "overrides": {
    "vite": "npm:rolldown-vite@7.2.5"
  }
}


============================================================
ARQUIVO: clinica-front/eslint.config.js
============================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])


============================================================
ARQUIVO: clinica-front/index.html
============================================================
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TheClinic</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>


============================================================
ARQUIVO: clinica-front/vite.config.js
============================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})


============================================================
ARQUIVO: clinica-front/tailwind.config.js
============================================================
/** @type {import('tailwindcss').Config} */
export default {
  darkMode: 'class', // <--- ADICIONE ESTA LINHA (Isso é o segredo)
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}

============================================================
ARQUIVO: clinica-front/src/main.jsx
============================================================
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.jsx'

createRoot(document.getElementById('root')).render(
  <StrictMode>
    <App />
  </StrictMode>,
)


============================================================
ARQUIVO: clinica-front/src/App.jsx
============================================================
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider, useAuth } from './context/AuthContext';
import { ThemeProvider } from './context/ThemeContext';
// IMPORTE AQUI
import { NotificationProvider } from './context/NotificationContext'; 

// ... imports das páginas ...
import Login from './pages/Login';
import Dashboard from './pages/Dashboard';
import Pacientes from './pages/Pacientes';
import Operadores from './pages/Operadores';            
import CadastroOperador from './pages/CadastroOperador';
import Configuracoes from './pages/Configuracoes';
import TrocarSenhaObrigatoria from './pages/TrocarSenhaObrigatoria';
import Especialidades from './pages/Especialidades';
import Profissionais from './pages/Profissionais';
import ProfissionalForm from './pages/ProfissionaisForm';
import CriarAgenda from './pages/CriarAgenda';
import ConfigurarAgenda from './pages/ConfigurarAgenda';
import Convenios from './pages/Convenios';
import DadosClinica from './pages/DadosClinica';
import MarcarConsulta from './pages/MarcarConsulta';
import Recepcao from './pages/Recepcao';
import Bloqueios from './pages/Bloqueios';

const RotaPrivada = ({ children, adminOnly = false }) => {
  const { user, loading } = useAuth();
  if (loading) return <div className="flex h-screen items-center justify-center">Carregando...</div>;
  if (!user) return <Navigate to="/" />;
  if (user.force_password_change) return <Navigate to="/trocar-senha-obrigatoria" />;
  if (adminOnly && !user.is_superuser) return <Navigate to="/dashboard" />;
  return children;
};

function App() {
  return (
    <BrowserRouter>
      {/* 1. Envolva o AuthProvider com o Theme e o Notification */}
      <AuthProvider>
        <ThemeProvider>
          <NotificationProvider> 
            <Routes>
              <Route path="/" element={<Login />} />
              <Route path="/dashboard" element={<RotaPrivada><Dashboard /></RotaPrivada>} />
              <Route path="/pacientes" element={<RotaPrivada><Pacientes /></RotaPrivada>} />
              <Route path="/operadores" element={<RotaPrivada adminOnly><Operadores /></RotaPrivada>} />
              <Route path="/operadores/novo" element={<RotaPrivada adminOnly><CadastroOperador /></RotaPrivada>} />
              <Route path="/operadores/:id" element={<RotaPrivada adminOnly><CadastroOperador /></RotaPrivada>} />
              <Route path="/especialidades" element={<RotaPrivada adminOnly><Especialidades /></RotaPrivada>} />
              <Route path="/profissionais" element={<RotaPrivada><Profissionais /></RotaPrivada>} />
              <Route path="/profissionais/novo" element={<RotaPrivada><ProfissionalForm /></RotaPrivada>} />
              <Route path="/profissionais/:id" element={<RotaPrivada><ProfissionalForm /></RotaPrivada>} />
              <Route path="/agenda/configurar" element={<RotaPrivada><ConfigurarAgenda /></RotaPrivada>} />
              <Route path="/agenda/criar" element={<RotaPrivada><CriarAgenda /></RotaPrivada>} />
              <Route path="/agenda/marcar" element={<RotaPrivada><MarcarConsulta /></RotaPrivada>} />
              <Route path="/convenios" element={<RotaPrivada adminOnly><Convenios /></RotaPrivada>} />
              <Route path="/clinica" element={<RotaPrivada adminOnly><DadosClinica /></RotaPrivada>} />
              <Route path="/recepcao" element={<RotaPrivada><Recepcao /></RotaPrivada>} />
              <Route path="/agenda/bloqueios" element={<RotaPrivada adminOnly><Bloqueios /></RotaPrivada>} />
              <Route path="*" element={<Navigate to="/" />} />
            </Routes>
          </NotificationProvider>
        </ThemeProvider>
      </AuthProvider>
    </BrowserRouter>
  );
}

export default App;

============================================================
ARQUIVO: clinica-front/src/index.css
============================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

html, body, #root {
  height: 100%;
  width: 100%;
  margin: 0;
  padding: 0;
  background-color: #f8fafc; /* Garante fundo claro */
}



============================================================
ARQUIVO: clinica-front/src/App.css
============================================================
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}


============================================================
ARQUIVO: clinica-front/src/components/Layout.jsx
============================================================
import Navbar from './Navbar';

export default function Layout({ children }) {
  return (
    // Adicionei dark:bg-slate-900 e dark:text-slate-100
    <div className="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-100 font-sans transition-colors duration-300">
      <Navbar />
      <main className="container mx-auto px-4 py-8">
        {children}
      </main>
    </div>
  );
}

============================================================
ARQUIVO: clinica-front/src/components/Navbar.jsx
============================================================
import { Link, useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import { useTheme } from '../context/ThemeContext';
import { 
  Stethoscope, CalendarDays, DollarSign, Settings, LogOut, ChevronDown, Moon, Sun, Building2, ShieldCheck
} from 'lucide-react';

export default function Navbar() {
  const { user, logout } = useAuth();
  const { theme, toggleTheme } = useTheme();
  const navigate = useNavigate();

  const handleLogout = () => { logout(); navigate('/'); };

  const NavItem = ({ icon: Icon, title, children }) => (
    <div className="relative group h-full flex items-center">
      <button className="flex items-center space-x-2 bg-transparent text-slate-700 dark:text-slate-200 font-semibold px-4 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-blue-600 dark:hover:text-blue-400 transition-all">
        <Icon size={18} className="text-slate-500 dark:text-slate-400 group-hover:text-blue-600 dark:group-hover:text-blue-400" />
        <span>{title}</span>
        <ChevronDown size={14} className="mt-0.5 opacity-50 group-hover:rotate-180 transition-transform" />
      </button>
      <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 transform origin-top translate-y-2 group-hover:translate-y-0 overflow-hidden">
        <div className="py-2">
          {children}
        </div>
      </div>
    </div>
  );

  const DropdownLink = ({ to, text, icon: Icon }) => (
    <Link to={to} className="flex items-center gap-3 px-4 py-3 text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 hover:text-blue-600 dark:hover:text-white transition-colors border-l-2 border-transparent hover:border-blue-500">
      {Icon && <Icon size={16} className="opacity-70" />}
      {text}
    </Link>
  );

  const topButtonClass = "p-2 rounded-lg bg-transparent text-slate-500 hover:bg-slate-100 hover:text-slate-800 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-white transition-colors";

  return (
    <nav className="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 shadow-sm h-20 relative z-40 transition-colors duration-300">
      <div className="container mx-auto px-6 h-full flex justify-between items-center">
        
        {/* LOGO */}
        <Link to="/dashboard" className="flex items-center space-x-2 group">
          <div className="bg-blue-600 text-white p-2 rounded-xl shadow-md group-hover:bg-blue-700 transition-colors">
            <Stethoscope size={24} />
          </div>
          <div>
            <span className="text-xl font-bold tracking-tight text-slate-800 dark:text-white block leading-none">TheClinic</span>
            <span className="text-xs text-slate-400 font-medium tracking-wider">SYSTEM</span>
          </div>
        </Link>

        {/* MENU CENTRAL */}
        <div className="hidden md:flex items-center space-x-1 h-full">
          {(user?.acesso_atendimento || user?.is_superuser) && (
            <NavItem icon={Stethoscope} title="Atendimento">
              <DropdownLink to="/prontuarios" text="Prontuário Eletrônico" />
              <DropdownLink to="/triagem" text="Triagem" />
            </NavItem>
          )}

          {(user?.acesso_agendamento || user?.is_superuser) && (
            <NavItem icon={CalendarDays} title="Agendamento">
              <DropdownLink to="/recepcao" text="Recepção" />
              <DropdownLink to="/agenda/marcar" text="Marcar Consulta" />
              <div className="border-t border-slate-100 dark:border-slate-700 my-1"></div>
              <DropdownLink to="/agenda/bloqueios" text="Bloqueios e Feriados" />
              <DropdownLink to="/agenda/configurar" text="Configurar Horários" />
            </NavItem>
          )}

          {(user?.acesso_faturamento || user?.is_superuser) && (
             <NavItem icon={DollarSign} title="Financeiro">
              <DropdownLink to="/faturamento" text="Emitir Nota Fiscal" />
              <DropdownLink to="/relatorios" text="Relatórios Financeiros" />
            </NavItem>
          )}

          {user?.is_superuser && (
            <NavItem icon={Settings} title="Sistema">
              <DropdownLink to="/pacientes" text="Pacientes" />
              <DropdownLink to="/operadores" text="Operadores" />
              <DropdownLink to="/profissionais" text="Profissionais" />
              <DropdownLink to="/especialidades" text="Especialidades" />
              
              {/* NOVOS LINKS ADICIONADOS AQUI */}
              <div className="border-t border-slate-100 dark:border-slate-700 my-1"></div>
              <DropdownLink to="/convenios" text="Convênios" icon={ShieldCheck} />
              <DropdownLink to="/clinica" text="Dados da Clínica" icon={Building2} />
              
              <div className="border-t border-slate-100 dark:border-slate-700 my-1"></div>
              <DropdownLink to="/configuracoes" text="Configurações Gerais" />
            </NavItem>
          )}
        </div>

        {/* ÁREA DIREITA */}
        <div className="flex items-center space-x-3">
          <button onClick={toggleTheme} className={topButtonClass}>
            {theme === 'light' ? <Moon size={20} /> : <Sun size={20} />}
          </button>

          <div className="h-8 w-px bg-slate-200 dark:bg-slate-700 mx-2 hidden lg:block"></div>

          <div className="text-right hidden lg:block">
            <p className="text-sm font-bold text-slate-700 dark:text-slate-200">{user?.first_name || user?.username}</p>
            <p className="text-xs text-slate-400 font-medium bg-slate-100 dark:bg-slate-800 inline-block px-2 py-0.5 rounded-full border border-slate-200 dark:border-slate-700">
              {user?.is_superuser ? 'Administrador' : 'Operador'}
            </p>
          </div>
          
          <button onClick={handleLogout} className={`${topButtonClass} hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20`}>
            <LogOut size={20} />
          </button>
        </div>
      </div>
    </nav>
  );
}

============================================================
ARQUIVO: clinica-front/src/utils/generateReceipt.js
============================================================
import jsPDF from 'jspdf';

// Função auxiliar para carregar imagem via URL
const getDataUri = (url) => {
    return new Promise((resolve) => {
        if (!url) { resolve(null); return; }
        
        const image = new Image();
        image.setAttribute('crossOrigin', 'anonymous'); // Tenta evitar CORS
        
        image.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = image.width;
            canvas.height = image.height;
            canvas.getContext('2d').drawImage(image, 0, 0);
            resolve(canvas.toDataURL('image/png'));
        };
        
        image.onerror = () => {
            // Se der erro ao carregar (ex: 404), retorna null e segue sem logo
            resolve(null);
        };

        image.src = url;
    });
}

// Transformei em ASYNC para esperar a imagem
export const generateAppointmentReceipt = async (agendamento) => {
    const doc = new jsPDF();
    const pdfData = agendamento.detalhes_pdf || {};
    
    // --- CARREGAR LOGO ---
    let logoData = null;
    if (pdfData.clinica_logo) {
        logoData = await getDataUri(pdfData.clinica_logo);
    }

    // --- CONFIGURAÇÕES DE FONTE ---
    const setBold = () => doc.setFont("helvetica", "bold");
    const setNormal = () => doc.setFont("helvetica", "normal");
    const setSmall = () => doc.setFontSize(9);
    const setRegular = () => doc.setFontSize(10);
    const setLarge = () => doc.setFontSize(12);

    let y = 20;

    // ================= CABEÇALHO COM LOGO =================
    
    // Se tiver logo, desenha na esquerda (x=10, y=10) e empurra o texto pra direita
    const textX = logoData ? 50 : 20; 

    if (logoData) {
        // addImage(data, format, x, y, width, height)
        doc.addImage(logoData, 'PNG', 10, 10, 30, 30);
        // Ajusta Y para ficar alinhado ao lado do logo
        y = 20; 
    }

    setBold(); setLarge();
    doc.text(pdfData.clinica_nome || "TheClinic System", textX, y);
    
    y += 6;
    setNormal(); setSmall();
    doc.text("Comprovante de Agendamento de Consultas", textX, y);
    
    // Se tiver logo, garantimos que a linha comece abaixo dele
    y = logoData ? 45 : y + 10;

    doc.setLineWidth(0.5);
    doc.line(10, y, 200, y);
    y += 6;

    // ================= DADOS DO PACIENTE =================
    setBold(); setLarge();
    doc.text("DADOS DO PACIENTE", 10, y);
    y += 8;

    setBold(); setRegular();
    doc.text("Paciente:", 10, y);
    setNormal();
    doc.text(`${agendamento.nome_paciente} - CPF: ${pdfData.paciente_cpf || '-'}`, 35, y);
    y += 6;

    setBold();
    doc.text("Nascimento:", 10, y);
    setNormal();
    const nasc = pdfData.paciente_nascimento ? new Date(pdfData.paciente_nascimento).toLocaleDateString('pt-BR') : '-';
    doc.text(nasc, 35, y);

    setBold();
    doc.text("Sexo:", 80, y);
    setNormal();
    doc.text(pdfData.paciente_sexo || '-', 95, y);

    setBold();
    doc.text("Telefone:", 140, y);
    setNormal();
    doc.text(agendamento.telefone_paciente || '-', 160, y);
    y += 6;

    setBold();
    doc.text("Nome da Mãe:", 10, y);
    setNormal();
    doc.text(pdfData.paciente_mae || 'Não informado', 38, y);
    y += 6;

    setBold();
    doc.text("Endereço:", 10, y);
    setNormal();
    doc.text(`${pdfData.paciente_endereco || ''} - ${pdfData.paciente_cidade || ''}`, 30, y);
    
    y += 4;
    doc.line(10, y, 200, y);
    y += 6;

    // ================= LOCAL DE ATENDIMENTO =================
    setBold(); setLarge();
    doc.text("LOCAL DE ATENDIMENTO", 10, y);
    y += 8;

    setBold(); setRegular();
    doc.text("Data/Hora:", 10, y);
    setNormal();
    const dataF = new Date(agendamento.data + 'T' + agendamento.horario).toLocaleString('pt-BR');
    doc.text(dataF, 35, y);
    y += 6;

    setBold();
    doc.text("Local:", 10, y);
    setNormal();
    doc.text(pdfData.clinica_nome || "Consultório Principal", 35, y);
    y += 6;

    setBold();
    doc.text("Endereço:", 10, y);
    setNormal();
    doc.text(`${pdfData.clinica_endereco || ''} - ${pdfData.clinica_bairro || ''}`, 35, y);
    y += 6;

    // ================= PROFISSIONAL =================
    setBold();
    doc.text("Profissional:", 10, y);
    setNormal();
    doc.text(agendamento.nome_profissional, 35, y);
    y += 6;

    setBold();
    doc.text("Especialidade:", 10, y);
    setNormal();
    doc.text(agendamento.nome_especialidade, 38, y);
    
    setBold();
    doc.text("Registro:", 140, y);
    setNormal();
    doc.text(pdfData.profissional_registro || '', 160, y);
    y += 6;

    setBold();
    doc.text("Convênio:", 10, y);
    setNormal();
    doc.text(agendamento.nome_convenio || "Particular", 35, y);

    y += 8;
    doc.line(10, y, 200, y);
    y += 6;

    // Rodapé
    setNormal(); setSmall();
    doc.text("Emitido em: " + new Date().toLocaleString('pt-BR'), 10, y);
    doc.text("TheClinic", 170, y);

    window.open(doc.output('bloburl'), '_blank');
};

============================================================
ARQUIVO: clinica-front/src/utils/generateReport.js
============================================================
import jsPDF from 'jspdf';

export const generateConflictReport = (pacientes, motivoBloqueio) => {
    const doc = new jsPDF();
    
    // Configurações visuais
    const primaryColor = [37, 99, 235]; // Azul
    const lineColor = [220, 220, 220]; // Cinza claro

    // Cabeçalho
    doc.setFontSize(18);
    doc.setTextColor(...primaryColor);
    doc.text("Relatório de Conflitos de Agenda", 14, 20);
    
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(`Motivo do Bloqueio: ${motivoBloqueio}`, 14, 28);
    doc.text(`Data de Emissão: ${new Date().toLocaleString()}`, 14, 34);

    doc.setDrawColor(...primaryColor);
    doc.line(14, 38, 196, 38);

    let y = 45;

    // Cabeçalho da Tabela
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(0);
    
    doc.text("DATA/HORA", 14, y);
    doc.text("MÉDICO", 45, y);
    doc.text("PACIENTE / CPF", 95, y);
    doc.text("CONTATO", 160, y);
    
    y += 4;
    doc.setDrawColor(...lineColor);
    doc.line(14, y, 196, y);
    y += 6;

    // Lista de Pacientes
    doc.setFont("helvetica", "normal");
    
    pacientes.forEach((p) => {
        // Verifica se precisa de nova página
        if (y > 270) {
            doc.addPage();
            y = 20;
        }

        const dataF = new Date(p.data).toLocaleDateString('pt-BR');
        const horaF = p.horario.substring(0, 5);
        const nascimento = new Date(p.paciente_nascimento).toLocaleDateString('pt-BR');

        doc.setFontSize(9);
        doc.text(`${dataF} ${horaF}`, 14, y);
        
        // Médico (trunca se for longo)
        const medico = p.medico.length > 25 ? p.medico.substring(0, 22) + '...' : p.medico;
        doc.text(medico, 45, y);

        // Paciente (Duas linhas: Nome e CPF/Nasc)
        doc.setFont("helvetica", "bold");
        doc.text(p.paciente_nome, 95, y);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        doc.text(`CPF: ${p.paciente_cpf} - Nasc: ${nascimento}`, 95, y + 4);

        // Telefone
        doc.setFontSize(9);
        doc.text(p.paciente_telefone || "Sem telefone", 160, y);

        y += 8;
        doc.setDrawColor(240); // Linha bem suave
        doc.line(14, y, 196, y);
        y += 6;
    });

    // Rodapé
    const total = pacientes.length;
    doc.setFontSize(10);
    doc.setFont("helvetica", "bold");
    doc.text(`Total de Pacientes Afetados: ${total}`, 14, y + 5);

    window.open(doc.output('bloburl'), '_blank');
};

============================================================
ARQUIVO: clinica-front/src/pages/Pacientes.jsx
============================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNotification } from '../context/NotificationContext';
import { 
  Search, UserPlus, MapPin, Pencil, Trash2, Save, ArrowLeft, ChevronLeft, ChevronRight, Loader2, User, Baby 
} from 'lucide-react';
import Layout from '../components/Layout';

export default function Pacientes() {
  const { api } = useAuth();
  const { notify, confirmDialog } = useNotification();
  
  const [viewMode, setViewMode] = useState('list');
  const [editandoId, setEditandoId] = useState(null);
  const [loading, setLoading] = useState(false);
  const [loadingCep, setLoadingCep] = useState(false);

  const [pacientes, setPacientes] = useState([]);
  const [search, setSearch] = useState('');
  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [totalCount, setTotalCount] = useState(0);

  // ADICIONADOS: nome_mae e sexo
  const formInicial = {
    nome: '', nome_mae: '', sexo: '', cpf: '', data_nascimento: '', telefone: '',
    cep: '', logradouro: '', numero: '', complemento: '', bairro: '', cidade: '', estado: ''
  };
  const [form, setForm] = useState(formInicial);

  const mascaraCPF = (v) => v.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})/, '$1-$2').slice(0, 14);
  const mascaraTelefone = (v) => v.replace(/\D/g, '').replace(/(\d{2})(\d)/, '($1) $2').replace(/(\d{5})(\d)/, '$1-$2').slice(0, 15);
  const mascaraCEP = (v) => v.replace(/\D/g, '').replace(/(\d{5})(\d)/, '$1-$2').slice(0, 9);

  const handleChange = (e) => {
    let { name, value } = e.target;
    if (name === 'cpf') value = mascaraCPF(value);
    if (name === 'telefone') value = mascaraTelefone(value);
    if (name === 'cep') value = mascaraCEP(value);
    setForm({ ...form, [name]: value });
  };

  const fetchPacientes = async () => {
    if (!api) return;
    setLoading(true);
    try {
      let pageSize = 15;
      try {
        const configRes = await api.get('operadores/config/');
        if (configRes.data?.itens_por_pagina) pageSize = configRes.data.itens_por_pagina;
      } catch {}

      const { data } = await api.get(`pacientes/?page=${page}&page_size=${pageSize}&search=${search}`);
      
      if (data.results) {
        setPacientes(data.results);
        setTotalCount(data.count);
        setTotalPages(Math.ceil(data.count / pageSize));
      } else if (Array.isArray(data)) {
        setPacientes(data);
        setTotalCount(data.length);
        setTotalPages(1);
      } else {
        setPacientes([]);
        setTotalCount(0);
      }
    } catch (error) {
      setPacientes([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { fetchPacientes(); }, [page, search, api]);

  const buscarCep = async () => {
    const cepLimpo = form.cep.replace(/\D/g, '');
    if (cepLimpo.length !== 8) return;
    setLoadingCep(true);
    try {
      const response = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
      const data = await response.json();
      if (!data.erro) {
        setForm(prev => ({ ...prev, logradouro: data.logradouro, bairro: data.bairro, cidade: data.localidade, estado: data.uf }));
        document.getElementById('numero')?.focus();
      }
    } catch {} finally { setLoadingCep(false); }
  };

  const handleNovo = () => { setForm(formInicial); setEditandoId(null); setViewMode('form'); };
  const handleEditar = (p) => { 
      // Garante que campos novos não sejam null
      setForm({
          ...p,
          nome_mae: p.nome_mae || '',
          sexo: p.sexo || '',
          complemento: p.complemento || ''
      }); 
      setEditandoId(p.id); 
      setViewMode('form'); 
  };
  
  const handleVoltar = () => { 
    setViewMode('list'); 
    setForm(formInicial); 
    fetchPacientes(); 
  };

  const handleExcluir = async (id) => {
    const confirmado = await confirmDialog("Tem certeza que deseja excluir este paciente?", "Excluir Paciente");
    if (confirmado) {
      try { 
        await api.delete(`pacientes/${id}/`); 
        notify.success("Paciente excluído.");
        fetchPacientes(); 
      } 
      catch (e) { notify.error("Erro ao excluir. Verifique vínculos."); }
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      if (editandoId) {
        await api.put(`pacientes/${editandoId}/`, form);
        notify.success("Paciente atualizado!");
      } else {
        await api.post('pacientes/', form);
        notify.success("Paciente cadastrado!");
      }
      handleVoltar();
    } catch (error) { 
        if (error.response?.data?.cpf) notify.warning("Este CPF já existe!");
        else notify.error("Erro ao salvar."); 
    }
  };

  const inputClass = "w-full bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-white border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none transition-colors";
  const labelClass = "block text-sm font-bold text-slate-600 dark:text-slate-300 mb-1";
  const paginationBtnClass = "p-2 border rounded-lg transition-colors disabled:opacity-50 bg-white border-slate-200 text-slate-600 hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-700";

  return (
    <Layout>
      <div className="max-w-6xl mx-auto pb-20">
        {viewMode === 'list' && (
          <div className="animate-in fade-in duration-300">
            <div className="flex justify-between items-center mb-8">
              <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Pacientes</h1>
              <button onClick={handleNovo} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-md transition-all active:scale-95">
                <UserPlus size={20}/> Incluir Paciente
              </button>
            </div>

            <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border mb-6 border-slate-200 dark:border-slate-700">
              <div className="relative">
                <Search className="absolute left-3 top-3.5 text-slate-400" size={18} />
                <input 
                    placeholder="Pesquisar por nome ou CPF..." 
                    value={search} 
                    onChange={e => { setSearch(e.target.value); setPage(1); }} 
                    className="w-full pl-10 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 outline-none text-slate-700 dark:text-white transition-colors focus:border-blue-500"
                />
              </div>
            </div>

            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
              <div className="overflow-x-auto">
                  <table className="w-full text-left text-sm">
                    <thead className="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700">
                      <tr>
                          <th className="px-6 py-4 font-bold uppercase">Nome</th>
                          <th className="px-6 py-4 font-bold uppercase">Sexo</th>
                          <th className="px-6 py-4 font-bold uppercase">CPF</th>
                          <th className="px-6 py-4 font-bold uppercase">Cidade/UF</th>
                          <th className="px-6 py-4 text-right font-bold uppercase">Ações</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                      {loading ? (
                          <tr><td colSpan="5" className="p-8 text-center text-slate-400"><Loader2 className="animate-spin mx-auto mb-2"/> Carregando...</td></tr>
                      ) : pacientes.length === 0 ? (
                          <tr><td colSpan="5" className="p-8 text-center text-slate-400">Nenhum paciente encontrado.</td></tr>
                      ) : (
                          pacientes.map(p => (
                            <tr key={p.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                              <td className="px-6 py-4 font-bold text-slate-700 dark:text-white">
                                  {p.nome}
                                  <div className="text-xs text-slate-400 font-normal">{p.nome_mae ? `Mãe: ${p.nome_mae}` : ''}</div>
                              </td>
                              <td className="px-6 py-4 text-slate-500 dark:text-slate-400">{p.sexo || '-'}</td>
                              <td className="px-6 py-4 text-slate-500 dark:text-slate-400">{p.cpf}</td>
                              <td className="px-6 py-4 text-slate-500 dark:text-slate-400">{p.cidade && p.estado ? `${p.cidade}/${p.estado}` : '-'}</td>
                              <td className="px-6 py-4 text-right flex justify-end gap-2">
                                <button onClick={() => handleEditar(p)} className="p-2 bg-transparent text-blue-600 hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-blue-900/30 rounded-lg"><Pencil size={18} /></button>
                                <button onClick={() => handleExcluir(p.id)} className="p-2 bg-transparent text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/30 rounded-lg"><Trash2 size={18} /></button>
                              </td>
                            </tr>
                          ))
                      )}
                    </tbody>
                  </table>
              </div>
              
              {totalPages > 1 && (
                  <div className="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center text-slate-500 text-xs font-bold uppercase">
                    <span>Página {page} de {totalPages}</span>
                    <div className="flex gap-2">
                      <button disabled={page===1} onClick={()=>setPage(p=>p-1)} className={paginationBtnClass}><ChevronLeft size={16}/></button>
                      <button disabled={page===totalPages} onClick={()=>setPage(p=>p+1)} className={paginationBtnClass}><ChevronRight size={16}/></button>
                    </div>
                  </div>
              )}
            </div>
          </div>
        )}

        {viewMode === 'form' && (
          <div className="animate-in slide-in-from-right-4 duration-300">
            <button onClick={handleVoltar} className="mb-6 flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors shadow-sm text-sm font-bold w-fit">
                <ArrowLeft size={18}/> Voltar para Lista
            </button>
            <div className={`rounded-xl shadow-lg border p-8 ${editandoId ? 'bg-white dark:bg-slate-800 border-orange-200 dark:border-orange-900/30' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700'}`}>
              <h2 className="text-xl font-bold mb-6 text-slate-800 dark:text-white flex items-center gap-2">
                  {editandoId ? <><Pencil className="text-orange-500"/> Editar Paciente</> : <><UserPlus className="text-blue-500"/> Novo Paciente</>}
              </h2>
              <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-12 gap-6">
                
                {/* DADOS PESSOAIS */}
                <div className="md:col-span-12 border-b pb-2 mb-2 font-bold text-slate-700 dark:text-white flex items-center gap-2"><User size={18}/> Dados Pessoais</div>
                
                <div className="md:col-span-6"><label className={labelClass}>Nome Completo</label><input name="nome" value={form.nome} onChange={handleChange} className={inputClass} required /></div>
                <div className="md:col-span-3"><label className={labelClass}>CPF</label><input name="cpf" value={form.cpf} onChange={handleChange} className={inputClass} required placeholder="000.000.000-00"/></div>
                <div className="md:col-span-3">
                    <label className={labelClass}>Sexo</label>
                    <select name="sexo" value={form.sexo} onChange={handleChange} className={inputClass}>
                        <option value="">Selecione...</option>
                        <option value="Feminino">Feminino</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                
                <div className="md:col-span-3"><label className={labelClass}>Nascimento</label><input type="date" name="data_nascimento" value={form.data_nascimento} onChange={handleChange} className={inputClass} required /></div>
                <div className="md:col-span-3"><label className={labelClass}>Telefone</label><input name="telefone" value={form.telefone} onChange={handleChange} className={inputClass} placeholder="(00) 00000-0000"/></div>
                <div className="md:col-span-6"><label className={labelClass}>Nome da Mãe</label><input name="nome_mae" value={form.nome_mae} onChange={handleChange} className={inputClass} /></div>

                {/* ENDEREÇO */}
                <div className="md:col-span-12 border-b pb-2 mb-2 font-bold text-slate-700 dark:text-white flex items-center gap-2 mt-4">
                    <MapPin size={18}/> Endereço
                </div>
                
                <div className="md:col-span-3">
                    <label className={labelClass}>CEP {loadingCep && <Loader2 size={12} className="inline animate-spin text-blue-500"/>}</label>
                    <input name="cep" value={form.cep} onChange={handleChange} onBlur={buscarCep} className={inputClass} placeholder="00000-000"/>
                </div>
                <div className="md:col-span-7"><label className={labelClass}>Logradouro</label><input name="logradouro" value={form.logradouro} onChange={handleChange} className={inputClass} /></div>
                <div className="md:col-span-2"><label className={labelClass}>Número</label><input id="numero" name="numero" value={form.numero} onChange={handleChange} className={inputClass} /></div>
                <div className="md:col-span-4"><label className={labelClass}>Complemento</label><input name="complemento" value={form.complemento || ''} onChange={handleChange} className={inputClass} placeholder="Apto, Bloco..." /></div>
                <div className="md:col-span-4"><label className={labelClass}>Bairro</label><input name="bairro" value={form.bairro} onChange={handleChange} className={inputClass} /></div>
                <div className="md:col-span-3"><label className={labelClass}>Cidade</label><input name="cidade" value={form.cidade} onChange={handleChange} className={inputClass} /></div>
                <div className="md:col-span-1"><label className={labelClass}>UF</label><input name="estado" value={form.estado} onChange={handleChange} className={inputClass} maxLength={2} style={{textTransform:'uppercase'}}/></div>
                
                <div className="md:col-span-12 flex justify-end mt-6 gap-3 border-t pt-6 dark:border-slate-700">
                  <button type="button" onClick={handleVoltar} className="px-6 py-2.5 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold transition-colors hover:bg-slate-200">Cancelar</button>
                  <button className={`text-white font-bold px-8 py-2.5 rounded-lg shadow-lg flex items-center gap-2 transition-transform active:scale-95 ${editandoId ? 'bg-orange-600 hover:bg-orange-700' : 'bg-blue-600 hover:bg-blue-700'}`}>
                    <Save size={18} /> {editandoId ? 'Salvar Alterações' : 'Cadastrar Paciente'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front/src/pages/TrocarSenhaObrigatoria.jsx
============================================================
import { useState } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNavigate } from 'react-router-dom';
import { KeyRound } from 'lucide-react';

export default function TrocarSenhaObrigatoria() {
  const { api, logout } = useAuth();
  const [senha, setSenha] = useState('');
  const [confirmar, setConfirmar] = useState('');
  const [loading, setLoading] = useState(false);
  const navigate = useNavigate();

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (senha !== confirmar) return alert('Senhas não conferem.');
    if (senha.length < 6) return alert('Mínimo 6 caracteres.');
    setLoading(true);
    try {
      await api.post('operadores/trocar-senha/', { nova_senha: senha });
      alert('Sucesso! Entre novamente.');
      logout();
      navigate('/');
    } catch (e) { alert('Erro ao alterar.'); } 
    finally { setLoading(false); }
  };

  return (
    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
      <div className="bg-white max-w-md w-full rounded-2xl shadow-xl overflow-hidden border border-slate-200 p-8">
        <div className="text-center mb-6">
            <KeyRound size={40} className="text-orange-600 mx-auto mb-2" />
            <h1 className="text-xl font-bold text-slate-800">Troca de Senha Obrigatória</h1>
        </div>
        <form onSubmit={handleSubmit} className="space-y-4">
            <input type="password" value={senha} onChange={e => setSenha(e.target.value)} className="w-full border p-3 rounded" placeholder="Nova Senha" required/>
            <input type="password" value={confirmar} onChange={e => setConfirmar(e.target.value)} className="w-full border p-3 rounded" placeholder="Confirmar Senha" required/>
            <button disabled={loading} className="w-full bg-slate-800 text-white font-bold py-3 rounded">{loading ? '...' : 'Atualizar Senha'}</button>
            <button type="button" onClick={()=>{logout(); navigate('/')}} className="w-full text-sm text-slate-400">Cancelar e Sair</button>
        </form>
      </div>
    </div>
  );
}

============================================================
ARQUIVO: clinica-front/src/pages/ConfigurarAgenda.jsx
============================================================
import React, { useState, useEffect, useRef } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNotification } from '../context/NotificationContext';
import Layout from '../components/Layout';
import { useNavigate } from 'react-router-dom';
import { 
  CalendarRange, Search, Plus, Filter, Edit, Trash2, 
  X, Save, Clock, CalendarDays, PlusCircle, Calculator, DollarSign, Pin, Hourglass, Repeat, ShieldCheck, Users, ListFilter, ChevronDown, Check, RotateCcw 
} from 'lucide-react';

// --- HELPERS DE TEMPO (Para o Cálculo Real-Time) ---
const timeToMinutes = (time) => {
    if (!time) return 0;
    // Divide HH:MM:SS ou HH:MM e pega apenas os 2 primeiros
    const parts = String(time).split(':');
    const h = parseInt(parts[0], 10);
    const m = parseInt(parts[1], 10);
    return (h * 60) + m;
};

const minutesToTime = (mins) => {
    const h = Math.floor(mins / 60).toString().padStart(2, '0');
    const m = (mins % 60).toString().padStart(2, '0');
    return `${h}:${m}`;
};

// --- COMPONENTES AUXILIARES ---
const FilterSearchableSelect = ({ options, value, onChange, placeholder, onEnter }) => {
    const [isOpen, setIsOpen] = useState(false);
    const [text, setText] = useState('');
    const containerRef = useRef(null);

    useEffect(() => {
        if (!value) setText('');
        else {
            const found = options.find(o => String(o.id) === String(value));
            if (found) setText(found.label);
        }
    }, [value, options]);

    const filtered = options.filter(o => o.label.toLowerCase().includes(text.toLowerCase()));

    useEffect(() => {
        const handleClickOutside = (e) => {
            if (containerRef.current && !containerRef.current.contains(e.target)) {
                setIsOpen(false);
                if (value) {
                    const found = options.find(o => String(o.id) === String(value));
                    if (found) setText(found.label);
                }
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, [value, options]);

    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (filtered.length === 1) {
                onChange(filtered[0].id);
                setText(filtered[0].label);
                setIsOpen(false);
                if(onEnter) setTimeout(() => onEnter(), 50); 
            } else if (value && onEnter) {
                onEnter();
            }
        }
    };

    return (
        <div className="relative w-full h-full" ref={containerRef}>
            <input 
                type="text" 
                className="w-full h-full pl-3 pr-8 bg-white dark:bg-slate-900 border-y border-r border-slate-200 dark:border-slate-700 outline-none dark:text-white focus:ring-2 focus:ring-blue-100 transition-all text-sm"
                placeholder={placeholder}
                value={text}
                onChange={e => { setText(e.target.value); setIsOpen(true); onChange(''); }}
                onFocus={() => setIsOpen(true)}
                onKeyDown={handleKeyDown}
            />
            {isOpen && (
                <ul className="absolute top-full left-0 w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-b-xl shadow-xl max-h-60 overflow-auto z-50">
                    {filtered.length > 0 ? filtered.map(opt => (
                        <li key={opt.id} onMouseDown={() => { onChange(opt.id); setText(opt.label); setIsOpen(false); }} className="px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer text-sm dark:text-white flex justify-between">
                            {opt.label}
                        </li>
                    )) : <li className="px-4 py-2 text-slate-400 text-xs">Sem resultados</li>}
                </ul>
            )}
        </div>
    );
};

const CustomDropdown = ({ options, value, onChange, icon: Icon, widthClass = "w-full" }) => {
    const [isOpen, setIsOpen] = useState(false);
    const containerRef = useRef(null);
    const selectedLabel = options.find(o => o.value === value)?.label || "Selecione";

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (containerRef.current && !containerRef.current.contains(event.target)) setIsOpen(false);
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    return (
        <div className={`relative ${widthClass} h-full`} ref={containerRef}>
            <button type="button" onClick={() => setIsOpen(!isOpen)} className={`flex items-center justify-between w-full h-full px-4 bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 text-sm font-bold transition-all outline-none ${isOpen ? 'rounded-tl-xl' : 'rounded-l-xl'}`}>
                <div className="flex items-center gap-2 truncate">{Icon && <Icon size={18} className="text-slate-500"/>}<span>{selectedLabel}</span></div>
                <ChevronDown size={16} className={`text-slate-400 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}/>
            </button>
            {isOpen && (
                <div className="absolute top-full left-0 w-full min-w-[200px] mt-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-xl z-50 overflow-hidden animate-in fade-in zoom-in duration-100">
                    <ul className="max-h-60 overflow-auto py-1">
                        {options.map((opt) => (
                            <li key={opt.value} onClick={() => { onChange(opt.value); setIsOpen(false); }} className={`px-4 py-2.5 text-sm cursor-pointer flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors ${value === opt.value ? 'text-blue-600 dark:text-blue-400 font-bold bg-blue-50 dark:bg-blue-900/20' : 'text-slate-600 dark:text-slate-300'}`}>
                                {opt.label} {value === opt.value && <Check size={14}/>}
                            </li>
                        ))}
                    </ul>
                </div>
            )}
        </div>
    );
};

export default function ConfigurarAgenda() {
  const { api } = useAuth();
  const { notify, confirmDialog } = useNotification();
  const navigate = useNavigate();

  const [configs, setConfigs] = useState([]);
  const [loading, setLoading] = useState(true);
  
  const [profissionaisFilter, setProfissionaisFilter] = useState([]);
  const [especialidadesFilter, setEspecialidadesFilter] = useState([]);
  const [conveniosFilter, setConveniosFilter] = useState([]);

  // Estados de Filtro
  const [filterType, setFilterType] = useState('texto'); 
  const [filterValue, setFilterValue] = useState(''); 
  const [activeFilters, setActiveFilters] = useState([]); 
  const [statusFilter, setStatusFilter] = useState('ativos'); 
  
  // Modal & Edição
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingItem, setEditingItem] = useState(null); 
  const [editingDays, setEditingDays] = useState([]);
  const [editModoCalculo, setEditModoCalculo] = useState('final');
  const [editHorariosFixos, setEditHorariosFixos] = useState([]); 
  const [saving, setSaving] = useState(false);
  
  const [allConvenios, setAllConvenios] = useState([]);

  const diasMap = [
    { id: 1, label: 'Seg', full: 'Segunda-feira' }, { id: 2, label: 'Ter', full: 'Terça-feira' }, { id: 3, label: 'Qua', full: 'Quarta-feira' },
    { id: 4, label: 'Qui', full: 'Quinta-feira' }, { id: 5, label: 'Sex', full: 'Sexta-feira' }, { id: 6, label: 'Sáb', full: 'Sábado' }, { id: 0, label: 'Dom', full: 'Domingo' }
  ];

  const filterTypeOptions = [
      { value: 'texto', label: 'Busca Geral' },
      { value: 'data_inicial', label: 'Data Inicial' },
      { value: 'data_final', label: 'Data Final' },
      { value: 'data_especifica', label: 'Data Específica' },
      { value: 'profissional_id', label: 'Profissional' },
      { value: 'especialidade_id', label: 'Especialidade' },
      { value: 'convenio_id', label: 'Convênio' },
      { value: 'dia_filtro', label: 'Dia da Semana' },
  ];

  const formatData = (dataString) => { if (!dataString) return '-'; const [ano, mes, dia] = dataString.split('-'); return `${dia}/${mes}/${ano}`; };
  const formatDateBr = (dateString) => { if(!dateString) return ''; const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; };

  const getStatusBadge = (item) => {
      const hoje = new Date().toISOString().split('T')[0];
      if (!item.situacao) return <span className="px-2.5 py-1 rounded-full text-xs font-bold bg-slate-200 text-slate-600 border border-slate-300">Encerrada</span>;
      if (item.data_fim < hoje) return <span className="px-2.5 py-1 rounded-full text-xs font-bold bg-red-100 text-red-600 border border-red-200">Vencida</span>;
      return <span className="px-2.5 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200">Ativa</span>;
  };

  // --- CARREGAMENTO INICIAL ---
  useEffect(() => {
    if (api) {
        // Carrega opções e dados INICIAIS
        api.get(`agendas/config/filters_data/?status=${statusFilter}`).then(res => {
            setProfissionaisFilter(res.data.profissionais);
            setEspecialidadesFilter(res.data.especialidades);
        });
        
        api.get('configuracoes/convenios/').then(res => {
            const data = res.data.results || res.data;
            const options = data.map(c => ({ id: c.id, label: c.nome }));
            setConveniosFilter([{ id: 'sem_convenio', label: 'Particular (Sem Convênio)' }, ...options]);
            setAllConvenios(data.map(c => ({ id: c.id, nome: c.nome })));
        });
        
        // Carga inicial explícita
        loadData();
    }
  }, [api, statusFilter]);

  // Recarrega sempre que mudar os filtros ativos
  useEffect(() => { if(api) loadData(); }, [activeFilters]);

  const loadData = async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams();
      params.append('status', statusFilter);
      activeFilters.forEach(f => {
          const key = f.type === 'texto' ? 'search' : f.type;
          if (f.value) params.append(key, f.value);
      });
      const response = await api.get(`agendas/config/?${params.toString()}`);
      setConfigs(response.data.results || response.data);
    } catch (error) { console.error(error); } finally { setLoading(false); }
  };

  const addFilter = () => {
      if (!filterValue) return;
      let label = filterValue;
      if (['data_inicial', 'data_final', 'data_especifica'].includes(filterType)) label = formatDateBr(filterValue);
      else if (filterType === 'profissional_id') label = profissionaisFilter.find(p => String(p.id) === String(filterValue))?.label || 'Desconhecido';
      else if (filterType === 'especialidade_id') label = especialidadesFilter.find(e => String(e.id) === String(filterValue))?.label || 'Desconhecida';
      else if (filterType === 'convenio_id') label = conveniosFilter.find(c => String(c.id) === String(filterValue))?.label || 'Desconhecido';
      else if (filterType === 'dia_filtro') label = diasMap.find(d => String(d.id) === String(filterValue))?.full;
      
      const typeLabel = filterTypeOptions.find(o => o.value === filterType)?.label;
      const newFilter = { id: Date.now(), type: filterType, value: filterValue, display: `${typeLabel}: ${label}` };
      const cleanFilters = activeFilters.filter(f => f.type !== filterType);
      setActiveFilters([...cleanFilters, newFilter]);
      setFilterValue('');
  };

  const removeFilter = (id) => setActiveFilters(activeFilters.filter(f => f.id !== id));
  const clearAllFilters = () => { setActiveFilters([]); setFilterValue(''); };
  const handleKeyDown = (e) => { if (e.key === 'Enter') addFilter(); };

  const renderDynamicInput = () => {
      const commonClass = "w-full pl-3 pr-12 bg-white dark:bg-slate-900 border-y border-r border-slate-200 dark:border-slate-700 p-3 outline-none dark:text-white focus:ring-2 focus:ring-blue-100 transition-all h-full";
      switch (filterType) {
          case 'data_inicial': case 'data_final': case 'data_especifica':
              return <input type="date" value={filterValue} onChange={e => setFilterValue(e.target.value)} className={commonClass} onKeyDown={handleKeyDown}/>;
          case 'dia_filtro':
              return <select value={filterValue} onChange={e => setFilterValue(e.target.value)} className={`${commonClass} cursor-pointer`}><option value="">Selecione...</option>{diasMap.map(dia => <option key={dia.id} value={dia.id}>{dia.full}</option>)}</select>;
          case 'profissional_id': return <FilterSearchableSelect placeholder="Digite o Profissional..." options={profissionaisFilter} value={filterValue} onChange={setFilterValue} onEnter={addFilter} />;
          case 'especialidade_id': return <FilterSearchableSelect placeholder="Digite a Especialidade..." options={especialidadesFilter} value={filterValue} onChange={setFilterValue} onEnter={addFilter} />;
          case 'convenio_id': return <FilterSearchableSelect placeholder="Digite o Convênio..." options={conveniosFilter} value={filterValue} onChange={setFilterValue} onEnter={addFilter} />;
          default: return <input placeholder="Digite para buscar..." value={filterValue} onChange={e => setFilterValue(e.target.value)} className={commonClass} onKeyDown={handleKeyDown}/>;
      }
  };

  // --- FUNÇÕES DO MODAL ---
  
  // 1. RECALCULO AUTOMÁTICO EM TEMPO REAL (CORRIGIDO)
  useEffect(() => {
    if (!isModalOpen || !editingItem) return;
    if (editingItem.tipo !== 'padrao' && editingItem.tipo !== 'tempo') return;

    const { hora_inicio, hora_fim, intervalo_minutos, quantidade_atendimentos } = editingItem;
    
    // Converte para números para cálculo seguro
    const intervalo = parseInt(intervalo_minutos, 10);
    const qtdAtual = parseInt(quantidade_atendimentos, 10);
    const inicioMin = timeToMinutes(hora_inicio);

    if (!hora_inicio || !intervalo || intervalo <= 0) return;

    if (editModoCalculo === 'final') {
        // MODO FINAL: Calcula QTD baseado em Inicio/Fim
        if (!hora_fim) return;
        const fimMin = timeToMinutes(hora_fim);
        
        if (fimMin <= inicioMin) { 
             if(qtdAtual !== 0) setEditingItem(prev => ({ ...prev, quantidade_atendimentos: 0 })); 
             return; 
        }

        const diff = fimMin - inicioMin;
        const novaQtd = Math.floor(diff / intervalo);
        
        if (novaQtd !== qtdAtual) { 
            setEditingItem(prev => ({ ...prev, quantidade_atendimentos: novaQtd })); 
        }
    } else {
        // MODO QTD: Calcula Fim baseado em Inicio/Qtd
        if (!qtdAtual && qtdAtual !== 0) return;
        
        const duracaoTotal = qtdAtual * intervalo;
        const fimMin = inicioMin + duracaoTotal;
        
        let novoFim = '';
        if (fimMin >= 1440) novoFim = '23:59'; 
        else novoFim = minutesToTime(fimMin);

        // Compara em minutos para evitar loop de string ("08:00" vs "08:00:00")
        if (timeToMinutes(novoFim) !== timeToMinutes(hora_fim)) { 
            setEditingItem(prev => ({ ...prev, hora_fim: novoFim })); 
        }
    }
  }, [
      // Dependências primitivas para evitar loops infinitos
      editingItem?.hora_inicio, 
      editingItem?.hora_fim, 
      editingItem?.intervalo_minutos, 
      editingItem?.quantidade_atendimentos, 
      editModoCalculo, 
      isModalOpen
  ]);

  const handleDelete = async (item) => {
    const msg = item.total_agendados > 0 ? `ATENÇÃO: Existem ${item.total_agendados} pacientes agendados! Se excluir, eles ficarão como 'Encaixe'.` : "Isso excluirá permanentemente esta agenda.";
    const confirmed = await confirmDialog(msg, "Excluir Agenda", "Sim, excluir", "Cancelar", "danger");
    if (confirmed) { try { await api.put(`agendas/config/update-group/${item.group_id}/`, { dias_semana: [] }); loadData(); notify.success("Agenda excluída."); } catch (error) { notify.error("Erro ao excluir."); } }
  };

  const handleEdit = (item) => {
    setEditingItem({ ...item, situacao: item.situacao !== undefined && item.situacao !== null ? item.situacao : true });
    const diasIniciais = (item.dias_vinculados && item.dias_vinculados.length > 0) ? item.dias_vinculados : (item.dia_semana !== undefined ? [item.dia_semana] : []);
    setEditingDays(diasIniciais);
    setEditModoCalculo('final'); 
    if (item.tipo === 'fixo') {
        const horarios = item.horarios_fixos_detalhes && item.horarios_fixos_detalhes.length > 0 ? item.horarios_fixos_detalhes : [{ time: item.hora_inicio, qtd: item.quantidade_atendimentos }];
        setEditHorariosFixos(horarios); 
    } else { setEditHorariosFixos([]); }
    setIsModalOpen(true);
  };

  const toggleEditDay = (id) => { if (editingDays.includes(id)) setEditingDays(editingDays.filter(d => d !== id)); else setEditingDays([...editingDays, id]); };
  const addHorarioFixo = () => setEditHorariosFixos([...editHorariosFixos, { time: '', qtd: 1 }]);
  const removeHorarioFixo = (idx) => setEditHorariosFixos(editHorariosFixos.filter((_, i) => i !== idx));
  const updateHorarioFixo = (idx, field, val) => { const novos = [...editHorariosFixos]; novos[idx][field] = val; setEditHorariosFixos(novos); };

  const handleSaveEdit = async (e) => {
    e.preventDefault();
    if (editingDays.length === 0) return notify.warning("Selecione pelo menos um dia.");
    setSaving(true);
    try {
        const payload = { tipo: editingItem.tipo, dias_semana: editingDays, data_inicio: editingItem.data_inicio, data_fim: editingItem.data_fim, valor: editingItem.valor, convenio: editingItem.convenio || null, situacao: editingItem.situacao };
        if (editingItem.tipo === 'fixo') { payload.lista_horarios = editHorariosFixos.filter(h => h.time); } 
        else { payload.hora_inicio = editingItem.hora_inicio; payload.hora_fim = editingItem.hora_fim; payload.intervalo_minutos = editingItem.intervalo_minutos; payload.quantidade_atendimentos = editingItem.quantidade_atendimentos; }
        await api.put(`agendas/config/update-group/${editingItem.group_id}/`, payload); setIsModalOpen(false); loadData(); notify.success("Agenda atualizada!");
    } catch (error) { notify.error("Erro ao atualizar."); } finally { setSaving(false); }
  };

  const thClass = "px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider";
  const tdClass = "px-6 py-4 whitespace-nowrap text-sm text-slate-700 dark:text-slate-300";
  const inputModalClass = "w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg p-2.5 dark:text-white outline-none focus:ring-2 focus:ring-blue-500";

  return (
    <Layout>
      <div className="max-w-6xl mx-auto pb-10">
        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><CalendarRange className="text-purple-600"/> Configuração de Horários</h1>
                <p className="text-slate-500 dark:text-slate-400 text-sm">Gerencie as regras de atendimento e vigência.</p>
            </div>
            <button onClick={() => navigate('/agenda/criar')} className="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg transition-transform active:scale-95"><Plus size={20}/> Nova Agenda</button>
        </div>

        <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6 flex flex-col lg:flex-row gap-4 items-start">
            <div className="flex-1 w-full">
                <div className="flex shadow-sm h-12 w-full">
                    <div className="w-[220px] z-20">
                        <CustomDropdown options={filterTypeOptions} value={filterType} onChange={(val) => { setFilterType(val); setFilterValue(''); }} icon={ListFilter}/>
                    </div>
                    <div className="relative flex-1 z-10">
                        {renderDynamicInput()}
                        <button onClick={addFilter} disabled={!filterValue} className="absolute right-1 top-1 bottom-1 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white px-4 rounded-lg font-bold text-sm transition-colors flex items-center gap-1">
                            <Plus size={16}/> <span className="hidden sm:inline">Adicionar</span>
                        </button>
                    </div>
                </div>
                {activeFilters.length > 0 && (
                    <div className="flex flex-wrap gap-2 mt-3 animate-in fade-in slide-in-from-top-2 duration-300">
                        {activeFilters.map(filter => (
                            <div key={filter.id} className="bg-blue-50 dark:bg-blue-900/30 border border-blue-100 dark:border-blue-800 text-blue-700 dark:text-blue-300 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm">
                                <span>{filter.display}</span>
                                <button onClick={() => removeFilter(filter.id)} className="hover:text-red-500 hover:bg-white dark:hover:bg-slate-800 rounded-full p-0.5 transition-colors"><X size={12}/></button>
                            </div>
                        ))}
                        <button onClick={clearAllFilters} className="text-xs text-red-500 hover:text-red-700 underline font-medium ml-2 flex items-center gap-1"><Trash2 size={12}/> Limpar tudo</button>
                    </div>
                )}
            </div>
            <div className="w-full lg:w-56 h-12 relative">
                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-purple-600 pointer-events-none z-10"><Filter size={18} /></div>
                <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)} className="w-full h-full pl-10 pr-8 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-sm font-medium text-slate-700 dark:text-slate-300 appearance-none cursor-pointer hover:border-purple-300 transition-colors">
                    <option value="ativos">Apenas Ativos</option><option value="encerrados">Apenas Encerrados</option><option value="todos">Mostrar Todos</option>
                </select>
                <div className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"><ChevronDown size={14} /></div>
            </div>
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
            <div className="overflow-x-auto">
                <table className="w-full">
                    <thead className="bg-slate-50 dark:bg-slate-700/50 border-b border-slate-200 dark:border-slate-700">
                        <tr><th className={thClass}>Situação</th><th className={thClass}>Profissional</th><th className={thClass}>Dias</th><th className={thClass}>Detalhes</th><th className={thClass}>Vigência</th><th className={thClass}>Agendados</th><th className="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Ações</th></tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                        {configs.map((item, idx) => (
                            <tr key={idx} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                                <td className={tdClass}>{getStatusBadge(item)}</td>
                                <td className={tdClass}><div className="font-bold text-slate-800 dark:text-white">{item.nome_profissional}</div><div className="text-xs text-slate-500">{item.nome_especialidade}</div><div className="flex items-center gap-1 text-xs text-blue-600 mt-1"><ShieldCheck size={12}/> {item.nome_convenio || 'Todos / Particular'}</div></td>
                                <td className={tdClass}><div className="flex gap-1 flex-wrap max-w-[150px]">{item.dias_vinculados && item.dias_vinculados.length > 0 ? (item.dias_vinculados.map(d => <span key={d} className="px-1.5 py-0.5 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 rounded text-[10px] font-bold uppercase border border-blue-100 dark:border-blue-800">{diasMap.find(dm => dm.id === d)?.label}</span>)) : (<span className="px-1.5 py-0.5 bg-gray-50 text-gray-500 rounded text-[10px] font-bold uppercase border">{diasMap.find(dm => dm.id === item.dia_semana)?.label || '-'}</span>)}</div></td>
                                <td className={tdClass}>{item.tipo === 'fixo' ? (<div><span className="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold mb-1 inline-block">FIXO</span><div className="text-xs text-slate-600 dark:text-slate-400 space-y-1">{item.horarios_fixos_detalhes?.map((h, i) => <div key={i}>{String(h.time).slice(0,5)} - {h.qtd} vagas</div>)}</div></div>) : item.tipo === 'periodo' ? (<div><span className="text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-bold mb-1 inline-block">QTD/HORA</span><div className="text-xs text-slate-500">{item.quantidade_atendimentos} vagas a cada {item.intervalo_minutos} min</div></div>) : (<div><span className="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full font-bold mb-1 inline-block">POR TEMPO</span><div className="text-xs text-slate-500">Intervalo de {item.intervalo_minutos} min</div></div>)}</td>
                                <td className={tdClass}><div className="text-xs flex flex-col gap-1"><span className="flex items-center gap-1"><CalendarDays size={12}/> {formatData(item.data_inicio)}</span><span className="text-slate-400">até {formatData(item.data_fim)}</span>{item.valor > 0 && <span className="text-green-600 font-bold">R$ {Number(item.valor).toFixed(2)}</span>}</div></td>
                                <td className={tdClass}><div className={`inline-flex items-center gap-1 px-2.5 py-1 rounded-full font-bold text-xs ${item.total_agendados > 0 ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-500'}`}><Users size={12}/> {item.total_agendados}</div></td>
                                <td className="px-6 py-4 text-right flex justify-end gap-2"><button onClick={() => handleEdit(item)} className="p-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors"><Edit size={18}/></button><button onClick={() => handleDelete(item)} className="p-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"><Trash2 size={18}/></button></td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>

        {isModalOpen && editingItem && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in zoom-in duration-200">
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden max-h-[90vh] flex flex-col">
                    <div className="flex justify-between items-center p-5 border-b border-slate-100 dark:border-slate-700 shrink-0">
                        <div><h3 className="text-lg font-bold text-slate-800 dark:text-white">Editar Regra</h3><p className="text-xs text-slate-500">{editingItem.nome_profissional}</p></div>
                        <button onClick={() => setIsModalOpen(false)}><X className="text-slate-400 hover:text-slate-600"/></button>
                    </div>
                    <form onSubmit={handleSaveEdit} className="p-6 space-y-5 overflow-y-auto">
                        <div className="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl flex items-center justify-between border border-slate-200 dark:border-slate-700">
                            <div><span className="block text-sm font-bold text-slate-700 dark:text-white">Situação da Agenda</span><span className="text-xs text-slate-500">{editingItem.situacao ? 'Esta agenda está ativa.' : 'Esta agenda está encerrada (invisível).'}</span></div>
                            <button type="button" onClick={() => setEditingItem({...editingItem, situacao: !editingItem.situacao})} className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${editingItem.situacao ? 'bg-green-500' : 'bg-slate-300'}`}><span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${editingItem.situacao ? 'translate-x-6' : 'translate-x-1'}`} /></button>
                        </div>
                        <div><label className="block text-sm font-bold text-slate-700 dark:text-slate-200 mb-2">Dias de Atendimento</label><div className="flex flex-wrap gap-2">{diasMap.map(dia => (<button key={dia.id} type="button" onClick={() => toggleEditDay(dia.id)} className={`w-9 h-9 rounded-full font-bold flex items-center justify-center transition-all text-xs ${editingDays.includes(dia.id) ? 'bg-purple-600 text-white shadow-lg' : 'bg-slate-100 dark:bg-slate-700 text-slate-500'}`}>{dia.label}</button>))}</div></div>
                        <div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-medium text-slate-500 mb-1">Início</label><input type="date" value={editingItem.data_inicio} onChange={e => setEditingItem({...editingItem, data_inicio: e.target.value})} className={inputModalClass}/></div><div><label className="block text-xs font-medium text-slate-500 mb-1">Fim</label><input type="date" value={editingItem.data_fim} onChange={e => setEditingItem({...editingItem, data_fim: e.target.value})} className={inputModalClass}/></div></div>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="block text-xs font-medium text-slate-500 mb-1">Convênio</label><select className={inputModalClass} value={editingItem.convenio || ''} onChange={e => setEditingItem({...editingItem, convenio: e.target.value || null})}><option value="">Todos / Particular</option>{allConvenios.map(c => <option key={c.id} value={c.id}>{c.nome}</option>)}</select></div>
                            <div><label className="block text-xs font-medium text-slate-500 mb-1">Valor (R$)</label><div className="relative"><DollarSign className="absolute left-2 top-2.5 text-slate-400" size={14}/><input type="number" step="0.01" value={editingItem.valor} onChange={e => setEditingItem({...editingItem, valor: e.target.value})} className={`${inputModalClass} pl-7`}/></div></div>
                        </div>
                        <hr className="border-slate-100 dark:border-slate-700"/>
                        {(editingItem.tipo === 'padrao' || editingItem.tipo === 'tempo') && (
                            <div className="animate-in fade-in zoom-in duration-300">
                                <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-lg mb-4 w-fit mx-auto"><button type="button" onClick={() => setEditModoCalculo('final')} className={`px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition-all ${editModoCalculo === 'final' ? 'bg-white dark:bg-slate-700 shadow text-purple-600 dark:text-white' : 'text-slate-500'}`}><Clock size={14}/> Calc. Final</button><button type="button" onClick={() => setEditModoCalculo('quantidade')} className={`px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition-all ${editModoCalculo === 'quantidade' ? 'bg-white dark:bg-slate-700 shadow text-purple-600 dark:text-white' : 'text-slate-500'}`}><Calculator size={14}/> Calc. Qtd.</button></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-xs font-medium text-slate-500 mb-1">Início</label><input type="time" value={editingItem.hora_inicio} onChange={e => setEditingItem({...editingItem, hora_inicio: e.target.value})} className={inputModalClass}/></div>
                                    <div><label className="block text-xs font-medium text-slate-500 mb-1">Tempo (min)</label><input type="number" value={editingItem.intervalo_minutos} onChange={e => setEditingItem({...editingItem, intervalo_minutos: e.target.value})} className={inputModalClass}/></div>
                                    {editModoCalculo === 'final' ? (
                                        <><div><label className="block text-xs font-medium text-slate-500 mb-1">Fim</label><input type="time" value={editingItem.hora_fim} onChange={e => setEditingItem({...editingItem, hora_fim: e.target.value})} className={inputModalClass}/></div><div className="flex flex-col justify-end"><div className="bg-purple-50 dark:bg-purple-900/20 border border-purple-100 dark:border-purple-800 rounded-lg p-2.5 flex items-center justify-between h-[42px]"><span className="text-[10px] font-bold text-purple-700 dark:text-purple-300 uppercase">Total</span><div><span className="text-lg font-bold text-purple-700 dark:text-white">{editingItem.quantidade_atendimentos}</span><span className="text-[10px] text-purple-600 dark:text-purple-300 ml-1">vagas</span></div></div></div></>
                                    ) : (<><div><label className="block text-xs font-medium text-slate-500 mb-1">Qtd.</label><input type="number" value={editingItem.quantidade_atendimentos} onChange={e => setEditingItem({...editingItem, quantidade_atendimentos: e.target.value})} className={inputModalClass}/></div><div className="flex flex-col justify-end"><div className="bg-purple-50 dark:bg-purple-900/20 border border-purple-100 dark:border-purple-800 rounded-lg p-2.5 flex items-center justify-between h-[42px]"><span className="text-[10px] font-bold text-purple-700 dark:text-purple-300 uppercase">Término</span><span className="text-lg font-bold text-purple-700 dark:text-white">{editingItem.hora_fim}</span></div></div></>)}
                                </div>
                            </div>
                        )}
                        {editingItem.tipo === 'periodo' && (<div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-medium text-slate-500 mb-1">Início</label><input type="time" value={editingItem.hora_inicio} onChange={e => setEditingItem({...editingItem, hora_inicio: e.target.value})} className={inputModalClass}/></div><div><label className="block text-xs font-medium text-slate-500 mb-1">Fim</label><input type="time" value={editingItem.hora_fim} onChange={e => setEditingItem({...editingItem, hora_fim: e.target.value})} className={inputModalClass}/></div><div><label className="block text-xs font-medium text-slate-500 mb-1">A cada (min)</label><input type="number" value={editingItem.intervalo_minutos} onChange={e => setEditingItem({...editingItem, intervalo_minutos: e.target.value})} className={inputModalClass}/></div><div><label className="block text-xs font-medium text-slate-500 mb-1">Vagas</label><input type="number" value={editingItem.quantidade_atendimentos} onChange={e => setEditingItem({...editingItem, quantidade_atendimentos: e.target.value})} className={inputModalClass}/></div></div>)}
                        {editingItem.tipo === 'fixo' && (<div><label className="block text-sm font-bold text-slate-700 dark:text-slate-200 mb-2">Lista de Horários Fixos</label><div className="space-y-2 max-h-[200px] overflow-y-auto pr-1 custom-scrollbar">{editHorariosFixos.map((h, idx) => (<div key={idx} className="flex gap-2"><input type="time" value={h.time} onChange={e => updateHorarioFixo(idx, 'time', e.target.value)} className={inputModalClass}/><input type="number" placeholder="Qtd" value={h.qtd} onChange={e => updateHorarioFixo(idx, 'qtd', e.target.value)} className={`${inputModalClass} w-24`}/><button type="button" onClick={() => removeHorarioFixo(idx)} className="text-red-500 p-2"><Trash2 size={18}/></button></div>))}</div><button type="button" onClick={addHorarioFixo} className="mt-2 text-blue-600 text-sm font-bold flex items-center gap-1"><PlusCircle size={16}/> Adicionar Horário</button></div>)}
                        <div className="pt-4 flex justify-end gap-2 shrink-0"><button type="button" onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium">Cancelar</button><button type="submit" disabled={saving} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg">{saving ? 'Salvando...' : <><Save size={18}/> Salvar Alterações</>}</button></div>
                    </form>
                </div>
            </div>
        )}
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front/src/pages/CriarAgenda.jsx
============================================================
import React, { useState, useEffect, useRef } from 'react';
import { useAuth } from '../context/AuthContext';
import Layout from '../components/Layout';
import { useNavigate } from 'react-router-dom';
import { 
  CalendarClock, CheckCircle2, Clock, Calculator, ArrowLeft, 
  ChevronDown, X, Users, Pin, Hourglass, Repeat, ListPlus, Pencil, Ban, 
  CalendarDays, DollarSign, ShieldCheck, Plus, Trash2 
} from 'lucide-react';

function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

const SearchableSelect = ({ label, options, value, onChange, placeholder, disabled }) => {
  const [isOpen, setIsOpen] = useState(false);
  const [query, setQuery] = useState('');
  const wrapperRef = useRef(null);

  useEffect(() => {
    const selected = options.find(o => String(o.id) === String(value));
    setQuery(selected ? selected.label : '');
  }, [value, options]);

  useEffect(() => {
    function handleClickOutside(event) {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
        setIsOpen(false);
        const selected = options.find(o => String(o.id) === String(value));
        setQuery(selected ? selected.label : '');
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [wrapperRef, value, options]);

  // --- CORREÇÃO AQUI: O nome da variável agora é 'filtered' ---
  const filtered = query === ''
    ? options
    : options.filter((opt) => opt.label.toLowerCase().includes(query.toLowerCase()));

  const handleSelect = (option) => {
    onChange(option.id);
    setQuery(option.label);
    setIsOpen(false);
  };

  const clearSelection = (e) => {
    e.stopPropagation();
    onChange('');
    setQuery('');
    setIsOpen(false);
  };

  return (
    <div className="relative" ref={wrapperRef}>
      <label className="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">{label}</label>
      <div className="relative">
        <input
          type="text"
          className={`w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-3 pr-10 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed cursor-text transition-all`}
          placeholder={placeholder}
          value={query}
          onChange={(e) => { setQuery(e.target.value); setIsOpen(true); }}
          onFocus={() => !disabled && setIsOpen(true)}
          disabled={disabled}
        />
        <div className="absolute right-3 top-3.5 flex items-center gap-2 text-slate-400">
          {value && !disabled && (
            <button type="button" onClick={clearSelection} className="hover:text-slate-600 dark:hover:text-slate-200"><X size={16} /></button>
          )}
          <ChevronDown size={16} className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </div>
      </div>

      {isOpen && !disabled && (
        <div className="absolute z-50 w-full mt-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-xl max-h-60 overflow-auto animate-in fade-in zoom-in duration-100">
          {filtered.length === 0 ? (
            <div className="p-3 text-sm text-slate-400 text-center">Nenhum resultado.</div>
          ) : (
            <ul>
              {filtered.map((opt) => (
                <li
                  key={opt.id}
                  onClick={() => handleSelect(opt)}
                  className={`p-3 text-sm cursor-pointer transition-colors flex justify-between items-center
                    ${String(value) === String(opt.id) 
                      ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 font-bold' 
                      : 'text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700'
                    }`}
                >
                  {opt.label}
                  {String(value) === String(opt.id) && <CheckCircle2 size={16}/>}
                </li>
              ))}
            </ul>
          )}
        </div>
      )}
    </div>
  );
};

export default function CriarAgenda() {
  const { api } = useAuth();
  const navigate = useNavigate();
  const [loading, setLoading] = useState(false);

  // --- DADOS GERAIS ---
  const [profissionaisOptions, setProfissionaisOptions] = useState([]);
  const [especialidadesOptions, setEspecialidadesOptions] = useState([]);
  const [conveniosOptions, setConveniosOptions] = useState([]);
  
  const [profissionalId, setProfissionalId] = useState('');
  const [especialidadeId, setEspecialidadeId] = useState('');
  const [convenioId, setConvenioId] = useState('');
  const [valorConsulta, setValorConsulta] = useState('');

  // --- LISTA DE REGRAS (CARRINHO) ---
  const [regrasAdicionadas, setRegrasAdicionadas] = useState([]);
  const [editingRuleId, setEditingRuleId] = useState(null);

  // --- ESTADOS DO FORMULÁRIO ---
  const [diasSelecionados, setDiasSelecionados] = useState([]);
  const [activeTab, setActiveTab] = useState('tempo'); 
  
  const hoje = new Date().toISOString().split('T')[0];
  const [dataInicioVigencia, setDataInicioVigencia] = useState(hoje);
  const [dataFimVigencia, setDataFimVigencia] = useState(hoje);

  // Aba 1: Tempo
  const [modoCalculo, setModoCalculo] = useState('final');
  const [horaInicio, setHoraInicio] = useState('08:00');
  const [horaFim, setHoraFim] = useState('12:00');
  const [intervalo, setIntervalo] = useState(30);
  const [quantidade, setQuantidade] = useState(0);

  // Aba 2: Periodo
  const [periodoInicio, setPeriodoInicio] = useState('07:00');
  const [periodoFim, setPeriodoFim] = useState('12:00');
  const [periodoIntervalo, setPeriodoIntervalo] = useState(60);
  const [periodoQtd, setPeriodoQtd] = useState(10);

  // Aba 3: Fixo
  const [horariosFixos, setHorariosFixos] = useState([{ time: '08:00', qtd: 10 }]);

  const diasSemana = [
    { id: 1, label: 'Seg' }, { id: 2, label: 'Ter' }, { id: 3, label: 'Qua' },
    { id: 4, label: 'Qui' }, { id: 5, label: 'Sex' }, { id: 6, label: 'Sáb' }, { id: 0, label: 'Dom' }
  ];

  // 1. Carregar Profissionais e Convênios
  useEffect(() => {
    if (api) {
        api.get('profissionais/').then(res => {
            const data = res.data.results || res.data;
            setProfissionaisOptions(data.map(p => ({ id: p.id, label: p.nome })));
        });
        api.get('configuracoes/convenios/').then(res => {
            const data = res.data.results || res.data;
            setConveniosOptions(data.map(c => ({ id: c.id, label: c.nome })));
        });
    }
  }, [api]);

  // 2. Carregar Especialidades
  useEffect(() => {
    setEspecialidadesOptions([]);
    setEspecialidadeId(''); 
    if (profissionalId && api) {
      api.get(`profissionais/${profissionalId}/`).then(res => {
        if (res.data.especialidades) {
            const specs = res.data.especialidades.map(vinculo => ({
                id: vinculo.especialidade_leitura || vinculo.especialidade_id || vinculo.especialidade, 
                label: vinculo.nome_especialidade
            }));
            setEspecialidadesOptions(specs);
            if(specs.length === 1) setEspecialidadeId(specs[0].id);
        }
      });
    }
  }, [profissionalId, api]);

  // 3. Cálculos Automáticos
  useEffect(() => {
    if (activeTab === 'tempo') calcularHorariosTempo();
  }, [horaInicio, horaFim, intervalo, quantidade, modoCalculo, activeTab]);

  const timeToMinutes = (time) => {
    if (!time) return 0;
    const [h, m] = time.split(':').map(Number);
    return h * 60 + m;
  };

  const minutesToTime = (mins) => {
    const h = Math.floor(mins / 60).toString().padStart(2, '0');
    const m = (mins % 60).toString().padStart(2, '0');
    return `${h}:${m}`;
  };

  const calcularHorariosTempo = () => {
    if (!horaInicio || !intervalo || intervalo <= 0) return;
    const inicioMin = timeToMinutes(horaInicio);

    if (modoCalculo === 'final') {
        if (!horaFim) return;
        const fimMin = timeToMinutes(horaFim);
        if (fimMin <= inicioMin) { setQuantidade(0); return; }
        const diff = fimMin - inicioMin;
        setQuantidade(Math.floor(diff / intervalo));
    } else {
        if (!quantidade) return;
        const duracaoTotal = quantidade * intervalo;
        const fimMin = inicioMin + duracaoTotal;
        if (fimMin >= 1440) setHoraFim('23:59'); 
        else setHoraFim(minutesToTime(fimMin));
    }
  };

  const toggleDia = (id) => {
    if (diasSelecionados.includes(id)) setDiasSelecionados(diasSelecionados.filter(d => d !== id));
    else setDiasSelecionados([...diasSelecionados, id]);
  };

  const addHorarioFixo = () => setHorariosFixos([...horariosFixos, { time: '', qtd: '' }]);
  const updateHorarioFixo = (index, field, val) => {
    const novos = [...horariosFixos];
    novos[index][field] = val;
    setHorariosFixos(novos);
  };
  const removeHorarioFixo = (index) => {
    setHorariosFixos(horariosFixos.filter((_, i) => i !== index));
  };

  const handleEditRule = (regra) => {
    setEditingRuleId(regra.id);
    setActiveTab(regra.tipo);
    setDiasSelecionados(regra.dias);
    setDataInicioVigencia(regra.data_inicio);
    setDataFimVigencia(regra.data_fim);
    setConvenioId(regra.convenio || '');
    setValorConsulta(regra.valor || '');

    setModoCalculo(regra.modoCalculo || 'final');

    if (regra.tipo === 'tempo') {
        setHoraInicio(regra.detalhes.inicio);
        setHoraFim(regra.detalhes.fim);
        setIntervalo(regra.detalhes.intervalo);
        setQuantidade(regra.detalhes.qtd);
    } else if (regra.tipo === 'periodo') {
        setPeriodoInicio(regra.detalhes.inicio);
        setPeriodoFim(regra.detalhes.fim);
        setPeriodoIntervalo(regra.detalhes.intervalo);
        setPeriodoQtd(regra.detalhes.qtd);
    } else if (regra.tipo === 'fixo') {
        setHorariosFixos(regra.detalhes.horarios);
    }
  };

  const handleCancelEdit = () => {
    setEditingRuleId(null);
    setDiasSelecionados([]);
    setHoraInicio('08:00');
    setHoraFim('12:00');
    setHorariosFixos([{ time: '08:00', qtd: 10 }]);
    setDataInicioVigencia(hoje);
    setDataFimVigencia(hoje);
    setValorConsulta('');
    setConvenioId('');
  };

  const handleAddRule = () => {
    if (!profissionalId) return alert('Selecione o Profissional antes de adicionar regras.');
    if (!especialidadeId) return alert('Selecione a Especialidade antes de adicionar regras.');
    if (diasSelecionados.length === 0) return alert('Selecione os dias da semana.');
    if (!dataInicioVigencia || !dataFimVigencia) return alert('Defina o período de vigência da agenda.');
    
    const newGroupId = editingRuleId 
        ? regrasAdicionadas.find(r => r.id === editingRuleId).group_id 
        : generateUUID(); 

    const ruleId = editingRuleId || Date.now(); 

    // Define nome amigável para o convênio
    const nomeConvenio = convenioId 
        ? conveniosOptions.find(c => String(c.id) === String(convenioId))?.label 
        : 'Todos / Particular';

    const novaRegra = {
        id: ruleId, 
        group_id: newGroupId, 
        dias: diasSelecionados,
        data_inicio: dataInicioVigencia,
        data_fim: dataFimVigencia,
        convenio: convenioId || null, // Garante que envie null se vazio
        convenio_nome: nomeConvenio,
        valor: valorConsulta,
        tipo: activeTab,
        modoCalculo: modoCalculo, 
        detalhes: {}
    };

    if (activeTab === 'tempo') {
        novaRegra.detalhes = { inicio: horaInicio, fim: horaFim, intervalo, qtd: 1 };
        novaRegra.resumo = `${horaInicio} às ${horaFim} (${intervalo} min)`;
    } else if (activeTab === 'periodo') {
        novaRegra.detalhes = { inicio: periodoInicio, fim: periodoFim, intervalo: periodoIntervalo, qtd: periodoQtd };
        novaRegra.resumo = `${periodoInicio} às ${periodoFim} (${periodoQtd} vagas a cada ${periodoIntervalo} min)`;
    } else if (activeTab === 'fixo') {
        const validos = horariosFixos.filter(h => h.time && h.qtd);
        if(validos.length === 0) return alert("Adicione pelo menos um horário válido.");
        novaRegra.detalhes = { horarios: validos };
        novaRegra.resumo = `${validos.length} horários específicos`;
    }

    if (editingRuleId) {
        setRegrasAdicionadas(regrasAdicionadas.map(r => r.id === editingRuleId ? novaRegra : r));
        setEditingRuleId(null);
    } else {
        setRegrasAdicionadas([...regrasAdicionadas, novaRegra]);
    }
    
    setDiasSelecionados([]); 
  };

  const handleRemoveRule = (id) => {
    if (id === editingRuleId) handleCancelEdit();
    setRegrasAdicionadas(regrasAdicionadas.filter(r => r.id !== id));
  };

  const handleSaveAll = async () => {
    if (!profissionalId) return alert('Erro: Profissional não selecionado.');
    if (!especialidadeId) return alert('Erro: Especialidade não selecionada.');
    if (regrasAdicionadas.length === 0) return alert('Adicione pelo menos uma regra.');

    setLoading(true);
    try {
        const promises = [];

        regrasAdicionadas.forEach(regra => {
            regra.dias.forEach(dia => {
                const basePayload = {
                    group_id: regra.group_id, 
                    profissional: profissionalId,
                    especialidade: especialidadeId,
                    dia_semana: dia,
                    data_inicio: regra.data_inicio,
                    data_fim: regra.data_fim,
                    valor: regra.valor || 0,
                    convenio: regra.convenio || null 
                };

                if (regra.tipo === 'tempo') {
                    promises.push(api.post('agendas/config/', {
                        ...basePayload,
                        hora_inicio: regra.detalhes.inicio,
                        hora_fim: regra.detalhes.fim,
                        intervalo_minutos: regra.detalhes.intervalo,
                        quantidade_atendimentos: 1, 
                        tipo: 'padrao'
                    }));
                } else if (regra.tipo === 'periodo') {
                    promises.push(api.post('agendas/config/', {
                        ...basePayload,
                        hora_inicio: regra.detalhes.inicio,
                        hora_fim: regra.detalhes.fim,
                        intervalo_minutos: regra.detalhes.intervalo,
                        quantidade_atendimentos: regra.detalhes.qtd,
                        tipo: 'periodo'
                    }));
                } else if (regra.tipo === 'fixo') {
                    regra.detalhes.horarios.forEach(h => {
                        promises.push(api.post('agendas/config/', {
                            ...basePayload,
                            hora_inicio: h.time,
                            hora_fim: h.time,
                            intervalo_minutos: 0,
                            quantidade_atendimentos: h.qtd,
                            tipo: 'fixo'
                        }));
                    });
                }
            });
        });

        await Promise.all(promises);
        alert('Todas as agendas foram criadas com sucesso!');
        navigate('/agenda/configurar');
    } catch (error) {
        console.error("Erro no salvamento:", error.response?.data || error.message);
        alert('Erro ao salvar. Verifique se os campos estão corretos.');
    } finally {
        setLoading(false);
    }
  };

  const inputClass = "w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-3 dark:text-white outline-none focus:ring-2 focus:ring-blue-500";
  const labelClass = "block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1";
  const tabBase = "flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-all border-b-2";
  const tabActive = "border-blue-600 text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20";
  const tabInactive = "border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800";

  return (
    <Layout>
      <div className="max-w-5xl mx-auto pb-20">
        <button onClick={() => navigate('/agenda/configurar')} className="mb-4 flex items-center gap-2 text-slate-500 hover:text-slate-800 dark:text-slate-400 bg-transparent px-3 py-2 rounded-lg transition-colors">
            <ArrowLeft size={18}/> Voltar para Lista
        </button>

        <div className="flex items-center gap-3 mb-6">
            <div className="bg-purple-600 p-3 rounded-xl text-white shadow"><CalendarClock size={28}/></div>
            <div>
                <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Criar Agenda</h1>
                <p className="text-slate-500 dark:text-slate-400 text-sm">Configure múltiplos horários para um profissional.</p>
            </div>
        </div>

        {/* 1. SELEÇÃO DE PROFISSIONAL */}
        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6">
            <h2 className="font-bold text-lg mb-4 text-slate-800 dark:text-white border-b border-slate-100 dark:border-slate-700 pb-2">1. Profissional e Especialidade</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <SearchableSelect label="Profissional" placeholder="Pesquisar..." options={profissionaisOptions} value={profissionalId} onChange={setProfissionalId} />
                <SearchableSelect label="Especialidade" placeholder="Selecione..." options={especialidadesOptions} value={especialidadeId} onChange={setEspecialidadeId} disabled={!profissionalId} />
            </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
            
            {/* 2. ÁREA DE CONFIGURAÇÃO */}
            <div className="lg:col-span-2 space-y-6">
                
                {/* 2A. DIAS E VIGÊNCIA */}
                <div className={`bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border transition-all ${editingRuleId ? 'border-purple-300 dark:border-purple-600 ring-2 ring-purple-100 dark:ring-purple-900/20' : 'border-slate-200 dark:border-slate-700'}`}>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                            {editingRuleId ? <><Pencil size={20} className="text-purple-600"/> Editando Regra</> : '2. Dias e Vigência'}
                        </h2>
                        {editingRuleId && (
                            <button onClick={handleCancelEdit} className="text-xs bg-red-100 text-red-600 px-3 py-1 rounded-full font-bold hover:bg-red-200 flex items-center gap-1">
                                <Ban size={12}/> Cancelar Edição
                            </button>
                        )}
                    </div>
                    
                    <div className="flex flex-wrap gap-3 mb-6">
                        {diasSemana.map(dia => {
                            const isSelected = diasSelecionados.includes(dia.id);
                            return (
                                <button key={dia.id} type="button" onClick={() => toggleDia(dia.id)}
                                    className={`w-12 h-12 rounded-full font-bold flex items-center justify-center transition-all ${isSelected ? 'bg-purple-600 text-white shadow-lg scale-110' : 'bg-slate-100 dark:bg-slate-700 text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-600'}`}
                                >{dia.label}</button>
                            )
                        })}
                    </div>

                    {/* VIGÊNCIA, CONVÊNIO E VALOR */}
                    <div className="border-t border-slate-100 dark:border-slate-700 pt-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className={labelClass}>Data Início</label>
                                <input type="date" value={dataInicioVigencia} onChange={e => setDataInicioVigencia(e.target.value)} className={inputClass} />
                            </div>
                            <div>
                                <label className={labelClass}>Data Fim</label>
                                <input type="date" value={dataFimVigencia} onChange={e => setDataFimVigencia(e.target.value)} className={inputClass} />
                            </div>
                            <div>
                                <SearchableSelect 
                                    label="Convênio (Opcional)" 
                                    placeholder="Todos / Particular" 
                                    options={conveniosOptions} 
                                    value={convenioId} 
                                    onChange={setConvenioId}
                                />
                            </div>
                            <div>
                                <label className={labelClass}>Valor da Consulta (R$)</label>
                                <div className="relative">
                                    <DollarSign className="absolute left-3 top-3.5 text-slate-400" size={16}/>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value={valorConsulta} 
                                        onChange={e => setValorConsulta(e.target.value)} 
                                        className={`${inputClass} pl-10`}
                                        placeholder="0.00"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* 2B. REGRAS DE HORÁRIO (MANTIDO) */}
                <div className={`bg-white dark:bg-slate-800 rounded-xl shadow-sm border overflow-hidden transition-all ${editingRuleId ? 'border-purple-300 dark:border-purple-600 ring-2 ring-purple-100 dark:ring-purple-900/20' : 'border-slate-200 dark:border-slate-700'}`}>
                    <div className="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800">
                        <div className="flex">
                            <button type="button" onClick={() => setActiveTab('tempo')} className={`${tabBase} ${activeTab === 'tempo' ? tabActive : tabInactive}`}><Hourglass size={18}/> Por Tempo</button>
                            <button type="button" onClick={() => setActiveTab('periodo')} className={`${tabBase} ${activeTab === 'periodo' ? tabActive : tabInactive}`}><Repeat size={18}/> Qtd/Horário</button>
                            <button type="button" onClick={() => setActiveTab('fixo')} className={`${tabBase} ${activeTab === 'fixo' ? tabActive : tabInactive}`}><Pin size={18}/> Horário Fixo</button>
                        </div>
                    </div>

                    <div className="p-6">
                        {/* ABA 1: TEMPO */}
                        {activeTab === 'tempo' && (
                            <div className="animate-in fade-in zoom-in duration-300">
                                <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-lg mb-6 w-fit">
                                    <button type="button" onClick={() => setModoCalculo('final')} className={`px-4 py-2 rounded-md text-sm font-bold flex items-center gap-2 transition-all ${modoCalculo === 'final' ? 'bg-white dark:bg-slate-700 shadow text-purple-600 dark:text-white' : 'text-slate-500'}`}><Clock size={16}/> Calcular Final</button>
                                    <button type="button" onClick={() => setModoCalculo('quantidade')} className={`px-4 py-2 rounded-md text-sm font-bold flex items-center gap-2 transition-all ${modoCalculo === 'quantidade' ? 'bg-white dark:bg-slate-700 shadow text-purple-600 dark:text-white' : 'text-slate-500'}`}><Calculator size={16}/> Calcular Qtd.</button>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className={labelClass}>Início</label><input type="time" value={horaInicio} onChange={e => setHoraInicio(e.target.value)} className={inputClass} /></div>
                                    <div><label className={labelClass}>Tempo (min)</label><input type="number" value={intervalo} onChange={e => setIntervalo(Number(e.target.value))} className={inputClass} /></div>
                                    
                                    {modoCalculo === 'final' ? (
                                        <>
                                            <div><label className={labelClass}>Fim</label><input type="time" value={horaFim} onChange={e => setHoraFim(e.target.value)} className={inputClass} /></div>
                                            <div className="flex flex-col justify-end">
                                                <div className="bg-purple-50 dark:bg-purple-900/20 border border-purple-100 dark:border-purple-800 rounded-lg p-3 flex items-center justify-between h-[50px]">
                                                    <span className="text-[10px] font-bold text-purple-700 dark:text-purple-300 uppercase">Total</span>
                                                    <div className="text-right leading-none">
                                                        <span className="text-xl font-bold text-purple-700 dark:text-white">{quantidade}</span>
                                                        <span className="text-[10px] text-purple-600 dark:text-purple-300 ml-1">vagas</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div><label className={labelClass}>Qtd.</label><input type="number" value={quantidade} onChange={e => setQuantidade(Number(e.target.value))} className={inputClass} /></div>
                                            <div className="flex flex-col justify-end">
                                                <div className="bg-purple-50 dark:bg-purple-900/20 border border-purple-100 dark:border-purple-800 rounded-lg p-3 flex items-center justify-between h-[50px]">
                                                    <span className="text-[10px] font-bold text-purple-700 dark:text-purple-300 uppercase">Término</span>
                                                    <div className="text-right leading-none">
                                                        <span className="text-xl font-bold text-purple-700 dark:text-white">{horaFim}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* ABA 2: PERIODO */}
                        {activeTab === 'periodo' && (
                            <div className="animate-in fade-in zoom-in duration-300 grid grid-cols-2 gap-4">
                                <div><label className={labelClass}>Início</label><input type="time" value={periodoInicio} onChange={e => setPeriodoInicio(e.target.value)} className={inputClass} /></div>
                                <div><label className={labelClass}>Fim</label><input type="time" value={periodoFim} onChange={e => setPeriodoFim(e.target.value)} className={inputClass} /></div>
                                <div><label className={labelClass}>A cada (min)</label><input type="number" value={periodoIntervalo} onChange={e => setPeriodoIntervalo(Number(e.target.value))} className={inputClass} /></div>
                                <div><label className={labelClass}>Vagas</label><input type="number" value={periodoQtd} onChange={e => setPeriodoQtd(Number(e.target.value))} className={inputClass} /></div>
                            </div>
                        )}

                        {/* ABA 3: FIXO */}
                        {activeTab === 'fixo' && (
                            <div className="animate-in fade-in zoom-in duration-300">
                                {horariosFixos.map((item, index) => (
                                    <div key={index} className="flex gap-2 mb-2">
                                        <input type="time" value={item.time} onChange={e => updateHorarioFixo(index, 'time', e.target.value)} className={inputClass}/>
                                        <input type="number" placeholder="Qtd" value={item.qtd} onChange={e => updateHorarioFixo(index, 'qtd', e.target.value)} className={inputClass}/>
                                        {horariosFixos.length > 1 && <button type="button" onClick={() => removeHorarioFixo(index)} className="text-red-500 p-2"><Trash2/></button>}
                                    </div>
                                ))}
                                <button type="button" onClick={addHorarioFixo} className="text-blue-600 font-bold text-sm flex items-center gap-1 mt-2"><Plus size={16}/> Mais Horário</button>
                            </div>
                        )}

                        <div className="mt-6 pt-6 border-t border-slate-100 dark:border-slate-700">
                            <button 
                                type="button" 
                                onClick={handleAddRule} 
                                className={`w-full font-bold py-3.5 rounded-xl flex items-center justify-center gap-2 transition-transform active:scale-95 shadow-md ${editingRuleId ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                            >
                                {editingRuleId ? <><CheckCircle2 size={20}/> Atualizar Regra</> : <><ListPlus size={20}/> Incluir nesta Agenda</>}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            {/* 3. RESUMO DA AGENDA */}
            <div className="lg:col-span-1">
                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 h-full flex flex-col">
                    <div className="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 rounded-t-xl">
                        <h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <CheckCircle2 className="text-green-500"/> Resumo da Criação
                        </h3>
                        <p className="text-xs text-slate-500 mt-1">Verifique as regras antes de salvar.</p>
                    </div>
                    
                    <div className="p-4 flex-1 overflow-y-auto max-h-[500px] space-y-3">
                        {regrasAdicionadas.length === 0 ? (
                            <div className="text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl">
                                <ListPlus size={32} className="mx-auto mb-2 opacity-50"/>
                                <p>Nenhuma regra adicionada.</p>
                                <p className="text-xs">Configure ao lado e clique em "Incluir".</p>
                            </div>
                        ) : (
                            regrasAdicionadas.map((regra, idx) => (
                                <div key={regra.id} className={`bg-slate-50 dark:bg-slate-700/30 border rounded-lg p-3 relative group animate-in slide-in-from-right-2 duration-300 ${editingRuleId === regra.id ? 'border-purple-400 ring-1 ring-purple-400 bg-purple-50 dark:bg-purple-900/10' : 'border-slate-200 dark:border-slate-600'}`}>
                                    <div className="absolute top-2 right-2 flex gap-1">
                                        <button onClick={() => handleEditRule(regra)} className="text-slate-400 hover:text-blue-500 transition-colors p-1" title="Editar"><Pencil size={14}/></button>
                                        <button onClick={() => handleRemoveRule(regra.id)} className="text-slate-400 hover:text-red-500 transition-colors p-1" title="Remover"><X size={16}/></button>
                                    </div>
                                    <div className="pr-12">
                                        <div className="flex flex-wrap gap-1 mb-2">
                                            {regra.dias.map(d => (
                                                <span key={d} className="text-[10px] uppercase font-bold bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-1.5 py-0.5 rounded">{diasSemana.find(dia => dia.id === d)?.label}</span>
                                            ))}
                                        </div>
                                        <p className="text-[10px] text-slate-400 mb-1 flex items-center gap-1">
                                            <CalendarDays size={10}/> {new Date(regra.data_inicio).toLocaleDateString()} até {new Date(regra.data_fim).toLocaleDateString()}
                                        </p>
                                        <p className="text-sm font-semibold text-slate-700 dark:text-slate-200">
                                            {regra.tipo === 'tempo' && <span className="text-purple-600 dark:text-purple-400 flex items-center gap-1"><Hourglass size={12}/> Por Tempo</span>}
                                            {regra.tipo === 'periodo' && <span className="text-orange-600 dark:text-orange-400 flex items-center gap-1"><Repeat size={12}/> Qtd/Horário</span>}
                                            {regra.tipo === 'fixo' && <span className="text-green-600 dark:text-green-400 flex items-center gap-1"><Pin size={12}/> Fixo</span>}
                                        </p>
                                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">{regra.resumo}</p>
                                        
                                        {/* MOSTRA CONVÊNIO E VALOR NO RESUMO */}
                                        <div className="mt-2 pt-2 border-t border-slate-200 dark:border-slate-600 text-xs flex justify-between items-center">
                                            <span className="flex items-center gap-1 text-slate-600 dark:text-slate-300"><ShieldCheck size={12}/> {regra.convenio_nome}</span>
                                            {regra.valor > 0 && <span className="font-bold text-green-600 dark:text-green-400">R$ {Number(regra.valor).toFixed(2)}</span>}
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    <div className="p-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 rounded-b-xl">
                        <button onClick={handleSaveAll} disabled={loading || regrasAdicionadas.length === 0} className="w-full bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3.5 rounded-xl shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2">
                            {loading ? 'Salvando...' : 'Salvar Todas as Agendas'}
                        </button>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front/src/pages/DadosClinica.jsx
============================================================
import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import Layout from '../components/Layout';
import { Building, Save, MapPin, Info, Loader2, Upload, Image as ImageIcon } from 'lucide-react';

export default function DadosClinica() {
  const { api } = useAuth();
  const [loading, setLoading] = useState(false);
  const [fetching, setFetching] = useState(true);
  const [loadingCep, setLoadingCep] = useState(false);
  
  // Estado para o arquivo e preview do logo
  const [logoFile, setLogoFile] = useState(null);
  const [logoPreview, setLogoPreview] = useState(null);

  const [form, setForm] = useState({
    nome_fantasia: '', 
    razao_social: '', // <--- CAMPO ADICIONADO NO ESTADO
    cnpj: '', 
    email: '', 
    telefone: '',
    logradouro: '', numero: '', complemento: '', 
    bairro: '', cidade: '', estado: '', cep: ''
  });

  // --- MÁSCARAS ---
  const mascaraCNPJ = (v) => v.replace(/\D/g, '').replace(/^(\d{2})(\d)/, '$1.$2').replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3').replace(/\.(\d{3})(\d)/, '.$1/$2').replace(/(\d{4})(\d)/, '$1-$2').slice(0, 18);
  const mascaraTelefone = (v) => v.replace(/\D/g, '').replace(/(\d{2})(\d)/, '($1) $2').replace(/(\d{5})(\d)/, '$1-$2').slice(0, 15);
  const mascaraCEP = (v) => v.replace(/\D/g, '').replace(/(\d{5})(\d)/, '$1-$2').slice(0, 9);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const res = await api.get('configuracoes/clinica/');
        const dados = res.data;
        setForm({
          ...dados,
          razao_social: dados.razao_social || '', // Garante que não seja null/undefined
          cnpj: dados.cnpj ? mascaraCNPJ(dados.cnpj) : '',
          telefone: dados.telefone ? mascaraTelefone(dados.telefone) : '',
          cep: dados.cep ? mascaraCEP(dados.cep) : ''
        });
        
        if (dados.logo) {
            setLogoPreview(dados.logo); 
        }
      } catch (e) {
        console.error("Erro ao carregar dados", e);
      } finally {
        setFetching(false);
      }
    };
    fetchData();
  }, [api]);

  const buscarCep = async () => {
    const cepLimpo = form.cep.replace(/\D/g, '');
    if (cepLimpo.length !== 8) return;
    setLoadingCep(true);
    try {
      const response = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
      const data = await response.json();
      if (!data.erro) {
        setForm(prev => ({
          ...prev,
          logradouro: data.logradouro, bairro: data.bairro, cidade: data.localidade, estado: data.uf
        }));
        document.getElementById('numero_clinica')?.focus();
      }
    } catch (error) { console.error(error); } finally { setLoadingCep(false); }
  };

  const handleChange = (e) => {
    let { name, value } = e.target;
    if (name === 'cnpj') value = mascaraCNPJ(value);
    if (name === 'telefone') value = mascaraTelefone(value);
    if (name === 'cep') value = mascaraCEP(value);
    setForm({ ...form, [name]: value });
  };

  const handleImageChange = (e) => {
      const file = e.target.files[0];
      if (file) {
          setLogoFile(file);
          setLogoPreview(URL.createObjectURL(file));
      }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      const formData = new FormData();
      
      Object.keys(form).forEach(key => {
          let val = form[key];
          if (key === 'cnpj' || key === 'telefone' || key === 'cep') {
              val = val ? val.replace(/\D/g, '') : '';
          }
          if(key !== 'logo' && val !== null && val !== undefined) {
              formData.append(key, val);
          }
      });

      if (logoFile) {
          formData.append('logo', logoFile);
      }

      await api.put('configuracoes/clinica/', formData, {
          headers: { 'Content-Type': 'multipart/form-data' }
      });
      
      alert("Dados atualizados com sucesso!");
    } catch (e) {
      console.error(e);
      alert("Erro ao salvar.");
    } finally {
      setLoading(false);
    }
  };

  const inputClass = "w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-blue-500 dark:text-white transition-all";
  const labelClass = "block text-sm font-bold text-slate-600 dark:text-slate-400 mb-1";

  if (fetching) return <Layout><div className="text-center p-10 text-slate-400">Carregando dados da clínica...</div></Layout>;

  return (
    <Layout>
      <div className="max-w-5xl mx-auto pb-10">
        <div className="flex items-center gap-3 mb-8">
            <div className="bg-blue-600 p-2 rounded-lg shadow-lg">
                <Building className="text-white" size={24}/>
            </div>
            <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Dados da Clínica</h1>
        </div>

        <form onSubmit={handleSubmit} className="space-y-6">
          
          {/* SEÇÃO DO LOGO */}
          <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
             <h2 className="text-lg font-bold mb-4 flex items-center gap-2 border-b pb-2 dark:border-slate-700">
                <ImageIcon size={18} className="text-purple-500"/> Logotipo
            </h2>
            <div className="flex items-center gap-6">
                <div className="w-32 h-32 bg-slate-100 dark:bg-slate-900 rounded-xl border-2 border-dashed border-slate-300 dark:border-slate-600 flex items-center justify-center overflow-hidden relative">
                    {logoPreview ? (
                        <img src={logoPreview} alt="Logo Preview" className="w-full h-full object-contain p-2" />
                    ) : (
                        <span className="text-xs text-slate-400 text-center px-2">Sem Logo</span>
                    )}
                </div>
                <div className="flex-1">
                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Selecione uma imagem (PNG, JPG)</label>
                    <label className="cursor-pointer inline-flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-white rounded-lg transition-colors font-bold text-sm">
                        <Upload size={16}/> Escolher Arquivo
                        <input type="file" accept="image/*" onChange={handleImageChange} className="hidden" />
                    </label>
                    <p className="text-xs text-slate-400 mt-2">Recomendado: Imagem quadrada ou retangular transparente.</p>
                </div>
            </div>
          </div>

          {/* INFORMAÇÕES GERAIS */}
          <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
            <h2 className="text-lg font-bold mb-4 flex items-center gap-2 border-b pb-2 dark:border-slate-700">
                <Info size={18} className="text-blue-500"/> Informações Gerais
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              
              {/* --- RAZÃO SOCIAL ADICIONADA AQUI --- */}
              <div className="md:col-span-2">
                <label className={labelClass}>Razão Social</label>
                <input name="razao_social" value={form.razao_social} onChange={handleChange} className={inputClass} placeholder="Ex: Clínica Médica Ltda."/>
              </div>

              <div className="md:col-span-2">
                <label className={labelClass}>Nome Fantasia</label>
                <input name="nome_fantasia" required value={form.nome_fantasia} onChange={handleChange} className={inputClass} placeholder="Ex: TheClinic"/>
              </div>
              
              <div>
                <label className={labelClass}>CNPJ</label>
                <input name="cnpj" value={form.cnpj} onChange={handleChange} className={inputClass} placeholder="00.000.000/0000-00"/>
              </div>
              <div>
                <label className={labelClass}>Telefone</label>
                <input name="telefone" value={form.telefone} onChange={handleChange} className={inputClass} placeholder="(00) 00000-0000" />
              </div>
              <div className="md:col-span-2">
                <label className={labelClass}>E-mail</label>
                <input name="email" type="email" value={form.email} onChange={handleChange} className={inputClass} />
              </div>
            </div>
          </div>

          {/* ENDEREÇO */}
          <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
            <h2 className="text-lg font-bold mb-4 flex items-center gap-2 border-b pb-2 dark:border-slate-700">
                <MapPin size={18} className="text-red-500"/> Endereço
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div className="md:col-span-1">
                <label className={labelClass}>CEP {loadingCep && <Loader2 size={12} className="inline animate-spin ml-1 text-blue-500"/>}</label>
                <input name="cep" value={form.cep} onChange={handleChange} onBlur={buscarCep} className={inputClass} placeholder="00000-000" />
              </div>
              <div className="md:col-span-2">
                <label className={labelClass}>Logradouro</label>
                <input name="logradouro" value={form.logradouro} onChange={handleChange} className={inputClass} />
              </div>
              <div className="md:col-span-1">
                <label className={labelClass}>Número</label>
                <input id="numero_clinica" name="numero" value={form.numero} onChange={handleChange} className={inputClass} />
              </div>
              <div className="md:col-span-2">
                <label className={labelClass}>Complemento</label>
                <input name="complemento" value={form.complemento || ''} onChange={handleChange} className={inputClass} />
              </div>
              <div className="md:col-span-2">
                <label className={labelClass}>Bairro</label>
                <input name="bairro" value={form.bairro} onChange={handleChange} className={inputClass} />
              </div>
              <div className="md:col-span-3">
                <label className={labelClass}>Cidade</label>
                <input name="cidade" value={form.cidade} onChange={handleChange} className={inputClass} />
              </div>
              <div className="md:col-span-1">
                <label className={labelClass}>UF</label>
                <input name="estado" maxLength="2" value={form.estado} onChange={handleChange} className={inputClass} style={{textTransform: 'uppercase'}} />
              </div>
            </div>
          </div>

          <div className="flex justify-end">
            <button type="submit" disabled={loading} className="bg-blue-600 hover:bg-blue-700 text-white px-10 py-3.5 rounded-xl font-bold flex items-center gap-2 shadow-lg transition-all active:scale-95 disabled:opacity-50">
              {loading ? <Loader2 size={20} className="animate-spin"/> : <Save size={20}/>}
              {loading ? 'Salvando...' : 'Salvar Alterações'}
            </button>
          </div>
        </form>
      </div>
    </Layout>
  );
} 

============================================================
ARQUIVO: clinica-front/src/pages/Dashboard.jsx
============================================================
import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNotification } from '../context/NotificationContext';
import { Link, useNavigate } from 'react-router-dom';
import Layout from '../components/Layout';
import { 
    Users, DollarSign, Activity, Clock, TrendingUp, 
    CalendarCheck, AlertCircle, ChevronRight, Stethoscope 
} from 'lucide-react';

export default function Dashboard() {
    const { user, api } = useAuth();
    const { notify } = useNotification();
    const navigate = useNavigate();

    // --- ESTADOS DOS FILTROS ---
    const hoje = new Date().toISOString().split('T')[0];
    const mesAtual = new Date().toISOString().slice(0, 7);

    const [filtroDia, setFiltroDia] = useState(hoje);
    const [filtroMes, setFiltroMes] = useState(mesAtual);

    // --- ESTADOS DOS DADOS ---
    const [statsDia, setStatsDia] = useState({ total: 0, aguardando: 0 });
    const [statsMes, setStatsMes] = useState({ totalPacientes: 0, receitaConfirmada: 0, receitaEstimada: 0 });
    const [listaHoje, setListaHoje] = useState([]); 
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (api) {
            carregarDados();
        }
    }, [api, filtroDia, filtroMes]);

    const carregarDados = async () => {
        setLoading(true);
        try {
            // 1. DADOS DO DIA
            const resDia = await api.get(`agendamento/?data=${filtroDia}&nopage=true`);
            const dadosDia = resDia.data.results || resDia.data;
            
            // "Pacientes Agendados no Total" = Todos (independente do status)
            const totalAgendadosDia = dadosDia.length;
            const aguardando = dadosDia.filter(a => a.status === 'aguardando').length;

            setStatsDia({ total: totalAgendadosDia, aguardando });
            setListaHoje(dadosDia);

            // 2. DADOS DO MÊS
            const [ano, mes] = filtroMes.split('-');
            const resMes = await api.get(`agendamento/?mes=${mes}&ano=${ano}&nopage=true`);
            const dadosMes = resMes.data.results || resMes.data;

            // "Total de pacientes no mês deve considerar a quantidade total de agendamento, independente da situação"
            const totalPacientesMes = dadosMes.length;

            // RECEITA CONFIRMADA: Apenas quem já pagou (fatura_pago = true)
            // Precisamos garantir que o serializer esteja enviando 'fatura_pago'
            const receitaConfirmada = dadosMes
                .filter(a => a.fatura_pago === true)
                .reduce((acc, curr) => acc + parseFloat(curr.valor || 0), 0);

            // RECEITA ESTIMADA: Todos agendados - Faltosos - Cancelados
            // (Assumindo que 'agendado', 'aguardando', 'em_atendimento', 'finalizado' contam)
            const receitaEstimada = dadosMes
                .filter(a => a.status !== 'faltou' && a.status !== 'cancelado')
                .reduce((acc, curr) => acc + parseFloat(curr.valor || 0), 0);

            setStatsMes({ 
                totalPacientes: totalPacientesMes, 
                receitaConfirmada: receitaConfirmada,
                receitaEstimada: receitaEstimada
            });

        } catch (error) {
            console.error("Erro dashboard", error);
        } finally {
            setLoading(false);
        }
    };

    const handleRealizarAtendimento = () => {
        // Redireciona para o Prontuário (que será criado no futuro)
        // Por enquanto, podemos colocar um aviso ou redirecionar para uma rota placeholder
        if (!user.profissional_id) {
            notify.error("Apenas profissionais de saúde podem realizar atendimento.");
            return;
        }
        // Exemplo: rota futura
        navigate('/atendimento/prontuario'); 
        // Como não existe ainda, vai cair no 404 ou dashboard, 
        // ou você pode colocar um alert provisório:
        notify.info("Módulo de Prontuário será implementado em breve.");
    };

    // --- COMPONENTES VISUAIS ---
    
    const FilterInput = ({ type, value, onChange, label }) => (
        <div className="flex flex-col">
            <span className="text-[10px] font-bold text-slate-400 mb-1 uppercase tracking-wider">{label}</span>
            <input 
                type={type} 
                value={value} 
                onChange={e => onChange(e.target.value)} 
                className="bg-transparent border-b border-slate-300 dark:border-slate-700 text-slate-700 dark:text-slate-200 text-sm py-1 outline-none focus:border-blue-500 transition-colors font-semibold"
            />
        </div>
    );

    const GradientCard = ({ title, value, subValue, icon: Icon, gradient, loading }) => (
        <div className={`relative overflow-hidden rounded-3xl p-6 text-white shadow-xl ${gradient} transition-all hover:scale-[1.02]`}>
            <div className="relative z-10">
                <div className="flex justify-between items-start mb-4">
                    <div className="p-3 bg-white/20 rounded-2xl backdrop-blur-md">
                        <Icon size={24} className="text-white" />
                    </div>
                    {loading && <div className="h-6 w-16 bg-white/20 animate-pulse rounded-full"></div>}
                </div>
                <div>
                    <p className="text-blue-100 font-medium text-sm mb-1">{title}</p>
                    <h3 className="text-4xl font-bold tracking-tight">{loading ? '...' : value}</h3>
                    {subValue && (
                        <p className="text-white/80 text-xs mt-2 font-medium bg-black/10 inline-block px-2 py-1 rounded-lg">
                            {subValue}
                        </p>
                    )}
                </div>
            </div>
            <div className="absolute -bottom-6 -right-6 w-32 h-32 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>
        </div>
    );

    const getStatusStyle = (status) => {
        switch(status) {
            case 'agendado': return 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300';
            case 'aguardando': return 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300 animate-pulse';
            case 'em_atendimento': return 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300';
            case 'finalizado': return 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300';
            case 'faltou': return 'bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-400';
            case 'cancelado': return 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300';
            default: return 'bg-gray-100 text-gray-600';
        }
    };

    return (
        <Layout>
            <div className="max-w-7xl mx-auto pb-10">
                
                {/* CABEÇALHO */}
                <div className="flex flex-col md:flex-row justify-between items-end mb-10 gap-6">
                    <div>
                        <h1 className="text-3xl font-bold text-slate-800 dark:text-white tracking-tight">
                            Dashboard
                        </h1>
                        <p className="text-slate-500 dark:text-slate-400 mt-1 flex items-center gap-2">
                            <Activity size={16} className="text-green-500"/> 
                            Visão geral de <span className="font-bold text-slate-700 dark:text-slate-200">{user?.first_name || user?.username}</span>
                        </p>
                    </div>

                    <div className="flex gap-6 bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <FilterInput label="Dia Referência" type="date" value={filtroDia} onChange={setFiltroDia} />
                        <FilterInput label="Mês Financeiro" type="month" value={filtroMes} onChange={setFiltroMes} />
                    </div>
                </div>

                {/* KPI CARDS */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <GradientCard 
                        title="Agendamentos (Dia)"
                        value={statsDia.total}
                        subValue={`${statsDia.aguardando} Aguardando`}
                        icon={CalendarCheck}
                        gradient="bg-gradient-to-br from-blue-600 to-indigo-600"
                        loading={loading}
                    />

                    <GradientCard 
                        title="Total Agendamentos (Mês)"
                        value={statsMes.totalPacientes}
                        subValue={`Referente a ${filtroMes.split('-')[1]}/${filtroMes.split('-')[0]}`}
                        icon={Users}
                        gradient="bg-gradient-to-br from-violet-600 to-purple-600"
                        loading={loading}
                    />

                    <GradientCard 
                        title="Receita Confirmada (Paga)"
                        value={new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(statsMes.receitaConfirmada)}
                        subValue={`Est. Total: ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(statsMes.receitaEstimada)}`}
                        icon={DollarSign}
                        gradient="bg-gradient-to-br from-emerald-500 to-teal-600"
                        loading={loading}
                    />
                </div>

                {/* ÁREA PRINCIPAL: LISTA DE HOJE */}
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    {/* COLUNA ESQUERDA: AGENDA DE HOJE */}
                    <div className="lg:col-span-2 bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden flex flex-col">
                        <div className="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50">
                            <div>
                                <h3 className="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                                    <Clock className="text-blue-500" size={20}/> Agenda do Dia
                                </h3>
                                <p className="text-xs text-slate-500">Visualização rápida dos pacientes de hoje ({filtroDia.split('-')[2]}/{filtroDia.split('-')[1]})</p>
                            </div>
                            <Link to="/recepcao" className="text-sm font-bold text-blue-600 hover:text-blue-700 flex items-center gap-1 bg-blue-50 dark:bg-blue-900/20 px-3 py-1.5 rounded-lg transition-colors">
                                Ir para Recepção <ChevronRight size={16}/>
                            </Link>
                        </div>
                        
                        <div className="flex-1 overflow-auto max-h-[400px] p-2">
                            {loading ? (
                                <div className="text-center py-10 text-slate-400">Carregando...</div>
                            ) : listaHoje.length === 0 ? (
                                <div className="text-center py-12 flex flex-col items-center">
                                    <div className="bg-slate-100 dark:bg-slate-700 p-4 rounded-full mb-3 text-slate-400"><CalendarCheck size={32}/></div>
                                    <p className="text-slate-500 font-medium">Nenhum agendamento para este dia.</p>
                                </div>
                            ) : (
                                <table className="w-full text-left border-collapse">
                                    <thead className="text-xs text-slate-400 uppercase tracking-wider bg-white dark:bg-slate-800 sticky top-0 z-10">
                                        <tr>
                                            <th className="px-6 py-3 font-bold">Horário</th>
                                            <th className="px-6 py-3 font-bold">Paciente</th>
                                            <th className="px-6 py-3 font-bold">Status</th>
                                            <th className="px-6 py-3 font-bold text-right">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 dark:divide-slate-700 text-sm">
                                        {listaHoje.map((item) => (
                                            <tr key={item.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                                                <td className="px-6 py-4 font-bold text-slate-700 dark:text-slate-200">{item.horario.slice(0,5)}</td>
                                                <td className="px-6 py-4">
                                                    <div className="font-bold text-slate-800 dark:text-white">{item.nome_paciente}</div>
                                                    <div className="text-xs text-slate-500">{item.nome_profissional}</div>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <span className={`px-2.5 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${getStatusStyle(item.status)}`}>
                                                        {item.status.replace('_', ' ')}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 text-right font-medium text-slate-600 dark:text-slate-400">
                                                    {item.valor > 0 ? `R$ ${Number(item.valor).toFixed(2)}` : '-'}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    </div>

                    {/* COLUNA DIREITA: STATUS RÁPIDO & ATENDIMENTO */}
                    <div className="flex flex-col gap-6">
                        <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-6 text-white shadow-lg flex flex-col justify-center items-center text-center h-full min-h-[200px]">
                            <div className="bg-white/10 p-4 rounded-full mb-4 animate-pulse">
                                <AlertCircle size={32} className="text-yellow-400"/>
                            </div>
                            <h3 className="text-2xl font-bold">{statsDia.aguardando}</h3>
                            <p className="text-slate-300 text-sm font-medium uppercase tracking-widest mt-1">Pacientes Aguardando</p>
                            
                            {/* BOTÃO REALIZAR ATENDIMENTO (CONDICIONAL) */}
                            {user?.profissional_id && (
                                <button 
                                    onClick={handleRealizarAtendimento}
                                    className="mt-6 w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2 active:scale-95"
                                >
                                    <Stethoscope size={20}/> Realizar Atendimento
                                </button>
                            )}
                            
                            {!user?.profissional_id && (
                                <p className="text-xs text-slate-500 mt-4 bg-black/20 px-3 py-1 rounded-lg">
                                    Acesso ao atendimento restrito a profissionais médicos vinculados.
                                </p>
                            )}
                        </div>
                        
                        <div className="bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                            <h4 className="font-bold text-slate-700 dark:text-white mb-4 flex items-center gap-2">
                                <TrendingUp size={18} className="text-green-500"/> Performance
                            </h4>
                            <div className="space-y-4">
                                <div>
                                    <div className="flex justify-between text-xs mb-1 text-slate-500 dark:text-slate-400">
                                        <span>Fluxo Diário</span>
                                        <span>Normal</span>
                                    </div>
                                    <div className="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-2">
                                        <div className="bg-green-500 h-2 rounded-full" style={{width: '75%'}}></div>
                                    </div>
                                </div>
                                <p className="text-xs text-slate-400 leading-relaxed">
                                    Dados atualizados em tempo real conforme a movimentação da recepção.
                                </p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </Layout>
    );
}

============================================================
ARQUIVO: clinica-front/src/pages/Profissionais.jsx
============================================================
import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import Layout from '../components/Layout';
import { useNavigate } from 'react-router-dom';
import { Search, UserPlus, Pencil, Trash2, Stethoscope, BriefcaseMedical } from 'lucide-react';

export default function Profissionais() {
  const { api } = useAuth();
  const navigate = useNavigate();
  const [profissionais, setProfissionais] = useState([]);
  const [search, setSearch] = useState('');

  // --- FUNÇÃO AUXILIAR PARA FORMATAR O CPF NA TELA ---
  const formatCPF = (cpf) => {
    if (!cpf) return '';
    const v = cpf.replace(/\D/g, ''); 
    return v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
  };

  useEffect(() => {
    // ROTA AJUSTADA: Agora chamamos 'profissionais/' (que no backend virou api/profissionais/)
    if(api) {
        api.get(`profissionais/?search=${search}`)
           .then(res => setProfissionais(res.data.results || res.data))
           .catch(err => console.error("Erro ao carregar profissionais", err));
    }
  }, [api, search]);

  const handleExcluir = async (id) => {
    if(window.confirm("Excluir profissional?")) {
        try {
            await api.delete(`profissionais/${id}/`);
            setProfissionais(prev => prev.filter(p => p.id !== id));
        } catch (error) {
            alert("Erro ao excluir. Verifique se existem vínculos.");
        }
    }
  }

  const actionBtnClass = "p-2 bg-transparent rounded-lg transition-colors";
  const editBtnClass = `${actionBtnClass} text-blue-600 hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-blue-900/30`;
  const deleteBtnClass = `${actionBtnClass} text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/30`;

  return (
    <Layout>
      <div className="max-w-6xl mx-auto">
        <div className="flex justify-between items-center mb-6">
            <div className="flex items-center gap-3">
                <div className="bg-blue-600 p-3 rounded-xl text-white shadow"><Stethoscope size={28}/></div>
                <div>
                    <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Profissionais</h1>
                    <p className="text-slate-500 dark:text-slate-400 text-sm">Gerencie sua equipe médica.</p>
                </div>
            </div>
            <button onClick={()=>navigate('/profissionais/novo')} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold flex gap-2 transition-colors"><UserPlus size={20}/> Novo Profissional</button>
        </div>

        {/* --- BUSCA SIMPLES --- */}
        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border mb-6 border-slate-200 dark:border-slate-700 relative">
            <Search className="absolute left-7 top-7 text-slate-400" size={18} />
            <input 
                placeholder="Buscar por nome ou CPF..." 
                value={search} 
                onChange={e=>setSearch(e.target.value)} 
                className="w-full pl-10 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 outline-none dark:text-white focus:ring-2 focus:ring-blue-500 transition-all"
            />
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
            <table className="w-full text-left">
                <thead className="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-300 uppercase text-xs font-bold">
                    <tr><th className="px-6 py-4">Nome / CPF</th><th className="px-6 py-4">Especialidades</th><th className="px-6 py-4 text-right">Ações</th></tr>
                </thead>
                <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                    {profissionais.map(p => (
                        <tr key={p.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                            <td className="px-6 py-4">
                                <div className="font-bold text-slate-700 dark:text-white">{p.nome}</div>
                                <span className="text-xs text-slate-400 font-mono">{formatCPF(p.cpf)}</span>
                            </td>
                            <td className="px-6 py-4">
                                <div className="flex flex-col gap-1">
                                    {p.especialidades.map((esp, i) => (
                                        <div key={i} className="flex items-center gap-2 text-sm">
                                            <span className="font-semibold text-blue-600 dark:text-blue-400 flex items-center gap-1">
                                                <BriefcaseMedical size={12}/> {esp.nome_especialidade}
                                            </span>
                                            <span className="text-xs bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-300">
                                                {esp.sigla_conselho}/{esp.uf_conselho}-{esp.registro_conselho}
                                            </span>
                                        </div>
                                    ))}
                                    {p.especialidades.length === 0 && <span className="text-xs text-slate-400 italic">Nenhuma especialidade</span>}
                                </div>
                            </td>
                            <td className="px-6 py-4 text-right flex justify-end gap-2">
                                <button onClick={()=>navigate(`/profissionais/${p.id}`)} className={editBtnClass}><Pencil size={18}/></button>
                                <button onClick={()=>handleExcluir(p.id)} className={deleteBtnClass}><Trash2 size={18}/></button>
                            </td>
                        </tr>
                    ))}
                    {profissionais.length === 0 && <tr><td colSpan="3" className="p-8 text-center text-slate-400">Nenhum profissional encontrado.</td></tr>}
                </tbody>
            </table>
        </div>
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front/src/pages/CadastroOperador.jsx
============================================================
import { useState, useEffect, useRef } from 'react'; // Adicione useRef
import { useAuth } from '../context/AuthContext';
import { useNotification } from '../context/NotificationContext';
import { useNavigate, useParams } from 'react-router-dom';
import Layout from '../components/Layout';
import { 
  UserCog, Mail, Lock, Shield, Save, Check, Stethoscope, CalendarDays, DollarSign, KeyRound, ArrowLeft, Loader2, Search, ChevronDown, X 
} from 'lucide-react';

// --- COMPONENTE SEARCHABLE SELECT (Reutilizado) ---
const SearchableSelect = ({ label, options, value, onChange, placeholder }) => {
    const [isOpen, setIsOpen] = useState(false);
    const [query, setQuery] = useState('');
    const containerRef = useRef(null);

    useEffect(() => { 
        const selected = options.find(o => String(o.id) === String(value)); 
        if (selected) setQuery(selected.label);
        else if (!value) setQuery('');
    }, [value, options]);

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (containerRef.current && !containerRef.current.contains(event.target)) {
                setIsOpen(false);
                const selected = options.find(o => String(o.id) === String(value));
                setQuery(selected ? selected.label : '');
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, [containerRef, value, options]);

    const filtered = (query === '' || query === (options.find(o => String(o.id) === String(value))?.label)) 
        ? options 
        : options.filter(o => o.label.toLowerCase().includes(query.toLowerCase()));
    
    return (
        <div className="relative mb-4" ref={containerRef}>
            <label className="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1.5">{label}</label>
            <div className="relative">
                <input 
                    type="text"
                    className="w-full pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white border border-slate-300 dark:border-slate-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder-slate-400" 
                    value={query} 
                    onFocus={() => setIsOpen(true)}
                    onClick={() => setIsOpen(true)}
                    onChange={e => { setQuery(e.target.value); setIsOpen(true); }} 
                    placeholder={placeholder} autoComplete="off"
                />
                <div className="absolute left-3 top-3.5 text-slate-400"><Search size={18}/></div>
                <div className="absolute right-2 top-3.5 flex items-center gap-1 text-slate-400">
                    {value && <button type="button" onClick={(e)=>{e.stopPropagation(); onChange(null); setQuery('')}} className="hover:text-red-500"><X size={14}/></button>}
                    <ChevronDown size={16}/>
                </div>
            </div>
            {isOpen && (
                <ul className="absolute z-[100] w-full bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg shadow-2xl max-h-60 overflow-auto mt-1 animate-in fade-in zoom-in duration-100">
                    {filtered.length > 0 ? filtered.map(opt => (
                        <li key={opt.id} onMouseDown={() => { onChange(opt.id); setQuery(opt.label); setIsOpen(false); }} className={`p-2.5 cursor-pointer text-sm border-b last:border-0 border-slate-100 dark:border-slate-700 flex justify-between items-center hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200`}>
                            {opt.label}
                            {String(value) === String(opt.id) && <Check size={14} className="text-blue-500"/>}
                        </li>
                    )) : <li className="p-3 text-sm text-slate-400 text-center">Nenhum resultado.</li>}
                </ul>
            )}
        </div>
    );
};

export default function CadastroOperador() {
  const { api } = useAuth();
  const { notify } = useNotification();
  const navigate = useNavigate();
  const { id } = useParams();
  
  const [loading, setLoading] = useState(false);
  const [fetching, setFetching] = useState(id ? true : false);
  const [profissionais, setProfissionais] = useState([]); // Lista de profissionais
  
  const [formData, setFormData] = useState({
    username: '', password: '', first_name: '', email: '',
    acesso_atendimento: false, acesso_agendamento: false, 
    acesso_faturamento: false, is_superuser: false,
    force_password_change: true,
    profissional_id: null // Vinculo com médico
  });

  useEffect(() => {
    // 1. Carrega Profissionais para o Select
    if (api) {
        api.get('profissionais/').then(res => {
            const lista = res.data.results || res.data;
            setProfissionais(lista.map(p => ({ id: p.id, label: `${p.nome} (CPF: ${p.cpf})` })));
        });

        // 2. Carrega dados do Operador se for edição
        if (id) {
            api.get(`operadores/${id}/`)
               .then(res => {
                   const data = res.data;
                   setFormData({
                       username: data.username || '',
                       first_name: data.first_name || '',
                       email: data.email || '',
                       acesso_atendimento: data.acesso_atendimento || false,
                       acesso_agendamento: data.acesso_agendamento || false,
                       acesso_faturamento: data.acesso_faturamento || false,
                       is_superuser: data.is_superuser || false,
                       force_password_change: data.force_password_change || false,
                       profissional_id: data.profissional_id || null, // Carrega o ID
                       password: ''
                   });
               })
               .catch(err => {
                   console.error(err);
                   navigate('/operadores');
               })
               .finally(() => setFetching(false));
        }
    }
  }, [id, api, navigate]);

  const handleChange = (e) => {
    const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
    setFormData({ ...formData, [e.target.name]: value });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      if (id) {
          const dadosParaEnviar = { ...formData };
          if (!dadosParaEnviar.password) delete dadosParaEnviar.password;
          await api.put(`operadores/${id}/`, dadosParaEnviar);
          notify.success('Operador atualizado com sucesso!');
      } else {
          await api.post('operadores/novo/', formData);
          notify.success('Operador criado com sucesso!');
      }
      navigate('/operadores');
    } catch (error) {
      console.error(error);
      const msg = error.response?.data?.error || 'Erro ao salvar operador.';
      notify.error(msg);
    } finally {
      setLoading(false);
    }
  };

  const inputClass = "w-full pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white border border-slate-300 dark:border-slate-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder-slate-400 dark:placeholder-slate-600";
  const labelClass = "block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1.5";
  const backButtonClass = "mb-4 flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors shadow-sm text-sm font-bold w-fit";

  const PermissionToggle = ({ name, label, icon: Icon, checked, onChange }) => {
    const activeContainer = "bg-blue-50 border-blue-600 ring-1 ring-blue-600 dark:bg-blue-900/30 dark:border-blue-400 dark:ring-blue-400";
    const inactiveContainer = "bg-white border-slate-200 hover:border-blue-300 dark:bg-slate-800 dark:border-slate-700";

    return (
      <label className={`relative flex items-center justify-between p-4 border rounded-xl cursor-pointer transition-all duration-200 ${checked ? activeContainer : inactiveContainer}`}>
        <div className="flex items-center space-x-4">
          <div className={`p-3 rounded-lg transition-colors ${checked ? 'bg-white shadow-sm dark:bg-slate-800 text-blue-600 dark:text-blue-400' : 'bg-slate-100 dark:bg-slate-700 text-slate-400'}`}>
            <Icon size={24} />
          </div>
          <div>
            <span className={`block font-bold text-base ${checked ? 'text-blue-900 dark:text-blue-100' : 'text-slate-600 dark:text-slate-300'}`}>
              {label}
            </span>
            <span className={`text-xs font-medium ${checked ? 'text-blue-600 dark:text-blue-300' : 'text-slate-400 dark:text-slate-500'}`}>
              {checked ? 'Habilitado' : 'Desabilitado'}
            </span>
          </div>
        </div>
        <div className={`w-8 h-8 rounded-full flex items-center justify-center border-2 transition-all duration-200 ${checked ? 'bg-blue-600 border-blue-600 scale-110 shadow-md' : 'bg-transparent border-slate-300 dark:border-slate-600'}`}>
          {checked && <Check size={18} className="text-white" strokeWidth={3} />}
        </div>
        <input type="checkbox" name={name} checked={checked} onChange={onChange} className="sr-only" />
      </label>
    );
  };

  if (fetching) return <Layout><div className="flex justify-center p-10 text-slate-400">Carregando dados do operador...</div></Layout>;

  return (
    <Layout>
      <div className="max-w-5xl mx-auto">
        <button onClick={() => navigate('/operadores')} className={backButtonClass}>
            <ArrowLeft size={18}/> Voltar
        </button>

        <div className="mb-8 flex items-center space-x-4">
          <div className="bg-blue-600 p-3 rounded-xl shadow-lg text-white">
            <UserCog size={32} />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-slate-800 dark:text-white">{id ? 'Editar Operador' : 'Novo Operador'}</h1>
            <p className="text-slate-500 dark:text-slate-400 text-sm">Gerencie as credenciais e permissões de acesso.</p>
          </div>
        </div>

        <form onSubmit={handleSubmit}>
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div className="lg:col-span-2 space-y-6">
              <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                <h2 className="text-lg font-bold text-slate-700 dark:text-white mb-6 flex items-center gap-2">
                  <Shield size={20} className="text-blue-600 dark:text-blue-400"/> Credenciais
                </h2>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                  <div className="col-span-2">
                    <label className={labelClass}>Nome Completo</label>
                    <input name="first_name" value={formData.first_name} onChange={handleChange} className={inputClass.replace('pl-10', 'px-4')} placeholder="Ex: Dra. Ana Paula" required />
                  </div>

                  <div className="col-span-2">
                    <label className={labelClass}>Email</label>
                    <div className="relative">
                      <Mail className="absolute left-3 top-3.5 text-slate-400" size={18} />
                      <input name="email" value={formData.email} type="email" onChange={handleChange} className={inputClass} placeholder="email@clinica.com" />
                    </div>
                  </div>

                  {/* SELEÇÃO DE PROFISSIONAL VINCULADO */}
                  <div className="col-span-2">
                    <hr className="my-2 border-slate-100 dark:border-slate-700"/>
                    <p className="text-xs text-blue-500 font-bold mb-2 uppercase tracking-wider flex items-center gap-1"><Stethoscope size={12}/> Vínculo Profissional (Médico)</p>
                    <SearchableSelect 
                        label="Este operador é um médico?" 
                        placeholder="Pesquise o profissional..." 
                        options={profissionais} 
                        value={formData.profissional_id} 
                        onChange={(val) => setFormData({...formData, profissional_id: val})}
                    />
                    <p className="text-xs text-slate-400">Ao vincular, este operador terá acesso ao Prontuário Eletrônico.</p>
                  </div>

                  <div>
                    <label className={labelClass}>Nome de Usuário</label>
                    <div className="relative">
                      <UserCog className="absolute left-3 top-3.5 text-slate-400" size={18} />
                      <input name="username" value={formData.username} onChange={handleChange} className={inputClass} placeholder="usuario.sistema" required />
                    </div>
                  </div>

                  <div>
                    <label className={labelClass}>Senha</label>
                    <div className="relative">
                      <Lock className="absolute left-3 top-3.5 text-slate-400" size={18} />
                      <input name="password" type="password" value={formData.password} onChange={handleChange} className={inputClass} placeholder={id ? "•••••• (Vazio p/ manter)" : "••••••"} required={!id} />
                    </div>
                  </div>
                  
                   <div className="col-span-2 mt-2">
                     <PermissionToggle 
                       name="force_password_change" 
                       label="Forçar Troca de Senha" 
                       icon={KeyRound} 
                       checked={formData.force_password_change} 
                       onChange={handleChange} 
                     />
                   </div>
                </div>
              </div>
            </div>

            <div className="lg:col-span-1">
              <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 h-full flex flex-col">
                <h2 className="text-lg font-bold text-slate-700 dark:text-white mb-2">Permissões de Acesso</h2>
                <p className="text-sm text-slate-400 mb-6">Selecione os módulos liberados:</p>

                <div className="space-y-4 flex-grow">
                  <PermissionToggle name="acesso_atendimento" label="Atendimento" icon={Stethoscope} checked={formData.acesso_atendimento} onChange={handleChange} />
                  <PermissionToggle name="acesso_agendamento" label="Agendamento" icon={CalendarDays} checked={formData.acesso_agendamento} onChange={handleChange} />
                  <PermissionToggle name="acesso_faturamento" label="Financeiro" icon={DollarSign} checked={formData.acesso_faturamento} onChange={handleChange} />
                  <hr className="border-slate-100 dark:border-slate-700 my-4"/>
                  <PermissionToggle name="is_superuser" label="Administrador" icon={Shield} checked={formData.is_superuser} onChange={handleChange} />
                </div>

                <div className="mt-8 flex flex-col gap-3">
                    <button disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2 active:scale-95 disabled:opacity-50">
                      {loading ? <Loader2 className="animate-spin" size={20}/> : <Save size={20} />}
                      {loading ? 'Salvando...' : 'Salvar Operador'}
                    </button>
                     <button type="button" onClick={() => navigate('/operadores')} className="w-full bg-slate-100 text-slate-600 font-bold py-3 rounded-xl transition-colors">
                        Cancelar
                    </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front/src/pages/Especialidades.jsx
============================================================
import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import Layout from '../components/Layout';
// MUDANÇA 1: Troquei 'Edit' por 'Pencil' para padronizar com as outras telas
import { Plus, Pencil, Trash2, Tag, X, Save, Search, ChevronLeft, ChevronRight } from 'lucide-react';

export default function Especialidades() {
  const { api } = useAuth();
  
  const [especialidades, setEspecialidades] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState('');
  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [totalCount, setTotalCount] = useState(0);
  
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const [nome, setNome] = useState('');
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    if (api) loadData();
  }, [api, page, search]);

  const loadData = async () => {
    setLoading(true);
    try {
      let pageSize = 15;
      try {
          const conf = await api.get('operadores/config/');
          if (conf.data?.itens_por_pagina) pageSize = conf.data.itens_por_pagina;
      } catch {}

      const response = await api.get(`especialidades/?page=${page}&page_size=${pageSize}&search=${search}`);
      const data = response.data;

      if (data.results) {
        setEspecialidades(data.results);
        setTotalCount(data.count);
        setTotalPages(Math.ceil(data.count / pageSize));
      } else {
        setEspecialidades(data);
        setTotalPages(1);
        setTotalCount(data.length);
      }
    } catch (error) {
      console.error("Erro", error);
      if (page > 1) setPage(1);
    } finally {
      setLoading(false);
    }
  };

  const handleOpenModal = (item = null) => {
    setEditingItem(item);
    setNome(item ? item.nome : '');
    setIsModalOpen(true);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setSaving(true);
    try {
      if (editingItem) {
        await api.put(`especialidades/${editingItem.id}/`, { nome });
      } else {
        await api.post('especialidades/', { nome });
      }
      setIsModalOpen(false);
      loadData();
    } catch (error) {
      alert("Erro ao salvar.");
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (id) => {
    if (confirm("Tem certeza que deseja excluir?")) {
      try {
        await api.delete(`especialidades/${id}/`);
        loadData();
      } catch (error) {
        alert("Não é possível excluir item em uso.");
      }
    }
  };

  const paginationBtnClass = "p-2 border rounded-lg transition-colors disabled:opacity-50 bg-white border-slate-200 text-slate-600 hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-700";
  
  // PADRÃO DE BOTÃO IDENTICO AO DE PACIENTES/OPERADORES
  const actionBtnClass = "p-2 bg-transparent rounded-lg transition-colors";
  const editBtnClass = `${actionBtnClass} text-blue-600 hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-blue-900/30`;
  const deleteBtnClass = `${actionBtnClass} text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/30`;

  return (
    <Layout>
      <div className="max-w-4xl mx-auto">
        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <Tag className="text-blue-600"/> Especialidades
                </h1>
                <p className="text-slate-500 dark:text-slate-400 text-sm">Gerencie as áreas de atuação médica.</p>
            </div>
            <button 
                onClick={() => handleOpenModal()} 
                className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg transition-transform active:scale-95"
            >
                <Plus size={20}/> Nova Especialidade
            </button>
        </div>

        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6 relative">
            <Search className="absolute left-7 top-7 text-slate-400" size={18} />
            <input 
                placeholder="Pesquisar especialidade..." 
                value={search} 
                onChange={e => { setSearch(e.target.value); setPage(1); }}
                className="w-full pl-10 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 outline-none text-slate-700 dark:text-white transition-colors focus:border-blue-500"
            />
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
            <table className="w-full text-left">
                <thead className="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700">
                    <tr>
                        <th className="px-6 py-4">Nome da Especialidade</th>
                        <th className="px-6 py-4 text-right">Ações</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                    {especialidades.map((item) => (
                        <tr key={item.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                            <td className="px-6 py-4 font-medium text-slate-700 dark:text-white">
                                {item.nome}
                            </td>
                            <td className="px-6 py-4 text-right flex justify-end gap-2">
                                {/* BOTÕES PADRONIZADOS */}
                                <button onClick={() => handleOpenModal(item)} className={editBtnClass} title="Editar">
                                    <Pencil size={18}/>
                                </button>
                                <button onClick={() => handleDelete(item.id)} className={deleteBtnClass} title="Excluir">
                                    <Trash2 size={18}/>
                                </button>
                            </td>
                        </tr>
                    ))}
                    {especialidades.length === 0 && !loading && (
                        <tr><td colSpan="2" className="p-8 text-center text-slate-400">Nenhuma especialidade encontrada.</td></tr>
                    )}
                </tbody>
            </table>

            {totalPages > 1 && (
                <div className="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center text-slate-500 text-sm">
                    <span>Página <strong>{page}</strong> de <strong>{totalPages}</strong> ({totalCount} itens)</span>
                    <div className="flex gap-2">
                        <button disabled={page === 1} onClick={() => setPage(p => p - 1)} className={paginationBtnClass}><ChevronLeft size={16}/></button>
                        <button disabled={page === totalPages} onClick={() => setPage(p => p + 1)} className={paginationBtnClass}><ChevronRight size={16}/></button>
                    </div>
                </div>
            )}
        </div>

        {isModalOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform scale-100 transition-all">
                    <div className="flex justify-between items-center p-5 border-b border-slate-100 dark:border-slate-700">
                        <h3 className="text-lg font-bold text-slate-800 dark:text-white">
                            {editingItem ? 'Editar Especialidade' : 'Nova Especialidade'}
                        </h3>
                        <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                            <X size={24} />
                        </button>
                    </div>
                    
                    <form onSubmit={handleSubmit} className="p-6">
                        <div className="mb-6">
                            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Nome</label>
                            <input 
                                autoFocus
                                required
                                type="text"
                                placeholder="Ex: Cardiologia"
                                className="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none"
                                value={nome}
                                onChange={e => setNome(e.target.value)}
                            />
                        </div>

                        <div className="flex justify-end gap-3">
                            <button type="button" onClick={() => setIsModalOpen(false)} className="px-5 py-2.5 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl font-bold transition-colors">Cancelar</button>
                            <button type="submit" disabled={saving} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-xl font-bold shadow-lg shadow-blue-500/20 flex items-center gap-2">
                                {saving ? 'Salvando...' : <><Save size={18}/> Salvar</>}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        )}
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front/src/pages/ProfissionaisForm.jsx
============================================================
import React, { useState, useEffect, useRef } from 'react';
import { useAuth } from '../context/AuthContext';
import Layout from '../components/Layout';
import { useNavigate, useParams } from 'react-router-dom';
import { Save, ArrowLeft, Plus, Trash2, BriefcaseMedical, ChevronDown, Check, X } from 'lucide-react';

// --- COMPONENTE DE SELEÇÃO PESQUISÁVEL OTIMIZADO ---
const SearchableSelect = ({ options, value, onChange, placeholder, required }) => {
    const [isOpen, setIsOpen] = useState(false);
    const [query, setQuery] = useState('');
    const containerRef = useRef(null);

    // Sincroniza o texto do input com o valor selecionado
    useEffect(() => { 
        const selected = options.find(o => String(o.id) === String(value)); 
        if (selected) setQuery(selected.label);
        else if (!value) setQuery('');
    }, [value, options]);

    // Fecha ao clicar fora
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (containerRef.current && !containerRef.current.contains(event.target)) {
                setIsOpen(false);
                const selected = options.find(o => String(o.id) === String(value));
                setQuery(selected ? selected.label : '');
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, [containerRef, value, options]);

    // Filtra na lista COMPLETA
    const filtered = (query === '' || (options.find(o => o.label === query))) 
        ? options 
        : options.filter(o => o.label.toLowerCase().includes(query.toLowerCase()));
    
    const handleSelect = (id, label) => {
        onChange(id);
        setQuery(label);
        setIsOpen(false);
    };

    const handleClear = (e) => {
        e.stopPropagation();
        onChange('');
        setQuery('');
        setIsOpen(false);
    };

    return (
        <div className="relative w-full" ref={containerRef}>
            <div className="relative">
                <input 
                    type="text" 
                    required={required && !value} 
                    className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 pr-10 outline-none focus:ring-2 focus:ring-blue-500 text-sm dark:text-white cursor-pointer" 
                    value={query} 
                    onFocus={() => setIsOpen(true)}
                    onClick={() => setIsOpen(true)}
                    onChange={e => { setQuery(e.target.value); setIsOpen(true); if(e.target.value === '') onChange(''); }} 
                    placeholder={placeholder} 
                    autoComplete="off"
                />
                <div className="absolute right-2 top-2.5 flex items-center gap-1 text-slate-400">
                    {value && (
                        <button type="button" onClick={handleClear} className="hover:text-red-500 p-0.5 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"><X size={14}/></button>
                    )}
                    <ChevronDown size={16} className={`transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}/>
                </div>
            </div>
            {isOpen && (
                <ul className="absolute z-[100] w-full bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg shadow-2xl max-h-60 overflow-auto mt-1 animate-in fade-in zoom-in duration-100">
                    {/* OTIMIZAÇÃO: Mostra apenas os top 50 resultados para não travar a tela, mas filtra na lista inteira */}
                    {filtered.slice(0, 50).map(opt => (
                        <li key={opt.id} onMouseDown={() => handleSelect(opt.id, opt.label)} className={`p-2.5 cursor-pointer text-sm border-b last:border-0 border-slate-100 dark:border-slate-700 flex justify-between items-center transition-colors ${String(value) === String(opt.id) ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-bold' : 'hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200'}`}>
                            {opt.label}
                            {String(value) === String(opt.id) && <Check size={14}/>}
                        </li>
                    ))}
                    {filtered.length === 0 && <li className="p-3 text-sm text-slate-400 text-center">Nenhum resultado.</li>}
                    {filtered.length > 50 && <li className="p-2 text-xs text-slate-400 text-center bg-slate-50 dark:bg-slate-900">...e mais {filtered.length - 50} resultados. Continue digitando.</li>}
                </ul>
            )}
        </div>
    );
};

export default function ProfissionalForm() {
  const { api } = useAuth();
  const navigate = useNavigate();
  const { id } = useParams();
  
  const [formData, setFormData] = useState({ nome: '', cpf: '', data_nascimento: '' });
  
  const [items, setItems] = useState([]); 
  const [listaEspecialidades, setListaEspecialidades] = useState([]);
  const [loading, setLoading] = useState(false);

  // --- MÁSCARA DE CPF PARA INPUT ---
  const mascaraCPF = (value) => {
    return value
      .replace(/\D/g, '') 
      .replace(/(\d{3})(\d)/, '$1.$2') 
      .replace(/(\d{3})(\d)/, '$1.$2') 
      .replace(/(\d{3})(\d{1,2})/, '$1-$2') 
      .replace(/(-\d{2})\d+?$/, '$1'); 
  };

  useEffect(() => {
    if(api) {
        // Traz TODAS as especialidades (nopage=true)
        api.get('especialidades/?nopage=true').then(res => setListaEspecialidades(res.data.results || res.data));
        
        if (id) {
            api.get(`profissionais/${id}/`).then(res => {
                setFormData({ nome: res.data.nome, cpf: res.data.cpf, data_nascimento: res.data.data_nascimento });
                setItems(res.data.especialidades);
            });
        }
    }
  }, [id, api]);

  const handleAddItem = () => {
    // ALTERAÇÃO: UF padrão agora é 'PR'
    setItems([...items, { especialidade_id: '', sigla_conselho: '', registro_conselho: '', uf_conselho: 'PR' }]);
  };

  const handleRemoveItem = (index) => setItems(items.filter((_, i) => i !== index));
  
  const handleItemChange = (index, field, value) => {
    const newItems = [...items];
    newItems[index][field] = value;
    setItems(newItems);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    const cpfLimpo = formData.cpf.replace(/\D/g, ''); 
    const payload = { ...formData, cpf: cpfLimpo, especialidades: items };
    
    try {
        if(id) await api.put(`profissionais/${id}/`, payload);
        else await api.post('profissionais/', payload);
        alert('Salvo com sucesso!');
        navigate('/profissionais');
    } catch (e) { alert('Erro ao salvar.'); }
    finally { setLoading(false); }
  };

  const inputClass = "w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 text-sm";
  const labelClass = "block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1";
  const subLabelClass = "text-xs text-slate-500 mb-1 block";

  return (
    <Layout>
      <div className="max-w-5xl mx-auto pb-10">
        <button 
            onClick={()=>navigate('/profissionais')} 
            className="mb-4 flex items-center gap-2 text-slate-500 hover:text-slate-800 dark:text-slate-400 bg-transparent hover:bg-slate-100 dark:hover:bg-slate-800 px-3 py-2 rounded-lg transition-colors"
        >
            <ArrowLeft size={18}/> Voltar
        </button>

        <h1 className="text-2xl font-bold mb-6 text-slate-800 dark:text-white">{id ? 'Editar' : 'Novo'} Profissional</h1>

        <form onSubmit={handleSubmit} className="space-y-6">
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                <h2 className="font-bold text-lg mb-4 text-slate-800 dark:text-white">Dados Pessoais</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="md:col-span-2">
                        <label className={labelClass}>Nome Completo</label>
                        <input required value={formData.nome} onChange={e=>setFormData({...formData, nome:e.target.value})} className={inputClass}/>
                    </div>
                    <div>
                        <label className={labelClass}>CPF</label>
                        <input 
                            required 
                            placeholder="000.000.000-00" 
                            value={formData.cpf} 
                            onChange={e => setFormData({ ...formData, cpf: mascaraCPF(e.target.value) })} 
                            className={inputClass}
                            maxLength={14}
                        />
                    </div>
                    <div>
                        <label className={labelClass}>Data Nascimento</label>
                        <input required type="date" value={formData.data_nascimento} onChange={e=>setFormData({...formData, data_nascimento:e.target.value})} className={inputClass}/>
                    </div>
                </div>
            </div>

            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2"><BriefcaseMedical size={20}/> Especialidades e Conselhos</h2>
                    
                    <button 
                        type="button" 
                        onClick={handleAddItem} 
                        className="text-sm font-bold text-blue-600 flex items-center gap-1 hover:bg-blue-50 dark:hover:bg-blue-900/20 px-3 py-2 rounded-lg transition-colors bg-transparent"
                    >
                        <Plus size={16}/> Adicionar Especialidade
                    </button>
                </div>

                {items.length === 0 && <div className="text-center p-4 text-slate-400 border border-dashed rounded-lg">Nenhuma especialidade vinculada. Clique em Adicionar.</div>}

                <div className="space-y-3">
                    {items.map((item, index) => (
                        <div key={index} className="flex flex-col md:flex-row gap-3 items-end bg-slate-50 dark:bg-slate-900/50 p-4 rounded-lg border border-slate-100 dark:border-slate-700 animate-in fade-in zoom-in duration-300">
                            
                            <div className="flex-[2] w-full min-w-[200px]">
                                <label className={subLabelClass}>Especialidade</label>
                                <SearchableSelect
                                    options={listaEspecialidades.map(e => ({ id: e.id, label: e.nome }))}
                                    value={item.especialidade_id}
                                    onChange={(val) => handleItemChange(index, 'especialidade_id', val)}
                                    placeholder="Digite para buscar..."
                                    required={true}
                                />
                            </div>

                            <div className="flex-1 w-full min-w-[100px]">
                                <label className={subLabelClass}>Sigla Conselho</label>
                                <input required value={item.sigla_conselho} onChange={e=>handleItemChange(index, 'sigla_conselho', e.target.value)} className={inputClass} placeholder="Ex: CRM" style={{textTransform: 'uppercase'}}/>
                            </div>

                            <div className="flex-1 w-full min-w-[120px]">
                                <label className={subLabelClass}>Nº Registro</label>
                                <input required value={item.registro_conselho} onChange={e=>handleItemChange(index, 'registro_conselho', e.target.value)} className={inputClass} placeholder="123456"/>
                            </div>

                            <div className="w-full md:w-20">
                                <label className={subLabelClass}>UF</label>
                                <input required value={item.uf_conselho} onChange={e=>handleItemChange(index, 'uf_conselho', e.target.value)} className={inputClass} placeholder="PR" maxLength={2} style={{textTransform: 'uppercase'}}/>
                            </div>

                            <button type="button" onClick={()=>handleRemoveItem(index)} className="p-2.5 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors bg-transparent" title="Remover">
                                <Trash2 size={18}/>
                            </button>
                        </div>
                    ))}
                </div>
            </div>

            <div className="flex justify-end">
                <button disabled={loading} className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg transition-all active:scale-95">
                    {loading ? 'Salvando...' : <><Save size={20}/> Salvar Profissional</>}
                </button>
            </div>
        </form>
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front/src/pages/Configuracoes.jsx
============================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import Layout from '../components/Layout';
import { Settings, Save } from 'lucide-react';

export default function Configuracoes() {
  const { api } = useAuth();
  const [itensPorPagina, setItensPorPagina] = useState(15);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (api) {
        api.get('operadores/config/')
           .then(res => setItensPorPagina(res.data.itens_por_pagina))
           .catch(() => console.log("Usando padrão"));
    }
  }, [api]);

  const handleSave = async () => {
    setLoading(true);
    try {
      await api.put('operadores/config/', { itens_por_pagina: itensPorPagina });
      alert('Configuração salva!');
    } catch (error) { alert('Erro ao salvar.'); } 
    finally { setLoading(false); }
  };

  if (!api) return <div>Carregando...</div>;

  return (
    <Layout>
      <div className="max-w-2xl mx-auto">
        <div className="mb-8 flex items-center space-x-3">
            <div className="bg-slate-700 p-3 rounded-xl text-white shadow"><Settings size={28}/></div>
            <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Configurações</h1>
        </div>
        <div className="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
            <label className="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-2">Itens por página</label>
            <div className="flex gap-4">
                <input type="number" value={itensPorPagina} onChange={e => setItensPorPagina(e.target.value)} className="w-32 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-3 dark:text-white"/>
                <button onClick={handleSave} disabled={loading} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold flex gap-2">
                    <Save size={20}/> Salvar
                </button>
            </div>
        </div>
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front/src/pages/Bloqueios.jsx
============================================================
import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNotification } from '../context/NotificationContext';
import Layout from '../components/Layout';
import { 
    CalendarX, Save, Trash2, AlertTriangle, FileDown, Ban, CheckCircle2 
} from 'lucide-react';
import { generateConflictReport } from '../utils/generateReport';

export default function Bloqueios() {
    const { api } = useAuth();
    const { notify, confirmDialog } = useNotification();
    
    const [bloqueios, setBloqueios] = useState([]);
    const [profissionais, setProfissionais] = useState([]);
    const [loading, setLoading] = useState(false);

    // Form
    const [form, setForm] = useState({
        profissional: '', data_inicio: '', data_fim: '', 
        hora_inicio: '00:00', hora_fim: '23:59', 
        motivo: '', tipo: 'bloqueio', recorrente: false
    });

    // Modal de Conflito
    const [conflictData, setConflictData] = useState(null);

    useEffect(() => {
        loadData();
    }, [api]);

    const loadData = async () => {
        try {
            const [resBloq, resProf] = await Promise.all([
                api.get('agendamento/bloqueios/'),
                api.get('profissionais/')
            ]);
            setBloqueios(resBloq.data.results || resBloq.data);
            setProfissionais(resProf.data.results || resProf.data);
        } catch (e) { notify.error("Erro ao carregar dados."); }
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        
        // 1. Verifica conflitos
        try {
            const res = await api.post('agendamento/bloqueios/verificar_conflitos/', form);
            
            if (res.data.conflito) {
                setConflictData(res.data);
                setLoading(false);
                return; // Para aqui e abre o modal
            }

            // Se não tem conflito, cria direto
            await api.post('agendamento/bloqueios/', { ...form, acao_conflito: 'manter' });
            notify.success("Bloqueio criado com sucesso!");
            setForm({ ...form, motivo: '', data_inicio: '', data_fim: '' });
            loadData();

        } catch (error) {
            notify.error("Erro ao processar bloqueio.");
        } finally {
            setLoading(false);
        }
    };

    const resolverConflito = async (acao) => {
        // acao = 'cancelar' ou 'manter'
        try {
            await api.post('agendamento/bloqueios/', { ...form, acao_conflito: acao });
            notify.success(`Bloqueio criado! Pacientes ${acao === 'cancelar' ? 'cancelados' : 'mantidos'}.`);
            setConflictData(null);
            setForm({ ...form, motivo: '', data_inicio: '', data_fim: '' });
            loadData();
        } catch (error) {
            notify.error("Erro ao resolver conflito.");
        }
    };

    const imprimirRelatorio = () => {
        if (conflictData) {
            generateConflictReport(conflictData.pacientes, form.motivo);
        }
    };

    const handleDelete = async (id) => {
        if (await confirmDialog("Remover este bloqueio?", "Exclusão", "Sim, remover", "Cancelar")) {
            await api.delete(`agendamento/bloqueios/${id}/`);
            loadData();
        }
    }

    const inputClass = "w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-red-500 text-sm dark:text-white";

    return (
        <Layout>
            <div className="max-w-6xl mx-auto pb-20">
                <h1 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2 mb-6">
                    <CalendarX className="text-red-500"/> Bloqueios e Feriados
                </h1>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    {/* FORMULÁRIO */}
                    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 h-fit">
                        <h2 className="font-bold text-lg mb-4 dark:text-white">Novo Bloqueio</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Tipo</label>
                                <div className="flex gap-2">
                                    <button type="button" onClick={()=>setForm({...form, tipo: 'bloqueio'})} className={`flex-1 py-2 rounded-lg text-sm font-bold border transition-colors ${form.tipo === 'bloqueio' ? 'bg-slate-700 text-white border-slate-700' : 'text-slate-500 border-slate-200'}`}>Bloqueio</button>
                                    <button type="button" onClick={()=>setForm({...form, tipo: 'feriado', profissional: ''})} className={`flex-1 py-2 rounded-lg text-sm font-bold border transition-colors ${form.tipo === 'feriado' ? 'bg-red-500 text-white border-red-500' : 'text-slate-500 border-slate-200'}`}>Feriado</button>
                                </div>
                            </div>

                            {form.tipo === 'bloqueio' && (
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">Profissional</label>
                                    <select value={form.profissional} onChange={e=>setForm({...form, profissional: e.target.value})} className={inputClass}>
                                        <option value="">Todos os Profissionais</option>
                                        {profissionais.map(p => <option key={p.id} value={p.id}>{p.nome}</option>)}
                                    </select>
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-2">
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">Início</label><input type="date" value={form.data_inicio} onChange={e=>setForm({...form, data_inicio: e.target.value})} className={inputClass} required/></div>
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">Fim</label><input type="date" value={form.data_fim} onChange={e=>setForm({...form, data_fim: e.target.value})} className={inputClass} required/></div>
                            </div>
                            
                            {form.tipo === 'bloqueio' && (
                                <div className="grid grid-cols-2 gap-2">
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">Hora Início</label><input type="time" value={form.hora_inicio} onChange={e=>setForm({...form, hora_inicio: e.target.value})} className={inputClass}/></div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">Hora Fim</label><input type="time" value={form.hora_fim} onChange={e=>setForm({...form, hora_fim: e.target.value})} className={inputClass}/></div>
                                </div>
                            )}

                            <div><label className="block text-xs font-bold text-slate-500 mb-1">Motivo</label><input value={form.motivo} onChange={e=>setForm({...form, motivo: e.target.value})} className={inputClass} placeholder="Ex: Férias, Natal..." required/></div>

                            {form.tipo === 'feriado' && (
                                <label className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300">
                                    <input type="checkbox" checked={form.recorrente} onChange={e=>setForm({...form, recorrente: e.target.checked})}/>
                                    Repetir todos os anos
                                </label>
                            )}

                            <button type="submit" disabled={loading} className="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2">
                                {loading ? <Loader2 className="animate-spin"/> : <Save size={18}/>} Salvar Bloqueio
                            </button>
                        </form>
                    </div>

                    {/* LISTA */}
                    <div className="lg:col-span-2">
                        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                            <table className="w-full text-left">
                                <thead className="bg-slate-50 dark:bg-slate-700/50 text-slate-500 text-xs uppercase font-bold">
                                    <tr>
                                        <th className="px-6 py-4">Tipo</th>
                                        <th className="px-6 py-4">Data</th>
                                        <th className="px-6 py-4">Motivo / Profissional</th>
                                        <th className="px-6 py-4 text-right">Ação</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100 dark:divide-slate-700 text-sm">
                                    {bloqueios.map(b => (
                                        <tr key={b.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30">
                                            <td className="px-6 py-4">
                                                {b.tipo === 'feriado' 
                                                    ? <span className="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">FERIADO</span>
                                                    : <span className="bg-slate-200 text-slate-700 px-2 py-1 rounded text-xs font-bold">BLOQUEIO</span>
                                                }
                                                {b.recorrente && <span className="ml-2 text-xs text-blue-500 font-bold" title="Anual">↻</span>}
                                            </td>
                                            <td className="px-6 py-4 dark:text-white">
                                                {new Date(b.data_inicio).toLocaleDateString()}
                                                {b.data_inicio !== b.data_fim && ` até ${new Date(b.data_fim).toLocaleDateString()}`}
                                                {b.tipo === 'bloqueio' && <div className="text-xs text-slate-400">{b.hora_inicio.slice(0,5)} - {b.hora_fim.slice(0,5)}</div>}
                                            </td>
                                            <td className="px-6 py-4">
                                                <div className="font-bold text-slate-700 dark:text-white">{b.motivo}</div>
                                                <div className="text-xs text-slate-500">{b.nome_profissional || "Todos os Profissionais"}</div>
                                            </td>
                                            <td className="px-6 py-4 text-right">
                                                <button onClick={()=>handleDelete(b.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 size={16}/></button>
                                            </td>
                                        </tr>
                                    ))}
                                    {bloqueios.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-400">Nenhum bloqueio ativo.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                {/* MODAL DE CONFLITO */}
                {conflictData && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4">
                        <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-in zoom-in-95">
                            <div className="bg-orange-500 p-5 text-white flex justify-between items-center">
                                <h3 className="font-bold text-lg flex items-center gap-2"><AlertTriangle/> Conflitos Detectados</h3>
                                <button onClick={() => setConflictData(null)}><X/></button>
                            </div>
                            <div className="p-6">
                                <p className="text-slate-700 dark:text-slate-300 mb-4">
                                    Existem <strong>{conflictData.total} pacientes</strong> agendados neste período. O que deseja fazer?
                                </p>
                                
                                <button onClick={imprimirRelatorio} className="w-full mb-6 border border-slate-300 dark:border-slate-600 text-slate-600 dark:text-slate-300 font-bold py-3 rounded-xl flex items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-700">
                                    <FileDown size={20}/> Baixar Relatório de Afetados (PDF)
                                </button>

                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => resolverConflito('manter')} className="bg-blue-100 hover:bg-blue-200 text-blue-800 font-bold py-3 rounded-xl flex flex-col items-center justify-center gap-1 text-sm">
                                        <CheckCircle2 size={20}/>
                                        Bloquear e MANTER
                                        <span className="text-[10px] font-normal opacity-70">Agenda bloqueada, pacientes continuam lá</span>
                                    </button>
                                    <button onClick={() => resolverConflito('cancelar')} className="bg-red-100 hover:bg-red-200 text-red-800 font-bold py-3 rounded-xl flex flex-col items-center justify-center gap-1 text-sm">
                                        <Ban size={20}/>
                                        Bloquear e CANCELAR
                                        <span className="text-[10px] font-normal opacity-70">Cancela todos os agendamentos</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </Layout>
    );
}

============================================================
ARQUIVO: clinica-front/src/pages/Recepcao.jsx
============================================================
import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNotification } from '../context/NotificationContext';
import Layout from '../components/Layout';
import { 
    Search, CalendarClock, User, CheckCircle2, 
    Clock, DollarSign, AlertCircle, X, Save, Loader2, Pencil, UserX, RotateCcw 
} from 'lucide-react';

export default function Recepcao() {
    const { api } = useAuth();
    const { notify, confirmDialog } = useNotification();

    // --- ESTADOS ---
    const [loading, setLoading] = useState(false);
    const [agendamentos, setAgendamentos] = useState([]);
    const [profissionais, setProfissionais] = useState([]);
    
    // Filtros
    const [dataFiltro, setDataFiltro] = useState(new Date().toISOString().split('T')[0]); // Hoje
    const [profissionalFiltro, setProfissionalFiltro] = useState('');
    const [buscaTexto, setBuscaTexto] = useState('');
    
    // Filtro Visual (Legenda)
    const [statusVisiveis, setStatusVisiveis] = useState(['agendado', 'aguardando', 'em_atendimento', 'finalizado', 'faltou']);

    // Modal de Check-in
    const [modalOpen, setModalOpen] = useState(false);
    const [selectedItem, setSelectedItem] = useState(null);
    const [loadingCheckin, setLoadingCheckin] = useState(false);
    const [formCheckin, setFormCheckin] = useState({
        valor: '',
        forma_pagamento: 'dinheiro',
        pago: false
    });

    // --- CARREGAMENTO ---
    useEffect(() => {
        if(api) {
            api.get('profissionais/').then(res => {
                setProfissionais(res.data.results || res.data);
            });
        }
    }, [api]);

    useEffect(() => {
        if(api) carregarAgenda();
    }, [api, dataFiltro, profissionalFiltro]);

    // --- LÓGICA ---
    const carregarAgenda = async () => {
        setLoading(true);
        try {
            const params = new URLSearchParams();
            if (dataFiltro) params.append('data', dataFiltro);
            if (profissionalFiltro) params.append('profissional', profissionalFiltro);
            
            const res = await api.get(`agendamento/?${params.toString()}`);
            setAgendamentos(res.data.results || res.data);
        } catch (error) {
            console.error(error);
            notify.error("Erro ao carregar agenda.");
        } finally {
            setLoading(false);
        }
    };

    const verificarAtraso = (horario, status) => {
        if (status !== 'agendado') return false;
        const dataAgendamento = new Date(`${dataFiltro}T${horario}`);
        const agora = new Date();
        
        if (dataFiltro === agora.toISOString().split('T')[0]) {
           return agora > new Date(dataAgendamento.getTime() + 15*60000);
        }
        if (new Date(dataFiltro) < new Date(agora.setHours(0,0,0,0))) return true;

        return false;
    };

    const calcularIdade = (dataNasc) => {
        if (!dataNasc) return '-';
        const hoje = new Date();
        const nasc = new Date(dataNasc);
        let idade = hoje.getFullYear() - nasc.getFullYear();
        const m = hoje.getMonth() - nasc.getMonth();
        if (m < 0 || (m === 0 && hoje.getDate() < nasc.getDate())) idade--;
        return idade;
    };

    const itensFiltrados = agendamentos.filter(item => {
        if (!statusVisiveis.includes(item.status)) return false;
        if (buscaTexto) {
            const termo = buscaTexto.toLowerCase();
            return item.nome_paciente?.toLowerCase().includes(termo) || 
                   item.nome_profissional?.toLowerCase().includes(termo);
        }
        return true;
    });

    const toggleStatus = (status) => {
        if (statusVisiveis.includes(status)) {
            setStatusVisiveis(statusVisiveis.filter(s => s !== status));
        } else {
            setStatusVisiveis([...statusVisiveis, status]);
        }
    };

    const getStatusColor = (status) => {
        switch(status) {
            case 'agendado': return 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-800';
            case 'aguardando': return 'bg-yellow-100 text-yellow-700 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-300 dark:border-yellow-800';
            case 'em_atendimento': return 'bg-purple-100 text-purple-700 border-purple-200 dark:bg-purple-900/30 dark:text-purple-300 dark:border-purple-800';
            case 'finalizado': return 'bg-green-100 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-300 dark:border-green-800';
            case 'cancelado': return 'bg-red-100 text-red-700 border-red-200 dark:bg-red-900/30 dark:text-red-300 dark:border-red-800';
            case 'faltou': return 'bg-slate-200 text-slate-600 border-slate-300 dark:bg-slate-700 dark:text-slate-300 dark:border-slate-600';
            default: return 'bg-slate-100 text-slate-600';
        }
    };

    // --- AÇÕES ---
    const abrirCheckin = (item) => {
        setSelectedItem(item);
        setFormCheckin({
            valor: item.valor || '',
            forma_pagamento: item.fatura_forma_pagamento || 'dinheiro',
            pago: item.fatura_pago || false
        });
        setModalOpen(true);
    };

    const confirmarCheckin = async () => {
        setLoadingCheckin(true);
        try {
            await api.post(`agendamento/${selectedItem.id}/confirmar_chegada/`, formCheckin);
            const acao = selectedItem.status === 'agendado' ? 'Chegada confirmada' : 'Dados atualizados';
            notify.success(`${acao} com sucesso!`);
            setModalOpen(false);
            carregarAgenda();
        } catch (error) {
            console.error(error);
            notify.error("Erro ao salvar dados.");
        } finally {
            setLoadingCheckin(false);
        }
    };

    const handleMarcarFalta = async (item) => {
        const confirm = await confirmDialog(
            `Confirmar que o paciente ${item.nome_paciente} FALTOU à consulta?`,
            "Registrar Falta",
            "Sim, Faltou",
            "Cancelar",
            "danger"
        );
        if (confirm) {
            try {
                await api.post(`agendamento/${item.id}/marcar_falta/`);
                notify.info("Falta registrada.");
                carregarAgenda();
            } catch (error) { notify.error("Erro ao registrar falta."); }
        }
    };

    // --- REVERTER: AGORA SUPORTA "FALTOU" ---
    const handleReverter = async (item) => {
        let mensagem = "";
        let titulo = "";
        
        if (item.status === 'aguardando') {
            titulo = "Desfazer Recepção";
            mensagem = `Deseja desfazer a recepção de ${item.nome_paciente}? Isso apagará os dados financeiros gerados para este atendimento.`;
        } else if (item.status === 'faltou') {
            titulo = "Remover Falta";
            mensagem = `Deseja remover a falta de ${item.nome_paciente} e retorná-lo para a lista de agendados?`;
        } else {
            return; // Outros status não revertem por aqui
        }

        const confirm = await confirmDialog(
            mensagem,
            titulo,
            "Sim, Reverter",
            "Cancelar",
            "warning"
        );

        if (confirm) {
            try {
                await api.post(`agendamento/${item.id}/reverter_chegada/`);
                notify.info("Status revertido para 'Agendado'.");
                carregarAgenda();
            } catch (error) {
                notify.error("Erro ao reverter status.");
            }
        }
    };

    const inputClass = "w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-blue-500 text-sm dark:text-white transition-all";

    return (
        <Layout>
            <div className="max-w-7xl mx-auto pb-20">
                <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div>
                        <h1 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <CheckCircle2 className="text-green-600"/> Recepção
                        </h1>
                        <p className="text-slate-500 dark:text-slate-400 text-sm">Gerencie a chegada e fluxo de pacientes.</p>
                    </div>
                </div>

                {/* --- BARRA DE FILTROS --- */}
                <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6 flex flex-col lg:flex-row gap-4">
                    <div className="w-full lg:w-48">
                        <label className="text-xs font-bold text-slate-500 mb-1 block">Data</label>
                        <input type="date" value={dataFiltro} onChange={e => setDataFiltro(e.target.value)} className={inputClass}/>
                    </div>
                    <div className="w-full lg:w-64">
                        <label className="text-xs font-bold text-slate-500 mb-1 block">Profissional</label>
                        <select value={profissionalFiltro} onChange={e => setProfissionalFiltro(e.target.value)} className={inputClass}>
                            <option value="">Todos os profissionais</option>
                            {profissionais.map(p => <option key={p.id} value={p.id}>{p.nome}</option>)}
                        </select>
                    </div>
                    <div className="flex-1">
                        <label className="text-xs font-bold text-slate-500 mb-1 block">Buscar Paciente</label>
                        <div className="relative">
                            <Search className="absolute left-3 top-2.5 text-slate-400" size={18} />
                            <input placeholder="Nome do paciente..." value={buscaTexto} onChange={e => setBuscaTexto(e.target.value)} className={`${inputClass} pl-10`}/>
                        </div>
                    </div>
                </div>

                {/* --- LEGENDA --- */}
                <div className="flex flex-wrap gap-2 mb-4 animate-in fade-in slide-in-from-top-2">
                    {['agendado', 'aguardando', 'em_atendimento', 'finalizado', 'faltou'].map(status => (
                        <button key={status} onClick={() => toggleStatus(status)} className={`px-3 py-1 rounded-full text-xs font-bold border transition-all uppercase flex items-center gap-1 ${statusVisiveis.includes(status) ? getStatusColor(status) + ' shadow-sm scale-105' : 'bg-slate-50 text-slate-400 border-slate-200 dark:bg-slate-800 dark:border-slate-700 opacity-60'}`}>
                            {status === 'agendado' && <CalendarClock size={12}/>}
                            {status === 'aguardando' && <Clock size={12}/>}
                            {status === 'faltou' && <UserX size={12}/>}
                            {status.replace('_', ' ')}
                        </button>
                    ))}
                </div>

                {/* --- TABELA --- */}
                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden min-h-[400px]">
                    <div className="overflow-x-auto">
                        <table className="w-full text-left">
                            <thead className="bg-slate-50 dark:bg-slate-700/50 border-b border-slate-200 dark:border-slate-700">
                                <tr>
                                    <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Horário</th>
                                    <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Status</th>
                                    <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Paciente</th>
                                    <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase">Profissional</th>
                                    <th className="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase">Ação</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                                {loading ? (
                                    <tr><td colSpan="5" className="p-10 text-center"><Loader2 className="animate-spin mx-auto text-blue-600 mb-2"/>Carregando agenda...</td></tr>
                                ) : itensFiltrados.length === 0 ? (
                                    <tr><td colSpan="5" className="p-10 text-center text-slate-400">Nenhum paciente encontrado para os filtros.</td></tr>
                                ) : (
                                    itensFiltrados.map((item) => {
                                        const atrasado = verificarAtraso(item.horario, item.status);
                                        const idade = item.detalhes_pdf?.paciente_nascimento ? calcularIdade(item.detalhes_pdf.paciente_nascimento) : '';

                                        return (
                                            <tr key={item.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                                                <td className="px-6 py-4">
                                                    <div className={`font-bold text-lg ${atrasado ? 'text-red-500 animate-pulse flex items-center gap-1' : 'text-slate-700 dark:text-white'}`}>
                                                        {item.horario.substring(0, 5)}
                                                        {atrasado && <AlertCircle size={14}/>}
                                                    </div>
                                                    {atrasado && <div className="text-[10px] text-red-500 font-bold uppercase">Atrasado</div>}
                                                </td>

                                                <td className="px-6 py-4">
                                                    <span className={`px-2.5 py-1 rounded-full text-xs font-bold border ${getStatusColor(item.status)}`}>
                                                        {item.status.replace('_', ' ').toUpperCase()}
                                                    </span>
                                                </td>

                                                <td className="px-6 py-4">
                                                    <div className="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                                                        {item.nome_paciente}
                                                    </div>
                                                    <div className="text-xs text-slate-500 flex items-center gap-2 mt-0.5">
                                                        <User size={12}/> {idade ? `${idade} anos` : 'Idade n/d'} 
                                                        {item.nome_convenio && <span className="bg-slate-100 dark:bg-slate-700 px-1.5 rounded text-slate-600 dark:text-slate-300 font-medium">{item.nome_convenio}</span>}
                                                    </div>
                                                </td>

                                                <td className="px-6 py-4 text-sm text-slate-600 dark:text-slate-300">
                                                    <div className="font-medium">{item.nome_profissional}</div>
                                                    <div className="text-xs text-slate-400">{item.nome_especialidade}</div>
                                                </td>

                                                <td className="px-6 py-4 text-right">
                                                    <div className="flex justify-end items-center gap-2">
                                                        {/* Ícone de Pagamento */}
                                                        {item.fatura_pago ? (
                                                            <div title="Pago" className="text-green-500 p-2"><DollarSign size={20}/></div>
                                                        ) : (
                                                            <div title="Pagamento Pendente" className="text-slate-300 p-2"><DollarSign size={20}/></div>
                                                        )}

                                                        {/* BOTOES AGENDADO */}
                                                        {item.status === 'agendado' && (
                                                            <>
                                                                <button onClick={() => handleMarcarFalta(item)} className="text-slate-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors border border-transparent" title="Marcar Falta"><UserX size={18}/></button>
                                                                <button onClick={() => abrirCheckin(item)} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md transition-transform active:scale-95 flex items-center gap-2"><CheckCircle2 size={16}/> Confirmar</button>
                                                            </>
                                                        )}

                                                        {/* BOTOES AGUARDANDO (EDITAR E REVERTER) */}
                                                        {(item.status === 'aguardando') && (
                                                            <>
                                                                <button onClick={() => handleReverter(item)} className="text-orange-500 hover:bg-orange-50 dark:hover:bg-orange-900/30 p-2 rounded-lg transition-colors border border-transparent hover:border-orange-200" title="Desfazer Recepção"><RotateCcw size={18}/></button>
                                                                <button onClick={() => abrirCheckin(item)} className="text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 p-2 rounded-lg transition-colors border border-transparent hover:border-blue-200" title="Editar dados"><Pencil size={18}/></button>
                                                            </>
                                                        )}
                                                        
                                                        {/* BOTAO REVERTER FALTA */}
                                                        {(item.status === 'faltou') && (
                                                             <button onClick={() => handleReverter(item)} className="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 p-2 rounded-lg transition-colors border border-transparent" title="Desfazer Falta"><RotateCcw size={18}/></button>
                                                        )}

                                                        {/* BOTAO EDITAR (EM ATENDIMENTO) */}
                                                        {item.status === 'em_atendimento' && (
                                                            <button onClick={() => abrirCheckin(item)} className="text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/30 p-2 rounded-lg transition-colors border border-transparent hover:border-blue-200" title="Editar dados"><Pencil size={18}/></button>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>

                {/* --- MODAL DE CHECK-IN --- */}
                {modalOpen && selectedItem && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                        <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                            <div className="bg-green-600 p-5 text-white flex justify-between items-center">
                                <h3 className="font-bold text-lg flex items-center gap-2"><CheckCircle2/> {selectedItem.status === 'agendado' ? 'Confirmar Chegada' : 'Editar Recepção'}</h3>
                                <button onClick={() => setModalOpen(false)}><X/></button>
                            </div>
                            <div className="p-6 space-y-4">
                                <div className="bg-slate-50 dark:bg-slate-900 p-3 rounded-lg text-center mb-4">
                                    <p className="text-sm text-slate-500">Paciente</p>
                                    <p className="font-bold text-lg text-slate-800 dark:text-white">{selectedItem.nome_paciente}</p>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1">Valor da Consulta (R$)</label>
                                    <input type="number" value={formCheckin.valor} onChange={e => setFormCheckin({...formCheckin, valor: e.target.value})} className={inputClass}/>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1">Forma de Pagamento</label>
                                    <select value={formCheckin.forma_pagamento} onChange={e => setFormCheckin({...formCheckin, forma_pagamento: e.target.value})} className={inputClass}>
                                        <option value="dinheiro">Dinheiro</option>
                                        <option value="pix">Pix</option>
                                        <option value="cartao_credito">Cartão de Crédito</option>
                                        <option value="cartao_debito">Cartão de Débito</option>
                                        <option value="convenio">Convênio</option>
                                        <option value="pendente">A Definir / Pagar Depois</option>
                                    </select>
                                </div>
                                <label className="flex items-center gap-3 p-3 border border-slate-200 dark:border-slate-700 rounded-lg cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                                    <input type="checkbox" checked={formCheckin.pago} onChange={e => setFormCheckin({...formCheckin, pago: e.target.checked})} className="w-5 h-5 rounded text-blue-600 focus:ring-blue-500"/>
                                    <span className="text-sm font-bold text-slate-700 dark:text-white">Pagamento já realizado?</span>
                                </label>
                                <div className="pt-4 flex gap-3 justify-end">
                                    <button onClick={() => setModalOpen(false)} className="px-4 py-2 text-slate-600 font-bold hover:bg-slate-100 rounded-lg">Cancelar</button>
                                    <button onClick={confirmarCheckin} disabled={loadingCheckin} className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg disabled:opacity-50">{loadingCheckin ? <Loader2 className="animate-spin" size={18}/> : <Save size={18}/>} {selectedItem.status === 'agendado' ? 'Confirmar' : 'Salvar Alterações'}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </Layout>
    );
}

============================================================
ARQUIVO: clinica-front/src/pages/MarcarConsulta.jsx
============================================================
import React, { useState, useEffect, useRef } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNotification } from '../context/NotificationContext';
import Layout from '../components/Layout';
import Calendar from 'react-calendar';
import 'react-calendar/dist/Calendar.css';
import { 
  Calendar as CalendarIcon, X, Plus, Trash2, Pencil, Loader2, Save, UserPlus, MapPin, ChevronDown, Check, AlertCircle, DollarSign, Printer, ShieldCheck, Lock 
} from 'lucide-react';
import { generateAppointmentReceipt } from '../utils/generateReceipt';

const calendarStyles = `
  .react-calendar { width: 100%; border: none; font-family: inherit; background: transparent; }
  .react-calendar__tile--now { background: transparent !important; color: #2563eb !important; border: 2px solid #2563eb !important; }
  
  /* ESTILOS NOVOS */
  .dia-livre { background-color: #dcfce7 !important; color: #166534 !important; border: 1px solid #bbf7d0 !important; font-weight: bold; }
  .dia-feriado { background-color: #fee2e2 !important; color: #b91c1c !important; border: 1px solid #fecaca !important; cursor: not-allowed !important; opacity: 0.8; }
  .dia-bloqueado { background-color: #f1f5f9 !important; color: #64748b !important; border: 1px solid #cbd5e1 !important; cursor: not-allowed !important; text-decoration: line-through; }
  
  /* Agenda Encerrada (Visualização no Calendário) - Opcional, pode usar dia-livre também, mas aqui diferenciamos se quiser */
  .dia-encerrado { background-color: #f3f4f6 !important; color: #6b7280 !important; border: 1px solid #e5e7eb !important; }

  .react-calendar__tile--active { background: #2563eb !important; color: white !important; border: none !important; }
  .react-calendar__tile:disabled { background-color: #f3f4f6 !important; color: #9ca3af !important; }
`;

const SearchableSelect = ({ label, options, value, onChange, placeholder, disabled }) => {
    const [isOpen, setIsOpen] = useState(false);
    const [query, setQuery] = useState('');
    const containerRef = useRef(null);

    useEffect(() => { 
        const selected = options.find(o => String(o.id) === String(value)); 
        if (selected) setQuery(selected.label);
        else if (!value) setQuery('');
    }, [value, options]); 

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (containerRef.current && !containerRef.current.contains(event.target)) {
                setIsOpen(false);
                const selected = options.find(o => String(o.id) === String(value));
                setQuery(selected ? selected.label : '');
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, [containerRef, value, options]);

    const filtered = (query === '' || query === (options.find(o => String(o.id) === String(value))?.label)) 
        ? options 
        : options.filter(o => o.label.toLowerCase().includes(query.toLowerCase()));
    
    const handleSelect = (id, label) => {
        onChange(id);
        setQuery(label);
        setIsOpen(false);
    };

    const handleClear = (e) => {
        e.stopPropagation();
        onChange('');
        setQuery('');
        setIsOpen(false);
    };

    return (
        <div className="relative mb-4" ref={containerRef}>
            <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1">{label}</label>
            <div className="relative">
                <input 
                    type="text" disabled={disabled}
                    className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 pr-10 outline-none focus:ring-2 focus:ring-blue-500 text-sm dark:text-white disabled:opacity-50 disabled:bg-slate-200 dark:disabled:bg-slate-800 disabled:text-slate-500 cursor-pointer disabled:cursor-not-allowed" 
                    value={query} 
                    onFocus={() => !disabled && setIsOpen(true)}
                    onClick={() => !disabled && setIsOpen(true)}
                    onChange={e => { setQuery(e.target.value); setIsOpen(true); }} 
                    placeholder={placeholder} autoComplete="off"
                />
                <div className="absolute right-2 top-2.5 flex items-center gap-1 text-slate-400">
                    {value && !disabled && (
                        <button onClick={handleClear} className="hover:text-red-500 p-0.5 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"><X size={14}/></button>
                    )}
                    <ChevronDown size={16} className={`transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}/>
                </div>
            </div>
            {isOpen && !disabled && (
                <ul className="absolute z-[100] w-full bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg shadow-2xl max-h-60 overflow-auto mt-1 animate-in fade-in zoom-in duration-100">
                    {filtered.length > 0 ? filtered.map(opt => (
                        <li key={opt.id} onMouseDown={() => handleSelect(opt.id, opt.label)} className={`p-2.5 cursor-pointer text-sm border-b last:border-0 border-slate-100 dark:border-slate-700 flex justify-between items-center transition-colors ${String(value) === String(opt.id) ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-bold' : 'hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200'}`}>
                            {opt.label}
                            {String(value) === String(opt.id) && <Check size={14}/>}
                        </li>
                    )) : <li className="p-3 text-sm text-slate-400 text-center">Nenhum resultado.</li>}
                </ul>
            )}
        </div>
    );
};

export default function MarcarConsulta() {
  const { api } = useAuth();
  const { notify, confirmDialog } = useNotification();
  
  const [profissionais, setProfissionais] = useState([]);
  const [especialidades, setEspecialidades] = useState([]);
  const [pacientes, setPacientes] = useState([]); 
  const [convenios, setConvenios] = useState([]);
  
  const [profissionalId, setProfissionalId] = useState('');
  const [especialidadeId, setEspecialidadeId] = useState('');
  const [dateValue, setDateValue] = useState(new Date());

  const [modalOpen, setModalOpen] = useState(false);
  const [tipoModal, setTipoModal] = useState(''); 
  const [horarioSelecionado, setHorarioSelecionado] = useState('');
  const [valorSelecionado, setValorSelecionado] = useState(''); 
  const [pacienteId, setPacienteId] = useState('');
  const [convenioId, setConvenioId] = useState('');
  const [convenioTravado, setConvenioTravado] = useState(false);
  
  const [encaixeHora, setEncaixeHora] = useState('');
  const [observacao, setObservacao] = useState('');
  const [loadingSave, setLoadingSave] = useState(false);
  const [agendamentoIdEditar, setAgendamentoIdEditar] = useState(null); 

  const [modalPacienteOpen, setModalPacienteOpen] = useState(false);
  const [loadingCep, setLoadingCep] = useState(false);
  const [loadingPaciente, setLoadingPaciente] = useState(false);
  
  const formInicialPaciente = { nome: '', nome_mae: '', sexo: '', cpf: '', data_nascimento: '', telefone: '', cep: '', logradouro: '', numero: '', complemento: '', bairro: '', cidade: '', estado: '' };
  const [novoPaciente, setNovoPaciente] = useState(formInicialPaciente);

  const [listaBloqueios, setListaBloqueios] = useState([]);

  const getLocalISODate = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
  };

  const isDateInPast = (date) => {
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      return date < hoje;
  };

  const [dataApi, setDataApi] = useState(getLocalISODate(new Date()));
  const [vagasDoDia, setVagasDoDia] = useState([]);
  const [regrasProfissional, setRegrasProfissional] = useState([]); 

  // Carrega listas iniciais
  useEffect(() => {
    if (api) {
        api.get('profissionais/').then(res => setProfissionais(res.data.results?.map(p => ({ id: p.id, label: p.nome })) || []));
        api.get('pacientes/lista/').then(res => setPacientes(res.data.results?.map(p => ({ id: p.id, label: `${p.nome} - ${p.cpf}` })) || []));
        api.get('configuracoes/convenios/').then(res => setConvenios(res.data.results?.map(c => ({ id: c.id, label: c.nome })) || []));
        
        api.get('agendamento/bloqueios/').then(res => setListaBloqueios(res.data.results || res.data));
    }
  }, [api]);

  useEffect(() => {
    if (profissionalId) {
        api.get(`profissionais/${profissionalId}/`).then(res => {
            const specs = res.data.especialidades.map(v => ({ id: v.especialidade_leitura || v.especialidade_id, label: v.nome_especialidade }));
            setEspecialidades(specs);
            if(specs.length === 1) setEspecialidadeId(specs[0].id);
            else setEspecialidadeId('');
        });
        
        // --- ALTERAÇÃO AQUI: STATUS 'TODOS' PARA TRAZER AGENDAS ENCERRADAS ---
        api.get(`agendas/config/?status=todos&profissional_id=${profissionalId}&nopage=true`)
            .then(res => setRegrasProfissional(res.data))
            .catch(e => console.error(e));
    } else {
        setEspecialidades([]);
        setEspecialidadeId('');
        setRegrasProfissional([]);
    }
  }, [profissionalId, api]);

  useEffect(() => {
    if (profissionalId && especialidadeId && dataApi) carregarAgenda();
    else setVagasDoDia([]);
  }, [profissionalId, especialidadeId, dataApi, regrasProfissional]);

  const carregarAgenda = async () => {
    try {
        const res = await api.get(`agendamento/?profissional=${profissionalId}&especialidade=${especialidadeId}&data=${dataApi}`);
        const agendamentos = res.data.results || res.data;
        gerarVisualizacao(regrasProfissional, agendamentos);
    } catch (e) { console.error(e); }
  };

  const getTileClassName = ({ date, view }) => {
    if (view !== 'month') return null;
    
    const dataIso = getLocalISODate(date);
    const diaMes = dataIso.slice(5);

    // 1. Bloqueios e Feriados
    const bloqueio = listaBloqueios.find(b => {
        const bateData = (b.data_inicio <= dataIso && b.data_fim >= dataIso);
        const bateRecorrente = b.recorrente && (b.data_inicio.slice(5) === diaMes);
        const bateProf = !b.profissional || (profissionalId && b.profissional === parseInt(profissionalId));
        return (bateData || bateRecorrente) && bateProf;
    });

    if (bloqueio) return bloqueio.tipo === 'feriado' ? 'dia-feriado' : 'dia-bloqueado';

    // 2. Agendas
    if (!especialidadeId) return null;
    const jsDay = date.getDay();
    
    // Procura alguma regra válida para o dia (ATIVA ou ENCERRADA)
    const regraEncontrada = regrasProfissional.find(r => 
        (r.dia_semana === jsDay) && 
        String(r.especialidade) === String(especialidadeId) && 
        (r.data_inicio <= dataIso && r.data_fim >= dataIso)
    );

    if (regraEncontrada) {
        // Se a regra existe mas está encerrada (situacao=false), pinta diferente (opcional)
        // Se quiser que apareça verde igual, retorne 'dia-livre'. 
        // Se quiser cinza, retorne 'dia-encerrado'.
        // O pedido foi "aparecer no calendario", então vamos manter 'dia-livre' para indicar que "houve agenda"
        return 'dia-livre'; 
    }
    
    return null;
  };

  const gerarVisualizacao = (regras, agendamentos) => {
    let slots = [];
    const jsDay = dateValue.getDay(); 
    
    // Verifica bloqueio explícito (Férias/Feriado)
    const dataIso = getLocalISODate(dateValue);
    const diaMes = dataIso.slice(5);
    const bloqueioAtivo = listaBloqueios.find(b => {
        const bateData = (b.data_inicio <= dataIso && b.data_fim >= dataIso);
        const bateRecorrente = b.recorrente && (b.data_inicio.slice(5) === diaMes);
        const bateProf = !b.profissional || (profissionalId && b.profissional === parseInt(profissionalId));
        return (bateData || bateRecorrente) && bateProf;
    });

    const regrasFiltradas = regras.filter(r => 
        r.dia_semana === jsDay && 
        r.data_inicio <= dataApi && 
        r.data_fim >= dataApi && 
        String(r.especialidade) === String(especialidadeId)
    );

    // Gera slots mesmo se tiver bloqueio ou agenda encerrada
    // Apenas marcamos as flags para desabilitar depois
    regrasFiltradas.forEach(regra => {
        const valorRegra = parseFloat(regra.valor || 0);
        const convenioRegraNome = regra.convenio_nome; 
        const convenioRegraId = regra.convenio;
        
        // Flag para indicar que a agenda base está fechada/encerrada
        const agendaEncerrada = (regra.situacao === false) || !!bloqueioAtivo;

        if (regra.tipo === 'fixo') {
            const qtd = regra.quantidade_atendimentos || 1;
            for (let i = 0; i < qtd; i++) {
                slots.push({ 
                    hora: regra.hora_inicio.slice(0,5), 
                    valor: valorRegra, 
                    ocupado: false, 
                    convenio_regra_nome: convenioRegraNome,
                    convenio_regra_id: convenioRegraId,
                    agenda_fechada: agendaEncerrada // Nova prop
                });
            }
        } else {
            let atual = parseInt(regra.hora_inicio.split(':')[0]) * 60 + parseInt(regra.hora_inicio.split(':')[1]);
            const fim = parseInt(regra.hora_fim.split(':')[0]) * 60 + parseInt(regra.hora_fim.split(':')[1]);
            while (atual < fim) {
                const h = Math.floor(atual/60).toString().padStart(2,'0');
                const m = (atual%60).toString().padStart(2,'0');
                const horaFormatada = `${h}:${m}`;
                const qtdVagas = regra.quantidade_atendimentos > 0 ? regra.quantidade_atendimentos : 1;
                for (let i = 0; i < qtdVagas; i++) {
                    slots.push({ 
                        hora: horaFormatada, 
                        valor: valorRegra, 
                        ocupado: false, 
                        convenio_regra_nome: convenioRegraNome,
                        convenio_regra_id: convenioRegraId,
                        agenda_fechada: agendaEncerrada // Nova prop
                    });
                }
                atual += regra.intervalo_minutos;
            }
        }
    });

    let rests = [...agendamentos];
    const final = slots.map(s => {
        const idx = rests.findIndex(a => a.horario.slice(0,5) === s.hora);
        if (idx !== -1) {
            const a = rests.splice(idx, 1)[0];
            return { 
                ...s, 
                ocupado: true, 
                paciente: a.nome_paciente, 
                agendamento_id: a.id, 
                paciente_id: a.paciente, 
                convenio_id: a.convenio, 
                convenio_nome: a.nome_convenio, 
                observacoes: a.observacoes,
                is_encaixe: a.is_encaixe,
                valor: parseFloat(a.valor || s.valor)
            };
        }
        return s;
    });
    
    rests.forEach(a => final.push({ 
        hora: a.horario.slice(0,5), 
        valor: parseFloat(a.valor || 0), 
        ocupado: true, 
        paciente: a.nome_paciente, 
        agendamento_id: a.id, 
        is_encaixe: true, 
        paciente_id: a.paciente,
        convenio_id: a.convenio,
        convenio_nome: a.nome_convenio,
        observacoes: a.observacoes
    }));
    
    setVagasDoDia(final.sort((a,b) => a.hora.localeCompare(b.hora)));
  };

  const abrirAgendar = (slot) => {
      setAgendamentoIdEditar(null);
      setHorarioSelecionado(slot.hora);
      setValorSelecionado(slot.valor);
      setTipoModal('normal');
      setPacienteId(''); 
      setObservacao('');
      
      if (slot.convenio_regra_id) {
          setConvenioId(slot.convenio_regra_id);
          setConvenioTravado(true);
      } else {
          setConvenioId('');
          setConvenioTravado(false);
      }
      
      setModalOpen(true);
  };

  const abrirEncaixe = () => {
     if(isDateInPast(dateValue)) {
         notify.warning("Não é possível criar encaixe em datas passadas.");
         return;
     }
     setAgendamentoIdEditar(null); 
     setTipoModal('encaixe'); 
     setValorSelecionado(''); 
     setConvenioId('');
     setConvenioTravado(false);
     setModalOpen(true); 
  };

  const abrirEditar = (slot) => {
      setAgendamentoIdEditar(slot.agendamento_id);
      setHorarioSelecionado(slot.hora);
      setValorSelecionado(slot.valor);
      setPacienteId(slot.paciente_id); 
      setConvenioId(slot.convenio_id || ''); 
      setObservacao(slot.observacoes || '');
      setTipoModal(slot.is_encaixe ? 'encaixe' : 'normal');
      if(slot.is_encaixe) setEncaixeHora(slot.hora);
      setConvenioTravado(false);
      setModalOpen(true);
  };

  const handleImprimir = async () => {
    if (!agendamentoIdEditar) return;
    try {
        const res = await api.get(`agendamento/${agendamentoIdEditar}/`);
        generateAppointmentReceipt(res.data);
    } catch (error) {
        notify.error("Erro ao gerar comprovante.");
    }
  };

  const handleImprimirSlot = async (e, id) => {
      e.stopPropagation();
      try {
          const res = await api.get(`agendamento/${id}/`);
          generateAppointmentReceipt(res.data);
      } catch (e) {
          notify.error("Erro ao gerar comprovante.");
      }
  };

  const salvarAgendamento = async () => {
    if (!pacienteId) return notify.error("Selecione um paciente.");
    setLoadingSave(true);
    const hora = tipoModal === 'encaixe' ? encaixeHora : horarioSelecionado;
    try {
        const payload = { 
            profissional: profissionalId, 
            especialidade: especialidadeId, 
            paciente: pacienteId, 
            data: dataApi, 
            horario: hora, 
            convenio: convenioId || null, 
            valor: valorSelecionado, 
            observacoes: observacao, 
            is_encaixe: tipoModal === 'encaixe' 
        };
        
        if(agendamentoIdEditar) {
            await api.put(`agendamento/${agendamentoIdEditar}/`, payload);
            notify.success("Agendamento atualizado!");
        } else {
            const { data } = await api.post('agendamento/', payload);
            notify.success("Agendamento criado!");
            generateAppointmentReceipt(data);
        }
        setModalOpen(false);
        carregarAgenda();
    } catch (e) { notify.error("Erro ao salvar: " + (e.response?.data?.detail || "Erro interno")); }
    finally { setLoadingSave(false); }
  };

  const handleExcluirAgendamento = async (e, id) => {
      e.stopPropagation();
      const confirmado = await confirmDialog("Excluir este agendamento?", "Exclusão", "Sim, excluir", "Cancelar", "danger");
      if (confirmado) {
          try {
              await api.delete(`agendamento/${id}/`);
              notify.success("Agendamento excluído.");
              carregarAgenda();
          } catch (e) { notify.error("Erro ao excluir agendamento."); }
      }
  };

  const mascaraCPF = (v) => v.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})/, '$1-$2').slice(0, 14);
  const mascaraTelefone = (v) => v.replace(/\D/g, '').replace(/(\d{2})(\d)/, '($1) $2').replace(/(\d{5})(\d)/, '$1-$2').slice(0, 15);
  const mascaraCEP = (v) => v.replace(/\D/g, '').replace(/(\d{5})(\d)/, '$1-$2').slice(0, 9);
  const handlePacienteChange = (e) => { 
      let { name, value } = e.target; 
      if (name === 'cpf') value = mascaraCPF(value);
      if (name === 'telefone') value = mascaraTelefone(value);
      if (name === 'cep') value = mascaraCEP(value);
      setNovoPaciente({ ...novoPaciente, [name]: value }); 
  };
  const buscarCep = async () => {
      const cepLimpo = novoPaciente.cep.replace(/\D/g, '');
      if (cepLimpo.length !== 8) return;
      setLoadingCep(true);
      try {
          const res = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
          const data = await res.json();
          if(!data.erro) {
              setNovoPaciente(prev => ({ ...prev, logradouro: data.logradouro, bairro: data.bairro, cidade: data.localidade, estado: data.uf }));
              document.getElementById('modal-numero')?.focus();
          }
      } finally { setLoadingCep(false); }
  };

  // --- FUNÇÃO CORRIGIDA E OTIMIZADA ---
  const salvarPacienteCompleto = async (e) => {
      e.preventDefault();
      setLoadingPaciente(true); 
      
      try {
          const { data } = await api.post('pacientes/', novoPaciente);
          
          notify.success("Paciente cadastrado com sucesso!");

          const novoItemParaLista = { 
              id: data.id, 
              label: `${data.nome} - ${data.cpf}` 
          };

          setPacientes(prevLista => [novoItemParaLista, ...prevLista]);
          setModalPacienteOpen(false);
          setNovoPaciente(formInicialPaciente);

          setTimeout(() => {
              setPacienteId(data.id);
          }, 100);

      } catch (error) { 
          console.error("Erro no cadastro:", error);
          if (error.response?.data?.cpf) {
              notify.warning("Atenção: Este CPF já está cadastrado!");
          } 
          else if (error.response?.data) {
              const msg = Object.values(error.response.data).flat()[0];
              notify.error(`Erro: ${msg || "Verifique os dados."}`);
          }
          else {
              notify.error("Erro de conexão ou processamento."); 
          }
      } finally {
          setLoadingPaciente(false);
      }
  };

  const inputClass = "w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-blue-500 text-sm dark:text-white";

  return (
    <Layout>
      <style>{calendarStyles}</style>
      <div className="max-w-7xl mx-auto pb-20">
        <div className="flex items-center gap-3 mb-6">
            <div className="bg-blue-600 p-3 rounded-xl text-white shadow"><CalendarIcon size={28}/></div>
            <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Marcar Consulta</h1>
        </div>

        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <SearchableSelect label="Profissional" options={profissionais} value={profissionalId} onChange={(id) => { setProfissionalId(id); }} placeholder="Médico..." />
            <SearchableSelect label="Especialidade" options={especialidades} value={especialidadeId} onChange={setEspecialidadeId} placeholder="Especialidade..." disabled={!profissionalId} />
        </div>

        {profissionalId && especialidadeId && (
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 animate-in fade-in duration-300">
                <div className="lg:col-span-4 bg-white dark:bg-slate-800 p-6 rounded-xl shadow border border-slate-200 dark:border-slate-700">
                    <Calendar 
                        onChange={(d) => { setDateValue(d); setDataApi(getLocalISODate(d)); }} 
                        value={dateValue} 
                        locale="pt-BR" 
                        tileClassName={getTileClassName}
                    />
                    
                    <div className="mt-8 pt-6 border-t border-slate-100 dark:border-slate-700">
                        <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Legenda do Calendário</h4>
                        <div className="flex flex-col gap-3 text-xs text-slate-600 dark:text-slate-300">
                            <div className="flex items-center gap-2">
                                <div className="w-4 h-4 rounded border" style={{backgroundColor: '#dcfce7', borderColor: '#bbf7d0'}}></div> 
                                <span>Dias com Vagas</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="w-4 h-4 rounded border" style={{backgroundColor: '#fee2e2', borderColor: '#fecaca'}}></div> 
                                <span>Bloqueios / Feriados</span>
                            </div>
                            {/* ADICIONADO PARA CLAREZA */}
                            <div className="flex items-center gap-2">
                                <div className="w-4 h-4 rounded border" style={{backgroundColor: '#f3f4f6', borderColor: '#e5e7eb'}}></div> 
                                <span>Sem Vagas / Encerrada</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="lg:col-span-8 bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 flex flex-col h-[550px]">
                    <div className="p-5 border-b flex justify-between items-center dark:border-slate-700">
                        <h3 className="font-bold text-lg dark:text-white uppercase">{dateValue.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' })}</h3>
                        <button onClick={abrirEncaixe} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2 shadow-sm transition-all"><Plus size={16}/> Encaixe</button>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 gap-3 content-start">
                        {vagasDoDia.length > 0 ? vagasDoDia.map((slot, idx) => {
                            const isPast = isDateInPast(dateValue);
                            // Se a agenda estiver fechada E não estiver ocupada, bloqueia
                            const isLocked = slot.agenda_fechada && !slot.ocupado; 
                            
                            return (
                                <div 
                                    key={idx} 
                                    onClick={() => {
                                        // TRAVAS DE CLIQUE
                                        if (slot.ocupado) return; 
                                        if (isLocked) {
                                            notify.warning("Esta agenda está encerrada ou bloqueada.");
                                            return;
                                        }
                                        if (isPast) {
                                            notify.warning("Não é possível agendar em datas passadas.");
                                            return;
                                        }
                                        abrirAgendar(slot);
                                    }} 
                                    className={`relative p-3 rounded-xl border-2 flex justify-between items-center transition-all duration-200 ${
                                        slot.is_encaixe ? 'bg-yellow-50 border-yellow-200 hover:border-yellow-400' : 
                                        slot.ocupado ? 'bg-slate-50 border-slate-200 opacity-90' : 
                                        isLocked ? 'bg-gray-100 border-gray-200 cursor-not-allowed opacity-70' : // ESTILO BLOQUEADO/ENCERRADO
                                        isPast ? 'bg-slate-50 border-slate-200 cursor-not-allowed opacity-60' : 'bg-white border-green-200 hover:border-green-500 cursor-pointer hover:shadow-md'
                                    }`}
                                >
                                    <div className="flex items-center gap-3 overflow-hidden">
                                        <div className={`text-lg font-bold w-16 text-center py-1 rounded-lg ${
                                            slot.is_encaixe ? 'bg-yellow-100 text-yellow-700' : 
                                            isLocked ? 'bg-gray-200 text-gray-500' : // Cor da hora se bloqueado
                                            slot.ocupado ? 'bg-slate-200 text-slate-500' : 'bg-blue-100 text-blue-700'
                                        }`}>
                                            {slot.hora}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            {slot.ocupado ? (
                                                <>
                                                    <div className="text-sm font-bold text-slate-700 dark:text-slate-800 truncate">{slot.paciente}</div>
                                                    {slot.convenio_nome && <div className="text-xs text-slate-500 truncate">{slot.convenio_nome}</div>}
                                                    {slot.valor > 0 && <div className="text-xs font-semibold text-slate-600 mt-0.5">R$ {Number(slot.valor).toFixed(2)}</div>}
                                                </>
                                            ) : (
                                                <>
                                                    <div className={`text-sm font-bold ${isLocked ? 'text-gray-500' : isPast ? 'text-slate-400' : 'text-green-600'}`}>
                                                        {isLocked ? (slot.agenda_fechada ? 'Agenda Encerrada' : 'Bloqueado') : isPast ? 'Expirado' : 'Livre'}
                                                    </div>
                                                    
                                                    {slot.convenio_regra_nome && (
                                                        <div className="text-xs font-bold text-blue-600 dark:text-blue-400 mt-0.5 flex items-center gap-1 truncate">
                                                            <ShieldCheck size={12}/> {slot.convenio_regra_nome}
                                                        </div>
                                                    )}

                                                    {slot.valor > 0 && <div className="text-xs font-semibold text-slate-500 mt-0.5">R$ {Number(slot.valor).toFixed(2)}</div>}
                                                </>
                                            )}
                                        </div>
                                    </div>
                                    
                                    {isLocked && !slot.ocupado && <div className="absolute top-2 right-2 text-gray-400"><Lock size={14}/></div>}

                                    {slot.ocupado && (
                                        <div className="flex gap-1 ml-2">
                                            <button onClick={(e) => handleImprimirSlot(e, slot.agendamento_id)} className="p-1.5 bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 rounded-lg transition-colors shadow-sm" title="Imprimir"><Printer size={14}/></button>
                                            <button onClick={(e) => { e.stopPropagation(); abrirEditar(slot); }} className="p-1.5 bg-white text-blue-600 border border-blue-100 hover:bg-blue-50 rounded-lg transition-colors shadow-sm"><Pencil size={14}/></button>
                                            <button onClick={(e) => handleExcluirAgendamento(e, slot.agendamento_id)} className="p-1.5 bg-white text-red-500 border border-red-100 hover:bg-red-50 rounded-lg transition-colors shadow-sm"><Trash2 size={14}/></button>
                                        </div>
                                    )}
                                    
                                    {slot.is_encaixe && <div className="absolute -top-2 -right-2 bg-yellow-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm flex items-center gap-1"><AlertCircle size={10}/> EXTRA</div>}
                                </div>
                            );
                        }) : (
                            <div className="col-span-2 text-center py-20 flex flex-col items-center text-slate-400">
                                <CalendarIcon size={48} className="mb-2 opacity-20"/>
                                <p>Nenhum horário disponível para esta data.</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        )}
        
        {/* MODAL DE AGENDAMENTO (CÓDIGO ANTERIOR) */}
        {modalOpen && (
            // ... (O código do modal permanece idêntico, apenas reusando a lógica)
             <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                    <div className="bg-blue-600 p-6 text-white flex justify-between items-center"><h2 className="text-xl font-bold">{agendamentoIdEditar ? 'Editar Agendamento' : 'Novo Agendamento'}</h2><button onClick={() => setModalOpen(false)}><X/></button></div>
                    <div className="p-6 space-y-4">
                        {tipoModal === 'encaixe' ? (
                            <div>
                                <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1">Valor da Consulta</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-2.5 text-slate-500">R$</span>
                                    <input type="number" step="0.01" className="w-full border p-2.5 pl-10 rounded-lg dark:bg-slate-900 dark:text-white" value={valorSelecionado} onChange={e => setValorSelecionado(e.target.value)} placeholder="0.00"/>
                                </div>
                            </div>
                        ) : (
                            parseFloat(valorSelecionado) > 0 && (
                                <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-xl flex items-center justify-between border border-blue-100 dark:border-blue-800">
                                    <div className="font-bold text-sm text-blue-700 dark:text-blue-300">Valor da Consulta</div>
                                    <div className="text-xl font-bold text-blue-800 dark:text-white">R$ {Number(valorSelecionado).toFixed(2)}</div>
                                </div>
                            )
                        )}
                        <div>
                            <div className="flex justify-between items-center mb-1">
                                <label className="block text-sm font-bold text-slate-700 dark:text-slate-300">Paciente</label>
                                <button onClick={() => setModalPacienteOpen(true)} className="text-xs text-blue-600 hover:underline font-bold flex items-center gap-1"><UserPlus size={14}/> Novo Cadastro</button>
                            </div>
                            <SearchableSelect label="" options={pacientes} value={pacienteId} onChange={setPacienteId} placeholder="Pesquisar..." />
                        </div>
                        
                        <SearchableSelect 
                            label="Convênio (Opcional)" 
                            options={convenios} 
                            value={convenioId} 
                            onChange={setConvenioId} 
                            placeholder="Particular..."
                            disabled={convenioTravado}
                        />
                        
                        {tipoModal === 'encaixe' && <div><label className="block text-sm font-bold mb-1">Horário</label><input type="time" className="w-full border p-3 rounded-lg dark:bg-slate-900 dark:text-white" value={encaixeHora} onChange={e => setEncaixeHora(e.target.value)} /></div>}
                        <textarea placeholder="Observações..." className="w-full border p-3 rounded-lg h-24 dark:bg-slate-900 dark:text-white" value={observacao} onChange={e => setObservacao(e.target.value)}></textarea>
                        
                        <div className="grid grid-cols-2 gap-3 mt-4">
                            <button onClick={salvarAgendamento} disabled={loadingSave} className={`col-span-2 w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 ${agendamentoIdEditar ? '' : 'col-span-2'}`}>
                                {loadingSave ? <Loader2 className="animate-spin" /> : <Save size={20}/>} 
                                {agendamentoIdEditar ? 'Salvar Alterações' : 'Confirmar Agendamento'}
                            </button>
                            {agendamentoIdEditar && (
                                <button onClick={handleImprimir} className="col-span-2 w-full py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 border border-slate-300 rounded-lg font-bold flex items-center justify-center gap-2">
                                    <Printer size={20}/> Imprimir Comprovante
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        )}
        
        {/* MODAL DE NOVO PACIENTE (CÓDIGO ANTERIOR) */}
        {modalPacienteOpen && (
             <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/70 p-4 overflow-y-auto">
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl animate-in fade-in zoom-in duration-200 my-10">
                    <div className="bg-slate-800 p-5 text-white flex justify-between items-center rounded-t-2xl"><h3 className="font-bold flex items-center gap-2 text-lg"><UserPlus size={20}/> Novo Paciente</h3><button onClick={() => setModalPacienteOpen(false)} className="text-slate-400 hover:text-white"><X size={24}/></button></div>
                    <form onSubmit={salvarPacienteCompleto} className="p-6">
                        <div className="grid grid-cols-1 md:grid-cols-12 gap-4">
                            <div className="md:col-span-12 border-b pb-2 mb-2 font-bold text-slate-700 dark:text-white uppercase text-xs tracking-wider">Dados Pessoais</div>
                            <div className="md:col-span-6"><label className="block text-xs mb-1">Nome Completo</label><input name="nome" required value={novoPaciente.nome} onChange={handlePacienteChange} className={inputClass} /></div>
                            <div className="md:col-span-3"><label className="block text-xs mb-1">CPF</label><input name="cpf" required value={novoPaciente.cpf} onChange={handlePacienteChange} className={inputClass} placeholder="000.000.000-00"/></div>
                            <div className="md:col-span-3"><label className="block text-xs mb-1">Sexo</label><select name="sexo" value={novoPaciente.sexo} onChange={handlePacienteChange} className={inputClass}><option value="">Selecione...</option><option value="Feminino">Feminino</option><option value="Masculino">Masculino</option><option value="Outro">Outro</option></select></div>
                            <div className="md:col-span-3"><label className="block text-xs mb-1">Nascimento</label><input type="date" name="data_nascimento" required value={novoPaciente.data_nascimento} onChange={handlePacienteChange} className={inputClass} /></div>
                            <div className="md:col-span-3"><label className="block text-xs mb-1">Telefone</label><input name="telefone" value={novoPaciente.telefone} onChange={handlePacienteChange} className={inputClass} placeholder="(00) 00000-0000"/></div>
                            <div className="md:col-span-6"><label className="block text-xs mb-1">Nome da Mãe</label><input name="nome_mae" value={novoPaciente.nome_mae} onChange={handlePacienteChange} className={inputClass} /></div>
                            <div className="md:col-span-12 border-b pb-2 mb-2 mt-4 font-bold text-slate-700 dark:text-white flex items-center gap-2 uppercase text-xs tracking-wider"><MapPin size={16}/> Endereço</div>
                            <div className="md:col-span-3"><label className="block text-xs mb-1">CEP {loadingCep && <Loader2 size={12} className="inline animate-spin text-blue-500"/>}</label><input name="cep" value={novoPaciente.cep} onChange={handlePacienteChange} onBlur={buscarCep} className={inputClass} placeholder="00000-000"/></div>
                            <div className="md:col-span-7"><label className="block text-xs mb-1">Logradouro</label><input name="logradouro" value={novoPaciente.logradouro} onChange={handlePacienteChange} className={inputClass} /></div>
                            <div className="md:col-span-2"><label className="block text-xs mb-1">Número</label><input id="modal-numero" name="numero" value={novoPaciente.numero} onChange={handlePacienteChange} className={inputClass} /></div>
                            <div className="md:col-span-4"><label className="block text-xs mb-1">Complemento</label><input name="complemento" value={novoPaciente.complemento} onChange={handlePacienteChange} className={inputClass} placeholder="Apto, Bloco..."/></div>
                            <div className="md:col-span-4"><label className="block text-xs mb-1">Bairro</label><input name="bairro" value={novoPaciente.bairro} onChange={handlePacienteChange} className={inputClass} /></div>
                            <div className="md:col-span-3"><label className="block text-xs mb-1">Cidade</label><input name="cidade" value={novoPaciente.cidade} onChange={handlePacienteChange} className={inputClass} /></div>
                            <div className="md:col-span-1"><label className="block text-xs mb-1">UF</label><input name="estado" value={novoPaciente.estado} onChange={handlePacienteChange} className={inputClass} maxLength={2} style={{textTransform:'uppercase'}}/></div>
                        </div>
                        <div className="pt-8 flex gap-3 justify-end">
                            <button type="button" onClick={() => setModalPacienteOpen(false)} className="px-6 py-2.5 bg-slate-100 text-slate-600 font-bold rounded-lg hover:bg-slate-200">Cancelar</button>
                            <button type="submit" disabled={loadingPaciente} className="px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 disabled:opacity-50">
                                {loadingPaciente ? <Loader2 className="animate-spin" size={18}/> : <Save size={18}/>} 
                                Salvar e Usar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        )}
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front/src/pages/Login.jsx
============================================================
import { useState } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNavigate } from 'react-router-dom';
import { HeartPulse, Lock, User, Activity } from 'lucide-react';

export default function Login() {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [rememberMe, setRememberMe] = useState(false);
  const { login } = useAuth();
  const navigate = useNavigate();
  const [error, setError] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setIsLoading(true);
    
    // Passamos o 'rememberMe' para a função de login
    const success = await login(username, password, rememberMe);
    
    setIsLoading(false);
    if (success) navigate('/dashboard');
    else setError('Usuário ou senha incorretos.');
  };

  return (
    <div className="w-screen h-screen flex items-center justify-center bg-slate-100 relative overflow-hidden">
      
      <div className="absolute inset-0 z-0">
        <div className="absolute inset-0 bg-gradient-to-br from-blue-900/10 to-blue-500/10 mix-blend-multiply" />
        <div className="h-full w-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
      </div>

      <div className="bg-white w-full max-w-4xl h-[600px] rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row z-10 m-4 relative">
        
        {/* Lado Esquerdo (Design) */}
        <div className="w-full md:w-1/2 bg-blue-600 relative flex flex-col justify-center items-center text-center p-12 overflow-hidden">
          <div 
            className="absolute inset-0 bg-cover bg-center mix-blend-overlay opacity-50"
            style={{ backgroundImage: "url('https://images.unsplash.com/photo-1516549655169-df83a092dd14?q=80&w=1000&auto=format&fit=crop')" }}
          ></div>
          <div className="absolute inset-0 bg-gradient-to-t from-blue-900/90 to-blue-600/80"></div>

          <div className="relative z-10">
            <div className="bg-white/10 p-5 rounded-full inline-block mb-6 backdrop-blur-md shadow-inner border border-white/20">
              <HeartPulse size={56} className="text-white animate-pulse" />
            </div>
            <h1 className="text-4xl font-bold text-white mb-2 tracking-wide">TheClinic</h1>
            <div className="h-1 w-20 bg-blue-300 mx-auto mb-4 rounded-full"></div>
            <p className="text-blue-100 text-lg font-light leading-relaxed">
              Gestão clínica inteligente, <br/> segura e eficiente.
            </p>
          </div>

          <div className="absolute bottom-8 text-blue-200/80 text-xs flex items-center gap-2">
            <Activity size={14} />
            <span>Ambiente Seguro & Criptografado</span>
          </div>
        </div>

        {/* Lado Direito (Formulário) */}
        <div className="w-full md:w-1/2 bg-white p-10 flex flex-col justify-center relative">
          
          <div className="mb-8">
            <h2 className="text-2xl font-bold text-slate-800">Área Restrita</h2>
            <p className="text-slate-500 text-sm mt-1">Insira suas credenciais de operador.</p>
          </div>
          
          <form onSubmit={handleSubmit} className="space-y-5">
            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wider">Usuário</label>
              <div className="relative group">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <User className="h-5 w-5 text-slate-400 group-focus-within:text-blue-600 transition-colors" />
                </div>
                <input 
                  id="username"
                  name="username"
                  // ADICIONADO: Ajuda o navegador a saber que é um usuário
                  autoComplete="username" 
                  className="block w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg text-slate-900 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                  placeholder="ID do Operador" 
                  value={username}
                  onChange={e => setUsername(e.target.value)}
                />
              </div>
            </div>

            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wider">Senha</label>
              <div className="relative group">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Lock className="h-5 w-5 text-slate-400 group-focus-within:text-blue-600 transition-colors" />
                </div>
                <input 
                  id="password"
                  name="password"
                  // ADICIONADO: Ajuda o navegador a saber que é a senha atual
                  autoComplete="current-password"
                  className="block w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg text-slate-900 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                  type="password" 
                  placeholder="••••••••" 
                  value={password}
                  onChange={e => setPassword(e.target.value)} 
                />
              </div>
            </div>

            <div className="flex items-center justify-between">
              <label className="flex items-center space-x-2 cursor-pointer group">
                <input 
                  type="checkbox" 
                  checked={rememberMe}
                  onChange={(e) => setRememberMe(e.target.checked)}
                  className="w-4 h-4 bg-white border border-slate-300 rounded text-blue-600 focus:ring-blue-500 cursor-pointer accent-blue-600"
                />
                <span className="text-sm text-slate-500 group-hover:text-slate-700 transition-colors">Lembrar-me</span>
              </label>

              <a href="#" className="text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors">
                Esqueceu a senha?
              </a>
            </div>

            {error && (
              <div className="bg-red-50 text-red-600 text-sm p-3 rounded-lg border border-red-100 flex items-center animate-shake">
                <span className="font-bold mr-2">Erro:</span> {error}
              </div>
            )}

            <div className="pt-2">
              <button 
                type="submit"
                disabled={isLoading}
                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-lg shadow-lg shadow-blue-500/30 transition-all transform active:scale-95 flex justify-center items-center"
              >
                {isLoading ? 'Acessando...' : 'Entrar no Sistema'}
              </button>
            </div>
          </form>

          <p className="absolute bottom-6 left-0 w-full text-center text-xs text-slate-300">
            © 2026 TheClinic Tecnologia
          </p>
        </div>
      </div>
    </div>
  );
}

============================================================
ARQUIVO: clinica-front/src/pages/Operadores.jsx
============================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNavigate } from 'react-router-dom';
import Layout from '../components/Layout';
import { Search, UserCog, Plus, ChevronLeft, ChevronRight, Pencil, Trash2 } from 'lucide-react';

export default function Operadores() {
  const { api } = useAuth();
  const navigate = useNavigate();
  
  const [operadores, setOperadores] = useState([]);
  const [search, setSearch] = useState('');
  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);

  const fetchOperadores = async () => {
    try {
        let pageSize = 15;
        try {
            const conf = await api.get('operadores/config/');
            if (conf.data?.itens_por_pagina) pageSize = conf.data.itens_por_pagina;
        } catch {}

        const res = await api.get(`operadores/listar/?page=${page}&page_size=${pageSize}&search=${search}`);
        const lista = res.data.results || res.data;
        
        if (Array.isArray(lista)) {
            setOperadores(lista);
            setTotalPages(res.data.count ? Math.ceil(res.data.count / pageSize) : 1);
        } else {
            setOperadores([]);
        }
    } catch (e) { setOperadores([]); }
  };

  useEffect(() => { if (api) fetchOperadores(); }, [page, search, api]);

  const handleExcluir = async (id) => {
    if (confirm('Tem certeza que deseja excluir?')) {
        try {
            await api.delete(`operadores/${id}/`);
            fetchOperadores();
        } catch (error) { alert('Erro ao excluir.'); }
    }
  };

  // CLASSE DOS BOTÕES DE PAGINAÇÃO (Branco no claro, Escuro no dark)
  const paginationBtnClass = "p-2 border rounded-lg transition-colors disabled:opacity-50 bg-white border-slate-200 text-slate-600 hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-700";

  return (
    <Layout>
      <div className="max-w-6xl mx-auto">
        <div className="flex justify-between items-center mb-8">
          <div className="flex items-center space-x-3">
            <div className="bg-blue-600 p-3 rounded-xl text-white shadow"><UserCog size={28}/></div>
            <div>
                <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Operadores</h1>
                <p className="text-slate-500 dark:text-slate-400 text-sm">Gerencie o acesso ao sistema.</p>
            </div>
          </div>
          <button onClick={() => navigate('/operadores/novo')} className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-md active:scale-95">
            <Plus size={20}/> Novo Operador
          </button>
        </div>

        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6">
            <div className="relative">
                <Search className="absolute left-3 top-3.5 text-slate-400" size={18} />
                <input placeholder="Buscar..." value={search} onChange={e => setSearch(e.target.value)} className="w-full pl-10 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 outline-none text-slate-700 dark:text-white"/>
            </div>
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
          <table className="w-full text-left">
            <thead className="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700">
              <tr>
                {/* COLUNAS SEPARADAS AGORA */}
                <th className="px-6 py-4">Nome</th>
                <th className="px-6 py-4">Email</th>
                <th className="px-6 py-4 text-center">Usuário</th>
                <th className="px-6 py-4 text-center">Tipo</th>
                <th className="px-6 py-4 text-right">Ações</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
              {operadores.map(op => (
                <tr key={op.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                    {/* DADOS SEPARADOS */}
                    <td className="px-6 py-4 font-bold text-slate-700 dark:text-white">
                        {op.first_name}
                    </td>
                    <td className="px-6 py-4 text-slate-500 dark:text-slate-400">
                        {op.email}
                    </td>
                    
                    <td className="px-6 py-4 text-center text-slate-600 dark:text-slate-300">{op.username}</td>
                    
                    <td className="px-6 py-4 text-center">
                        {op.is_superuser ? <span className="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded-full font-bold">ADMIN</span> : <span className="bg-slate-100 text-slate-500 text-xs px-2 py-1 rounded-full font-bold">OPERADOR</span>}
                    </td>
                    
                    <td className="px-6 py-4 text-right">
                        <div className="flex justify-end gap-2">
                            <button onClick={() => navigate(`/operadores/${op.id}`)} title="Editar" className="p-2 bg-transparent text-blue-600 hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-blue-900/30 rounded-lg transition-colors">
                                <Pencil size={18} />
                            </button>
                            <button onClick={() => handleExcluir(op.id)} title="Excluir" className="p-2 bg-transparent text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/30 rounded-lg transition-colors">
                                <Trash2 size={18} />
                            </button>
                        </div>
                    </td>
                </tr>
              ))}
            </tbody>
          </table>
          <div className="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center text-slate-500">
            <span>Página {page} de {totalPages}</span>
            <div className="flex gap-2">
                <button disabled={page===1} onClick={()=>setPage(p=>p-1)} className={paginationBtnClass}><ChevronLeft size={16}/></button>
                <button disabled={page===totalPages} onClick={()=>setPage(p=>p+1)} className={paginationBtnClass}><ChevronRight size={16}/></button>
            </div>
          </div>
        </div>
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front/src/pages/Convenios.jsx
============================================================
import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNotification } from '../context/NotificationContext'; // <--- NOVO
import Layout from '../components/Layout';
import { 
  Building2, Search, Plus, Pencil, Trash2, X, Save, Percent, Loader2 
} from 'lucide-react';

export default function Convenios() {
  const { api } = useAuth();
  const { notify, confirmDialog } = useNotification(); // <--- HOOK
  
  const [convenios, setConvenios] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState('');
  
  const [modalOpen, setModalOpen] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const [saving, setSaving] = useState(false);
  
  const [nome, setNome] = useState('');
  const [desconto, setDesconto] = useState('');

  useEffect(() => {
    if (api) loadData();
  }, [api, search]);

  const loadData = async () => {
    setLoading(true);
    try {
      const res = await api.get(`configuracoes/convenios/?search=${search}`);
      setConvenios(res.data.results || res.data);
    } catch (e) {
      console.error("Erro ao carregar convênios", e);
    } finally {
      setLoading(false);
    }
  };

  const openModal = (item = null) => {
    setEditingItem(item);
    if (item) {
        setNome(item.nome || '');
        setDesconto(item.percentual_desconto || '0.00');
    } else {
        setNome('');
        setDesconto('');
    }
    setModalOpen(true);
  };

  const handleSave = async (e) => {
    e.preventDefault();
    setSaving(true);
    
    const payload = { 
        nome, 
        percentual_desconto: desconto === '' ? 0 : parseFloat(desconto) 
    };

    try {
      if (editingItem) {
        await api.put(`configuracoes/convenios/${editingItem.id}/`, payload);
        notify.success('Convênio atualizado!'); // <---
      } else {
        await api.post('configuracoes/convenios/', payload);
        notify.success('Convênio criado!'); // <---
      }
      setModalOpen(false);
      loadData();
    } catch (error) {
      notify.error("Erro ao salvar convênio."); // <---
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (id) => {
    // --- DIALOG BONITO ---
    const confirmado = await confirmDialog("Excluir este convênio?", "Exclusão", "Sim, excluir", "Cancelar", "danger");
    if(confirmado) {
        try {
            await api.delete(`configuracoes/convenios/${id}/`);
            notify.success("Convênio excluído.");
            loadData();
        } catch(e) {
            notify.error("Erro ao excluir.");
        }
    }
  };

  const inputClass = "w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-blue-500 text-slate-800 dark:text-white transition-all";

  return (
    <Layout>
      <div className="max-w-4xl mx-auto pb-20">
        
        <div className="flex justify-between items-center mb-6">
            <div>
                <h1 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <Building2 className="text-blue-600"/> Convênios
                </h1>
                <p className="text-slate-500 text-sm">Gerencie os planos de saúde e descontos.</p>
            </div>
            <button onClick={() => openModal()} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg transition-transform active:scale-95">
                <Plus size={20}/> Novo Convênio
            </button>
        </div>

        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6">
            <div className="relative">
                <Search className="absolute left-3 top-3 text-slate-400" size={18} />
                <input 
                    placeholder="Pesquisar convênio..." 
                    value={search} 
                    onChange={e => setSearch(e.target.value)} 
                    className="w-full pl-10 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2.5 outline-none dark:text-white"
                />
            </div>
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
            <table className="w-full text-left">
                <thead className="bg-slate-50 dark:bg-slate-700/50 border-b border-slate-200 dark:border-slate-700">
                    <tr>
                        <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Nome</th>
                        <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Desconto (%)</th>
                        <th className="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                    {convenios.map(item => (
                        <tr key={item.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                            <td className="px-6 py-4 font-bold text-slate-700 dark:text-white">{item.nome}</td>
                            <td className="px-6 py-4">
                                <span className="bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 px-2 py-1 rounded-lg text-xs font-bold">
                                    {Number(item.percentual_desconto).toFixed(2)}%
                                </span>
                            </td>
                            <td className="px-6 py-4 text-right flex justify-end gap-2">
                                <button onClick={() => openModal(item)} className="p-2 text-blue-600 hover:bg-blue-50 dark:text-blue-400 rounded-lg transition-colors"><Pencil size={18}/></button>
                                <button onClick={() => handleDelete(item.id)} className="p-2 text-red-600 hover:bg-red-50 dark:text-red-400 rounded-lg transition-colors"><Trash2 size={18}/></button>
                            </td>
                        </tr>
                    ))}
                    {convenios.length === 0 && !loading && (
                        <tr><td colSpan="3" className="p-8 text-center text-slate-400">Nenhum convênio encontrado.</td></tr>
                    )}
                </tbody>
            </table>
        </div>

        {modalOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in zoom-in duration-200">
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                    <div className="flex justify-between items-center p-5 border-b border-slate-100 dark:border-slate-700">
                        <h3 className="font-bold text-lg text-slate-800 dark:text-white">{editingItem ? 'Editar Convênio' : 'Novo Convênio'}</h3>
                        <button onClick={() => setModalOpen(false)} className="text-slate-400 hover:text-slate-600"><X size={20}/></button>
                    </div>
                    
                    <form onSubmit={handleSave} className="p-6 space-y-4">
                        <div>
                            <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1">Nome do Convênio</label>
                            <input 
                                required 
                                value={nome} 
                                onChange={e => setNome(e.target.value)} 
                                className={inputClass} 
                                placeholder="Ex: Unimed, Bradesco..."
                            />
                        </div>
                        
                        <div>
                            <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1">Desconto Padrão (%)</label>
                            <div className="relative">
                                <Percent className="absolute left-3 top-3.5 text-slate-400" size={16}/>
                                <input 
                                    type="number" 
                                    step="0.01" 
                                    value={desconto} 
                                    onChange={e => setDesconto(e.target.value)} 
                                    className={`${inputClass} pl-10`} 
                                    placeholder="0.00"
                                />
                            </div>
                        </div>

                        <div className="pt-4 flex gap-3 justify-end">
                            <button type="button" onClick={() => setModalOpen(false)} className="px-4 py-2 text-slate-600 font-bold">Cancelar</button>
                            <button type="submit" disabled={saving} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg transition-all active:scale-95">
                                {saving ? <Loader2 className="animate-spin" size={18}/> : <Save size={18}/>}
                                {saving ? 'Salvando...' : 'Salvar'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        )}

      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front/src/context/ThemeContext.jsx
============================================================
import { createContext, useContext, useEffect, useState } from 'react';

const ThemeContext = createContext();

export function ThemeProvider({ children }) {
  // Tenta pegar do localStorage, se não tiver, começa como 'light'
  const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');

  useEffect(() => {
    const root = window.document.documentElement;
    
    // Remove a classe antiga e adiciona a nova
    root.classList.remove('light', 'dark');
    root.classList.add(theme);
    
    // Salva a escolha para a próxima vez
    localStorage.setItem('theme', theme);
  }, [theme]);

  const toggleTheme = () => {
    setTheme((prev) => (prev === 'light' ? 'dark' : 'light'));
  };

  return (
    <ThemeContext.Provider value={{ theme, toggleTheme }}>
      {children}
    </ThemeContext.Provider>
  );
}

export const useTheme = () => useContext(ThemeContext);

============================================================
ARQUIVO: clinica-front/src/context/AuthContext.jsx
============================================================
import { createContext, useState, useEffect, useContext } from 'react';
import axios from 'axios';

const AuthContext = createContext();

// Defina a URL da sua API aqui
const api = axios.create({
    // Se existir a variável de ambiente (Railway), usa ela. Se não, usa localhost.
    baseURL: import.meta.env.VITE_API_URL || 'http://localhost:8000/api/',
});

export default api;

export function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // 1. Tenta recuperar de ambos os lugares (Local ou Session)
    const token = localStorage.getItem('token') || sessionStorage.getItem('token');

    if (token) {
      api.defaults.headers.common['Authorization'] = `Bearer ${token}`;
      api.get('me/')
        .then(res => setUser(res.data))
        .catch(() => {
          logout(); // Se o token for inválido, limpa tudo
        })
        .finally(() => setLoading(false));
    } else {
      setLoading(false);
    }
  }, []);

  // 2. Agora o login aceita o parâmetro 'remember'
  const login = async (username, password, remember) => {
    try {
      const response = await api.post('token/', { username, password });
      const { access } = response.data;

      // LÓGICA DO LEMBRAR-ME:
      if (remember) {
        localStorage.setItem('token', access); // Salva pra sempre (até limpar cache)
      } else {
        sessionStorage.setItem('token', access); // Salva só enquanto a aba estiver aberta
      }

      api.defaults.headers.common['Authorization'] = `Bearer ${access}`;
      
      const userResponse = await api.get('me/');
      setUser(userResponse.data);
      return true;
    } catch (error) {
      return false;
    }
  };

  const logout = () => {
    // Limpa dos dois lugares para garantir
    localStorage.removeItem('token');
    sessionStorage.removeItem('token');
    delete api.defaults.headers.common['Authorization'];
    setUser(null);
  };

  return (
    <AuthContext.Provider value={{ user, login, logout, loading, api }}>
      {children}
    </AuthContext.Provider>
  );
}

export const useAuth = () => useContext(AuthContext);

============================================================
ARQUIVO: clinica-front/src/context/NotificationContext.jsx
============================================================
import React, { createContext, useContext, useState, useCallback } from 'react';
import { CheckCircle2, XCircle, AlertTriangle, Info, X, Loader2 } from 'lucide-react';

const NotificationContext = createContext();

export function NotificationProvider({ children }) {
  const [toasts, setToasts] = useState([]);
  const [dialog, setDialog] = useState(null);

  // --- LÓGICA DOS TOASTS (NOTIFICAÇÕES) ---
  const addToast = useCallback((message, type = 'info') => {
    const id = Date.now();
    setToasts((prev) => [...prev, { id, message, type }]);
    
    // Remove automaticamente após 3 segundos
    setTimeout(() => {
      removeToast(id);
    }, 4000);
  }, []);

  const removeToast = useCallback((id) => {
    setToasts((prev) => prev.filter((t) => t.id !== id));
  }, []);

  // Atalhos para facilitar
  const notify = {
    success: (msg) => addToast(msg, 'success'),
    error: (msg) => addToast(msg, 'error'),
    warning: (msg) => addToast(msg, 'warning'),
    info: (msg) => addToast(msg, 'info'),
  };

  // --- LÓGICA DO DIALOG (CONFIRMAÇÃO) ---
  // Retorna uma Promise para podermos usar: await confirm(...)
  const confirmDialog = useCallback((message, title = 'Confirmação', confirmText = 'Confirmar', cancelText = 'Cancelar', variant = 'danger') => {
    return new Promise((resolve) => {
      setDialog({
        title,
        message,
        confirmText,
        cancelText,
        variant, // 'danger' (vermelho) ou 'primary' (azul)
        onConfirm: () => {
          setDialog(null);
          resolve(true);
        },
        onCancel: () => {
          setDialog(null);
          resolve(false);
        }
      });
    });
  }, []);

  // --- COMPONENTES VISUAIS INTERNOS ---
  
  // Ícones e cores baseados no tipo
  const toastConfig = {
    success: { icon: CheckCircle2, color: 'bg-green-500', border: 'border-green-600', text: 'text-white' },
    error: { icon: XCircle, color: 'bg-red-500', border: 'border-red-600', text: 'text-white' },
    warning: { icon: AlertTriangle, color: 'bg-orange-500', border: 'border-orange-600', text: 'text-white' },
    info: { icon: Info, color: 'bg-blue-500', border: 'border-blue-600', text: 'text-white' },
  };

  return (
    <NotificationContext.Provider value={{ notify, confirmDialog }}>
      {children}

      {/* RENDERIZAÇÃO DOS TOASTS (Canto Superior Direito) */}
      <div className="fixed top-4 right-4 z-[9999] flex flex-col gap-2">
        {toasts.map((t) => {
          const config = toastConfig[t.type];
          const Icon = config.icon;
          return (
            <div key={t.id} className={`${config.color} ${config.text} border-l-4 ${config.border} p-4 rounded-r shadow-lg flex items-center gap-3 min-w-[300px] animate-in slide-in-from-right duration-300`}>
              <Icon size={24} />
              <p className="font-medium text-sm flex-1">{t.message}</p>
              <button onClick={() => removeToast(t.id)} className="opacity-70 hover:opacity-100"><X size={18}/></button>
            </div>
          );
        })}
      </div>

      {/* RENDERIZAÇÃO DO MODAL DE CONFIRMAÇÃO */}
      {dialog && (
        <div className="fixed inset-0 z-[10000] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
          <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full p-6 transform scale-100 animate-in zoom-in-95 duration-200">
            <h3 className="text-xl font-bold text-slate-800 dark:text-white mb-2">{dialog.title}</h3>
            <p className="text-slate-600 dark:text-slate-300 mb-6">{dialog.message}</p>
            
            <div className="flex justify-end gap-3">
              <button 
                onClick={dialog.onCancel}
                className="px-4 py-2 text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
              >
                {dialog.cancelText}
              </button>
              <button 
                onClick={dialog.onConfirm}
                className={`px-6 py-2 text-white font-bold rounded-lg shadow-md transition-transform active:scale-95 ${
                  dialog.variant === 'danger' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'
                }`}
              >
                {dialog.confirmText}
              </button>
            </div>
          </div>
        </div>
      )}
    </NotificationContext.Provider>
  );
}

export const useNotification = () => useContext(NotificationContext);

