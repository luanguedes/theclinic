--- DUMP DO PROJETO THECLINIC ---
Raiz: C:\Users\luan2\OneDrive\Desktop\theclinic

============================================================
ARQUIVO: manage.py
============================================================
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'clinica_core.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()


============================================================
ARQUIVO: raio_x.py
============================================================
import os

# --- CONFIGURAÇÕES ---
NOME_ARQUIVO_SAIDA = 'projeto_completo.txt'

# Extensões que queremos ler (Backend e Frontend)
EXTENSOES_PERMITIDAS = {'.py', '.js', '.jsx', '.html', '.css', '.json'}

# Pastas para IGNORAR COMPLETAMENTE
IGNORAR_PASTAS = {
    'venv', '.venv', 'env',          # Ambientes virtuais
    'node_modules',                  # Dependências Node
    '.git', '.idea', '.vscode',      # Configurações de IDE/Git
    '__pycache__',                   # Cache do Python
    'build', 'dist',                 # Builds do Frontend
    'migrations',                    # Migrações do Django (muito arquivo inútil)
    'media', 'static', 'assets',     # Arquivos estáticos/imagens
    'public'                         # Pasta public do React (geralmente só tem ícones)
}

# Arquivos específicos para IGNORAR
IGNORAR_ARQUIVOS = {
    'package-lock.json', 'yarn.lock', 'pnpm-lock.yaml', # Travas de versão (muito grandes)
    'db.sqlite3',                                       # Banco de dados binário
    'gerar_documento.py',                               # Este script
    NOME_ARQUIVO_SAIDA                                  # O próprio arquivo de saída
}

def salvar_projeto():
    caminho_raiz = os.getcwd()
    print(f"Iniciando varredura em: {caminho_raiz}")
    print("Isso pode levar alguns segundos...")

    arquivos_processados = 0

    with open(NOME_ARQUIVO_SAIDA, 'w', encoding='utf-8') as arquivo_saida:
        arquivo_saida.write(f"--- DUMP DO PROJETO THECLINIC ---\n")
        arquivo_saida.write(f"Raiz: {caminho_raiz}\n\n")

        for root, dirs, files in os.walk(caminho_raiz):
            # 1. Modifica a lista 'dirs' in-place para impedir que o os.walk entre em pastas ignoradas
            # Isso faz o script ser muito rápido pois nem entra em node_modules ou venv
            dirs[:] = [d for d in dirs if d not in IGNORAR_PASTAS]

            for file in files:
                if file in IGNORAR_ARQUIVOS:
                    continue

                # Verifica a extensão
                _, extensao = os.path.splitext(file)
                if extensao.lower() not in EXTENSOES_PERMITIDAS:
                    continue

                caminho_completo = os.path.join(root, file)
                caminho_relativo = os.path.relpath(caminho_completo, caminho_raiz)

                # Escreve no arquivo final
                try:
                    with open(caminho_completo, 'r', encoding='utf-8') as f:
                        conteudo = f.read()
                        
                        arquivo_saida.write(f"{'='*60}\n")
                        arquivo_saida.write(f"ARQUIVO: {caminho_relativo}\n")
                        arquivo_saida.write(f"{'='*60}\n")
                        arquivo_saida.write(conteudo + "\n\n")
                        
                        arquivos_processados += 1
                        print(f"Lido: {caminho_relativo}")

                except Exception as e:
                    print(f"Erro ao ler {caminho_relativo}: {e}")

    print(f"\n--- SUCESSO! ---")
    print(f"Total de arquivos processados: {arquivos_processados}")
    print(f"Todo o código foi salvo em: {NOME_ARQUIVO_SAIDA}")
    print("Agora você pode copiar o conteúdo desse arquivo e colar no chat.")

if __name__ == "__main__":
    salvar_projeto()

============================================================
ARQUIVO: agendamento\admin.py
============================================================
from django.contrib import admin

# Register your models here.


============================================================
ARQUIVO: agendamento\apps.py
============================================================
from django.apps import AppConfig


class AgendamentoConfig(AppConfig):
    name = 'agendamento'


============================================================
ARQUIVO: agendamento\models.py
============================================================
from django.db import models
from profissionais.models import Profissional, Especialidade
from pacientes.models import Paciente 
# Importação do modelo de Convenio
from configuracoes.models import Convenio 

class Agendamento(models.Model):
    STATUS_CHOICES = [
        ('agendado', 'Agendado'),
        ('confirmado', 'Confirmado'),
        ('cancelado', 'Cancelado'),
        ('concluido', 'Concluído'),
    ]

    profissional = models.ForeignKey(Profissional, on_delete=models.CASCADE)
    especialidade = models.ForeignKey(Especialidade, on_delete=models.CASCADE)
    paciente = models.ForeignKey(Paciente, on_delete=models.CASCADE)
    
    # --- CAMPO NOVO ADICIONADO ---
    convenio = models.ForeignKey(Convenio, on_delete=models.SET_NULL, null=True, blank=True)
    
    data = models.DateField()
    horario = models.TimeField()
    is_encaixe = models.BooleanField(default=False)
    
    valor = models.DecimalField(max_digits=10, decimal_places=2, default=0.00)
    observacoes = models.TextField(blank=True, null=True)
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='agendado')
    
    criado_em = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['data', 'horario']

    def __str__(self):
        return f"{self.paciente} - {self.data} {self.horario}"  

============================================================
ARQUIVO: agendamento\serializers.py
============================================================
from rest_framework import serializers
from .models import Agendamento

class AgendamentoSerializer(serializers.ModelSerializer):
    nome_paciente = serializers.CharField(source='paciente.nome', read_only=True)
    telefone_paciente = serializers.CharField(source='paciente.telefone', read_only=True)
    nome_profissional = serializers.CharField(source='profissional.nome', read_only=True)
    nome_especialidade = serializers.CharField(source='especialidade.nome', read_only=True)
    # Exibe o nome do convênio na leitura
    nome_convenio = serializers.CharField(source='convenio.nome', read_only=True)

    class Meta:
        model = Agendamento
        fields = '__all__'

============================================================
ARQUIVO: agendamento\tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARQUIVO: agendamento\urls.py
============================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import AgendamentoViewSet

router = DefaultRouter()
# Isso vai gerar a rota: /api/agendamentos/ (vazia pois o prefixo já está no include principal)
router.register(r'', AgendamentoViewSet, basename='agendamento')

urlpatterns = [
    path('', include(router.urls)),
]

============================================================
ARQUIVO: agendamento\views.py
============================================================
from rest_framework import viewsets, permissions
from rest_framework_simplejwt.authentication import JWTAuthentication
from .models import Agendamento
from .serializers import AgendamentoSerializer

class AgendamentoViewSet(viewsets.ModelViewSet):
    queryset = Agendamento.objects.all()
    serializer_class = AgendamentoSerializer
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        queryset = super().get_queryset()
        
        profissional = self.request.query_params.get('profissional')
        especialidade = self.request.query_params.get('especialidade')
        data = self.request.query_params.get('data')
        
        # BLINDAGEM: Só filtra se o valor não for nulo E não for string vazia
        if profissional and profissional != 'undefined':
            queryset = queryset.filter(profissional_id=profissional)
        
        if especialidade and especialidade != 'undefined':
            queryset = queryset.filter(especialidade_id=especialidade)
            
        if data and data != 'undefined':
            queryset = queryset.filter(data=data)

        return queryset

============================================================
ARQUIVO: agendamento\__init__.py
============================================================


============================================================
ARQUIVO: agendas\admin.py
============================================================
from django.contrib import admin

# Register your models here.


============================================================
ARQUIVO: agendas\apps.py
============================================================
from django.apps import AppConfig


class AgendasConfig(AppConfig):
    name = 'agendas'


============================================================
ARQUIVO: agendas\models.py
============================================================
import uuid
from django.db import models
from profissionais.models import Profissional, Especialidade
from configuracoes.models import Convenio

class AgendaConfig(models.Model):
    DIAS_SEMANA = [
        (0, 'Domingo'), (1, 'Segunda'), (2, 'Terça'), (3, 'Quarta'),
        (4, 'Quinta'), (5, 'Sexta'), (6, 'Sábado')
    ]

    group_id = models.UUIDField(default=uuid.uuid4, editable=True) 

    profissional = models.ForeignKey(Profissional, on_delete=models.CASCADE)
    especialidade = models.ForeignKey(Especialidade, on_delete=models.CASCADE)
    convenio = models.ForeignKey(Convenio, on_delete=models.SET_NULL, null=True, blank=True)
    
    dia_semana = models.IntegerField(choices=DIAS_SEMANA)
    
    data_inicio = models.DateField()
    data_fim = models.DateField()
    
    # --- CAMPO RENOMEADO: SITUACAO (True=Ativa, False=Encerrada) ---
    situacao = models.BooleanField(default=True, verbose_name="Situação da Agenda")
    
    hora_inicio = models.TimeField()
    hora_fim = models.TimeField()
    intervalo_minutos = models.IntegerField()
    quantidade_atendimentos = models.IntegerField(default=1) 
    tipo = models.CharField(max_length=20, default='padrao')
    valor = models.DecimalField(max_digits=10, decimal_places=2, default=0.00, verbose_name="Valor da Consulta")

    criado_em = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return f"{self.profissional} - {self.get_dia_semana_display()}"

============================================================
ARQUIVO: agendas\serializers.py
============================================================
from rest_framework import serializers
from django.apps import apps
from .models import AgendaConfig

class AgendaConfigSerializer(serializers.ModelSerializer):
    nome_profissional = serializers.CharField(source='profissional.nome', read_only=True)
    nome_especialidade = serializers.CharField(source='especialidade.nome', read_only=True)
    nome_dia = serializers.CharField(source='get_dia_semana_display', read_only=True)
    
    # --- CORREÇÃO AQUI: Método seguro para ler o nome do convênio ---
    nome_convenio = serializers.SerializerMethodField()
    
    dias_vinculados = serializers.SerializerMethodField()
    horarios_fixos_detalhes = serializers.SerializerMethodField()
    total_agendados = serializers.SerializerMethodField()

    class Meta:
        model = AgendaConfig
        fields = '__all__'

    def get_nome_convenio(self, obj):
        if obj.convenio:
            return obj.convenio.nome
        return "Todos / Particular" # Retorno padrão para agendas sem convênio

    def get_dias_vinculados(self, obj):
        # Retorna lista de dias que compartilham o mesmo group_id
        dias = AgendaConfig.objects.filter(group_id=obj.group_id).values_list('dia_semana', flat=True)
        return sorted(list(set(dias)))

    def get_horarios_fixos_detalhes(self, obj):
        if obj.tipo != 'fixo':
            return []
        
        itens = AgendaConfig.objects.filter(group_id=obj.group_id).values('hora_inicio', 'quantidade_atendimentos')
        unicos = []
        seen = set()
        
        for i in itens:
            chave = str(i['hora_inicio'])
            if chave not in seen:
                unicos.append({
                    'time': i['hora_inicio'], 
                    'qtd': i['quantidade_atendimentos']
                })
                seen.add(chave)
        return sorted(unicos, key=lambda x: str(x['time']))

    def get_total_agendados(self, obj):
        try:
            Agendamento = apps.get_model('agendamento', 'Agendamento')
            # 0=Domingo no model AgendaConfig -> week_day 1=Domingo no Django Filter
            target_day = obj.dia_semana + 1 

            return Agendamento.objects.filter(
                profissional=obj.profissional,
                data__range=(obj.data_inicio, obj.data_fim),
                data__week_day=target_day,
                status__in=['agendado', 'confirmado', 'concluido']
            ).count()
        except Exception:
            return 0

============================================================
ARQUIVO: agendas\tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARQUIVO: agendas\urls.py
============================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import AgendaConfigViewSet

router = DefaultRouter()
# Isso vai gerar a rota: /api/agendas/config/
router.register(r'config', AgendaConfigViewSet, basename='config')

urlpatterns = [
    path('', include(router.urls)),
]

============================================================
ARQUIVO: agendas\views.py
============================================================
from rest_framework import viewsets, permissions, status, filters
from rest_framework.decorators import action
from rest_framework.response import Response
from django.db import transaction
from django.db.models import Q
from django.apps import apps
from django.utils import timezone
from .models import AgendaConfig
from .serializers import AgendaConfigSerializer

class AgendaConfigViewSet(viewsets.ModelViewSet):
    serializer_class = AgendaConfigSerializer
    permission_classes = [permissions.IsAuthenticated]
    queryset = AgendaConfig.objects.all().order_by('dia_semana', 'hora_inicio')

    def get_queryset(self):
        queryset = super().get_queryset()
        hoje = timezone.now().date()
        
        # --- 1. FILTRO DE STATUS (O único que roda sempre) ---
        status_param = self.request.query_params.get('status', 'ativos')
        
        if status_param == 'ativos':
            # Traz agendas marcadas como Ativas (ou nulas/legado) que NÃO venceram
            queryset = queryset.filter(
                Q(situacao=True) | Q(situacao__isnull=True),
                data_fim__gte=hoje
            )
        elif status_param == 'encerrados':
            # Traz agendas marcadas como Inativas OU que já venceram
            queryset = queryset.filter(Q(situacao=False) | Q(data_fim__lt=hoje))
        
        # Se status_param == 'todos', não filtra nada, mostra histórico completo.

        # --- 2. FILTROS ESPECÍFICOS (Só aplicam se o usuário pedir) ---
        
        # Helper para garantir que não vamos filtrar por lixo (undefined, null, string vazia)
        def should_filter(param):
            return param and str(param).strip() != '' and str(param) != 'undefined' and str(param) != 'null'

        # A) Data Inicial
        data_inicial = self.request.query_params.get('data_inicial')
        if should_filter(data_inicial):
            queryset = queryset.filter(data_inicio=data_inicial)

        # B) Data Final
        data_final = self.request.query_params.get('data_final')
        if should_filter(data_final):
            queryset = queryset.filter(data_fim=data_final)

        # C) Data Específica (Vigência)
        data_especifica = self.request.query_params.get('data_especifica')
        if should_filter(data_especifica):
            queryset = queryset.filter(data_inicio__lte=data_especifica, data_fim__gte=data_especifica)

        # D) IDs
        profissional_id = self.request.query_params.get('profissional_id')
        if should_filter(profissional_id):
            queryset = queryset.filter(profissional_id=profissional_id)
        
        especialidade_id = self.request.query_params.get('especialidade_id')
        if should_filter(especialidade_id):
            queryset = queryset.filter(especialidade_id=especialidade_id)

        # E) Convênio (CRÍTICO: Se não vier nada, NÃO FILTRA NADA)
        convenio_id = self.request.query_params.get('convenio_id')
        if should_filter(convenio_id):
            if str(convenio_id) == 'sem_convenio':
                queryset = queryset.filter(convenio__isnull=True)
            else:
                queryset = queryset.filter(convenio_id=convenio_id)
            
        dia_filtro = self.request.query_params.get('dia_filtro')
        if should_filter(dia_filtro):
            queryset = queryset.filter(dia_semana=dia_filtro)
            
        search = self.request.query_params.get('search')
        if should_filter(search):
            queryset = queryset.filter(
                Q(profissional__nome__icontains=search) | 
                Q(especialidade__nome__icontains=search)
            )

        return queryset

    # --- RESTANTE DOS MÉTODOS MANTIDOS E PROTEGIDOS ---
    @action(detail=False, methods=['get'])
    def filters_data(self, request):
        qs = AgendaConfig.objects.all()
        hoje = timezone.now().date()
        status_param = request.query_params.get('status', 'ativos')
        
        if status_param == 'ativos':
            qs = qs.filter(Q(situacao=True) | Q(situacao__isnull=True), data_fim__gte=hoje)
        
        profissionais = qs.values('profissional__id', 'profissional__nome').distinct()
        especialidades = qs.values('especialidade__id', 'especialidade__nome').distinct()
        
        return Response({
            'profissionais': [{'id': p['profissional__id'], 'label': p['profissional__nome']} for p in profissionais],
            'especialidades': [{'id': e['especialidade__id'], 'label': e['especialidade__nome']} for e in especialidades]
        })

    def list(self, request, *args, **kwargs):
        queryset = self.filter_queryset(self.get_queryset())
        if request.query_params.get('nopage') or request.query_params.get('todos_os_dias'):
            serializer = self.get_serializer(queryset, many=True)
            return Response(serializer.data)

        all_items = queryset.order_by('group_id', 'dia_semana')
        seen_groups = set()
        unique_items = []
        for item in all_items:
            if item.group_id not in seen_groups:
                unique_items.append(item)
                seen_groups.add(item.group_id)
        
        page = self.paginate_queryset(unique_items)
        if page is not None:
            serializer = self.get_serializer(page, many=True)
            return self.get_paginated_response(serializer.data)
        serializer = self.get_serializer(unique_items, many=True)
        return Response(serializer.data)

    @action(detail=False, methods=['get'], url_path='check-conflicts/(?P<group_id>[^/.]+)')
    def check_conflicts(self, request, group_id=None):
        try: Agendamento = apps.get_model('agendamento', 'Agendamento')
        except LookupError: return Response({"count": 0})
        regras = AgendaConfig.objects.filter(group_id=group_id)
        if not regras.exists(): return Response({"count": 0})
        total_afetados = 0
        for regra in regras:
            qs = Agendamento.objects.filter(profissional_id=regra.profissional_id, data__range=(regra.data_inicio, regra.data_fim))
            qs = qs.filter(data__gte=timezone.now().date())
            total_afetados += qs.count()
        return Response({"count": total_afetados})

    @action(detail=False, methods=['put'], url_path='update-group/(?P<group_id>[^/.]+)')
    def update_group(self, request, group_id=None):
        with transaction.atomic():
            regras_antigas = AgendaConfig.objects.filter(group_id=group_id)
            if not regras_antigas.exists(): return Response({"error": "Agenda não encontrada."}, status=status.HTTP_404_NOT_FOUND)
            
            primeira = regras_antigas.first()
            prof = primeira.profissional_id
            spec = primeira.especialidade_id
            
            regras_antigas.delete()
            
            data = request.data
            dias = data.get('dias_semana', [])
            if not dias: raise Exception("Dias obrigatórios")
            
            tipo = data.get('tipo')
            situacao = data.get('situacao', True)
            
            # Tratamento rigoroso de convênio para não salvar lixo
            c_val = data.get('convenio')
            if c_val and str(c_val).strip() not in ['', 'null', 'undefined']:
                convenio_id = c_val
            else:
                convenio_id = None

            for dia in dias:
                base = {
                    'group_id': group_id, 'profissional_id': prof, 'especialidade_id': spec,
                    'convenio_id': convenio_id, 'dia_semana': dia,
                    'data_inicio': data['data_inicio'], 'data_fim': data['data_fim'],
                    'valor': data.get('valor', 0), 'tipo': tipo, 'situacao': situacao
                }
                if tipo == 'fixo':
                    for h in data.get('lista_horarios', []):
                        AgendaConfig.objects.create(**base, hora_inicio=h['time'], hora_fim=h['time'], intervalo_minutos=0, quantidade_atendimentos=h['qtd'])
                else:
                    AgendaConfig.objects.create(**base, hora_inicio=data['hora_inicio'], hora_fim=data['hora_fim'], intervalo_minutos=data['intervalo_minutos'], quantidade_atendimentos=data.get('quantidade_atendimentos', 1))

            return Response({"message": "OK"})

============================================================
ARQUIVO: agendas\__init__.py
============================================================


============================================================
ARQUIVO: clinica-front\eslint.config.js
============================================================
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])


============================================================
ARQUIVO: clinica-front\index.html
============================================================
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>clinica-front</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>


============================================================
ARQUIVO: clinica-front\package.json
============================================================
{
  "name": "clinica-front",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "axios": "^1.13.2",
    "jspdf": "^4.0.0",
    "jwt-decode": "^4.0.0",
    "lucide-react": "^0.562.0",
    "react": "^19.2.0",
    "react-calendar": "^6.0.0",
    "react-dom": "^19.2.0",
    "react-router-dom": "^7.11.0"
  },
  "devDependencies": {
    "@eslint/js": "^9.39.1",
    "@types/react": "^19.2.5",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.1",
    "autoprefixer": "^10.4.23",
    "eslint": "^9.39.1",
    "eslint-plugin-react-hooks": "^7.0.1",
    "eslint-plugin-react-refresh": "^0.4.24",
    "globals": "^16.5.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17",
    "vite": "npm:rolldown-vite@7.2.5"
  },
  "overrides": {
    "vite": "npm:rolldown-vite@7.2.5"
  }
}


============================================================
ARQUIVO: clinica-front\postcss.config.js
============================================================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

============================================================
ARQUIVO: clinica-front\tailwind.config.js
============================================================
/** @type {import('tailwindcss').Config} */
export default {
  darkMode: 'class', // <--- ADICIONE ESTA LINHA (Isso é o segredo)
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}

============================================================
ARQUIVO: clinica-front\vite.config.js
============================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})


============================================================
ARQUIVO: clinica-front\src\App.css
============================================================
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}


============================================================
ARQUIVO: clinica-front\src\App.jsx
============================================================
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { AuthProvider, useAuth } from './context/AuthContext';
import { ThemeProvider } from './context/ThemeContext';
// IMPORTE AQUI
import { NotificationProvider } from './context/NotificationContext'; 

// ... imports das páginas ...
import Login from './pages/Login';
import Dashboard from './pages/Dashboard';
import Pacientes from './pages/Pacientes';
import Operadores from './pages/Operadores';            
import CadastroOperador from './pages/CadastroOperador';
import Configuracoes from './pages/Configuracoes';
import TrocarSenhaObrigatoria from './pages/TrocarSenhaObrigatoria';
import Especialidades from './pages/Especialidades';
import Profissionais from './pages/Profissionais';
import ProfissionalForm from './pages/ProfissionaisForm';
import CriarAgenda from './pages/CriarAgenda';
import ConfigurarAgenda from './pages/ConfigurarAgenda';
import Convenios from './pages/Convenios';
import DadosClinica from './pages/DadosClinica';
import MarcarConsulta from './pages/MarcarConsulta';

const RotaPrivada = ({ children, adminOnly = false }) => {
  const { user, loading } = useAuth();
  if (loading) return <div className="flex h-screen items-center justify-center">Carregando...</div>;
  if (!user) return <Navigate to="/" />;
  if (user.force_password_change) return <Navigate to="/trocar-senha-obrigatoria" />;
  if (adminOnly && !user.is_superuser) return <Navigate to="/dashboard" />;
  return children;
};

function App() {
  return (
    <BrowserRouter>
      {/* 1. Envolva o AuthProvider com o Theme e o Notification */}
      <AuthProvider>
        <ThemeProvider>
          <NotificationProvider> 
            <Routes>
              <Route path="/" element={<Login />} />
              <Route path="/dashboard" element={<RotaPrivada><Dashboard /></RotaPrivada>} />
              <Route path="/pacientes" element={<RotaPrivada><Pacientes /></RotaPrivada>} />
              <Route path="/operadores" element={<RotaPrivada adminOnly><Operadores /></RotaPrivada>} />
              <Route path="/operadores/novo" element={<RotaPrivada adminOnly><CadastroOperador /></RotaPrivada>} />
              <Route path="/operadores/:id" element={<RotaPrivada adminOnly><CadastroOperador /></RotaPrivada>} />
              <Route path="/especialidades" element={<RotaPrivada adminOnly><Especialidades /></RotaPrivada>} />
              <Route path="/profissionais" element={<RotaPrivada><Profissionais /></RotaPrivada>} />
              <Route path="/profissionais/novo" element={<RotaPrivada><ProfissionalForm /></RotaPrivada>} />
              <Route path="/profissionais/:id" element={<RotaPrivada><ProfissionalForm /></RotaPrivada>} />
              <Route path="/agenda/configurar" element={<RotaPrivada><ConfigurarAgenda /></RotaPrivada>} />
              <Route path="/agenda/criar" element={<RotaPrivada><CriarAgenda /></RotaPrivada>} />
              <Route path="/agenda/marcar" element={<RotaPrivada><MarcarConsulta /></RotaPrivada>} />
              <Route path="/convenios" element={<RotaPrivada adminOnly><Convenios /></RotaPrivada>} />
              <Route path="/clinica" element={<RotaPrivada adminOnly><DadosClinica /></RotaPrivada>} />
              <Route path="*" element={<Navigate to="/" />} />
            </Routes>
          </NotificationProvider>
        </ThemeProvider>
      </AuthProvider>
    </BrowserRouter>
  );
}

export default App;

============================================================
ARQUIVO: clinica-front\src\index.css
============================================================
@tailwind base;
@tailwind components;
@tailwind utilities;

html, body, #root {
  height: 100%;
  width: 100%;
  margin: 0;
  padding: 0;
  background-color: #f8fafc; /* Garante fundo claro */
}



============================================================
ARQUIVO: clinica-front\src\main.jsx
============================================================
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.jsx'

createRoot(document.getElementById('root')).render(
  <StrictMode>
    <App />
  </StrictMode>,
)


============================================================
ARQUIVO: clinica-front\src\components\Layout.jsx
============================================================
import Navbar from './Navbar';

export default function Layout({ children }) {
  return (
    // Adicionei dark:bg-slate-900 e dark:text-slate-100
    <div className="min-h-screen bg-slate-50 dark:bg-slate-950 text-slate-800 dark:text-slate-100 font-sans transition-colors duration-300">
      <Navbar />
      <main className="container mx-auto px-4 py-8">
        {children}
      </main>
    </div>
  );
}

============================================================
ARQUIVO: clinica-front\src\components\Navbar.jsx
============================================================
import { Link, useNavigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';
import { useTheme } from '../context/ThemeContext';
import { 
  Stethoscope, CalendarDays, DollarSign, Settings, LogOut, ChevronDown, Moon, Sun, Building2, ShieldCheck
} from 'lucide-react';

export default function Navbar() {
  const { user, logout } = useAuth();
  const { theme, toggleTheme } = useTheme();
  const navigate = useNavigate();

  const handleLogout = () => { logout(); navigate('/'); };

  const NavItem = ({ icon: Icon, title, children }) => (
    <div className="relative group h-full flex items-center">
      <button className="flex items-center space-x-2 bg-transparent text-slate-700 dark:text-slate-200 font-semibold px-4 py-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-blue-600 dark:hover:text-blue-400 transition-all">
        <Icon size={18} className="text-slate-500 dark:text-slate-400 group-hover:text-blue-600 dark:group-hover:text-blue-400" />
        <span>{title}</span>
        <ChevronDown size={14} className="mt-0.5 opacity-50 group-hover:rotate-180 transition-transform" />
      </button>
      <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 transform origin-top translate-y-2 group-hover:translate-y-0 overflow-hidden">
        <div className="py-2">
          {children}
        </div>
      </div>
    </div>
  );

  const DropdownLink = ({ to, text, icon: Icon }) => (
    <Link to={to} className="flex items-center gap-3 px-4 py-3 text-sm text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 hover:text-blue-600 dark:hover:text-white transition-colors border-l-2 border-transparent hover:border-blue-500">
      {Icon && <Icon size={16} className="opacity-70" />}
      {text}
    </Link>
  );

  const topButtonClass = "p-2 rounded-lg bg-transparent text-slate-500 hover:bg-slate-100 hover:text-slate-800 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-white transition-colors";

  return (
    <nav className="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 shadow-sm h-20 relative z-40 transition-colors duration-300">
      <div className="container mx-auto px-6 h-full flex justify-between items-center">
        
        {/* LOGO */}
        <Link to="/dashboard" className="flex items-center space-x-2 group">
          <div className="bg-blue-600 text-white p-2 rounded-xl shadow-md group-hover:bg-blue-700 transition-colors">
            <Stethoscope size={24} />
          </div>
          <div>
            <span className="text-xl font-bold tracking-tight text-slate-800 dark:text-white block leading-none">TheClinic</span>
            <span className="text-xs text-slate-400 font-medium tracking-wider">SYSTEM</span>
          </div>
        </Link>

        {/* MENU CENTRAL */}
        <div className="hidden md:flex items-center space-x-1 h-full">
          {(user?.acesso_atendimento || user?.is_superuser) && (
            <NavItem icon={Stethoscope} title="Atendimento">
              <DropdownLink to="/prontuarios" text="Prontuário Eletrônico" />
              <DropdownLink to="/triagem" text="Triagem" />
            </NavItem>
          )}

          {(user?.acesso_agendamento || user?.is_superuser) && (
            <NavItem icon={CalendarDays} title="Agendamento">
              <DropdownLink to="/agenda" text="Ver Agenda" />
              <DropdownLink to="/agenda/marcar" text="Marcar Consulta" />
              <div className="border-t border-slate-100 dark:border-slate-700 my-1"></div>
              <DropdownLink to="/agenda/configurar" text="Configurar Horários" />
            </NavItem>
          )}

          {(user?.acesso_faturamento || user?.is_superuser) && (
             <NavItem icon={DollarSign} title="Financeiro">
              <DropdownLink to="/faturamento" text="Emitir Nota Fiscal" />
              <DropdownLink to="/relatorios" text="Relatórios Financeiros" />
            </NavItem>
          )}

          {user?.is_superuser && (
            <NavItem icon={Settings} title="Sistema">
              <DropdownLink to="/pacientes" text="Pacientes" />
              <DropdownLink to="/operadores" text="Operadores" />
              <DropdownLink to="/profissionais" text="Profissionais" />
              <DropdownLink to="/especialidades" text="Especialidades" />
              
              {/* NOVOS LINKS ADICIONADOS AQUI */}
              <div className="border-t border-slate-100 dark:border-slate-700 my-1"></div>
              <DropdownLink to="/convenios" text="Convênios" icon={ShieldCheck} />
              <DropdownLink to="/clinica" text="Dados da Clínica" icon={Building2} />
              
              <div className="border-t border-slate-100 dark:border-slate-700 my-1"></div>
              <DropdownLink to="/configuracoes" text="Configurações Gerais" />
            </NavItem>
          )}
        </div>

        {/* ÁREA DIREITA */}
        <div className="flex items-center space-x-3">
          <button onClick={toggleTheme} className={topButtonClass}>
            {theme === 'light' ? <Moon size={20} /> : <Sun size={20} />}
          </button>

          <div className="h-8 w-px bg-slate-200 dark:bg-slate-700 mx-2 hidden lg:block"></div>

          <div className="text-right hidden lg:block">
            <p className="text-sm font-bold text-slate-700 dark:text-slate-200">{user?.first_name || user?.username}</p>
            <p className="text-xs text-slate-400 font-medium bg-slate-100 dark:bg-slate-800 inline-block px-2 py-0.5 rounded-full border border-slate-200 dark:border-slate-700">
              {user?.is_superuser ? 'Administrador' : 'Operador'}
            </p>
          </div>
          
          <button onClick={handleLogout} className={`${topButtonClass} hover:text-red-600 dark:hover:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20`}>
            <LogOut size={20} />
          </button>
        </div>
      </div>
    </nav>
  );
}

============================================================
ARQUIVO: clinica-front\src\context\AuthContext.jsx
============================================================
import { createContext, useState, useEffect, useContext } from 'react';
import axios from 'axios';

const AuthContext = createContext();

// Defina a URL da sua API aqui
const api = axios.create({ baseURL: 'http://127.0.0.1:8000/api/' });

export function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // 1. Tenta recuperar de ambos os lugares (Local ou Session)
    const token = localStorage.getItem('token') || sessionStorage.getItem('token');

    if (token) {
      api.defaults.headers.common['Authorization'] = `Bearer ${token}`;
      api.get('me/')
        .then(res => setUser(res.data))
        .catch(() => {
          logout(); // Se o token for inválido, limpa tudo
        })
        .finally(() => setLoading(false));
    } else {
      setLoading(false);
    }
  }, []);

  // 2. Agora o login aceita o parâmetro 'remember'
  const login = async (username, password, remember) => {
    try {
      const response = await api.post('token/', { username, password });
      const { access } = response.data;

      // LÓGICA DO LEMBRAR-ME:
      if (remember) {
        localStorage.setItem('token', access); // Salva pra sempre (até limpar cache)
      } else {
        sessionStorage.setItem('token', access); // Salva só enquanto a aba estiver aberta
      }

      api.defaults.headers.common['Authorization'] = `Bearer ${access}`;
      
      const userResponse = await api.get('me/');
      setUser(userResponse.data);
      return true;
    } catch (error) {
      return false;
    }
  };

  const logout = () => {
    // Limpa dos dois lugares para garantir
    localStorage.removeItem('token');
    sessionStorage.removeItem('token');
    delete api.defaults.headers.common['Authorization'];
    setUser(null);
  };

  return (
    <AuthContext.Provider value={{ user, login, logout, loading, api }}>
      {children}
    </AuthContext.Provider>
  );
}

export const useAuth = () => useContext(AuthContext);

============================================================
ARQUIVO: clinica-front\src\context\NotificationContext.jsx
============================================================
import React, { createContext, useContext, useState, useCallback } from 'react';
import { CheckCircle2, XCircle, AlertTriangle, Info, X, Loader2 } from 'lucide-react';

const NotificationContext = createContext();

export function NotificationProvider({ children }) {
  const [toasts, setToasts] = useState([]);
  const [dialog, setDialog] = useState(null);

  // --- LÓGICA DOS TOASTS (NOTIFICAÇÕES) ---
  const addToast = useCallback((message, type = 'info') => {
    const id = Date.now();
    setToasts((prev) => [...prev, { id, message, type }]);
    
    // Remove automaticamente após 3 segundos
    setTimeout(() => {
      removeToast(id);
    }, 4000);
  }, []);

  const removeToast = useCallback((id) => {
    setToasts((prev) => prev.filter((t) => t.id !== id));
  }, []);

  // Atalhos para facilitar
  const notify = {
    success: (msg) => addToast(msg, 'success'),
    error: (msg) => addToast(msg, 'error'),
    warning: (msg) => addToast(msg, 'warning'),
    info: (msg) => addToast(msg, 'info'),
  };

  // --- LÓGICA DO DIALOG (CONFIRMAÇÃO) ---
  // Retorna uma Promise para podermos usar: await confirm(...)
  const confirmDialog = useCallback((message, title = 'Confirmação', confirmText = 'Confirmar', cancelText = 'Cancelar', variant = 'danger') => {
    return new Promise((resolve) => {
      setDialog({
        title,
        message,
        confirmText,
        cancelText,
        variant, // 'danger' (vermelho) ou 'primary' (azul)
        onConfirm: () => {
          setDialog(null);
          resolve(true);
        },
        onCancel: () => {
          setDialog(null);
          resolve(false);
        }
      });
    });
  }, []);

  // --- COMPONENTES VISUAIS INTERNOS ---
  
  // Ícones e cores baseados no tipo
  const toastConfig = {
    success: { icon: CheckCircle2, color: 'bg-green-500', border: 'border-green-600', text: 'text-white' },
    error: { icon: XCircle, color: 'bg-red-500', border: 'border-red-600', text: 'text-white' },
    warning: { icon: AlertTriangle, color: 'bg-orange-500', border: 'border-orange-600', text: 'text-white' },
    info: { icon: Info, color: 'bg-blue-500', border: 'border-blue-600', text: 'text-white' },
  };

  return (
    <NotificationContext.Provider value={{ notify, confirmDialog }}>
      {children}

      {/* RENDERIZAÇÃO DOS TOASTS (Canto Superior Direito) */}
      <div className="fixed top-4 right-4 z-[9999] flex flex-col gap-2">
        {toasts.map((t) => {
          const config = toastConfig[t.type];
          const Icon = config.icon;
          return (
            <div key={t.id} className={`${config.color} ${config.text} border-l-4 ${config.border} p-4 rounded-r shadow-lg flex items-center gap-3 min-w-[300px] animate-in slide-in-from-right duration-300`}>
              <Icon size={24} />
              <p className="font-medium text-sm flex-1">{t.message}</p>
              <button onClick={() => removeToast(t.id)} className="opacity-70 hover:opacity-100"><X size={18}/></button>
            </div>
          );
        })}
      </div>

      {/* RENDERIZAÇÃO DO MODAL DE CONFIRMAÇÃO */}
      {dialog && (
        <div className="fixed inset-0 z-[10000] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
          <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full p-6 transform scale-100 animate-in zoom-in-95 duration-200">
            <h3 className="text-xl font-bold text-slate-800 dark:text-white mb-2">{dialog.title}</h3>
            <p className="text-slate-600 dark:text-slate-300 mb-6">{dialog.message}</p>
            
            <div className="flex justify-end gap-3">
              <button 
                onClick={dialog.onCancel}
                className="px-4 py-2 text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors"
              >
                {dialog.cancelText}
              </button>
              <button 
                onClick={dialog.onConfirm}
                className={`px-6 py-2 text-white font-bold rounded-lg shadow-md transition-transform active:scale-95 ${
                  dialog.variant === 'danger' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'
                }`}
              >
                {dialog.confirmText}
              </button>
            </div>
          </div>
        </div>
      )}
    </NotificationContext.Provider>
  );
}

export const useNotification = () => useContext(NotificationContext);

============================================================
ARQUIVO: clinica-front\src\context\ThemeContext.jsx
============================================================
import { createContext, useContext, useEffect, useState } from 'react';

const ThemeContext = createContext();

export function ThemeProvider({ children }) {
  // Tenta pegar do localStorage, se não tiver, começa como 'light'
  const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');

  useEffect(() => {
    const root = window.document.documentElement;
    
    // Remove a classe antiga e adiciona a nova
    root.classList.remove('light', 'dark');
    root.classList.add(theme);
    
    // Salva a escolha para a próxima vez
    localStorage.setItem('theme', theme);
  }, [theme]);

  const toggleTheme = () => {
    setTheme((prev) => (prev === 'light' ? 'dark' : 'light'));
  };

  return (
    <ThemeContext.Provider value={{ theme, toggleTheme }}>
      {children}
    </ThemeContext.Provider>
  );
}

export const useTheme = () => useContext(ThemeContext);

============================================================
ARQUIVO: clinica-front\src\pages\CadastroOperador.jsx
============================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNotification } from '../context/NotificationContext'; // <--- NOVO
import { useNavigate, useParams } from 'react-router-dom';
import Layout from '../components/Layout';
import { 
  UserCog, Mail, Lock, Shield, Save, Check, Stethoscope, CalendarDays, DollarSign, KeyRound, ArrowLeft, Loader2 
} from 'lucide-react';

export default function CadastroOperador() {
  const { api } = useAuth();
  const { notify } = useNotification(); // <--- HOOK
  const navigate = useNavigate();
  const { id } = useParams();
  
  const [loading, setLoading] = useState(false);
  const [fetching, setFetching] = useState(id ? true : false);
  
  const [formData, setFormData] = useState({
    username: '', password: '', first_name: '', email: '',
    acesso_atendimento: false, acesso_agendamento: false, 
    acesso_faturamento: false, is_superuser: false,
    force_password_change: true
  });

  useEffect(() => {
    if (id && api) {
        api.get(`operadores/${id}/`)
           .then(res => {
                const data = res.data;
                setFormData({
                    username: data.username || '',
                    first_name: data.first_name || '',
                    email: data.email || '',
                    acesso_atendimento: data.acesso_atendimento || false,
                    acesso_agendamento: data.acesso_agendamento || false,
                    acesso_faturamento: data.acesso_faturamento || false,
                    is_superuser: data.is_superuser || false,
                    force_password_change: data.force_password_change || false,
                    password: ''
                });
           })
           .catch(err => {
               console.error(err);
               if (err.response?.status === 401) notify.error("Sessão expirada. Faça login novamente.");
               navigate('/operadores');
           })
           .finally(() => setFetching(false));
    }
  }, [id, api, navigate]);

  const handleChange = (e) => {
    const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
    setFormData({ ...formData, [e.target.name]: value });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      if (id) {
          const dadosParaEnviar = { ...formData };
          if (!dadosParaEnviar.password) delete dadosParaEnviar.password;
          await api.put(`operadores/${id}/`, dadosParaEnviar);
          notify.success('Operador atualizado com sucesso!'); // <---
      } else {
          await api.post('operadores/novo/', formData);
          notify.success('Operador criado com sucesso!'); // <---
      }
      navigate('/operadores');
    } catch (error) {
      console.error(error);
      const msg = error.response?.data?.error || 'Erro ao salvar operador.';
      notify.error(msg); // <---
    } finally {
      setLoading(false);
    }
  };

  const inputClass = "w-full pl-10 bg-white dark:bg-slate-900 text-slate-900 dark:text-white border border-slate-300 dark:border-slate-700 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder-slate-400 dark:placeholder-slate-600";
  const labelClass = "block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1.5";
  const backButtonClass = "mb-4 flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors shadow-sm text-sm font-bold w-fit";

  const PermissionToggle = ({ name, label, icon: Icon, checked, onChange }) => {
    const activeContainer = "bg-blue-50 border-blue-600 ring-1 ring-blue-600 dark:bg-blue-900/30 dark:border-blue-400 dark:ring-blue-400";
    const inactiveContainer = "bg-white border-slate-200 hover:border-blue-300 dark:bg-slate-800 dark:border-slate-700";

    return (
      <label className={`relative flex items-center justify-between p-4 border rounded-xl cursor-pointer transition-all duration-200 ${checked ? activeContainer : inactiveContainer}`}>
        <div className="flex items-center space-x-4">
          <div className={`p-3 rounded-lg transition-colors ${checked ? 'bg-white shadow-sm dark:bg-slate-800 text-blue-600 dark:text-blue-400' : 'bg-slate-100 dark:bg-slate-700 text-slate-400'}`}>
            <Icon size={24} />
          </div>
          <div>
            <span className={`block font-bold text-base ${checked ? 'text-blue-900 dark:text-blue-100' : 'text-slate-600 dark:text-slate-300'}`}>
              {label}
            </span>
            <span className={`text-xs font-medium ${checked ? 'text-blue-600 dark:text-blue-300' : 'text-slate-400 dark:text-slate-500'}`}>
              {checked ? 'Habilitado' : 'Desabilitado'}
            </span>
          </div>
        </div>
        <div className={`w-8 h-8 rounded-full flex items-center justify-center border-2 transition-all duration-200 ${checked ? 'bg-blue-600 border-blue-600 scale-110 shadow-md' : 'bg-transparent border-slate-300 dark:border-slate-600'}`}>
          {checked && <Check size={18} className="text-white" strokeWidth={3} />}
        </div>
        <input type="checkbox" name={name} checked={checked} onChange={onChange} className="sr-only" />
      </label>
    );
  };

  if (fetching) return <Layout><div className="flex justify-center p-10 text-slate-400">Carregando dados do operador...</div></Layout>;

  return (
    <Layout>
      <div className="max-w-5xl mx-auto">
        <button onClick={() => navigate('/operadores')} className={backButtonClass}>
            <ArrowLeft size={18}/> Voltar
        </button>

        <div className="mb-8 flex items-center space-x-4">
          <div className="bg-blue-600 p-3 rounded-xl shadow-lg text-white">
            <UserCog size={32} />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-slate-800 dark:text-white">{id ? 'Editar Operador' : 'Novo Operador'}</h1>
            <p className="text-slate-500 dark:text-slate-400 text-sm">Gerencie as credenciais e permissões de acesso.</p>
          </div>
        </div>

        <form onSubmit={handleSubmit}>
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div className="lg:col-span-2 space-y-6">
              <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
                <h2 className="text-lg font-bold text-slate-700 dark:text-white mb-6 flex items-center gap-2">
                  <Shield size={20} className="text-blue-600 dark:text-blue-400"/> Credenciais
                </h2>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                  <div className="col-span-2">
                    <label className={labelClass}>Nome Completo</label>
                    <input name="first_name" value={formData.first_name} onChange={handleChange} className={inputClass.replace('pl-10', 'px-4')} placeholder="Ex: Dra. Ana Paula" required />
                  </div>

                  <div className="col-span-2">
                    <label className={labelClass}>Email</label>
                    <div className="relative">
                      <Mail className="absolute left-3 top-3.5 text-slate-400" size={18} />
                      <input name="email" value={formData.email} type="email" onChange={handleChange} className={inputClass} placeholder="email@clinica.com" />
                    </div>
                  </div>

                  <div>
                    <label className={labelClass}>Nome de Usuário</label>
                    <div className="relative">
                      <UserCog className="absolute left-3 top-3.5 text-slate-400" size={18} />
                      <input name="username" value={formData.username} onChange={handleChange} className={inputClass} placeholder="usuario.sistema" required />
                    </div>
                  </div>

                  <div>
                    <label className={labelClass}>Senha</label>
                    <div className="relative">
                      <Lock className="absolute left-3 top-3.5 text-slate-400" size={18} />
                      <input name="password" type="password" value={formData.password} onChange={handleChange} className={inputClass} placeholder={id ? "•••••• (Vazio p/ manter)" : "••••••"} required={!id} />
                    </div>
                  </div>
                  
                   <div className="col-span-2 mt-2">
                     <PermissionToggle 
                        name="force_password_change" 
                        label="Forçar Troca de Senha" 
                        icon={KeyRound} 
                        checked={formData.force_password_change} 
                        onChange={handleChange} 
                      />
                   </div>
                </div>
              </div>
            </div>

            <div className="lg:col-span-1">
              <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 h-full flex flex-col">
                <h2 className="text-lg font-bold text-slate-700 dark:text-white mb-2">Permissões de Acesso</h2>
                <p className="text-sm text-slate-400 mb-6">Selecione os módulos liberados:</p>

                <div className="space-y-4 flex-grow">
                  <PermissionToggle name="acesso_atendimento" label="Atendimento" icon={Stethoscope} checked={formData.acesso_atendimento} onChange={handleChange} />
                  <PermissionToggle name="acesso_agendamento" label="Agendamento" icon={CalendarDays} checked={formData.acesso_agendamento} onChange={handleChange} />
                  <PermissionToggle name="acesso_faturamento" label="Financeiro" icon={DollarSign} checked={formData.acesso_faturamento} onChange={handleChange} />
                  <hr className="border-slate-100 dark:border-slate-700 my-4"/>
                  <PermissionToggle name="is_superuser" label="Administrador" icon={Shield} checked={formData.is_superuser} onChange={handleChange} />
                </div>

                <div className="mt-8 flex flex-col gap-3">
                    <button disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2 active:scale-95 disabled:opacity-50">
                      {loading ? <Loader2 className="animate-spin" size={20}/> : <Save size={20} />}
                      {loading ? 'Salvando...' : 'Salvar Operador'}
                    </button>
                     <button type="button" onClick={() => navigate('/operadores')} className="w-full bg-slate-100 text-slate-600 font-bold py-3 rounded-xl transition-colors">
                        Cancelar
                    </button>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front\src\pages\Configuracoes.jsx
============================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import Layout from '../components/Layout';
import { Settings, Save } from 'lucide-react';

export default function Configuracoes() {
  const { api } = useAuth();
  const [itensPorPagina, setItensPorPagina] = useState(15);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (api) {
        api.get('operadores/config/')
           .then(res => setItensPorPagina(res.data.itens_por_pagina))
           .catch(() => console.log("Usando padrão"));
    }
  }, [api]);

  const handleSave = async () => {
    setLoading(true);
    try {
      await api.put('operadores/config/', { itens_por_pagina: itensPorPagina });
      alert('Configuração salva!');
    } catch (error) { alert('Erro ao salvar.'); } 
    finally { setLoading(false); }
  };

  if (!api) return <div>Carregando...</div>;

  return (
    <Layout>
      <div className="max-w-2xl mx-auto">
        <div className="mb-8 flex items-center space-x-3">
            <div className="bg-slate-700 p-3 rounded-xl text-white shadow"><Settings size={28}/></div>
            <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Configurações</h1>
        </div>
        <div className="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
            <label className="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-2">Itens por página</label>
            <div className="flex gap-4">
                <input type="number" value={itensPorPagina} onChange={e => setItensPorPagina(e.target.value)} className="w-32 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-3 dark:text-white"/>
                <button onClick={handleSave} disabled={loading} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold flex gap-2">
                    <Save size={20}/> Salvar
                </button>
            </div>
        </div>
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front\src\pages\ConfigurarAgenda.jsx
============================================================
import React, { useState, useEffect, useRef } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNotification } from '../context/NotificationContext';
import Layout from '../components/Layout';
import { useNavigate } from 'react-router-dom';
import { 
  CalendarRange, Search, Plus, Filter, Edit, Trash2, 
  X, Save, Clock, CalendarDays, PlusCircle, Calculator, DollarSign, Pin, Hourglass, Repeat, ShieldCheck, Users, ListFilter, ChevronDown, Check, RotateCcw 
} from 'lucide-react';

// --- COMPONENTES AUXILIARES ---
const FilterSearchableSelect = ({ options, value, onChange, placeholder, onEnter }) => {
    const [isOpen, setIsOpen] = useState(false);
    const [text, setText] = useState('');
    const containerRef = useRef(null);

    useEffect(() => {
        if (!value) setText('');
        else {
            const found = options.find(o => String(o.id) === String(value));
            if (found) setText(found.label);
        }
    }, [value, options]);

    const filtered = options.filter(o => o.label.toLowerCase().includes(text.toLowerCase()));

    useEffect(() => {
        const handleClickOutside = (e) => {
            if (containerRef.current && !containerRef.current.contains(e.target)) {
                setIsOpen(false);
                if (value) {
                    const found = options.find(o => String(o.id) === String(value));
                    if (found) setText(found.label);
                }
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, [value, options]);

    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (filtered.length === 1) {
                onChange(filtered[0].id);
                setText(filtered[0].label);
                setIsOpen(false);
                if(onEnter) setTimeout(() => onEnter(), 50); 
            } else if (value && onEnter) onEnter();
        }
    };

    return (
        <div className="relative w-full h-full" ref={containerRef}>
            <input type="text" className="w-full h-full pl-3 pr-8 bg-white dark:bg-slate-900 border-y border-r border-slate-200 dark:border-slate-700 outline-none dark:text-white focus:ring-2 focus:ring-blue-100 transition-all text-sm" placeholder={placeholder} value={text} onChange={e => { setText(e.target.value); setIsOpen(true); onChange(''); }} onFocus={() => setIsOpen(true)} onKeyDown={handleKeyDown} />
            {isOpen && (
                <ul className="absolute top-full left-0 w-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-b-xl shadow-xl max-h-60 overflow-auto z-50">
                    {filtered.length > 0 ? filtered.map(opt => (
                        <li key={opt.id} onMouseDown={() => { onChange(opt.id); setText(opt.label); setIsOpen(false); }} className="px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer text-sm dark:text-white flex justify-between">{opt.label}</li>
                    )) : <li className="px-4 py-2 text-slate-400 text-xs">Sem resultados</li>}
                </ul>
            )}
        </div>
    );
};

const CustomDropdown = ({ options, value, onChange, icon: Icon, widthClass = "w-full" }) => {
    const [isOpen, setIsOpen] = useState(false);
    const containerRef = useRef(null);
    const selectedLabel = options.find(o => o.value === value)?.label || "Selecione";

    useEffect(() => {
        const handleClickOutside = (e) => { if (containerRef.current && !containerRef.current.contains(e.target)) setIsOpen(false); };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);

    return (
        <div className={`relative ${widthClass} h-full`} ref={containerRef}>
            <button type="button" onClick={() => setIsOpen(!isOpen)} className={`flex items-center justify-between w-full h-full px-4 bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 text-sm font-bold transition-all outline-none ${isOpen ? 'rounded-tl-xl' : 'rounded-l-xl'}`}>
                <div className="flex items-center gap-2 truncate">{Icon && <Icon size={18} className="text-slate-500"/>}<span>{selectedLabel}</span></div>
                <ChevronDown size={16} className={`text-slate-400 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}/>
            </button>
            {isOpen && (
                <div className="absolute top-full left-0 w-full min-w-[200px] mt-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-xl z-50 overflow-hidden animate-in fade-in zoom-in duration-100">
                    <ul className="max-h-60 overflow-auto py-1">{options.map((opt) => (<li key={opt.value} onClick={() => { onChange(opt.value); setIsOpen(false); }} className={`px-4 py-2.5 text-sm cursor-pointer flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors ${value === opt.value ? 'text-blue-600 dark:text-blue-400 font-bold bg-blue-50 dark:bg-blue-900/20' : 'text-slate-600 dark:text-slate-300'}`}>{opt.label} {value === opt.value && <Check size={14}/>}</li>))}</ul>
                </div>
            )}
        </div>
    );
};

export default function ConfigurarAgenda() {
  const { api } = useAuth();
  const { notify, confirmDialog } = useNotification();
  const navigate = useNavigate();

  const [configs, setConfigs] = useState([]);
  const [loading, setLoading] = useState(true);
  
  const [profissionaisFilter, setProfissionaisFilter] = useState([]);
  const [especialidadesFilter, setEspecialidadesFilter] = useState([]);
  const [conveniosFilter, setConveniosFilter] = useState([]);

  // Estados de Filtro - INICIA VAZIO []
  const [filterType, setFilterType] = useState('texto'); 
  const [filterValue, setFilterValue] = useState(''); 
  const [activeFilters, setActiveFilters] = useState([]); 
  const [statusFilter, setStatusFilter] = useState('ativos'); 
  
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingItem, setEditingItem] = useState(null); 
  const [editingDays, setEditingDays] = useState([]);
  const [editModoCalculo, setEditModoCalculo] = useState('final');
  const [editHorariosFixos, setEditHorariosFixos] = useState([]); 
  const [saving, setSaving] = useState(false);
  const [allConvenios, setAllConvenios] = useState([]);

  const diasMap = [{ id: 1, label: 'Seg', full: 'Segunda-feira' }, { id: 2, label: 'Ter', full: 'Terça-feira' }, { id: 3, label: 'Qua', full: 'Quarta-feira' }, { id: 4, label: 'Qui', full: 'Quinta-feira' }, { id: 5, label: 'Sex', full: 'Sexta-feira' }, { id: 6, label: 'Sáb', full: 'Sábado' }, { id: 0, label: 'Dom', full: 'Domingo' }];

  const filterTypeOptions = [{ value: 'texto', label: 'Busca Geral' }, { value: 'data_inicial', label: 'Data Inicial' }, { value: 'data_final', label: 'Data Final' }, { value: 'data_especifica', label: 'Data Específica' }, { value: 'profissional_id', label: 'Profissional' }, { value: 'especialidade_id', label: 'Especialidade' }, { value: 'convenio_id', label: 'Convênio' }, { value: 'dia_filtro', label: 'Dia da Semana' }];

  const formatData = (dataString) => { if (!dataString) return '-'; const [ano, mes, dia] = dataString.split('-'); return `${dia}/${mes}/${ano}`; };
  const formatDateBr = (dateString) => { if(!dateString) return ''; const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; };

  const getStatusBadge = (item) => {
      const hoje = new Date().toISOString().split('T')[0];
      if (!item.situacao) return <span className="px-2.5 py-1 rounded-full text-xs font-bold bg-slate-200 text-slate-600 border border-slate-300">Encerrada</span>;
      if (item.data_fim < hoje) return <span className="px-2.5 py-1 rounded-full text-xs font-bold bg-red-100 text-red-600 border border-red-200">Vencida</span>;
      return <span className="px-2.5 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-200">Ativa</span>;
  };

  useEffect(() => {
    if (api) {
        api.get(`agendas/config/filters_data/?status=${statusFilter}`).then(res => {
            setProfissionaisFilter(res.data.profissionais);
            setEspecialidadesFilter(res.data.especialidades);
        });
        api.get('configuracoes/convenios/').then(res => {
            const data = res.data.results || res.data;
            const options = data.map(c => ({ id: c.id, label: c.nome }));
            setConveniosFilter([{ id: 'sem_convenio', label: 'Particular (Sem Convênio)' }, ...options]);
            setAllConvenios(data.map(c => ({ id: c.id, nome: c.nome })));
        });
        loadData();
    }
  }, [api, statusFilter]);

  useEffect(() => { if(api) loadData(); }, [activeFilters]);

  const loadData = async () => {
    setLoading(true);
    try {
      // Começa SÓ com o status. Os outros só entram se existirem em activeFilters
      const params = new URLSearchParams();
      params.append('status', statusFilter);
      
      activeFilters.forEach(f => {
          const key = f.type === 'texto' ? 'search' : f.type;
          // Proteção extra: só adiciona se tiver valor
          if (f.value) params.append(key, f.value);
      });

      const response = await api.get(`agendas/config/?${params.toString()}`);
      setConfigs(response.data.results || response.data);
    } catch (error) { console.error(error); } finally { setLoading(false); }
  };

  const addFilter = () => {
      if (!filterValue) return;
      let label = filterValue;
      if (['data_inicial', 'data_final', 'data_especifica'].includes(filterType)) label = formatDateBr(filterValue);
      else if (filterType === 'profissional_id') label = profissionaisFilter.find(p => String(p.id) === String(filterValue))?.label || 'Desconhecido';
      else if (filterType === 'especialidade_id') label = especialidadesFilter.find(e => String(e.id) === String(filterValue))?.label || 'Desconhecida';
      else if (filterType === 'convenio_id') label = conveniosFilter.find(c => String(c.id) === String(filterValue))?.label || 'Desconhecido';
      else if (filterType === 'dia_filtro') label = diasMap.find(d => String(d.id) === String(filterValue))?.full;
      
      const typeLabel = filterTypeOptions.find(o => o.value === filterType)?.label;
      const newFilter = { id: Date.now(), type: filterType, value: filterValue, display: `${typeLabel}: ${label}` };
      const cleanFilters = activeFilters.filter(f => f.type !== filterType);
      setActiveFilters([...cleanFilters, newFilter]);
      setFilterValue('');
  };

  const removeFilter = (id) => setActiveFilters(activeFilters.filter(f => f.id !== id));
  const clearAllFilters = () => { setActiveFilters([]); setFilterValue(''); };
  const handleKeyDown = (e) => { if (e.key === 'Enter') addFilter(); };

  const renderDynamicInput = () => {
      const commonClass = "w-full pl-3 pr-12 bg-white dark:bg-slate-900 border-y border-r border-slate-200 dark:border-slate-700 p-3 outline-none dark:text-white focus:ring-2 focus:ring-blue-100 transition-all h-full";
      switch (filterType) {
          case 'data_inicial': case 'data_final': case 'data_especifica':
              return <input type="date" value={filterValue} onChange={e => setFilterValue(e.target.value)} className={commonClass} onKeyDown={handleKeyDown}/>;
          case 'dia_filtro':
              return <select value={filterValue} onChange={e => setFilterValue(e.target.value)} className={`${commonClass} cursor-pointer`}><option value="">Selecione...</option>{diasMap.map(dia => <option key={dia.id} value={dia.id}>{dia.full}</option>)}</select>;
          case 'profissional_id': return <FilterSearchableSelect placeholder="Digite o Profissional..." options={profissionaisFilter} value={filterValue} onChange={setFilterValue} onEnter={addFilter} />;
          case 'especialidade_id': return <FilterSearchableSelect placeholder="Digite a Especialidade..." options={especialidadesFilter} value={filterValue} onChange={setFilterValue} onEnter={addFilter} />;
          case 'convenio_id': return <FilterSearchableSelect placeholder="Digite o Convênio..." options={conveniosFilter} value={filterValue} onChange={setFilterValue} onEnter={addFilter} />;
          default: return <input placeholder="Digite para buscar..." value={filterValue} onChange={e => setFilterValue(e.target.value)} className={commonClass} onKeyDown={handleKeyDown}/>;
      }
  };

  const handleEdit = (item) => {
    setEditingItem({ ...item, situacao: item.situacao !== undefined && item.situacao !== null ? item.situacao : true });
    const diasIniciais = (item.dias_vinculados && item.dias_vinculados.length > 0) ? item.dias_vinculados : (item.dia_semana !== undefined ? [item.dia_semana] : []);
    setEditingDays(diasIniciais);
    setEditModoCalculo('final'); 
    if (item.tipo === 'fixo') {
        const horarios = item.horarios_fixos_detalhes && item.horarios_fixos_detalhes.length > 0 ? item.horarios_fixos_detalhes : [{ time: item.hora_inicio, qtd: item.quantidade_atendimentos }];
        setEditHorariosFixos(horarios); 
    } else { setEditHorariosFixos([]); }
    setIsModalOpen(true);
  };

  const handleDelete = async (item) => {
    const msg = item.total_agendados > 0 ? `ATENÇÃO: Existem ${item.total_agendados} pacientes agendados! Se excluir, eles ficarão como 'Encaixe'.` : "Isso excluirá permanentemente esta agenda.";
    const confirmed = await confirmDialog(msg, "Excluir Agenda", "Sim, excluir", "Cancelar", "danger");
    if (confirmed) { try { await api.put(`agendas/config/update-group/${item.group_id}/`, { dias_semana: [] }); loadData(); notify.success("Agenda excluída."); } catch (error) { notify.error("Erro ao excluir."); } }
  };

  const toggleEditDay = (id) => { if (editingDays.includes(id)) setEditingDays(editingDays.filter(d => d !== id)); else setEditingDays([...editingDays, id]); };
  const addHorarioFixo = () => setEditHorariosFixos([...editHorariosFixos, { time: '', qtd: 1 }]);
  const removeHorarioFixo = (idx) => setEditHorariosFixos(editHorariosFixos.filter((_, i) => i !== idx));
  const updateHorarioFixo = (idx, field, val) => { const novos = [...editHorariosFixos]; novos[idx][field] = val; setEditHorariosFixos(novos); };
  const timeToMinutes = (time) => { if (!time) return 0; const [h, m] = String(time).split(':').map(Number); return h * 60 + m; };
  const minutesToTime = (mins) => { const h = Math.floor(mins / 60).toString().padStart(2, '0'); const m = (mins % 60).toString().padStart(2, '0'); return `${h}:${m}`; };

  useEffect(() => {
    if (!isModalOpen || !editingItem) return;
    if (editingItem.tipo !== 'padrao' && editingItem.tipo !== 'tempo') return;
    const { hora_inicio, hora_fim, intervalo_minutos, quantidade_atendimentos } = editingItem;
    if (!hora_inicio || !intervalo_minutos || intervalo_minutos <= 0) return;
    const inicioMin = timeToMinutes(hora_inicio);
    if (editModoCalculo === 'final') {
        if (!hora_fim) return;
        const fimMin = timeToMinutes(hora_fim);
        if (fimMin <= inicioMin) { if(quantidade_atendimentos !== 0) setEditingItem(prev => ({ ...prev, quantidade_atendimentos: 0 })); return; }
        const diff = fimMin - inicioMin;
        const novaQtd = Math.floor(diff / intervalo_minutos);
        if (novaQtd !== quantidade_atendimentos) { setEditingItem(prev => ({ ...prev, quantidade_atendimentos: novaQtd })); }
    } else {
        if (!quantidade_atendimentos) return;
        const duracaoTotal = quantidade_atendimentos * intervalo_minutos;
        const fimMin = inicioMin + duracaoTotal;
        let novoFim = '';
        if (fimMin >= 1440) novoFim = '23:59'; else novoFim = minutesToTime(fimMin);
        if (novoFim !== hora_fim) { setEditingItem(prev => ({ ...prev, hora_fim: novoFim })); }
    }
  }, [editingItem?.hora_inicio, editingItem?.hora_fim, editingItem?.intervalo_minutos, editingItem?.quantidade_atendimentos, editModoCalculo, isModalOpen]);

  const handleSaveEdit = async (e) => {
    e.preventDefault();
    if (editingDays.length === 0) return notify.warning("Selecione pelo menos um dia.");
    setSaving(true);
    try {
        const payload = { tipo: editingItem.tipo, dias_semana: editingDays, data_inicio: editingItem.data_inicio, data_fim: editingItem.data_fim, valor: editingItem.valor, convenio: editingItem.convenio || null, situacao: editingItem.situacao };
        if (editingItem.tipo === 'fixo') { payload.lista_horarios = editHorariosFixos.filter(h => h.time); } 
        else { payload.hora_inicio = editingItem.hora_inicio; payload.hora_fim = editingItem.hora_fim; payload.intervalo_minutos = editingItem.intervalo_minutos; payload.quantidade_atendimentos = editingItem.quantidade_atendimentos; }
        await api.put(`agendas/config/update-group/${editingItem.group_id}/`, payload); setIsModalOpen(false); loadData(); notify.success("Agenda atualizada!");
    } catch (error) { notify.error("Erro ao atualizar."); } finally { setSaving(false); }
  };

  const thClass = "px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider";
  const tdClass = "px-6 py-4 whitespace-nowrap text-sm text-slate-700 dark:text-slate-300";
  const inputModalClass = "w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg p-2.5 dark:text-white outline-none focus:ring-2 focus:ring-blue-500";

  return (
    <Layout>
      <div className="max-w-6xl mx-auto pb-10">
        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><CalendarRange className="text-purple-600"/> Configuração de Horários</h1>
                <p className="text-slate-500 dark:text-slate-400 text-sm">Gerencie as regras de atendimento e vigência.</p>
            </div>
            <button onClick={() => navigate('/agenda/criar')} className="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg transition-transform active:scale-95"><Plus size={20}/> Nova Agenda</button>
        </div>

        <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6 flex flex-col lg:flex-row gap-4 items-start">
            <div className="flex-1 w-full">
                <div className="flex shadow-sm h-12 w-full">
                    <div className="w-[220px] z-20">
                        <CustomDropdown options={filterTypeOptions} value={filterType} onChange={(val) => { setFilterType(val); setFilterValue(''); }} icon={ListFilter}/>
                    </div>
                    <div className="relative flex-1 z-10">
                        {renderDynamicInput()}
                        <button onClick={addFilter} disabled={!filterValue} className="absolute right-1 top-1 bottom-1 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white px-4 rounded-lg font-bold text-sm transition-colors flex items-center gap-1">
                            <Plus size={16}/> <span className="hidden sm:inline">Adicionar</span>
                        </button>
                    </div>
                </div>
                {activeFilters.length > 0 && (
                    <div className="flex flex-wrap gap-2 mt-3 animate-in fade-in slide-in-from-top-2 duration-300">
                        {activeFilters.map(filter => (
                            <div key={filter.id} className="bg-blue-50 dark:bg-blue-900/30 border border-blue-100 dark:border-blue-800 text-blue-700 dark:text-blue-300 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm">
                                <span>{filter.display}</span>
                                <button onClick={() => removeFilter(filter.id)} className="hover:text-red-500 hover:bg-white dark:hover:bg-slate-800 rounded-full p-0.5 transition-colors"><X size={12}/></button>
                            </div>
                        ))}
                        <button onClick={clearAllFilters} className="text-xs text-red-500 hover:text-red-700 underline font-medium ml-2 flex items-center gap-1"><Trash2 size={12}/> Limpar tudo</button>
                    </div>
                )}
            </div>
            <div className="w-full lg:w-56 h-12 relative">
                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-purple-600 pointer-events-none z-10"><Filter size={18} /></div>
                <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)} className="w-full h-full pl-10 pr-8 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none text-sm font-medium text-slate-700 dark:text-slate-300 appearance-none cursor-pointer hover:border-purple-300 transition-colors">
                    <option value="ativos">Apenas Ativos</option><option value="encerrados">Apenas Encerrados</option><option value="todos">Mostrar Todos</option>
                </select>
                <div className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"><ChevronDown size={14} /></div>
            </div>
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
            <div className="overflow-x-auto">
                <table className="w-full">
                    <thead className="bg-slate-50 dark:bg-slate-700/50 border-b border-slate-200 dark:border-slate-700">
                        <tr><th className={thClass}>Situação</th><th className={thClass}>Profissional</th><th className={thClass}>Dias</th><th className={thClass}>Detalhes</th><th className={thClass}>Vigência</th><th className={thClass}>Agendados</th><th className="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Ações</th></tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                        {configs.map((item, idx) => (
                            <tr key={idx} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                                <td className={tdClass}>{getStatusBadge(item)}</td>
                                <td className={tdClass}><div className="font-bold text-slate-800 dark:text-white">{item.nome_profissional}</div><div className="text-xs text-slate-500">{item.nome_especialidade}</div><div className="flex items-center gap-1 text-xs text-blue-600 mt-1"><ShieldCheck size={12}/> {item.nome_convenio || 'Todos / Particular'}</div></td>
                                <td className={tdClass}><div className="flex gap-1 flex-wrap max-w-[150px]">{item.dias_vinculados && item.dias_vinculados.length > 0 ? (item.dias_vinculados.map(d => <span key={d} className="px-1.5 py-0.5 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300 rounded text-[10px] font-bold uppercase border border-blue-100 dark:border-blue-800">{diasMap.find(dm => dm.id === d)?.label}</span>)) : (<span className="px-1.5 py-0.5 bg-gray-50 text-gray-500 rounded text-[10px] font-bold uppercase border">{diasMap.find(dm => dm.id === item.dia_semana)?.label || '-'}</span>)}</div></td>
                                <td className={tdClass}>{item.tipo === 'fixo' ? (<div><span className="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold mb-1 inline-block">FIXO</span><div className="text-xs text-slate-600 dark:text-slate-400 space-y-1">{item.horarios_fixos_detalhes?.map((h, i) => <div key={i}>{String(h.time).slice(0,5)} - {h.qtd} vagas</div>)}</div></div>) : item.tipo === 'periodo' ? (<div><span className="text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-bold mb-1 inline-block">QTD/HORA</span><div className="text-xs text-slate-500">{item.quantidade_atendimentos} vagas a cada {item.intervalo_minutos} min</div></div>) : (<div><span className="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full font-bold mb-1 inline-block">POR TEMPO</span><div className="text-xs text-slate-500">Intervalo de {item.intervalo_minutos} min</div></div>)}</td>
                                <td className={tdClass}><div className="text-xs flex flex-col gap-1"><span className="flex items-center gap-1"><CalendarDays size={12}/> {formatData(item.data_inicio)}</span><span className="text-slate-400">até {formatData(item.data_fim)}</span>{item.valor > 0 && <span className="text-green-600 font-bold">R$ {Number(item.valor).toFixed(2)}</span>}</div></td>
                                <td className={tdClass}><div className={`inline-flex items-center gap-1 px-2.5 py-1 rounded-full font-bold text-xs ${item.total_agendados > 0 ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-500'}`}><Users size={12}/> {item.total_agendados}</div></td>
                                <td className="px-6 py-4 text-right flex justify-end gap-2"><button onClick={() => handleEdit(item)} className="p-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors"><Edit size={18}/></button><button onClick={() => handleDelete(item)} className="p-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"><Trash2 size={18}/></button></td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>

        {isModalOpen && editingItem && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in zoom-in duration-200">
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden max-h-[90vh] flex flex-col">
                    <div className="flex justify-between items-center p-5 border-b border-slate-100 dark:border-slate-700 shrink-0">
                        <div><h3 className="text-lg font-bold text-slate-800 dark:text-white">Editar Regra</h3><p className="text-xs text-slate-500">{editingItem.nome_profissional}</p></div>
                        <button onClick={() => setIsModalOpen(false)}><X className="text-slate-400 hover:text-slate-600"/></button>
                    </div>
                    <form onSubmit={handleSaveEdit} className="p-6 space-y-5 overflow-y-auto">
                        <div className="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl flex items-center justify-between border border-slate-200 dark:border-slate-700">
                            <div><span className="block text-sm font-bold text-slate-700 dark:text-white">Situação da Agenda</span><span className="text-xs text-slate-500">{editingItem.situacao ? 'Esta agenda está ativa.' : 'Esta agenda está encerrada (invisível).'}</span></div>
                            <button type="button" onClick={() => setEditingItem({...editingItem, situacao: !editingItem.situacao})} className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${editingItem.situacao ? 'bg-green-500' : 'bg-slate-300'}`}><span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${editingItem.situacao ? 'translate-x-6' : 'translate-x-1'}`} /></button>
                        </div>
                        <div><label className="block text-sm font-bold text-slate-700 dark:text-slate-200 mb-2">Dias de Atendimento</label><div className="flex flex-wrap gap-2">{diasMap.map(dia => (<button key={dia.id} type="button" onClick={() => toggleEditDay(dia.id)} className={`w-9 h-9 rounded-full font-bold flex items-center justify-center transition-all text-xs ${editingDays.includes(dia.id) ? 'bg-purple-600 text-white shadow-lg' : 'bg-slate-100 dark:bg-slate-700 text-slate-500'}`}>{dia.label}</button>))}</div></div>
                        <div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-medium text-slate-500 mb-1">Início</label><input type="date" value={editingItem.data_inicio} onChange={e => setEditingItem({...editingItem, data_inicio: e.target.value})} className={inputModalClass}/></div><div><label className="block text-xs font-medium text-slate-500 mb-1">Fim</label><input type="date" value={editingItem.data_fim} onChange={e => setEditingItem({...editingItem, data_fim: e.target.value})} className={inputModalClass}/></div></div>
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="block text-xs font-medium text-slate-500 mb-1">Convênio</label><select className={inputModalClass} value={editingItem.convenio || ''} onChange={e => setEditingItem({...editingItem, convenio: e.target.value || null})}><option value="">Todos / Particular</option>{allConvenios.map(c => <option key={c.id} value={c.id}>{c.nome}</option>)}</select></div>
                            <div><label className="block text-xs font-medium text-slate-500 mb-1">Valor (R$)</label><div className="relative"><DollarSign className="absolute left-2 top-2.5 text-slate-400" size={14}/><input type="number" step="0.01" value={editingItem.valor} onChange={e => setEditingItem({...editingItem, valor: e.target.value})} className={`${inputModalClass} pl-7`}/></div></div>
                        </div>
                        <hr className="border-slate-100 dark:border-slate-700"/>
                        {(editingItem.tipo === 'padrao' || editingItem.tipo === 'tempo') && (
                            <div className="animate-in fade-in zoom-in duration-300">
                                <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-lg mb-4 w-fit mx-auto"><button type="button" onClick={() => setEditModoCalculo('final')} className={`px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition-all ${editModoCalculo === 'final' ? 'bg-white dark:bg-slate-700 shadow text-purple-600 dark:text-white' : 'text-slate-500'}`}><Clock size={14}/> Calc. Final</button><button type="button" onClick={() => setEditModoCalculo('quantidade')} className={`px-3 py-1.5 rounded text-xs font-bold flex items-center gap-1 transition-all ${editModoCalculo === 'quantidade' ? 'bg-white dark:bg-slate-700 shadow text-purple-600 dark:text-white' : 'text-slate-500'}`}><Calculator size={14}/> Calc. Qtd.</button></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-xs font-medium text-slate-500 mb-1">Início</label><input type="time" value={editingItem.hora_inicio} onChange={e => setEditingItem({...editingItem, hora_inicio: e.target.value})} className={inputModalClass}/></div>
                                    <div><label className="block text-xs font-medium text-slate-500 mb-1">Tempo (min)</label><input type="number" value={editingItem.intervalo_minutos} onChange={e => setEditingItem({...editingItem, intervalo_minutos: e.target.value})} className={inputModalClass}/></div>
                                    {editModoCalculo === 'final' ? (
                                        <><div><label className="block text-xs font-medium text-slate-500 mb-1">Fim</label><input type="time" value={editingItem.hora_fim} onChange={e => setEditingItem({...editingItem, hora_fim: e.target.value})} className={inputModalClass}/></div><div className="flex flex-col justify-end"><div className="bg-purple-50 dark:bg-purple-900/20 border border-purple-100 dark:border-purple-800 rounded-lg p-2.5 flex items-center justify-between h-[42px]"><span className="text-[10px] font-bold text-purple-700 dark:text-purple-300 uppercase">Total</span><div><span className="text-lg font-bold text-purple-700 dark:text-white">{editingItem.quantidade_atendimentos}</span><span className="text-[10px] text-purple-600 dark:text-purple-300 ml-1">vagas</span></div></div></div></>
                                    ) : (<><div><label className="block text-xs font-medium text-slate-500 mb-1">Qtd.</label><input type="number" value={editingItem.quantidade_atendimentos} onChange={e => setEditingItem({...editingItem, quantidade_atendimentos: e.target.value})} className={inputModalClass}/></div><div className="flex flex-col justify-end"><div className="bg-purple-50 dark:bg-purple-900/20 border border-purple-100 dark:border-purple-800 rounded-lg p-2.5 flex items-center justify-between h-[42px]"><span className="text-[10px] font-bold text-purple-700 dark:text-purple-300 uppercase">Término</span><span className="text-lg font-bold text-purple-700 dark:text-white">{editingItem.hora_fim}</span></div></div></>)}
                                </div>
                            </div>
                        )}
                        {editingItem.tipo === 'periodo' && (<div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-medium text-slate-500 mb-1">Início</label><input type="time" value={editingItem.hora_inicio} onChange={e => setEditingItem({...editingItem, hora_inicio: e.target.value})} className={inputModalClass}/></div><div><label className="block text-xs font-medium text-slate-500 mb-1">Fim</label><input type="time" value={editingItem.hora_fim} onChange={e => setEditingItem({...editingItem, hora_fim: e.target.value})} className={inputModalClass}/></div><div><label className="block text-xs font-medium text-slate-500 mb-1">A cada (min)</label><input type="number" value={editingItem.intervalo_minutos} onChange={e => setEditingItem({...editingItem, intervalo_minutos: e.target.value})} className={inputModalClass}/></div><div><label className="block text-xs font-medium text-slate-500 mb-1">Vagas</label><input type="number" value={editingItem.quantidade_atendimentos} onChange={e => setEditingItem({...editingItem, quantidade_atendimentos: e.target.value})} className={inputModalClass}/></div></div>)}
                        {editingItem.tipo === 'fixo' && (<div><label className="block text-sm font-bold text-slate-700 dark:text-slate-200 mb-2">Lista de Horários Fixos</label><div className="space-y-2 max-h-[200px] overflow-y-auto pr-1 custom-scrollbar">{editHorariosFixos.map((h, idx) => (<div key={idx} className="flex gap-2"><input type="time" value={h.time} onChange={e => updateHorarioFixo(idx, 'time', e.target.value)} className={inputModalClass}/><input type="number" placeholder="Qtd" value={h.qtd} onChange={e => updateHorarioFixo(idx, 'qtd', e.target.value)} className={`${inputModalClass} w-24`}/><button type="button" onClick={() => removeHorarioFixo(idx)} className="text-red-500 p-2"><Trash2 size={18}/></button></div>))}</div><button type="button" onClick={addHorarioFixo} className="mt-2 text-blue-600 text-sm font-bold flex items-center gap-1"><PlusCircle size={16}/> Adicionar Horário</button></div>)}
                        <div className="pt-4 flex justify-end gap-2 shrink-0"><button type="button" onClick={() => setIsModalOpen(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium">Cancelar</button><button type="submit" disabled={saving} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg">{saving ? 'Salvando...' : <><Save size={18}/> Salvar Alterações</>}</button></div>
                    </form>
                </div>
            </div>
        )}
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front\src\pages\Convenios.jsx
============================================================
import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNotification } from '../context/NotificationContext'; // <--- NOVO
import Layout from '../components/Layout';
import { 
  Building2, Search, Plus, Pencil, Trash2, X, Save, Percent, Loader2 
} from 'lucide-react';

export default function Convenios() {
  const { api } = useAuth();
  const { notify, confirmDialog } = useNotification(); // <--- HOOK
  
  const [convenios, setConvenios] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState('');
  
  const [modalOpen, setModalOpen] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const [saving, setSaving] = useState(false);
  
  const [nome, setNome] = useState('');
  const [desconto, setDesconto] = useState('');

  useEffect(() => {
    if (api) loadData();
  }, [api, search]);

  const loadData = async () => {
    setLoading(true);
    try {
      const res = await api.get(`configuracoes/convenios/?search=${search}`);
      setConvenios(res.data.results || res.data);
    } catch (e) {
      console.error("Erro ao carregar convênios", e);
    } finally {
      setLoading(false);
    }
  };

  const openModal = (item = null) => {
    setEditingItem(item);
    if (item) {
        setNome(item.nome || '');
        setDesconto(item.percentual_desconto || '0.00');
    } else {
        setNome('');
        setDesconto('');
    }
    setModalOpen(true);
  };

  const handleSave = async (e) => {
    e.preventDefault();
    setSaving(true);
    
    const payload = { 
        nome, 
        percentual_desconto: desconto === '' ? 0 : parseFloat(desconto) 
    };

    try {
      if (editingItem) {
        await api.put(`configuracoes/convenios/${editingItem.id}/`, payload);
        notify.success('Convênio atualizado!'); // <---
      } else {
        await api.post('configuracoes/convenios/', payload);
        notify.success('Convênio criado!'); // <---
      }
      setModalOpen(false);
      loadData();
    } catch (error) {
      notify.error("Erro ao salvar convênio."); // <---
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (id) => {
    // --- DIALOG BONITO ---
    const confirmado = await confirmDialog("Excluir este convênio?", "Exclusão", "Sim, excluir", "Cancelar", "danger");
    if(confirmado) {
        try {
            await api.delete(`configuracoes/convenios/${id}/`);
            notify.success("Convênio excluído.");
            loadData();
        } catch(e) {
            notify.error("Erro ao excluir.");
        }
    }
  };

  const inputClass = "w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-blue-500 text-slate-800 dark:text-white transition-all";

  return (
    <Layout>
      <div className="max-w-4xl mx-auto pb-20">
        
        <div className="flex justify-between items-center mb-6">
            <div>
                <h1 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <Building2 className="text-blue-600"/> Convênios
                </h1>
                <p className="text-slate-500 text-sm">Gerencie os planos de saúde e descontos.</p>
            </div>
            <button onClick={() => openModal()} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg transition-transform active:scale-95">
                <Plus size={20}/> Novo Convênio
            </button>
        </div>

        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6">
            <div className="relative">
                <Search className="absolute left-3 top-3 text-slate-400" size={18} />
                <input 
                    placeholder="Pesquisar convênio..." 
                    value={search} 
                    onChange={e => setSearch(e.target.value)} 
                    className="w-full pl-10 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-2.5 outline-none dark:text-white"
                />
            </div>
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
            <table className="w-full text-left">
                <thead className="bg-slate-50 dark:bg-slate-700/50 border-b border-slate-200 dark:border-slate-700">
                    <tr>
                        <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Nome</th>
                        <th className="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Desconto (%)</th>
                        <th className="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Ações</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                    {convenios.map(item => (
                        <tr key={item.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                            <td className="px-6 py-4 font-bold text-slate-700 dark:text-white">{item.nome}</td>
                            <td className="px-6 py-4">
                                <span className="bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 px-2 py-1 rounded-lg text-xs font-bold">
                                    {Number(item.percentual_desconto).toFixed(2)}%
                                </span>
                            </td>
                            <td className="px-6 py-4 text-right flex justify-end gap-2">
                                <button onClick={() => openModal(item)} className="p-2 text-blue-600 hover:bg-blue-50 dark:text-blue-400 rounded-lg transition-colors"><Pencil size={18}/></button>
                                <button onClick={() => handleDelete(item.id)} className="p-2 text-red-600 hover:bg-red-50 dark:text-red-400 rounded-lg transition-colors"><Trash2 size={18}/></button>
                            </td>
                        </tr>
                    ))}
                    {convenios.length === 0 && !loading && (
                        <tr><td colSpan="3" className="p-8 text-center text-slate-400">Nenhum convênio encontrado.</td></tr>
                    )}
                </tbody>
            </table>
        </div>

        {modalOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in zoom-in duration-200">
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                    <div className="flex justify-between items-center p-5 border-b border-slate-100 dark:border-slate-700">
                        <h3 className="font-bold text-lg text-slate-800 dark:text-white">{editingItem ? 'Editar Convênio' : 'Novo Convênio'}</h3>
                        <button onClick={() => setModalOpen(false)} className="text-slate-400 hover:text-slate-600"><X size={20}/></button>
                    </div>
                    
                    <form onSubmit={handleSave} className="p-6 space-y-4">
                        <div>
                            <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1">Nome do Convênio</label>
                            <input 
                                required 
                                value={nome} 
                                onChange={e => setNome(e.target.value)} 
                                className={inputClass} 
                                placeholder="Ex: Unimed, Bradesco..."
                            />
                        </div>
                        
                        <div>
                            <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1">Desconto Padrão (%)</label>
                            <div className="relative">
                                <Percent className="absolute left-3 top-3.5 text-slate-400" size={16}/>
                                <input 
                                    type="number" 
                                    step="0.01" 
                                    value={desconto} 
                                    onChange={e => setDesconto(e.target.value)} 
                                    className={`${inputClass} pl-10`} 
                                    placeholder="0.00"
                                />
                            </div>
                        </div>

                        <div className="pt-4 flex gap-3 justify-end">
                            <button type="button" onClick={() => setModalOpen(false)} className="px-4 py-2 text-slate-600 font-bold">Cancelar</button>
                            <button type="submit" disabled={saving} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg transition-all active:scale-95">
                                {saving ? <Loader2 className="animate-spin" size={18}/> : <Save size={18}/>}
                                {saving ? 'Salvando...' : 'Salvar'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        )}

      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front\src\pages\CriarAgenda.jsx
============================================================
import React, { useState, useEffect, useRef } from 'react';
import { useAuth } from '../context/AuthContext';
import Layout from '../components/Layout';
import { useNavigate } from 'react-router-dom';
import { 
  CalendarClock, CheckCircle2, Clock, Calculator, ArrowLeft, 
  ChevronDown, X, Users, Pin, Hourglass, Repeat, ListPlus, Pencil, Ban, CalendarDays, DollarSign, ShieldCheck
} from 'lucide-react';

function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

const SearchableSelect = ({ label, options, value, onChange, placeholder, disabled }) => {
  const [isOpen, setIsOpen] = useState(false);
  const [query, setQuery] = useState('');
  const wrapperRef = useRef(null);

  useEffect(() => {
    const selected = options.find(o => String(o.id) === String(value));
    setQuery(selected ? selected.label : '');
  }, [value, options]);

  useEffect(() => {
    function handleClickOutside(event) {
      if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
        setIsOpen(false);
        const selected = options.find(o => String(o.id) === String(value));
        setQuery(selected ? selected.label : '');
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [wrapperRef, value, options]);

  const filteredOptions = query === ''
    ? options
    : options.filter((opt) => opt.label.toLowerCase().includes(query.toLowerCase()));

  const handleSelect = (option) => {
    onChange(option.id);
    setQuery(option.label);
    setIsOpen(false);
  };

  const clearSelection = (e) => {
    e.stopPropagation();
    onChange('');
    setQuery('');
    setIsOpen(false);
  };

  return (
    <div className="relative" ref={wrapperRef}>
      <label className="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">{label}</label>
      <div className="relative">
        <input
          type="text"
          className={`w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-3 pr-10 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed cursor-text transition-all`}
          placeholder={placeholder}
          value={query}
          onChange={(e) => { setQuery(e.target.value); setIsOpen(true); }}
          onFocus={() => !disabled && setIsOpen(true)}
          disabled={disabled}
        />
        <div className="absolute right-3 top-3.5 flex items-center gap-2 text-slate-400">
          {value && !disabled && (
            <button type="button" onClick={clearSelection} className="hover:text-slate-600 dark:hover:text-slate-200"><X size={16} /></button>
          )}
          <ChevronDown size={16} className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </div>
      </div>

      {isOpen && !disabled && (
        <div className="absolute z-50 w-full mt-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-xl max-h-60 overflow-auto animate-in fade-in zoom-in duration-100">
          {filteredOptions.length === 0 ? (
            <div className="p-3 text-sm text-slate-400 text-center">Nenhum resultado.</div>
          ) : (
            <ul>
              {filteredOptions.map((opt) => (
                <li
                  key={opt.id}
                  onClick={() => handleSelect(opt)}
                  className={`p-3 text-sm cursor-pointer transition-colors flex justify-between items-center
                    ${String(value) === String(opt.id) 
                      ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 font-bold' 
                      : 'text-slate-700 dark:text-slate-200 hover:bg-slate-100 dark:hover:bg-slate-700'
                    }`}
                >
                  {opt.label}
                  {String(value) === String(opt.id) && <CheckCircle2 size={16}/>}
                </li>
              ))}
            </ul>
          )}
        </div>
      )}
    </div>
  );
};

export default function CriarAgenda() {
  const { api } = useAuth();
  const navigate = useNavigate();
  const [loading, setLoading] = useState(false);

  // --- DADOS GERAIS ---
  const [profissionaisOptions, setProfissionaisOptions] = useState([]);
  const [especialidadesOptions, setEspecialidadesOptions] = useState([]);
  const [conveniosOptions, setConveniosOptions] = useState([]);
  
  const [profissionalId, setProfissionalId] = useState('');
  const [especialidadeId, setEspecialidadeId] = useState('');
  const [convenioId, setConvenioId] = useState('');
  const [valorConsulta, setValorConsulta] = useState('');

  // --- LISTA DE REGRAS (CARRINHO) ---
  const [regrasAdicionadas, setRegrasAdicionadas] = useState([]);
  const [editingRuleId, setEditingRuleId] = useState(null);

  // --- ESTADOS DO FORMULÁRIO ---
  const [diasSelecionados, setDiasSelecionados] = useState([]);
  const [activeTab, setActiveTab] = useState('tempo'); 
  
  const hoje = new Date().toISOString().split('T')[0];
  const [dataInicioVigencia, setDataInicioVigencia] = useState(hoje);
  const [dataFimVigencia, setDataFimVigencia] = useState(hoje);

  // Aba 1: Tempo
  const [modoCalculo, setModoCalculo] = useState('final');
  const [horaInicio, setHoraInicio] = useState('08:00');
  const [horaFim, setHoraFim] = useState('12:00');
  const [intervalo, setIntervalo] = useState(30);
  const [quantidade, setQuantidade] = useState(0);

  // Aba 2: Periodo
  const [periodoInicio, setPeriodoInicio] = useState('07:00');
  const [periodoFim, setPeriodoFim] = useState('12:00');
  const [periodoIntervalo, setPeriodoIntervalo] = useState(60);
  const [periodoQtd, setPeriodoQtd] = useState(10);

  // Aba 3: Fixo
  const [horariosFixos, setHorariosFixos] = useState([{ time: '08:00', qtd: 10 }]);

  const diasSemana = [
    { id: 1, label: 'Seg' }, { id: 2, label: 'Ter' }, { id: 3, label: 'Qua' },
    { id: 4, label: 'Qui' }, { id: 5, label: 'Sex' }, { id: 6, label: 'Sáb' }, { id: 0, label: 'Dom' }
  ];

  // 1. Carregar Profissionais e Convênios
  useEffect(() => {
    if (api) {
        api.get('profissionais/').then(res => {
            const data = res.data.results || res.data;
            setProfissionaisOptions(data.map(p => ({ id: p.id, label: p.nome })));
        });
        api.get('configuracoes/convenios/').then(res => {
            const data = res.data.results || res.data;
            setConveniosOptions(data.map(c => ({ id: c.id, label: c.nome })));
        });
    }
  }, [api]);

  // 2. Carregar Especialidades
  useEffect(() => {
    setEspecialidadesOptions([]);
    setEspecialidadeId(''); 
    if (profissionalId && api) {
      api.get(`profissionais/${profissionalId}/`).then(res => {
        if (res.data.especialidades) {
            const specs = res.data.especialidades.map(vinculo => ({
                id: vinculo.especialidade_leitura || vinculo.especialidade_id || vinculo.especialidade, 
                label: vinculo.nome_especialidade
            }));
            setEspecialidadesOptions(specs);
            if(specs.length === 1) setEspecialidadeId(specs[0].id);
        }
      });
    }
  }, [profissionalId, api]);

  // 3. Cálculos Automáticos
  useEffect(() => {
    if (activeTab === 'tempo') calcularHorariosTempo();
  }, [horaInicio, horaFim, intervalo, quantidade, modoCalculo, activeTab]);

  const timeToMinutes = (time) => {
    if (!time) return 0;
    const [h, m] = time.split(':').map(Number);
    return h * 60 + m;
  };

  const minutesToTime = (mins) => {
    const h = Math.floor(mins / 60).toString().padStart(2, '0');
    const m = (mins % 60).toString().padStart(2, '0');
    return `${h}:${m}`;
  };

  const calcularHorariosTempo = () => {
    if (!horaInicio || !intervalo || intervalo <= 0) return;
    const inicioMin = timeToMinutes(horaInicio);

    if (modoCalculo === 'final') {
        if (!horaFim) return;
        const fimMin = timeToMinutes(horaFim);
        if (fimMin <= inicioMin) { setQuantidade(0); return; }
        const diff = fimMin - inicioMin;
        setQuantidade(Math.floor(diff / intervalo));
    } else {
        if (!quantidade) return;
        const duracaoTotal = quantidade * intervalo;
        const fimMin = inicioMin + duracaoTotal;
        if (fimMin >= 1440) setHoraFim('23:59'); 
        else setHoraFim(minutesToTime(fimMin));
    }
  };

  const toggleDia = (id) => {
    if (diasSelecionados.includes(id)) setDiasSelecionados(diasSelecionados.filter(d => d !== id));
    else setDiasSelecionados([...diasSelecionados, id]);
  };

  const addHorarioFixo = () => setHorariosFixos([...horariosFixos, { time: '', qtd: '' }]);
  const updateHorarioFixo = (index, field, val) => {
    const novos = [...horariosFixos];
    novos[index][field] = val;
    setHorariosFixos(novos);
  };
  const removeHorarioFixo = (index) => {
    setHorariosFixos(horariosFixos.filter((_, i) => i !== index));
  };

  const handleEditRule = (regra) => {
    setEditingRuleId(regra.id);
    setActiveTab(regra.tipo);
    setDiasSelecionados(regra.dias);
    setDataInicioVigencia(regra.data_inicio);
    setDataFimVigencia(regra.data_fim);
    setConvenioId(regra.convenio || '');
    setValorConsulta(regra.valor || '');

    setModoCalculo(regra.modoCalculo || 'final');

    if (regra.tipo === 'tempo') {
        setHoraInicio(regra.detalhes.inicio);
        setHoraFim(regra.detalhes.fim);
        setIntervalo(regra.detalhes.intervalo);
        setQuantidade(regra.detalhes.qtd);
    } else if (regra.tipo === 'periodo') {
        setPeriodoInicio(regra.detalhes.inicio);
        setPeriodoFim(regra.detalhes.fim);
        setPeriodoIntervalo(regra.detalhes.intervalo);
        setPeriodoQtd(regra.detalhes.qtd);
    } else if (regra.tipo === 'fixo') {
        setHorariosFixos(regra.detalhes.horarios);
    }
  };

  const handleCancelEdit = () => {
    setEditingRuleId(null);
    setDiasSelecionados([]);
    setHoraInicio('08:00');
    setHoraFim('12:00');
    setHorariosFixos([{ time: '08:00', qtd: 10 }]);
    setDataInicioVigencia(hoje);
    setDataFimVigencia(hoje);
    setValorConsulta('');
    setConvenioId('');
  };

  const handleAddRule = () => {
    if (!profissionalId) return alert('Selecione o Profissional antes de adicionar regras.');
    if (!especialidadeId) return alert('Selecione a Especialidade antes de adicionar regras.');
    if (diasSelecionados.length === 0) return alert('Selecione os dias da semana.');
    if (!dataInicioVigencia || !dataFimVigencia) return alert('Defina o período de vigência da agenda.');
    
    const newGroupId = editingRuleId 
        ? regrasAdicionadas.find(r => r.id === editingRuleId).group_id 
        : generateUUID(); 

    const ruleId = editingRuleId || Date.now(); 

    // Define nome amigável para o convênio
    const nomeConvenio = convenioId 
        ? conveniosOptions.find(c => String(c.id) === String(convenioId))?.label 
        : 'Todos / Particular';

    const novaRegra = {
        id: ruleId, 
        group_id: newGroupId, 
        dias: diasSelecionados,
        data_inicio: dataInicioVigencia,
        data_fim: dataFimVigencia,
        convenio: convenioId || null, // Garante que envie null se vazio
        convenio_nome: nomeConvenio,
        valor: valorConsulta,
        tipo: activeTab,
        modoCalculo: modoCalculo, 
        detalhes: {}
    };

    if (activeTab === 'tempo') {
        novaRegra.detalhes = { inicio: horaInicio, fim: horaFim, intervalo, qtd: 1 };
        novaRegra.resumo = `${horaInicio} às ${horaFim} (${intervalo} min)`;
    } else if (activeTab === 'periodo') {
        novaRegra.detalhes = { inicio: periodoInicio, fim: periodoFim, intervalo: periodoIntervalo, qtd: periodoQtd };
        novaRegra.resumo = `${periodoInicio} às ${periodoFim} (${periodoQtd} vagas a cada ${periodoIntervalo} min)`;
    } else if (activeTab === 'fixo') {
        const validos = horariosFixos.filter(h => h.time && h.qtd);
        if(validos.length === 0) return alert("Adicione pelo menos um horário válido.");
        novaRegra.detalhes = { horarios: validos };
        novaRegra.resumo = `${validos.length} horários específicos`;
    }

    if (editingRuleId) {
        setRegrasAdicionadas(regrasAdicionadas.map(r => r.id === editingRuleId ? novaRegra : r));
        setEditingRuleId(null);
    } else {
        setRegrasAdicionadas([...regrasAdicionadas, novaRegra]);
    }
    
    setDiasSelecionados([]); 
  };

  const handleRemoveRule = (id) => {
    if (id === editingRuleId) handleCancelEdit();
    setRegrasAdicionadas(regrasAdicionadas.filter(r => r.id !== id));
  };

  const handleSaveAll = async () => {
    if (!profissionalId) return alert('Erro: Profissional não selecionado.');
    if (!especialidadeId) return alert('Erro: Especialidade não selecionada.');
    if (regrasAdicionadas.length === 0) return alert('Adicione pelo menos uma regra.');

    setLoading(true);
    try {
        const promises = [];

        regrasAdicionadas.forEach(regra => {
            regra.dias.forEach(dia => {
                const basePayload = {
                    group_id: regra.group_id, 
                    profissional: profissionalId,
                    especialidade: especialidadeId,
                    dia_semana: dia,
                    data_inicio: regra.data_inicio,
                    data_fim: regra.data_fim,
                    valor: regra.valor || 0,
                    convenio: regra.convenio || null 
                };

                if (regra.tipo === 'tempo') {
                    promises.push(api.post('agendas/config/', {
                        ...basePayload,
                        hora_inicio: regra.detalhes.inicio,
                        hora_fim: regra.detalhes.fim,
                        intervalo_minutos: regra.detalhes.intervalo,
                        quantidade_atendimentos: 1, 
                        tipo: 'padrao'
                    }));
                } else if (regra.tipo === 'periodo') {
                    promises.push(api.post('agendas/config/', {
                        ...basePayload,
                        hora_inicio: regra.detalhes.inicio,
                        hora_fim: regra.detalhes.fim,
                        intervalo_minutos: regra.detalhes.intervalo,
                        quantidade_atendimentos: regra.detalhes.qtd,
                        tipo: 'periodo'
                    }));
                } else if (regra.tipo === 'fixo') {
                    regra.detalhes.horarios.forEach(h => {
                        promises.push(api.post('agendas/config/', {
                            ...basePayload,
                            hora_inicio: h.time,
                            hora_fim: h.time,
                            intervalo_minutos: 0,
                            quantidade_atendimentos: h.qtd,
                            tipo: 'fixo'
                        }));
                    });
                }
            });
        });

        await Promise.all(promises);
        alert('Todas as agendas foram criadas com sucesso!');
        navigate('/agenda/configurar');
    } catch (error) {
        console.error("Erro no salvamento:", error.response?.data || error.message);
        alert('Erro ao salvar. Verifique se os campos estão corretos.');
    } finally {
        setLoading(false);
    }
  };

  const inputClass = "w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-3 dark:text-white outline-none focus:ring-2 focus:ring-blue-500";
  const labelClass = "block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1";
  const tabBase = "flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 transition-all border-b-2";
  const tabActive = "border-blue-600 text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20";
  const tabInactive = "border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800";

  return (
    <Layout>
      <div className="max-w-5xl mx-auto pb-20">
        <button onClick={() => navigate('/agenda/configurar')} className="mb-4 flex items-center gap-2 text-slate-500 hover:text-slate-800 dark:text-slate-400 bg-transparent px-3 py-2 rounded-lg transition-colors">
            <ArrowLeft size={18}/> Voltar para Lista
        </button>

        <div className="flex items-center gap-3 mb-6">
            <div className="bg-purple-600 p-3 rounded-xl text-white shadow"><CalendarClock size={28}/></div>
            <div>
                <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Criar Agenda</h1>
                <p className="text-slate-500 dark:text-slate-400 text-sm">Configure múltiplos horários para um profissional.</p>
            </div>
        </div>

        {/* 1. SELEÇÃO DE PROFISSIONAL */}
        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6">
            <h2 className="font-bold text-lg mb-4 text-slate-800 dark:text-white border-b border-slate-100 dark:border-slate-700 pb-2">1. Profissional e Especialidade</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <SearchableSelect label="Profissional" placeholder="Pesquisar..." options={profissionaisOptions} value={profissionalId} onChange={setProfissionalId} />
                <SearchableSelect label="Especialidade" placeholder="Selecione..." options={especialidadesOptions} value={especialidadeId} onChange={setEspecialidadeId} disabled={!profissionalId} />
            </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
            
            {/* 2. ÁREA DE CONFIGURAÇÃO */}
            <div className="lg:col-span-2 space-y-6">
                
                {/* 2A. DIAS E VIGÊNCIA */}
                <div className={`bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border transition-all ${editingRuleId ? 'border-purple-300 dark:border-purple-600 ring-2 ring-purple-100 dark:ring-purple-900/20' : 'border-slate-200 dark:border-slate-700'}`}>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                            {editingRuleId ? <><Pencil size={20} className="text-purple-600"/> Editando Regra</> : '2. Dias e Vigência'}
                        </h2>
                        {editingRuleId && (
                            <button onClick={handleCancelEdit} className="text-xs bg-red-100 text-red-600 px-3 py-1 rounded-full font-bold hover:bg-red-200 flex items-center gap-1">
                                <Ban size={12}/> Cancelar Edição
                            </button>
                        )}
                    </div>
                    
                    <div className="flex flex-wrap gap-3 mb-6">
                        {diasSemana.map(dia => {
                            const isSelected = diasSelecionados.includes(dia.id);
                            return (
                                <button key={dia.id} type="button" onClick={() => toggleDia(dia.id)}
                                    className={`w-12 h-12 rounded-full font-bold flex items-center justify-center transition-all ${isSelected ? 'bg-purple-600 text-white shadow-lg scale-110' : 'bg-slate-100 dark:bg-slate-700 text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-600'}`}
                                >{dia.label}</button>
                            )
                        })}
                    </div>

                    {/* VIGÊNCIA, CONVÊNIO E VALOR */}
                    <div className="border-t border-slate-100 dark:border-slate-700 pt-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className={labelClass}>Data Início</label>
                                <input type="date" value={dataInicioVigencia} onChange={e => setDataInicioVigencia(e.target.value)} className={inputClass} />
                            </div>
                            <div>
                                <label className={labelClass}>Data Fim</label>
                                <input type="date" value={dataFimVigencia} onChange={e => setDataFimVigencia(e.target.value)} className={inputClass} />
                            </div>
                            <div>
                                <SearchableSelect 
                                    label="Convênio (Opcional)" 
                                    placeholder="Todos / Particular" 
                                    options={conveniosOptions} 
                                    value={convenioId} 
                                    onChange={setConvenioId}
                                />
                            </div>
                            <div>
                                <label className={labelClass}>Valor da Consulta (R$)</label>
                                <div className="relative">
                                    <DollarSign className="absolute left-3 top-3.5 text-slate-400" size={16}/>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value={valorConsulta} 
                                        onChange={e => setValorConsulta(e.target.value)} 
                                        className={`${inputClass} pl-10`}
                                        placeholder="0.00"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* 2B. REGRAS DE HORÁRIO (MANTIDO) */}
                <div className={`bg-white dark:bg-slate-800 rounded-xl shadow-sm border overflow-hidden transition-all ${editingRuleId ? 'border-purple-300 dark:border-purple-600 ring-2 ring-purple-100 dark:ring-purple-900/20' : 'border-slate-200 dark:border-slate-700'}`}>
                    <div className="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800">
                        <div className="flex">
                            <button type="button" onClick={() => setActiveTab('tempo')} className={`${tabBase} ${activeTab === 'tempo' ? tabActive : tabInactive}`}><Hourglass size={18}/> Por Tempo</button>
                            <button type="button" onClick={() => setActiveTab('periodo')} className={`${tabBase} ${activeTab === 'periodo' ? tabActive : tabInactive}`}><Repeat size={18}/> Qtd/Horário</button>
                            <button type="button" onClick={() => setActiveTab('fixo')} className={`${tabBase} ${activeTab === 'fixo' ? tabActive : tabInactive}`}><Pin size={18}/> Horário Fixo</button>
                        </div>
                    </div>

                    <div className="p-6">
                        {/* ABA 1: TEMPO */}
                        {activeTab === 'tempo' && (
                            <div className="animate-in fade-in zoom-in duration-300">
                                <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-lg mb-6 w-fit">
                                    <button type="button" onClick={() => setModoCalculo('final')} className={`px-4 py-2 rounded-md text-sm font-bold flex items-center gap-2 transition-all ${modoCalculo === 'final' ? 'bg-white dark:bg-slate-700 shadow text-purple-600 dark:text-white' : 'text-slate-500'}`}><Clock size={16}/> Calcular Final</button>
                                    <button type="button" onClick={() => setModoCalculo('quantidade')} className={`px-4 py-2 rounded-md text-sm font-bold flex items-center gap-2 transition-all ${modoCalculo === 'quantidade' ? 'bg-white dark:bg-slate-700 shadow text-purple-600 dark:text-white' : 'text-slate-500'}`}><Calculator size={16}/> Calcular Qtd.</button>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className={labelClass}>Início</label><input type="time" value={horaInicio} onChange={e => setHoraInicio(e.target.value)} className={inputClass} /></div>
                                    <div><label className={labelClass}>Tempo (min)</label><input type="number" value={intervalo} onChange={e => setIntervalo(Number(e.target.value))} className={inputClass} /></div>
                                    
                                    {modoCalculo === 'final' ? (
                                        <>
                                            <div><label className={labelClass}>Fim</label><input type="time" value={horaFim} onChange={e => setHoraFim(e.target.value)} className={inputClass} /></div>
                                            <div className="flex flex-col justify-end">
                                                <div className="bg-purple-50 dark:bg-purple-900/20 border border-purple-100 dark:border-purple-800 rounded-lg p-3 flex items-center justify-between h-[50px]">
                                                    <span className="text-[10px] font-bold text-purple-700 dark:text-purple-300 uppercase">Total</span>
                                                    <div className="text-right leading-none">
                                                        <span className="text-xl font-bold text-purple-700 dark:text-white">{quantidade}</span>
                                                        <span className="text-[10px] text-purple-600 dark:text-purple-300 ml-1">vagas</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div><label className={labelClass}>Qtd.</label><input type="number" value={quantidade} onChange={e => setQuantidade(Number(e.target.value))} className={inputClass} /></div>
                                            <div className="flex flex-col justify-end">
                                                <div className="bg-purple-50 dark:bg-purple-900/20 border border-purple-100 dark:border-purple-800 rounded-lg p-3 flex items-center justify-between h-[50px]">
                                                    <span className="text-[10px] font-bold text-purple-700 dark:text-purple-300 uppercase">Término</span>
                                                    <div className="text-right leading-none">
                                                        <span className="text-xl font-bold text-purple-700 dark:text-white">{horaFim}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* ABA 2: PERIODO */}
                        {activeTab === 'periodo' && (
                            <div className="animate-in fade-in zoom-in duration-300 grid grid-cols-2 gap-4">
                                <div><label className={labelClass}>Início</label><input type="time" value={periodoInicio} onChange={e => setPeriodoInicio(e.target.value)} className={inputClass} /></div>
                                <div><label className={labelClass}>Fim</label><input type="time" value={periodoFim} onChange={e => setPeriodoFim(e.target.value)} className={inputClass} /></div>
                                <div><label className={labelClass}>A cada (min)</label><input type="number" value={periodoIntervalo} onChange={e => setPeriodoIntervalo(Number(e.target.value))} className={inputClass} /></div>
                                <div><label className={labelClass}>Vagas</label><input type="number" value={periodoQtd} onChange={e => setPeriodoQtd(Number(e.target.value))} className={inputClass} /></div>
                            </div>
                        )}

                        {/* ABA 3: FIXO */}
                        {activeTab === 'fixo' && (
                            <div className="animate-in fade-in zoom-in duration-300">
                                {horariosFixos.map((item, index) => (
                                    <div key={index} className="flex gap-2 mb-2">
                                        <input type="time" value={item.time} onChange={e => updateHorarioFixo(index, 'time', e.target.value)} className={inputClass}/>
                                        <input type="number" placeholder="Qtd" value={item.qtd} onChange={e => updateHorarioFixo(index, 'qtd', e.target.value)} className={inputClass}/>
                                        {horariosFixos.length > 1 && <button type="button" onClick={() => removeHorarioFixo(index)} className="text-red-500 p-2"><Trash2/></button>}
                                    </div>
                                ))}
                                <button type="button" onClick={addHorarioFixo} className="text-blue-600 font-bold text-sm flex items-center gap-1 mt-2"><Plus size={16}/> Mais Horário</button>
                            </div>
                        )}

                        <div className="mt-6 pt-6 border-t border-slate-100 dark:border-slate-700">
                            <button 
                                type="button" 
                                onClick={handleAddRule} 
                                className={`w-full font-bold py-3.5 rounded-xl flex items-center justify-center gap-2 transition-transform active:scale-95 shadow-md ${editingRuleId ? 'bg-purple-600 hover:bg-purple-700 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                            >
                                {editingRuleId ? <><CheckCircle2 size={20}/> Atualizar Regra</> : <><ListPlus size={20}/> Incluir nesta Agenda</>}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            {/* 3. RESUMO DA AGENDA */}
            <div className="lg:col-span-1">
                <div className="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 h-full flex flex-col">
                    <div className="p-5 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 rounded-t-xl">
                        <h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                            <CheckCircle2 className="text-green-500"/> Resumo da Criação
                        </h3>
                        <p className="text-xs text-slate-500 mt-1">Verifique as regras antes de salvar.</p>
                    </div>
                    
                    <div className="p-4 flex-1 overflow-y-auto max-h-[500px] space-y-3">
                        {regrasAdicionadas.length === 0 ? (
                            <div className="text-center py-10 text-slate-400 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl">
                                <ListPlus size={32} className="mx-auto mb-2 opacity-50"/>
                                <p>Nenhuma regra adicionada.</p>
                                <p className="text-xs">Configure ao lado e clique em "Incluir".</p>
                            </div>
                        ) : (
                            regrasAdicionadas.map((regra, idx) => (
                                <div key={regra.id} className={`bg-slate-50 dark:bg-slate-700/30 border rounded-lg p-3 relative group animate-in slide-in-from-right-2 duration-300 ${editingRuleId === regra.id ? 'border-purple-400 ring-1 ring-purple-400 bg-purple-50 dark:bg-purple-900/10' : 'border-slate-200 dark:border-slate-600'}`}>
                                    <div className="absolute top-2 right-2 flex gap-1">
                                        <button onClick={() => handleEditRule(regra)} className="text-slate-400 hover:text-blue-500 transition-colors p-1" title="Editar"><Pencil size={14}/></button>
                                        <button onClick={() => handleRemoveRule(regra.id)} className="text-slate-400 hover:text-red-500 transition-colors p-1" title="Remover"><X size={16}/></button>
                                    </div>
                                    <div className="pr-12">
                                        <div className="flex flex-wrap gap-1 mb-2">
                                            {regra.dias.map(d => (
                                                <span key={d} className="text-[10px] uppercase font-bold bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-1.5 py-0.5 rounded">{diasSemana.find(dia => dia.id === d)?.label}</span>
                                            ))}
                                        </div>
                                        <p className="text-[10px] text-slate-400 mb-1 flex items-center gap-1">
                                            <CalendarDays size={10}/> {new Date(regra.data_inicio).toLocaleDateString()} até {new Date(regra.data_fim).toLocaleDateString()}
                                        </p>
                                        <p className="text-sm font-semibold text-slate-700 dark:text-slate-200">
                                            {regra.tipo === 'tempo' && <span className="text-purple-600 dark:text-purple-400 flex items-center gap-1"><Hourglass size={12}/> Por Tempo</span>}
                                            {regra.tipo === 'periodo' && <span className="text-orange-600 dark:text-orange-400 flex items-center gap-1"><Repeat size={12}/> Qtd/Horário</span>}
                                            {regra.tipo === 'fixo' && <span className="text-green-600 dark:text-green-400 flex items-center gap-1"><Pin size={12}/> Fixo</span>}
                                        </p>
                                        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">{regra.resumo}</p>
                                        
                                        {/* MOSTRA CONVÊNIO E VALOR NO RESUMO */}
                                        <div className="mt-2 pt-2 border-t border-slate-200 dark:border-slate-600 text-xs flex justify-between items-center">
                                            <span className="flex items-center gap-1 text-slate-600 dark:text-slate-300"><ShieldCheck size={12}/> {regra.convenio_nome}</span>
                                            {regra.valor > 0 && <span className="font-bold text-green-600 dark:text-green-400">R$ {Number(regra.valor).toFixed(2)}</span>}
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    <div className="p-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 rounded-b-xl">
                        <button onClick={handleSaveAll} disabled={loading || regrasAdicionadas.length === 0} className="w-full bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3.5 rounded-xl shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2">
                            {loading ? 'Salvando...' : 'Salvar Todas as Agendas'}
                        </button>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front\src\pages\DadosClinica.jsx
============================================================
import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import Layout from '../components/Layout';
import { Building, Save, MapPin, Info, Loader2 } from 'lucide-react';

export default function DadosClinica() {
  const { api } = useAuth();
  const [loading, setLoading] = useState(false);
  const [fetching, setFetching] = useState(true);
  const [loadingCep, setLoadingCep] = useState(false);
  
  const [form, setForm] = useState({
    nome_fantasia: '', cnpj: '', email: '', telefone: '',
    logradouro: '', numero: '', complemento: '', 
    bairro: '', cidade: '', estado: '', cep: ''
  });

  // --- MÁSCARAS ---
  const mascaraCNPJ = (v) => {
    return v.replace(/\D/g, '')
            .replace(/^(\d{2})(\d)/, '$1.$2')
            .replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3')
            .replace(/\.(\d{3})(\d)/, '.$1/$2')
            .replace(/(\d{4})(\d)/, '$1-$2')
            .slice(0, 18);
  };

  const mascaraTelefone = (v) => {
    return v.replace(/\D/g, '')
            .replace(/(\d{2})(\d)/, '($1) $2')
            .replace(/(\d{5})(\d)/, '$1-$2')
            .slice(0, 15);
  };

  const mascaraCEP = (v) => {
    return v.replace(/\D/g, '')
            .replace(/(\d{5})(\d)/, '$1-$2')
            .slice(0, 9);
  };

  useEffect(() => {
    const fetchData = async () => {
      try {
        const res = await api.get('configuracoes/clinica/');
        // Aplica máscaras nos dados que vêm do banco
        const dados = res.data;
        setForm({
          ...dados,
          cnpj: dados.cnpj ? mascaraCNPJ(dados.cnpj) : '',
          telefone: dados.telefone ? mascaraTelefone(dados.telefone) : '',
          cep: dados.cep ? mascaraCEP(dados.cep) : ''
        });
      } catch (e) {
        console.error("Erro ao carregar dados", e);
      } finally {
        setFetching(false);
      }
    };
    fetchData();
  }, [api]);

  // --- BUSCA DE CEP (ViaCEP) ---
  const buscarCep = async () => {
    const cepLimpo = form.cep.replace(/\D/g, '');
    if (cepLimpo.length !== 8) return;

    setLoadingCep(true);
    try {
      const response = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
      const data = await response.json();
      if (!data.erro) {
        setForm(prev => ({
          ...prev,
          logradouro: data.logradouro,
          bairro: data.bairro,
          cidade: data.localidade,
          estado: data.uf
        }));
        // Foca no campo número após carregar o endereço
        document.getElementById('numero_clinica')?.focus();
      }
    } catch (error) {
      console.error("Erro ao buscar CEP", error);
    } finally {
      setLoadingCep(false);
    }
  };

  const handleChange = (e) => {
    let { name, value } = e.target;
    if (name === 'cnpj') value = mascaraCNPJ(value);
    if (name === 'telefone') value = mascaraTelefone(value);
    if (name === 'cep') value = mascaraCEP(value);
    
    setForm({ ...form, [name]: value });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      // Opcional: remover formatação antes de enviar ao backend
      const payload = {
        ...form,
        cnpj: form.cnpj.replace(/\D/g, ''),
        telefone: form.telefone.replace(/\D/g, ''),
        cep: form.cep.replace(/\D/g, '')
      };
      await api.put('configuracoes/clinica/', payload);
      alert("Dados atualizados com sucesso!");
    } catch (e) {
      alert("Erro ao salvar.");
    } finally {
      setLoading(false);
    }
  };

  const inputClass = "w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-blue-500 dark:text-white transition-all";
  const labelClass = "block text-sm font-bold text-slate-600 dark:text-slate-400 mb-1";

  if (fetching) return <Layout><div className="text-center p-10 text-slate-400">Carregando dados da clínica...</div></Layout>;

  return (
    <Layout>
      <div className="max-w-5xl mx-auto pb-10">
        <div className="flex items-center gap-3 mb-8">
            <div className="bg-blue-600 p-2 rounded-lg shadow-lg">
                <Building className="text-white" size={24}/>
            </div>
            <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Dados da Clínica</h1>
        </div>

        <form onSubmit={handleSubmit} className="space-y-6">
          <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
            <h2 className="text-lg font-bold mb-4 flex items-center gap-2 border-b pb-2 dark:border-slate-700">
                <Info size={18} className="text-blue-500"/> Informações Gerais
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="md:col-span-2">
                <label className={labelClass}>Nome Fantasia</label>
                <input name="nome_fantasia" required value={form.nome_fantasia} onChange={handleChange} className={inputClass} />
              </div>
              <div>
                <label className={labelClass}>CNPJ</label>
                <input name="cnpj" value={form.cnpj} onChange={handleChange} className={inputClass} placeholder="00.000.000/0000-00"/>
              </div>
              <div>
                <label className={labelClass}>Telefone</label>
                <input name="telefone" value={form.telefone} onChange={handleChange} className={inputClass} placeholder="(00) 00000-0000" />
              </div>
              <div className="md:col-span-2">
                <label className={labelClass}>E-mail</label>
                <input name="email" type="email" value={form.email} onChange={handleChange} className={inputClass} />
              </div>
            </div>
          </div>

          <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
            <h2 className="text-lg font-bold mb-4 flex items-center gap-2 border-b pb-2 dark:border-slate-700">
                <MapPin size={18} className="text-red-500"/> Endereço
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div className="md:col-span-1">
                <label className={labelClass}>CEP {loadingCep && <Loader2 size={12} className="inline animate-spin ml-1 text-blue-500"/>}</label>
                <input name="cep" value={form.cep} onChange={handleChange} onBlur={buscarCep} className={inputClass} placeholder="00000-000" />
              </div>
              <div className="md:col-span-2">
                <label className={labelClass}>Logradouro</label>
                <input name="logradouro" value={form.logradouro} onChange={handleChange} className={inputClass} />
              </div>
              <div className="md:col-span-1">
                <label className={labelClass}>Número</label>
                <input id="numero_clinica" name="numero" value={form.numero} onChange={handleChange} className={inputClass} />
              </div>
              <div className="md:col-span-2">
                <label className={labelClass}>Complemento</label>
                <input name="complemento" value={form.complemento || ''} onChange={handleChange} className={inputClass} />
              </div>
              <div className="md:col-span-2">
                <label className={labelClass}>Bairro</label>
                <input name="bairro" value={form.bairro} onChange={handleChange} className={inputClass} />
              </div>
              <div className="md:col-span-3">
                <label className={labelClass}>Cidade</label>
                <input name="cidade" value={form.cidade} onChange={handleChange} className={inputClass} />
              </div>
              <div className="md:col-span-1">
                <label className={labelClass}>UF</label>
                <input name="estado" maxLength="2" value={form.estado} onChange={handleChange} className={inputClass} style={{textTransform: 'uppercase'}} />
              </div>
            </div>
          </div>

          <div className="flex justify-end">
            <button type="submit" disabled={loading} className="bg-blue-600 hover:bg-blue-700 text-white px-10 py-3.5 rounded-xl font-bold flex items-center gap-2 shadow-lg transition-all active:scale-95 disabled:opacity-50">
              {loading ? <Loader2 size={20} className="animate-spin"/> : <Save size={20}/>}
              {loading ? 'Salvando...' : 'Salvar Alterações'}
            </button>
          </div>
        </form>
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front\src\pages\Dashboard.jsx
============================================================
import { useAuth } from '../context/AuthContext';
import { Link } from 'react-router-dom';
import Layout from '../components/Layout';
import { Users, Calendar, DollarSign, Settings, Activity, ArrowRight } from 'lucide-react';

export default function Dashboard() {
  const { user } = useAuth();

  const ShortcutCard = ({ to, title, description, icon: Icon, colorClass }) => (
    <Link to={to} className="group relative bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md hover:-translate-y-1 transition-all overflow-hidden">
      <div className={`absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity ${colorClass.replace('bg-', 'text-')}`}>
        <Icon size={80} />
      </div>
      <div className="relative z-10 flex items-start justify-between">
        <div>
          <div className={`p-3 rounded-lg inline-flex mb-4 ${colorClass} text-white shadow-lg`}>
            <Icon size={24} />
          </div>
          <h3 className="text-lg font-bold text-slate-700 dark:text-white mb-1">{title}</h3>
          <p className="text-sm text-slate-500 dark:text-slate-400 mb-4">{description}</p>
        </div>
      </div>
      <div className="flex items-center text-sm font-medium text-blue-600 dark:text-blue-400">
        Acessar <ArrowRight size={16} className="ml-1 group-hover:translate-x-1 transition-transform" />
      </div>
    </Link>
  );

  const StatWidget = ({ label, value, trend, positive }) => (
    <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex items-center justify-between">
      <div>
        <p className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-1">{label}</p>
        <h4 className="text-2xl font-bold text-slate-800 dark:text-white">{value}</h4>
      </div>
      <div className={`text-sm px-2 py-1 rounded-full ${positive ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400'}`}>
        {trend}
      </div>
    </div>
  );

  return (
    <Layout>
      <div className="max-w-7xl mx-auto">
        <div className="mb-8">
          <h1 className="text-2xl font-bold text-slate-800 dark:text-white">
            Olá, <span className="text-blue-600 dark:text-blue-400">{user?.first_name || user?.username}</span>
          </h1>
          <p className="text-slate-500 dark:text-slate-400">Resumo da clínica.</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
          <StatWidget label="Pacientes Hoje" value="12" trend="+2 novos" positive={true} />
          <StatWidget label="Consultas" value="4" trend="Pendentes" positive={false} />
          <StatWidget label="Faturamento" value="R$ 1.250" trend="+15%" positive={true} />
        </div>

        <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-6">Acesso Rápido</h2>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          {(user?.acesso_atendimento || user?.is_superuser) && (
             <ShortcutCard to="/pacientes" title="Atendimento" description="Gestão de pacientes." icon={Users} colorClass="bg-blue-600"/>
          )}
          {(user?.acesso_agendamento || user?.is_superuser) && (
             <ShortcutCard to="/agenda" title="Agendamento" description="Agenda médica." icon={Calendar} colorClass="bg-indigo-500"/>
          )}
          {(user?.acesso_faturamento || user?.is_superuser) && (
             <ShortcutCard to="/faturamento" title="Financeiro" description="Notas e caixa." icon={DollarSign} colorClass="bg-emerald-500"/>
          )}
          {user?.is_superuser && (
             <ShortcutCard to="/cadastro-operador" title="Configurações" description="Gestão do sistema." icon={Settings} colorClass="bg-slate-700"/>
          )}
        </div>

        <div className="mt-10 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-slate-800 dark:to-slate-800 rounded-2xl p-6 border border-blue-100 dark:border-slate-700">
          <div className="flex items-center space-x-3 text-blue-800 dark:text-blue-300 mb-2">
            <Activity size={20} />
            <h3 className="font-bold">Status do Sistema</h3>
          </div>
          <p className="text-sm text-blue-600 dark:text-slate-400">
            Todas as integrações operando normalmente.
          </p>
        </div>
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front\src\pages\Especialidades.jsx
============================================================
import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import Layout from '../components/Layout';
// MUDANÇA 1: Troquei 'Edit' por 'Pencil' para padronizar com as outras telas
import { Plus, Pencil, Trash2, Tag, X, Save, Search, ChevronLeft, ChevronRight } from 'lucide-react';

export default function Especialidades() {
  const { api } = useAuth();
  
  const [especialidades, setEspecialidades] = useState([]);
  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState('');
  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [totalCount, setTotalCount] = useState(0);
  
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const [nome, setNome] = useState('');
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    if (api) loadData();
  }, [api, page, search]);

  const loadData = async () => {
    setLoading(true);
    try {
      let pageSize = 15;
      try {
          const conf = await api.get('operadores/config/');
          if (conf.data?.itens_por_pagina) pageSize = conf.data.itens_por_pagina;
      } catch {}

      const response = await api.get(`especialidades/?page=${page}&page_size=${pageSize}&search=${search}`);
      const data = response.data;

      if (data.results) {
        setEspecialidades(data.results);
        setTotalCount(data.count);
        setTotalPages(Math.ceil(data.count / pageSize));
      } else {
        setEspecialidades(data);
        setTotalPages(1);
        setTotalCount(data.length);
      }
    } catch (error) {
      console.error("Erro", error);
      if (page > 1) setPage(1);
    } finally {
      setLoading(false);
    }
  };

  const handleOpenModal = (item = null) => {
    setEditingItem(item);
    setNome(item ? item.nome : '');
    setIsModalOpen(true);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setSaving(true);
    try {
      if (editingItem) {
        await api.put(`especialidades/${editingItem.id}/`, { nome });
      } else {
        await api.post('especialidades/', { nome });
      }
      setIsModalOpen(false);
      loadData();
    } catch (error) {
      alert("Erro ao salvar.");
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (id) => {
    if (confirm("Tem certeza que deseja excluir?")) {
      try {
        await api.delete(`especialidades/${id}/`);
        loadData();
      } catch (error) {
        alert("Não é possível excluir item em uso.");
      }
    }
  };

  const paginationBtnClass = "p-2 border rounded-lg transition-colors disabled:opacity-50 bg-white border-slate-200 text-slate-600 hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-700";
  
  // PADRÃO DE BOTÃO IDENTICO AO DE PACIENTES/OPERADORES
  const actionBtnClass = "p-2 bg-transparent rounded-lg transition-colors";
  const editBtnClass = `${actionBtnClass} text-blue-600 hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-blue-900/30`;
  const deleteBtnClass = `${actionBtnClass} text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/30`;

  return (
    <Layout>
      <div className="max-w-4xl mx-auto">
        <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <Tag className="text-blue-600"/> Especialidades
                </h1>
                <p className="text-slate-500 dark:text-slate-400 text-sm">Gerencie as áreas de atuação médica.</p>
            </div>
            <button 
                onClick={() => handleOpenModal()} 
                className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg transition-transform active:scale-95"
            >
                <Plus size={20}/> Nova Especialidade
            </button>
        </div>

        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6 relative">
            <Search className="absolute left-7 top-7 text-slate-400" size={18} />
            <input 
                placeholder="Pesquisar especialidade..." 
                value={search} 
                onChange={e => { setSearch(e.target.value); setPage(1); }}
                className="w-full pl-10 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 outline-none text-slate-700 dark:text-white transition-colors focus:border-blue-500"
            />
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
            <table className="w-full text-left">
                <thead className="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700">
                    <tr>
                        <th className="px-6 py-4">Nome da Especialidade</th>
                        <th className="px-6 py-4 text-right">Ações</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                    {especialidades.map((item) => (
                        <tr key={item.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                            <td className="px-6 py-4 font-medium text-slate-700 dark:text-white">
                                {item.nome}
                            </td>
                            <td className="px-6 py-4 text-right flex justify-end gap-2">
                                {/* BOTÕES PADRONIZADOS */}
                                <button onClick={() => handleOpenModal(item)} className={editBtnClass} title="Editar">
                                    <Pencil size={18}/>
                                </button>
                                <button onClick={() => handleDelete(item.id)} className={deleteBtnClass} title="Excluir">
                                    <Trash2 size={18}/>
                                </button>
                            </td>
                        </tr>
                    ))}
                    {especialidades.length === 0 && !loading && (
                        <tr><td colSpan="2" className="p-8 text-center text-slate-400">Nenhuma especialidade encontrada.</td></tr>
                    )}
                </tbody>
            </table>

            {totalPages > 1 && (
                <div className="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center text-slate-500 text-sm">
                    <span>Página <strong>{page}</strong> de <strong>{totalPages}</strong> ({totalCount} itens)</span>
                    <div className="flex gap-2">
                        <button disabled={page === 1} onClick={() => setPage(p => p - 1)} className={paginationBtnClass}><ChevronLeft size={16}/></button>
                        <button disabled={page === totalPages} onClick={() => setPage(p => p + 1)} className={paginationBtnClass}><ChevronRight size={16}/></button>
                    </div>
                </div>
            )}
        </div>

        {isModalOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform scale-100 transition-all">
                    <div className="flex justify-between items-center p-5 border-b border-slate-100 dark:border-slate-700">
                        <h3 className="text-lg font-bold text-slate-800 dark:text-white">
                            {editingItem ? 'Editar Especialidade' : 'Nova Especialidade'}
                        </h3>
                        <button onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                            <X size={24} />
                        </button>
                    </div>
                    
                    <form onSubmit={handleSubmit} className="p-6">
                        <div className="mb-6">
                            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Nome</label>
                            <input 
                                autoFocus
                                required
                                type="text"
                                placeholder="Ex: Cardiologia"
                                className="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none"
                                value={nome}
                                onChange={e => setNome(e.target.value)}
                            />
                        </div>

                        <div className="flex justify-end gap-3">
                            <button type="button" onClick={() => setIsModalOpen(false)} className="px-5 py-2.5 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl font-bold transition-colors">Cancelar</button>
                            <button type="submit" disabled={saving} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-xl font-bold shadow-lg shadow-blue-500/20 flex items-center gap-2">
                                {saving ? 'Salvando...' : <><Save size={18}/> Salvar</>}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        )}
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front\src\pages\Login.jsx
============================================================
import { useState } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNavigate } from 'react-router-dom';
import { HeartPulse, Lock, User, Activity } from 'lucide-react';

export default function Login() {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [rememberMe, setRememberMe] = useState(false);
  const { login } = useAuth();
  const navigate = useNavigate();
  const [error, setError] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setIsLoading(true);
    
    // Passamos o 'rememberMe' para a função de login
    const success = await login(username, password, rememberMe);
    
    setIsLoading(false);
    if (success) navigate('/dashboard');
    else setError('Usuário ou senha incorretos.');
  };

  return (
    <div className="w-screen h-screen flex items-center justify-center bg-slate-100 relative overflow-hidden">
      
      <div className="absolute inset-0 z-0">
        <div className="absolute inset-0 bg-gradient-to-br from-blue-900/10 to-blue-500/10 mix-blend-multiply" />
        <div className="h-full w-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20"></div>
      </div>

      <div className="bg-white w-full max-w-4xl h-[600px] rounded-2xl shadow-2xl overflow-hidden flex flex-col md:flex-row z-10 m-4 relative">
        
        {/* Lado Esquerdo (Design) */}
        <div className="w-full md:w-1/2 bg-blue-600 relative flex flex-col justify-center items-center text-center p-12 overflow-hidden">
          <div 
            className="absolute inset-0 bg-cover bg-center mix-blend-overlay opacity-50"
            style={{ backgroundImage: "url('https://images.unsplash.com/photo-1516549655169-df83a092dd14?q=80&w=1000&auto=format&fit=crop')" }}
          ></div>
          <div className="absolute inset-0 bg-gradient-to-t from-blue-900/90 to-blue-600/80"></div>

          <div className="relative z-10">
            <div className="bg-white/10 p-5 rounded-full inline-block mb-6 backdrop-blur-md shadow-inner border border-white/20">
              <HeartPulse size={56} className="text-white animate-pulse" />
            </div>
            <h1 className="text-4xl font-bold text-white mb-2 tracking-wide">TheClinic</h1>
            <div className="h-1 w-20 bg-blue-300 mx-auto mb-4 rounded-full"></div>
            <p className="text-blue-100 text-lg font-light leading-relaxed">
              Gestão clínica inteligente, <br/> segura e eficiente.
            </p>
          </div>

          <div className="absolute bottom-8 text-blue-200/80 text-xs flex items-center gap-2">
            <Activity size={14} />
            <span>Ambiente Seguro & Criptografado</span>
          </div>
        </div>

        {/* Lado Direito (Formulário) */}
        <div className="w-full md:w-1/2 bg-white p-10 flex flex-col justify-center relative">
          
          <div className="mb-8">
            <h2 className="text-2xl font-bold text-slate-800">Área Restrita</h2>
            <p className="text-slate-500 text-sm mt-1">Insira suas credenciais de operador.</p>
          </div>
          
          <form onSubmit={handleSubmit} className="space-y-5">
            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wider">Usuário</label>
              <div className="relative group">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <User className="h-5 w-5 text-slate-400 group-focus-within:text-blue-600 transition-colors" />
                </div>
                <input 
                  id="username"
                  name="username"
                  // ADICIONADO: Ajuda o navegador a saber que é um usuário
                  autoComplete="username" 
                  className="block w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg text-slate-900 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                  placeholder="ID do Operador" 
                  value={username}
                  onChange={e => setUsername(e.target.value)}
                />
              </div>
            </div>

            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase mb-2 tracking-wider">Senha</label>
              <div className="relative group">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Lock className="h-5 w-5 text-slate-400 group-focus-within:text-blue-600 transition-colors" />
                </div>
                <input 
                  id="password"
                  name="password"
                  // ADICIONADO: Ajuda o navegador a saber que é a senha atual
                  autoComplete="current-password"
                  className="block w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg text-slate-900 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                  type="password" 
                  placeholder="••••••••" 
                  value={password}
                  onChange={e => setPassword(e.target.value)} 
                />
              </div>
            </div>

            <div className="flex items-center justify-between">
              <label className="flex items-center space-x-2 cursor-pointer group">
                <input 
                  type="checkbox" 
                  checked={rememberMe}
                  onChange={(e) => setRememberMe(e.target.checked)}
                  className="w-4 h-4 bg-white border border-slate-300 rounded text-blue-600 focus:ring-blue-500 cursor-pointer accent-blue-600"
                />
                <span className="text-sm text-slate-500 group-hover:text-slate-700 transition-colors">Lembrar-me</span>
              </label>

              <a href="#" className="text-sm text-blue-600 hover:text-blue-800 font-medium transition-colors">
                Esqueceu a senha?
              </a>
            </div>

            {error && (
              <div className="bg-red-50 text-red-600 text-sm p-3 rounded-lg border border-red-100 flex items-center animate-shake">
                <span className="font-bold mr-2">Erro:</span> {error}
              </div>
            )}

            <div className="pt-2">
              <button 
                type="submit"
                disabled={isLoading}
                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-lg shadow-lg shadow-blue-500/30 transition-all transform active:scale-95 flex justify-center items-center"
              >
                {isLoading ? 'Acessando...' : 'Entrar no Sistema'}
              </button>
            </div>
          </form>

          <p className="absolute bottom-6 left-0 w-full text-center text-xs text-slate-300">
            © 2026 TheClinic Tecnologia
          </p>
        </div>
      </div>
    </div>
  );
}

============================================================
ARQUIVO: clinica-front\src\pages\MarcarConsulta.jsx
============================================================
import React, { useState, useEffect, useCallback, useRef } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNotification } from '../context/NotificationContext';
import Layout from '../components/Layout';
import Calendar from 'react-calendar';
import 'react-calendar/dist/Calendar.css';
import { 
  Calendar as CalendarIcon, X, Plus, Trash2, Pencil, Loader2, Save, UserPlus, MapPin, ChevronDown, Check, AlertCircle, DollarSign 
} from 'lucide-react';

const calendarStyles = `
  .react-calendar { width: 100%; border: none; font-family: inherit; background: transparent; }
  .react-calendar__tile--now { background: transparent !important; color: #2563eb !important; border: 2px solid #2563eb !important; }
  .dia-livre { background-color: #dcfce7 !important; color: #166534 !important; border: 1px solid #bbf7d0 !important; }
  .react-calendar__tile--active { background: #2563eb !important; color: white !important; border: none !important; }
`;

const SearchableSelect = ({ label, options, value, onChange, placeholder, disabled }) => {
    const [isOpen, setIsOpen] = useState(false);
    const [query, setQuery] = useState('');
    const containerRef = useRef(null);

    useEffect(() => { 
        const selected = options.find(o => String(o.id) === String(value)); 
        setQuery(selected ? selected.label : '');
    }, [value, options]);

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (containerRef.current && !containerRef.current.contains(event.target)) {
                setIsOpen(false);
                const selected = options.find(o => String(o.id) === String(value));
                setQuery(selected ? selected.label : '');
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, [containerRef, value, options]);

    const selectedLabel = options.find(o => String(o.id) === String(value))?.label;
    const filtered = (query === '' || query === selectedLabel) 
        ? options 
        : options.filter(o => o.label.toLowerCase().includes(query.toLowerCase()));

    const handleClear = (e) => {
        e.stopPropagation();
        onChange('');
        setQuery('');
        setIsOpen(false);
    };

    return (
        <div className="relative mb-4" ref={containerRef}>
            <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1">{label}</label>
            <div className="relative">
                <input 
                    type="text" 
                    disabled={disabled}
                    className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 pr-10 outline-none focus:ring-2 focus:ring-blue-500 text-sm dark:text-white disabled:opacity-50 cursor-pointer" 
                    value={query} 
                    onFocus={() => !disabled && setIsOpen(true)}
                    onClick={() => !disabled && setIsOpen(true)}
                    onChange={e => { setQuery(e.target.value); setIsOpen(true); if(e.target.value === '') onChange(''); }} 
                    placeholder={placeholder} 
                    autoComplete="off"
                />
                <div className="absolute right-2 top-2.5 flex items-center gap-1 text-slate-400">
                    {value && !disabled && (
                        <button onClick={handleClear} className="hover:text-red-500 p-0.5 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                            <X size={14}/>
                        </button>
                    )}
                    <ChevronDown size={16} className={`transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}/>
                </div>
            </div>
            {isOpen && !disabled && (
                <ul className="absolute z-[100] w-full bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg shadow-2xl max-h-60 overflow-auto mt-1 animate-in fade-in zoom-in duration-100">
                    {filtered.length > 0 ? filtered.map(opt => (
                        <li key={opt.id} onMouseDown={() => { onChange(opt.id); setIsOpen(false); }} className={`p-2.5 cursor-pointer text-sm border-b last:border-0 border-slate-100 dark:border-slate-700 flex justify-between items-center transition-colors ${String(value) === String(opt.id) ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-bold' : 'hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200'}`}>
                            {opt.label}
                            {String(value) === String(opt.id) && <Check size={14}/>}
                        </li>
                    )) : <li className="p-3 text-sm text-slate-400 text-center">Nenhum resultado.</li>}
                </ul>
            )}
        </div>
    );
};

export default function MarcarConsulta() {
  const { api } = useAuth();
  const { notify, confirmDialog } = useNotification();
  
  const [profissionais, setProfissionais] = useState([]);
  const [especialidades, setEspecialidades] = useState([]);
  const [pacientes, setPacientes] = useState([]); 
  const [convenios, setConvenios] = useState([]);
  
  const [profissionalId, setProfissionalId] = useState('');
  const [especialidadeId, setEspecialidadeId] = useState('');
  const [dateValue, setDateValue] = useState(new Date());

  const [modalOpen, setModalOpen] = useState(false);
  const [tipoModal, setTipoModal] = useState(''); 
  const [horarioSelecionado, setHorarioSelecionado] = useState('');
  const [valorSelecionado, setValorSelecionado] = useState(''); // Começa vazio ou string
  const [pacienteId, setPacienteId] = useState('');
  const [convenioId, setConvenioId] = useState('');
  const [encaixeHora, setEncaixeHora] = useState('');
  const [observacao, setObservacao] = useState('');
  const [loadingSave, setLoadingSave] = useState(false);
  const [agendamentoIdEditar, setAgendamentoIdEditar] = useState(null); 

  const [modalPacienteOpen, setModalPacienteOpen] = useState(false);
  const [loadingCep, setLoadingCep] = useState(false);
  const formInicialPaciente = { nome: '', nome_mae: '', sexo: '', cpf: '', data_nascimento: '', telefone: '', cep: '', logradouro: '', numero: '', complemento: '', bairro: '', cidade: '', estado: '' };
  const [novoPaciente, setNovoPaciente] = useState(formInicialPaciente);

  const getLocalISODate = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
  };

  const [dataApi, setDataApi] = useState(getLocalISODate(new Date()));
  const [vagasDoDia, setVagasDoDia] = useState([]);
  const [regrasProfissional, setRegrasProfissional] = useState([]); 

  const carregarPacientes = () => {
      api.get('pacientes/lista/').then(res => setPacientes(res.data.results?.map(p => ({ id: p.id, label: `${p.nome} - ${p.cpf}` })) || []));
  };

  useEffect(() => {
    if (api) {
        api.get('profissionais/').then(res => setProfissionais(res.data.results?.map(p => ({ id: p.id, label: p.nome })) || []));
        carregarPacientes();
        api.get('configuracoes/convenios/').then(res => setConvenios(res.data.results?.map(c => ({ id: c.id, label: c.nome })) || []));
    }
  }, [api]);

  useEffect(() => {
    if (profissionalId) {
        api.get(`profissionais/${profissionalId}/`).then(res => {
            const specs = res.data.especialidades.map(v => ({ id: v.especialidade_leitura || v.especialidade_id, label: v.nome_especialidade }));
            setEspecialidades(specs);
            if(specs.length === 1) setEspecialidadeId(specs[0].id);
        });
        api.get(`agendas/config/?status=ativos&profissional_id=${profissionalId}&nopage=true`).then(res => setRegrasProfissional(res.data));
    } else {
        setEspecialidades([]);
        setEspecialidadeId('');
    }
  }, [profissionalId, api]);

  useEffect(() => {
    if (profissionalId && especialidadeId && dataApi) carregarAgenda();
    else setVagasDoDia([]);
  }, [profissionalId, especialidadeId, dataApi, regrasProfissional]);

  const carregarAgenda = async () => {
    try {
        const res = await api.get(`agendamento/?profissional=${profissionalId}&especialidade=${especialidadeId}&data=${dataApi}`);
        const agendamentos = res.data.results || res.data;
        gerarVisualizacao(regrasProfissional, agendamentos);
    } catch (e) { console.error(e); }
  };

  const getTileClassName = ({ date, view }) => {
    if (view !== 'month' || !especialidadeId) return null;
    const dataString = getLocalISODate(date);
    const jsDay = date.getDay(); 
    return regrasProfissional.some(r => (r.dia_semana === jsDay) && String(r.especialidade) === String(especialidadeId) && (r.data_inicio <= dataString && r.data_fim >= dataString)) ? 'dia-livre' : null;
  };

  const gerarVisualizacao = (regras, agendamentos) => {
    let slots = [];
    const jsDay = dateValue.getDay(); 
    const regrasFiltradas = regras.filter(r => r.dia_semana === jsDay && r.data_inicio <= dataApi && r.data_fim >= dataApi && String(r.especialidade) === String(especialidadeId));

    regrasFiltradas.forEach(regra => {
        const valorRegra = parseFloat(regra.valor || 0);

        if (regra.tipo === 'fixo') {
            const qtd = regra.quantidade_atendimentos || 1;
            for (let i = 0; i < qtd; i++) {
                slots.push({ hora: regra.hora_inicio.slice(0,5), valor: valorRegra, ocupado: false });
            }
        } else {
            let atual = parseInt(regra.hora_inicio.split(':')[0]) * 60 + parseInt(regra.hora_inicio.split(':')[1]);
            const fim = parseInt(regra.hora_fim.split(':')[0]) * 60 + parseInt(regra.hora_fim.split(':')[1]);
            while (atual < fim) {
                const h = Math.floor(atual/60).toString().padStart(2,'0');
                const m = (atual%60).toString().padStart(2,'0');
                const horaFormatada = `${h}:${m}`;
                const qtdVagas = regra.quantidade_atendimentos > 0 ? regra.quantidade_atendimentos : 1;
                for (let i = 0; i < qtdVagas; i++) {
                    slots.push({ hora: horaFormatada, valor: valorRegra, ocupado: false });
                }
                atual += regra.intervalo_minutos;
            }
        }
    });

    let rests = [...agendamentos];
    const final = slots.map(s => {
        const idx = rests.findIndex(a => a.horario.slice(0,5) === s.hora);
        if (idx !== -1) {
            const a = rests.splice(idx, 1)[0];
            return { 
                ...s, 
                ocupado: true, 
                paciente: a.nome_paciente, 
                agendamento_id: a.id, 
                paciente_id: a.paciente, 
                convenio_id: a.convenio, 
                convenio_nome: a.nome_convenio, 
                observacoes: a.observacoes,
                is_encaixe: a.is_encaixe,
                valor: parseFloat(a.valor || s.valor)
            };
        }
        return s;
    });
    
    rests.forEach(a => final.push({ 
        hora: a.horario.slice(0,5), 
        valor: parseFloat(a.valor || 0), 
        ocupado: true, 
        paciente: a.nome_paciente, 
        agendamento_id: a.id, 
        is_encaixe: true, 
        paciente_id: a.paciente,
        convenio_id: a.convenio,
        convenio_nome: a.nome_convenio,
        observacoes: a.observacoes
    }));
    
    setVagasDoDia(final.sort((a,b) => a.hora.localeCompare(b.hora)));
  };

  const abrirAgendar = (slot) => {
      setAgendamentoIdEditar(null);
      setHorarioSelecionado(slot.hora);
      setValorSelecionado(slot.valor);
      setTipoModal('normal');
      setPacienteId(''); setConvenioId(''); setObservacao('');
      setModalOpen(true);
  };

  const abrirEditar = (slot) => {
      setAgendamentoIdEditar(slot.agendamento_id);
      setHorarioSelecionado(slot.hora);
      setValorSelecionado(slot.valor);
      setPacienteId(slot.paciente_id); 
      setConvenioId(slot.convenio_id || ''); 
      setObservacao(slot.observacoes || '');
      setTipoModal(slot.is_encaixe ? 'encaixe' : 'normal');
      if(slot.is_encaixe) setEncaixeHora(slot.hora);
      setModalOpen(true);
  };

  const salvarAgendamento = async () => {
    if (!pacienteId) return notify.error("Selecione um paciente.");
    setLoadingSave(true);
    const hora = tipoModal === 'encaixe' ? encaixeHora : horarioSelecionado;
    try {
        const payload = { 
            profissional: profissionalId, 
            especialidade: especialidadeId, 
            paciente: pacienteId, 
            data: dataApi, 
            horario: hora, 
            convenio: convenioId || null, 
            valor: valorSelecionado, 
            observacoes: observacao, 
            is_encaixe: tipoModal === 'encaixe' 
        };
        
        if(agendamentoIdEditar) {
            await api.put(`agendamento/${agendamentoIdEditar}/`, payload);
            notify.success("Agendamento atualizado!");
        } else {
            await api.post('agendamento/', payload);
            notify.success("Agendamento criado!");
        }
        setModalOpen(false);
        carregarAgenda();
    } catch (e) { notify.error("Erro ao salvar: " + (e.response?.data?.detail || "Erro interno")); }
    finally { setLoadingSave(false); }
  };

  const handleExcluirAgendamento = async (e, id) => {
      e.stopPropagation();
      const confirmado = await confirmDialog("Excluir este agendamento?", "Exclusão", "Sim, excluir", "Cancelar", "danger");
      if (confirmado) {
          try {
              await api.delete(`agendamento/${id}/`);
              notify.success("Agendamento excluído.");
              carregarAgenda();
          } catch (e) { notify.error("Erro ao excluir agendamento."); }
      }
  };

  const mascaraCPF = (v) => v.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})/, '$1-$2').slice(0, 14);
  const mascaraTelefone = (v) => v.replace(/\D/g, '').replace(/(\d{2})(\d)/, '($1) $2').replace(/(\d{5})(\d)/, '$1-$2').slice(0, 15);
  const mascaraCEP = (v) => v.replace(/\D/g, '').replace(/(\d{5})(\d)/, '$1-$2').slice(0, 9);

  const handlePacienteChange = (e) => { 
      let { name, value } = e.target; 
      if (name === 'cpf') value = mascaraCPF(value);
      if (name === 'telefone') value = mascaraTelefone(value);
      if (name === 'cep') value = mascaraCEP(value);
      setNovoPaciente({ ...novoPaciente, [name]: value }); 
  };

  const buscarCep = async () => {
      const cepLimpo = novoPaciente.cep.replace(/\D/g, '');
      if (cepLimpo.length !== 8) return;
      setLoadingCep(true);
      try {
          const res = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
          const data = await res.json();
          if(!data.erro) {
              setNovoPaciente(prev => ({ ...prev, logradouro: data.logradouro, bairro: data.bairro, cidade: data.localidade, estado: data.uf }));
              document.getElementById('modal-numero')?.focus();
          }
      } finally { setLoadingCep(false); }
  };

  const salvarPacienteCompleto = async (e) => {
      e.preventDefault();
      try {
          const { data } = await api.post('pacientes/', novoPaciente);
          notify.success("Paciente cadastrado!");
          carregarPacientes(); 
          setPacienteId(data.id); 
          setModalPacienteOpen(false);
          setNovoPaciente(formInicialPaciente);
      } catch (error) { 
          if (error.response?.data?.cpf) notify.warning("CPF já cadastrado!");
          else notify.error("Erro ao cadastrar paciente."); 
      }
  };

  const inputClass = "w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-blue-500 text-sm dark:text-white";

  return (
    <Layout>
      <style>{calendarStyles}</style>
      <div className="max-w-7xl mx-auto pb-20">
        <div className="flex items-center gap-3 mb-6">
            <div className="bg-blue-600 p-3 rounded-xl text-white shadow"><CalendarIcon size={28}/></div>
            <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Marcar Consulta</h1>
        </div>

        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <SearchableSelect label="Profissional" options={profissionais} value={profissionalId} onChange={(id) => { setProfissionalId(id); }} placeholder="Médico..." />
            <SearchableSelect label="Especialidade" options={especialidades} value={especialidadeId} onChange={setEspecialidadeId} placeholder="Especialidade..." disabled={!profissionalId} />
        </div>

        {profissionalId && especialidadeId && (
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 animate-in fade-in duration-300">
                <div className="lg:col-span-4 bg-white dark:bg-slate-800 p-6 rounded-xl shadow border border-slate-200 dark:border-slate-700">
                    <Calendar onChange={(d) => { setDateValue(d); setDataApi(getLocalISODate(d)); }} value={dateValue} locale="pt-BR" tileClassName={getTileClassName} />
                    
                    <div className="mt-8 pt-6 border-t border-slate-100 dark:border-slate-700">
                        <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Legenda do Calendário</h4>
                        <div className="flex flex-col gap-3 text-xs text-slate-600 dark:text-slate-300">
                            <div className="flex items-center gap-2">
                                <div className="w-4 h-4 rounded border bg-[#dcfce7] border-[#bbf7d0]"></div> 
                                <span>Dias com Vagas</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="w-4 h-4 rounded border bg-[#fee2e2] border-[#fecaca]"></div> 
                                <span>Sem Vagas (Indisponível)</span>
                            </div>
                            <div className="flex items-center gap-2">
                                <div className="w-4 h-4 rounded border bg-[#fef3c7] border-[#fcd34d]"></div> 
                                <span>Bloqueio (Em breve)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="lg:col-span-8 bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 flex flex-col h-[550px]">
                    <div className="p-5 border-b flex justify-between items-center dark:border-slate-700">
                        <h3 className="font-bold text-lg dark:text-white uppercase">{dateValue.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' })}</h3>
                        <button onClick={() => { 
                            setAgendamentoIdEditar(null); 
                            setTipoModal('encaixe'); 
                            setValorSelecionado(''); // Zera valor no encaixe
                            setModalOpen(true); 
                        }} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2 shadow-sm transition-all"><Plus size={16}/> Encaixe</button>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 grid grid-cols-1 md:grid-cols-2 gap-3 content-start">
                        {vagasDoDia.length > 0 ? vagasDoDia.map((slot, idx) => (
                            <div 
                                key={idx} 
                                onClick={() => !slot.ocupado && abrirAgendar(slot)} 
                                className={`relative p-3 rounded-xl border-2 flex justify-between items-center transition-all duration-200 ${slot.is_encaixe ? 'bg-yellow-50 border-yellow-200 hover:border-yellow-400' : slot.ocupado ? 'bg-slate-50 border-slate-200 opacity-90' : 'bg-white border-green-200 hover:border-green-500 cursor-pointer hover:shadow-md'}`}
                            >
                                <div className="flex items-center gap-3 overflow-hidden">
                                    <div className={`text-lg font-bold w-16 text-center py-1 rounded-lg ${slot.is_encaixe ? 'bg-yellow-100 text-yellow-700' : slot.ocupado ? 'bg-slate-200 text-slate-500' : 'bg-blue-100 text-blue-700'}`}>
                                        {slot.hora}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        {slot.ocupado ? (
                                            <>
                                                <div className="text-sm font-bold text-slate-700 dark:text-slate-800 truncate">{slot.paciente}</div>
                                                {slot.convenio_nome && <div className="text-xs text-slate-500 truncate">{slot.convenio_nome}</div>}
                                            </>
                                        ) : (
                                            <>
                                                <div className="text-sm font-bold text-green-600">Livre</div>
                                                {slot.valor > 0 && <div className="text-xs font-semibold text-slate-500 mt-0.5">R$ {Number(slot.valor).toFixed(2)}</div>}
                                            </>
                                        )}
                                    </div>
                                </div>

                                {slot.ocupado && (
                                    <div className="flex gap-1 ml-2">
                                        <button onClick={(e) => { e.stopPropagation(); abrirEditar(slot); }} className="p-1.5 bg-white text-blue-600 border border-blue-100 hover:bg-blue-50 rounded-lg transition-colors shadow-sm"><Pencil size={14}/></button>
                                        <button onClick={(e) => handleExcluirAgendamento(e, slot.agendamento_id)} className="p-1.5 bg-white text-red-500 border border-red-100 hover:bg-red-50 rounded-lg transition-colors shadow-sm"><Trash2 size={14}/></button>
                                    </div>
                                )}
                                
                                {slot.is_encaixe && <div className="absolute -top-2 -right-2 bg-yellow-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm flex items-center gap-1"><AlertCircle size={10}/> EXTRA</div>}
                            </div>
                        )) : (
                            <div className="col-span-2 text-center py-20 flex flex-col items-center text-slate-400">
                                <CalendarIcon size={48} className="mb-2 opacity-20"/>
                                <p>Nenhum horário disponível para esta data.</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        )}

        {/* MODAL DE AGENDAMENTO (COM CAMPO EDITÁVEL NO ENCAIXE) */}
        {modalOpen && (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                    <div className="bg-blue-600 p-6 text-white flex justify-between items-center"><h2 className="text-xl font-bold">{agendamentoIdEditar ? 'Editar Agendamento' : 'Novo Agendamento'}</h2><button onClick={() => setModalOpen(false)}><X/></button></div>
                    <div className="p-6 space-y-4">
                        
                        {/* SE FOR ENCAIXE, CAMPO DE VALOR EDITÁVEL */}
                        {tipoModal === 'encaixe' ? (
                            <div>
                                <label className="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-1">Valor da Consulta</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-2.5 text-slate-500">R$</span>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        className="w-full border p-2.5 pl-10 rounded-lg dark:bg-slate-900 dark:text-white"
                                        value={valorSelecionado} 
                                        onChange={e => setValorSelecionado(e.target.value)} 
                                        placeholder="0.00"
                                    />
                                </div>
                            </div>
                        ) : (
                            /* SE FOR NORMAL, MANTÉM VISUALIZAÇÃO APENAS */
                            parseFloat(valorSelecionado) > 0 && (
                                <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-xl flex items-center justify-between border border-blue-100 dark:border-blue-800">
                                    <div className="font-bold text-sm text-blue-700 dark:text-blue-300">
                                        Valor da Consulta
                                    </div>
                                    <div className="text-xl font-bold text-blue-800 dark:text-white">
                                        R$ {Number(valorSelecionado).toFixed(2)}
                                    </div>
                                </div>
                            )
                        )}

                        <div>
                            <div className="flex justify-between items-center mb-1">
                                <label className="block text-sm font-bold text-slate-700 dark:text-slate-300">Paciente</label>
                                <button onClick={() => setModalPacienteOpen(true)} className="text-xs text-blue-600 hover:underline font-bold flex items-center gap-1"><UserPlus size={14}/> Novo Cadastro</button>
                            </div>
                            <SearchableSelect label="" options={pacientes} value={pacienteId} onChange={setPacienteId} placeholder="Pesquisar..." />
                        </div>
                        <SearchableSelect label="Convênio (Opcional)" options={convenios} value={convenioId} onChange={setConvenioId} placeholder="Particular..." />
                        {tipoModal === 'encaixe' && <div><label className="block text-sm font-bold mb-1">Horário</label><input type="time" className="w-full border p-3 rounded-lg dark:bg-slate-900 dark:text-white" value={encaixeHora} onChange={e => setEncaixeHora(e.target.value)} /></div>}
                        <textarea placeholder="Observações..." className="w-full border p-3 rounded-lg h-24 dark:bg-slate-900 dark:text-white" value={observacao} onChange={e => setObservacao(e.target.value)}></textarea>
                        <button onClick={salvarAgendamento} disabled={loadingSave} className="w-full py-4 bg-green-600 text-white rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2">
                            {loadingSave ? <Loader2 className="animate-spin" /> : <Save size={20}/>} {agendamentoIdEditar ? 'Salvar Alterações' : 'Confirmar'}
                        </button>
                    </div>
                </div>
            </div>
        )}

        {/* MODAL DE NOVO PACIENTE (MANTIDO) */}
        {modalPacienteOpen && (
            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/70 p-4 overflow-y-auto">
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-4xl animate-in fade-in zoom-in duration-200 my-10">
                    <div className="bg-slate-800 p-5 text-white flex justify-between items-center rounded-t-2xl"><h3 className="font-bold flex items-center gap-2 text-lg"><UserPlus size={20}/> Novo Paciente</h3><button onClick={() => setModalPacienteOpen(false)} className="text-slate-400 hover:text-white"><X size={24}/></button></div>
                    <form onSubmit={salvarPacienteCompleto} className="p-6">
                        <div className="grid grid-cols-1 md:grid-cols-12 gap-4">
                            <div className="md:col-span-12 border-b pb-2 mb-2 font-bold text-slate-700 dark:text-white uppercase text-xs tracking-wider">Dados Pessoais</div>
                            <div className="md:col-span-6"><label className="block text-xs mb-1">Nome Completo</label><input name="nome" required value={novoPaciente.nome} onChange={handlePacienteChange} className={inputClass} /></div>
                            <div className="md:col-span-3"><label className="block text-xs mb-1">CPF</label><input name="cpf" required value={novoPaciente.cpf} onChange={handlePacienteChange} className={inputClass} placeholder="000.000.000-00"/></div>
                            <div className="md:col-span-3"><label className="block text-xs mb-1">Sexo</label><select name="sexo" value={novoPaciente.sexo} onChange={handlePacienteChange} className={inputClass}><option value="">Selecione...</option><option value="Feminino">Feminino</option><option value="Masculino">Masculino</option><option value="Outro">Outro</option></select></div>
                            <div className="md:col-span-3"><label className="block text-xs mb-1">Nascimento</label><input type="date" name="data_nascimento" required value={novoPaciente.data_nascimento} onChange={handlePacienteChange} className={inputClass} /></div>
                            <div className="md:col-span-3"><label className="block text-xs mb-1">Telefone</label><input name="telefone" value={novoPaciente.telefone} onChange={handlePacienteChange} className={inputClass} placeholder="(00) 00000-0000"/></div>
                            <div className="md:col-span-6"><label className="block text-xs mb-1">Nome da Mãe</label><input name="nome_mae" value={novoPaciente.nome_mae} onChange={handlePacienteChange} className={inputClass} /></div>
                            <div className="md:col-span-12 border-b pb-2 mb-2 mt-4 font-bold text-slate-700 dark:text-white flex items-center gap-2 uppercase text-xs tracking-wider"><MapPin size={16}/> Endereço</div>
                            <div className="md:col-span-3"><label className="block text-xs mb-1">CEP {loadingCep && <Loader2 size={12} className="inline animate-spin text-blue-500"/>}</label><input name="cep" value={novoPaciente.cep} onChange={handlePacienteChange} onBlur={buscarCep} className={inputClass} placeholder="00000-000"/></div>
                            <div className="md:col-span-7"><label className="block text-xs mb-1">Logradouro</label><input name="logradouro" value={novoPaciente.logradouro} onChange={handlePacienteChange} className={inputClass} /></div>
                            <div className="md:col-span-2"><label className="block text-xs mb-1">Número</label><input id="modal-numero" name="numero" value={novoPaciente.numero} onChange={handlePacienteChange} className={inputClass} /></div>
                            <div className="md:col-span-4"><label className="block text-xs mb-1">Complemento</label><input name="complemento" value={novoPaciente.complemento} onChange={handlePacienteChange} className={inputClass} placeholder="Apto, Bloco..."/></div>
                            <div className="md:col-span-4"><label className="block text-xs mb-1">Bairro</label><input name="bairro" value={novoPaciente.bairro} onChange={handlePacienteChange} className={inputClass} /></div>
                            <div className="md:col-span-3"><label className="block text-xs mb-1">Cidade</label><input name="cidade" value={novoPaciente.cidade} onChange={handlePacienteChange} className={inputClass} /></div>
                            <div className="md:col-span-1"><label className="block text-xs mb-1">UF</label><input name="estado" value={novoPaciente.estado} onChange={handlePacienteChange} className={inputClass} maxLength={2} style={{textTransform:'uppercase'}}/></div>
                        </div>
                        <div className="pt-8 flex gap-3 justify-end">
                            <button type="button" onClick={() => setModalPacienteOpen(false)} className="px-6 py-2.5 bg-slate-100 text-slate-600 font-bold rounded-lg hover:bg-slate-200">Cancelar</button>
                            <button type="submit" className="px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"><Save size={18}/> Salvar e Usar</button>
                        </div>
                    </form>
                </div>
            </div>
        )}
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front\src\pages\Operadores.jsx
============================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNavigate } from 'react-router-dom';
import Layout from '../components/Layout';
import { Search, UserCog, Plus, ChevronLeft, ChevronRight, Pencil, Trash2 } from 'lucide-react';

export default function Operadores() {
  const { api } = useAuth();
  const navigate = useNavigate();
  
  const [operadores, setOperadores] = useState([]);
  const [search, setSearch] = useState('');
  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);

  const fetchOperadores = async () => {
    try {
        let pageSize = 15;
        try {
            const conf = await api.get('operadores/config/');
            if (conf.data?.itens_por_pagina) pageSize = conf.data.itens_por_pagina;
        } catch {}

        const res = await api.get(`operadores/listar/?page=${page}&page_size=${pageSize}&search=${search}`);
        const lista = res.data.results || res.data;
        
        if (Array.isArray(lista)) {
            setOperadores(lista);
            setTotalPages(res.data.count ? Math.ceil(res.data.count / pageSize) : 1);
        } else {
            setOperadores([]);
        }
    } catch (e) { setOperadores([]); }
  };

  useEffect(() => { if (api) fetchOperadores(); }, [page, search, api]);

  const handleExcluir = async (id) => {
    if (confirm('Tem certeza que deseja excluir?')) {
        try {
            await api.delete(`operadores/${id}/`);
            fetchOperadores();
        } catch (error) { alert('Erro ao excluir.'); }
    }
  };

  // CLASSE DOS BOTÕES DE PAGINAÇÃO (Branco no claro, Escuro no dark)
  const paginationBtnClass = "p-2 border rounded-lg transition-colors disabled:opacity-50 bg-white border-slate-200 text-slate-600 hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-700";

  return (
    <Layout>
      <div className="max-w-6xl mx-auto">
        <div className="flex justify-between items-center mb-8">
          <div className="flex items-center space-x-3">
            <div className="bg-blue-600 p-3 rounded-xl text-white shadow"><UserCog size={28}/></div>
            <div>
                <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Operadores</h1>
                <p className="text-slate-500 dark:text-slate-400 text-sm">Gerencie o acesso ao sistema.</p>
            </div>
          </div>
          <button onClick={() => navigate('/operadores/novo')} className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-md active:scale-95">
            <Plus size={20}/> Novo Operador
          </button>
        </div>

        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 mb-6">
            <div className="relative">
                <Search className="absolute left-3 top-3.5 text-slate-400" size={18} />
                <input placeholder="Buscar..." value={search} onChange={e => setSearch(e.target.value)} className="w-full pl-10 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 outline-none text-slate-700 dark:text-white"/>
            </div>
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
          <table className="w-full text-left">
            <thead className="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700">
              <tr>
                {/* COLUNAS SEPARADAS AGORA */}
                <th className="px-6 py-4">Nome</th>
                <th className="px-6 py-4">Email</th>
                <th className="px-6 py-4 text-center">Usuário</th>
                <th className="px-6 py-4 text-center">Tipo</th>
                <th className="px-6 py-4 text-right">Ações</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
              {operadores.map(op => (
                <tr key={op.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                    {/* DADOS SEPARADOS */}
                    <td className="px-6 py-4 font-bold text-slate-700 dark:text-white">
                        {op.first_name}
                    </td>
                    <td className="px-6 py-4 text-slate-500 dark:text-slate-400">
                        {op.email}
                    </td>
                    
                    <td className="px-6 py-4 text-center text-slate-600 dark:text-slate-300">{op.username}</td>
                    
                    <td className="px-6 py-4 text-center">
                        {op.is_superuser ? <span className="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded-full font-bold">ADMIN</span> : <span className="bg-slate-100 text-slate-500 text-xs px-2 py-1 rounded-full font-bold">OPERADOR</span>}
                    </td>
                    
                    <td className="px-6 py-4 text-right">
                        <div className="flex justify-end gap-2">
                            <button onClick={() => navigate(`/operadores/${op.id}`)} title="Editar" className="p-2 bg-transparent text-blue-600 hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-blue-900/30 rounded-lg transition-colors">
                                <Pencil size={18} />
                            </button>
                            <button onClick={() => handleExcluir(op.id)} title="Excluir" className="p-2 bg-transparent text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/30 rounded-lg transition-colors">
                                <Trash2 size={18} />
                            </button>
                        </div>
                    </td>
                </tr>
              ))}
            </tbody>
          </table>
          <div className="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center text-slate-500">
            <span>Página {page} de {totalPages}</span>
            <div className="flex gap-2">
                <button disabled={page===1} onClick={()=>setPage(p=>p-1)} className={paginationBtnClass}><ChevronLeft size={16}/></button>
                <button disabled={page===totalPages} onClick={()=>setPage(p=>p+1)} className={paginationBtnClass}><ChevronRight size={16}/></button>
            </div>
          </div>
        </div>
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front\src\pages\Pacientes.jsx
============================================================
import { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNotification } from '../context/NotificationContext';
import { 
  Search, UserPlus, MapPin, Pencil, Trash2, Save, ArrowLeft, ChevronLeft, ChevronRight, Loader2, User, Baby 
} from 'lucide-react';
import Layout from '../components/Layout';

export default function Pacientes() {
  const { api } = useAuth();
  const { notify, confirmDialog } = useNotification();
  
  const [viewMode, setViewMode] = useState('list');
  const [editandoId, setEditandoId] = useState(null);
  const [loading, setLoading] = useState(false);
  const [loadingCep, setLoadingCep] = useState(false);

  const [pacientes, setPacientes] = useState([]);
  const [search, setSearch] = useState('');
  const [page, setPage] = useState(1);
  const [totalPages, setTotalPages] = useState(1);
  const [totalCount, setTotalCount] = useState(0);

  // ADICIONADOS: nome_mae e sexo
  const formInicial = {
    nome: '', nome_mae: '', sexo: '', cpf: '', data_nascimento: '', telefone: '',
    cep: '', logradouro: '', numero: '', complemento: '', bairro: '', cidade: '', estado: ''
  };
  const [form, setForm] = useState(formInicial);

  const mascaraCPF = (v) => v.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})/, '$1-$2').slice(0, 14);
  const mascaraTelefone = (v) => v.replace(/\D/g, '').replace(/(\d{2})(\d)/, '($1) $2').replace(/(\d{5})(\d)/, '$1-$2').slice(0, 15);
  const mascaraCEP = (v) => v.replace(/\D/g, '').replace(/(\d{5})(\d)/, '$1-$2').slice(0, 9);

  const handleChange = (e) => {
    let { name, value } = e.target;
    if (name === 'cpf') value = mascaraCPF(value);
    if (name === 'telefone') value = mascaraTelefone(value);
    if (name === 'cep') value = mascaraCEP(value);
    setForm({ ...form, [name]: value });
  };

  const fetchPacientes = async () => {
    if (!api) return;
    setLoading(true);
    try {
      let pageSize = 15;
      try {
        const configRes = await api.get('operadores/config/');
        if (configRes.data?.itens_por_pagina) pageSize = configRes.data.itens_por_pagina;
      } catch {}

      const { data } = await api.get(`pacientes/?page=${page}&page_size=${pageSize}&search=${search}`);
      
      if (data.results) {
        setPacientes(data.results);
        setTotalCount(data.count);
        setTotalPages(Math.ceil(data.count / pageSize));
      } else if (Array.isArray(data)) {
        setPacientes(data);
        setTotalCount(data.length);
        setTotalPages(1);
      } else {
        setPacientes([]);
        setTotalCount(0);
      }
    } catch (error) {
      setPacientes([]);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { fetchPacientes(); }, [page, search, api]);

  const buscarCep = async () => {
    const cepLimpo = form.cep.replace(/\D/g, '');
    if (cepLimpo.length !== 8) return;
    setLoadingCep(true);
    try {
      const response = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
      const data = await response.json();
      if (!data.erro) {
        setForm(prev => ({ ...prev, logradouro: data.logradouro, bairro: data.bairro, cidade: data.localidade, estado: data.uf }));
        document.getElementById('numero')?.focus();
      }
    } catch {} finally { setLoadingCep(false); }
  };

  const handleNovo = () => { setForm(formInicial); setEditandoId(null); setViewMode('form'); };
  const handleEditar = (p) => { 
      // Garante que campos novos não sejam null
      setForm({
          ...p,
          nome_mae: p.nome_mae || '',
          sexo: p.sexo || '',
          complemento: p.complemento || ''
      }); 
      setEditandoId(p.id); 
      setViewMode('form'); 
  };
  
  const handleVoltar = () => { 
    setViewMode('list'); 
    setForm(formInicial); 
    fetchPacientes(); 
  };

  const handleExcluir = async (id) => {
    const confirmado = await confirmDialog("Tem certeza que deseja excluir este paciente?", "Excluir Paciente");
    if (confirmado) {
      try { 
        await api.delete(`pacientes/${id}/`); 
        notify.success("Paciente excluído.");
        fetchPacientes(); 
      } 
      catch (e) { notify.error("Erro ao excluir. Verifique vínculos."); }
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      if (editandoId) {
        await api.put(`pacientes/${editandoId}/`, form);
        notify.success("Paciente atualizado!");
      } else {
        await api.post('pacientes/', form);
        notify.success("Paciente cadastrado!");
      }
      handleVoltar();
    } catch (error) { 
        if (error.response?.data?.cpf) notify.warning("Este CPF já existe!");
        else notify.error("Erro ao salvar."); 
    }
  };

  const inputClass = "w-full bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-white border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none transition-colors";
  const labelClass = "block text-sm font-bold text-slate-600 dark:text-slate-300 mb-1";
  const paginationBtnClass = "p-2 border rounded-lg transition-colors disabled:opacity-50 bg-white border-slate-200 text-slate-600 hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-700";

  return (
    <Layout>
      <div className="max-w-6xl mx-auto pb-20">
        {viewMode === 'list' && (
          <div className="animate-in fade-in duration-300">
            <div className="flex justify-between items-center mb-8">
              <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Pacientes</h1>
              <button onClick={handleNovo} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-md transition-all active:scale-95">
                <UserPlus size={20}/> Incluir Paciente
              </button>
            </div>

            <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border mb-6 border-slate-200 dark:border-slate-700">
              <div className="relative">
                <Search className="absolute left-3 top-3.5 text-slate-400" size={18} />
                <input 
                    placeholder="Pesquisar por nome ou CPF..." 
                    value={search} 
                    onChange={e => { setSearch(e.target.value); setPage(1); }} 
                    className="w-full pl-10 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 outline-none text-slate-700 dark:text-white transition-colors focus:border-blue-500"
                />
              </div>
            </div>

            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
              <div className="overflow-x-auto">
                  <table className="w-full text-left text-sm">
                    <thead className="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-300 border-b border-slate-200 dark:border-slate-700">
                      <tr>
                          <th className="px-6 py-4 font-bold uppercase">Nome</th>
                          <th className="px-6 py-4 font-bold uppercase">Sexo</th>
                          <th className="px-6 py-4 font-bold uppercase">CPF</th>
                          <th className="px-6 py-4 font-bold uppercase">Cidade/UF</th>
                          <th className="px-6 py-4 text-right font-bold uppercase">Ações</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                      {loading ? (
                          <tr><td colSpan="5" className="p-8 text-center text-slate-400"><Loader2 className="animate-spin mx-auto mb-2"/> Carregando...</td></tr>
                      ) : pacientes.length === 0 ? (
                          <tr><td colSpan="5" className="p-8 text-center text-slate-400">Nenhum paciente encontrado.</td></tr>
                      ) : (
                          pacientes.map(p => (
                            <tr key={p.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition-colors">
                              <td className="px-6 py-4 font-bold text-slate-700 dark:text-white">
                                  {p.nome}
                                  <div className="text-xs text-slate-400 font-normal">{p.nome_mae ? `Mãe: ${p.nome_mae}` : ''}</div>
                              </td>
                              <td className="px-6 py-4 text-slate-500 dark:text-slate-400">{p.sexo || '-'}</td>
                              <td className="px-6 py-4 text-slate-500 dark:text-slate-400">{p.cpf}</td>
                              <td className="px-6 py-4 text-slate-500 dark:text-slate-400">{p.cidade && p.estado ? `${p.cidade}/${p.estado}` : '-'}</td>
                              <td className="px-6 py-4 text-right flex justify-end gap-2">
                                <button onClick={() => handleEditar(p)} className="p-2 bg-transparent text-blue-600 hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-blue-900/30 rounded-lg"><Pencil size={18} /></button>
                                <button onClick={() => handleExcluir(p.id)} className="p-2 bg-transparent text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/30 rounded-lg"><Trash2 size={18} /></button>
                              </td>
                            </tr>
                          ))
                      )}
                    </tbody>
                  </table>
              </div>
              
              {totalPages > 1 && (
                  <div className="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center text-slate-500 text-xs font-bold uppercase">
                    <span>Página {page} de {totalPages}</span>
                    <div className="flex gap-2">
                      <button disabled={page===1} onClick={()=>setPage(p=>p-1)} className={paginationBtnClass}><ChevronLeft size={16}/></button>
                      <button disabled={page===totalPages} onClick={()=>setPage(p=>p+1)} className={paginationBtnClass}><ChevronRight size={16}/></button>
                    </div>
                  </div>
              )}
            </div>
          </div>
        )}

        {viewMode === 'form' && (
          <div className="animate-in slide-in-from-right-4 duration-300">
            <button onClick={handleVoltar} className="mb-6 flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors shadow-sm text-sm font-bold w-fit">
                <ArrowLeft size={18}/> Voltar para Lista
            </button>
            <div className={`rounded-xl shadow-lg border p-8 ${editandoId ? 'bg-white dark:bg-slate-800 border-orange-200 dark:border-orange-900/30' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700'}`}>
              <h2 className="text-xl font-bold mb-6 text-slate-800 dark:text-white flex items-center gap-2">
                  {editandoId ? <><Pencil className="text-orange-500"/> Editar Paciente</> : <><UserPlus className="text-blue-500"/> Novo Paciente</>}
              </h2>
              <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-12 gap-6">
                
                {/* DADOS PESSOAIS */}
                <div className="md:col-span-12 border-b pb-2 mb-2 font-bold text-slate-700 dark:text-white flex items-center gap-2"><User size={18}/> Dados Pessoais</div>
                
                <div className="md:col-span-6"><label className={labelClass}>Nome Completo</label><input name="nome" value={form.nome} onChange={handleChange} className={inputClass} required /></div>
                <div className="md:col-span-3"><label className={labelClass}>CPF</label><input name="cpf" value={form.cpf} onChange={handleChange} className={inputClass} required placeholder="000.000.000-00"/></div>
                <div className="md:col-span-3">
                    <label className={labelClass}>Sexo</label>
                    <select name="sexo" value={form.sexo} onChange={handleChange} className={inputClass}>
                        <option value="">Selecione...</option>
                        <option value="Feminino">Feminino</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                
                <div className="md:col-span-3"><label className={labelClass}>Nascimento</label><input type="date" name="data_nascimento" value={form.data_nascimento} onChange={handleChange} className={inputClass} required /></div>
                <div className="md:col-span-3"><label className={labelClass}>Telefone</label><input name="telefone" value={form.telefone} onChange={handleChange} className={inputClass} placeholder="(00) 00000-0000"/></div>
                <div className="md:col-span-6"><label className={labelClass}>Nome da Mãe</label><input name="nome_mae" value={form.nome_mae} onChange={handleChange} className={inputClass} /></div>

                {/* ENDEREÇO */}
                <div className="md:col-span-12 border-b pb-2 mb-2 font-bold text-slate-700 dark:text-white flex items-center gap-2 mt-4">
                    <MapPin size={18}/> Endereço
                </div>
                
                <div className="md:col-span-3">
                    <label className={labelClass}>CEP {loadingCep && <Loader2 size={12} className="inline animate-spin text-blue-500"/>}</label>
                    <input name="cep" value={form.cep} onChange={handleChange} onBlur={buscarCep} className={inputClass} placeholder="00000-000"/>
                </div>
                <div className="md:col-span-7"><label className={labelClass}>Logradouro</label><input name="logradouro" value={form.logradouro} onChange={handleChange} className={inputClass} /></div>
                <div className="md:col-span-2"><label className={labelClass}>Número</label><input id="numero" name="numero" value={form.numero} onChange={handleChange} className={inputClass} /></div>
                <div className="md:col-span-4"><label className={labelClass}>Complemento</label><input name="complemento" value={form.complemento || ''} onChange={handleChange} className={inputClass} placeholder="Apto, Bloco..." /></div>
                <div className="md:col-span-4"><label className={labelClass}>Bairro</label><input name="bairro" value={form.bairro} onChange={handleChange} className={inputClass} /></div>
                <div className="md:col-span-3"><label className={labelClass}>Cidade</label><input name="cidade" value={form.cidade} onChange={handleChange} className={inputClass} /></div>
                <div className="md:col-span-1"><label className={labelClass}>UF</label><input name="estado" value={form.estado} onChange={handleChange} className={inputClass} maxLength={2} style={{textTransform:'uppercase'}}/></div>
                
                <div className="md:col-span-12 flex justify-end mt-6 gap-3 border-t pt-6 dark:border-slate-700">
                  <button type="button" onClick={handleVoltar} className="px-6 py-2.5 rounded-lg bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold transition-colors hover:bg-slate-200">Cancelar</button>
                  <button className={`text-white font-bold px-8 py-2.5 rounded-lg shadow-lg flex items-center gap-2 transition-transform active:scale-95 ${editandoId ? 'bg-orange-600 hover:bg-orange-700' : 'bg-blue-600 hover:bg-blue-700'}`}>
                    <Save size={18} /> {editandoId ? 'Salvar Alterações' : 'Cadastrar Paciente'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front\src\pages\Profissionais.jsx
============================================================
import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import Layout from '../components/Layout';
import { useNavigate } from 'react-router-dom';
import { Search, UserPlus, Pencil, Trash2, Stethoscope } from 'lucide-react';

export default function Profissionais() {
  const { api } = useAuth();
  const navigate = useNavigate();
  const [profissionais, setProfissionais] = useState([]);
  const [search, setSearch] = useState('');

  // --- FUNÇÃO AUXILIAR PARA FORMATAR O CPF NA TELA ---
  const formatCPF = (cpf) => {
    if (!cpf) return '';
    const v = cpf.replace(/\D/g, ''); // Remove tudo que não é dígito
    return v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
  };

  useEffect(() => {
    if(api) api.get(`profissionais/?search=${search}`).then(res => setProfissionais(res.data.results || res.data));
  }, [api, search]);

  const handleExcluir = async (id) => {
    if(confirm("Excluir profissional?")) {
        await api.delete(`profissionais/${id}/`);
        setProfissionais(prev => prev.filter(p => p.id !== id));
    }
  }

  const actionBtnClass = "p-2 bg-transparent rounded-lg transition-colors";
  const editBtnClass = `${actionBtnClass} text-blue-600 hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-blue-900/30`;
  const deleteBtnClass = `${actionBtnClass} text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/30`;

  return (
    <Layout>
      <div className="max-w-6xl mx-auto">
        <div className="flex justify-between items-center mb-6">
            <h1 className="text-2xl font-bold text-slate-800 dark:text-white flex gap-2"><Stethoscope/> Profissionais</h1>
            <button onClick={()=>navigate('/profissionais/novo')} className="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold flex gap-2"><UserPlus size={20}/> Novo Profissional</button>
        </div>

        <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border mb-6 border-slate-200 dark:border-slate-700 relative">
            <Search className="absolute left-7 top-7 text-slate-400" size={18} />
            <input placeholder="Buscar por nome ou CPF..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full pl-10 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 outline-none dark:text-white"/>
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
            <table className="w-full text-left">
                <thead className="bg-slate-50 dark:bg-slate-700/50 text-slate-500 dark:text-slate-300">
                    <tr><th className="px-6 py-4">Nome</th><th className="px-6 py-4">Especialidades</th><th className="px-6 py-4 text-right">Ações</th></tr>
                </thead>
                <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                    {profissionais.map(p => (
                        <tr key={p.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30">
                            <td className="px-6 py-4 font-medium text-slate-700 dark:text-white">
                                {p.nome}
                                <br/>
                                {/* APLICAÇÃO DA MÁSCARA AQUI */}
                                <span className="text-xs text-slate-400">{formatCPF(p.cpf)}</span>
                            </td>
                            <td className="px-6 py-4">
                                <div className="flex flex-col gap-1">
                                    {p.especialidades.map((esp, i) => (
                                        <span key={i} className="text-sm text-slate-600 dark:text-slate-300 flex items-center gap-2">
                                            <span className="font-semibold text-blue-600 dark:text-blue-400">
                                                {esp.nome_especialidade}
                                            </span>
                                            <span className="text-xs bg-slate-100 dark:bg-slate-700 px-2 py-0.5 rounded border border-slate-200 dark:border-slate-600">
                                                {esp.sigla_conselho}/{esp.uf_conselho}-{esp.registro_conselho}
                                            </span>
                                        </span>
                                    ))}
                                </div>
                            </td>
                            <td className="px-6 py-4 text-right flex justify-end gap-2">
                                <button onClick={()=>navigate(`/profissionais/${p.id}`)} className={editBtnClass}><Pencil size={18}/></button>
                                <button onClick={()=>handleExcluir(p.id)} className={deleteBtnClass}><Trash2 size={18}/></button>
                            </td>
                        </tr>
                    ))}
                    {profissionais.length === 0 && <tr><td colSpan="3" className="p-8 text-center text-slate-400">Nenhum profissional encontrado.</td></tr>}
                </tbody>
            </table>
        </div>
      </div>
    </Layout>
  );
}

============================================================
ARQUIVO: clinica-front\src\pages\ProfissionaisForm.jsx
============================================================
import React, { useState, useEffect } from 'react';
import { useAuth } from '../context/AuthContext';
import Layout from '../components/Layout';
import { useNavigate, useParams } from 'react-router-dom';
import { Save, ArrowLeft, Plus, Trash2, BriefcaseMedical } from 'lucide-react';

export default function ProfissionalForm() {
  const { api } = useAuth();
  const navigate = useNavigate();
  const { id } = useParams();
  
  const [formData, setFormData] = useState({ nome: '', cpf: '', data_nascimento: '' });
  
  const [items, setItems] = useState([]); 
  const [listaEspecialidades, setListaEspecialidades] = useState([]);
  const [loading, setLoading] = useState(false);

  // --- MÁSCARA DE CPF PARA INPUT ---
  const mascaraCPF = (value) => {
    return value
      .replace(/\D/g, '') // Remove tudo o que não é dígito
      .replace(/(\d{3})(\d)/, '$1.$2') // Coloca ponto entre o 3º e o 4º
      .replace(/(\d{3})(\d)/, '$1.$2') // Coloca ponto entre o 6º e o 7º
      .replace(/(\d{3})(\d{1,2})/, '$1-$2') // Coloca traço entre o 9º e o 10º
      .replace(/(-\d{2})\d+?$/, '$1'); // Impede digitar mais que isso
  };

  useEffect(() => {
    if(api) {
        api.get('especialidades/').then(res => setListaEspecialidades(res.data.results || res.data));
        
        if (id) {
            api.get(`profissionais/${id}/`).then(res => {
                setFormData({ nome: res.data.nome, cpf: res.data.cpf, data_nascimento: res.data.data_nascimento });
                setItems(res.data.especialidades);
            });
        }
    }
  }, [id, api]);

  const handleAddItem = () => {
    setItems([...items, { especialidade_id: '', sigla_conselho: '', registro_conselho: '', uf_conselho: 'SP' }]);
  };

  const handleRemoveItem = (index) => setItems(items.filter((_, i) => i !== index));
  
  const handleItemChange = (index, field, value) => {
    const newItems = [...items];
    newItems[index][field] = value;
    setItems(newItems);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    // Removemos a máscara antes de salvar para garantir que vá limpo pro banco (opcional, mas recomendado)
    // Se seu backend espera COM pontuação, remova o .replace(/\D/g, '') abaixo
    const cpfLimpo = formData.cpf.replace(/\D/g, ''); 
    const payload = { ...formData, cpf: cpfLimpo, especialidades: items };
    
    try {
        if(id) await api.put(`profissionais/${id}/`, payload);
        else await api.post('profissionais/', payload);
        alert('Salvo com sucesso!');
        navigate('/profissionais');
    } catch (e) { alert('Erro ao salvar.'); }
    finally { setLoading(false); }
  };

  const inputClass = "w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 text-sm";
  const labelClass = "block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1";
  const subLabelClass = "text-xs text-slate-500 mb-1 block";

  return (
    <Layout>
      <div className="max-w-5xl mx-auto">
        <button 
            onClick={()=>navigate('/profissionais')} 
            className="mb-4 flex items-center gap-2 text-slate-500 hover:text-slate-800 dark:text-slate-400 bg-transparent hover:bg-slate-100 dark:hover:bg-slate-800 px-3 py-2 rounded-lg transition-colors"
        >
            <ArrowLeft size={18}/> Voltar
        </button>

        <h1 className="text-2xl font-bold mb-6 text-slate-800 dark:text-white">{id ? 'Editar' : 'Novo'} Profissional</h1>

        <form onSubmit={handleSubmit} className="space-y-6">
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                <h2 className="font-bold text-lg mb-4 text-slate-800 dark:text-white">Dados Pessoais</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="md:col-span-2">
                        <label className={labelClass}>Nome Completo</label>
                        <input required value={formData.nome} onChange={e=>setFormData({...formData, nome:e.target.value})} className={inputClass}/>
                    </div>
                    <div>
                        <label className={labelClass}>CPF</label>
                        {/* INPUT DE CPF COM MÁSCARA */}
                        <input 
                            required 
                            placeholder="000.000.000-00" 
                            value={formData.cpf} 
                            onChange={e => setFormData({ ...formData, cpf: mascaraCPF(e.target.value) })} 
                            className={inputClass}
                            maxLength={14}
                        />
                    </div>
                    <div>
                        <label className={labelClass}>Data Nascimento</label>
                        <input required type="date" value={formData.data_nascimento} onChange={e=>setFormData({...formData, data_nascimento:e.target.value})} className={inputClass}/>
                    </div>
                </div>
            </div>

            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                <div className="flex justify-between items-center mb-4">
                    <h2 className="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2"><BriefcaseMedical size={20}/> Especialidades e Conselhos</h2>
                    
                    <button 
                        type="button" 
                        onClick={handleAddItem} 
                        className="text-sm font-bold text-blue-600 flex items-center gap-1 hover:bg-blue-50 dark:hover:bg-blue-900/20 px-3 py-2 rounded-lg transition-colors bg-transparent"
                    >
                        <Plus size={16}/> Adicionar Especialidade
                    </button>
                </div>

                {items.length === 0 && <div className="text-center p-4 text-slate-400 border border-dashed rounded-lg">Nenhuma especialidade vinculada. Clique em Adicionar.</div>}

                <div className="space-y-3">
                    {items.map((item, index) => (
                        <div key={index} className="flex flex-col md:flex-row gap-3 items-end bg-slate-50 dark:bg-slate-900/50 p-4 rounded-lg border border-slate-100 dark:border-slate-700 animate-in fade-in zoom-in duration-300">
                            
                            <div className="flex-[2] w-full min-w-[200px]">
                                <label className={subLabelClass}>Especialidade</label>
                                <select required value={item.especialidade_id} onChange={e=>handleItemChange(index, 'especialidade_id', e.target.value)} className={inputClass}>
                                    <option value="">Selecione...</option>
                                    {listaEspecialidades.map(esp => <option key={esp.id} value={esp.id}>{esp.nome}</option>)}
                                </select>
                            </div>

                            <div className="flex-1 w-full min-w-[100px]">
                                <label className={subLabelClass}>Sigla Conselho</label>
                                <input required value={item.sigla_conselho} onChange={e=>handleItemChange(index, 'sigla_conselho', e.target.value)} className={inputClass} placeholder="Ex: CRM" style={{textTransform: 'uppercase'}}/>
                            </div>

                            <div className="flex-1 w-full min-w-[120px]">
                                <label className={subLabelClass}>Nº Registro</label>
                                <input required value={item.registro_conselho} onChange={e=>handleItemChange(index, 'registro_conselho', e.target.value)} className={inputClass} placeholder="123456"/>
                            </div>

                            <div className="w-full md:w-20">
                                <label className={subLabelClass}>UF</label>
                                <input required value={item.uf_conselho} onChange={e=>handleItemChange(index, 'uf_conselho', e.target.value)} className={inputClass} placeholder="SP" maxLength={2} style={{textTransform: 'uppercase'}}/>
                            </div>

                            <button type="button" onClick={()=>handleRemoveItem(index)} className="p-2.5 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors bg-transparent" title="Remover">
                                <Trash2 size={18}/>
                            </button>
                        </div>
                    ))}
                </div>
            </div>

            <div className="flex justify-end">
                <button disabled={loading} className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg transition-all active:scale-95">
                    {loading ? 'Salvando...' : <><Save size={20}/> Salvar Profissional</>}
                </button>
            </div>
        </form>
      </div>
    </Layout>
  );
}   

============================================================
ARQUIVO: clinica-front\src\pages\TrocarSenhaObrigatoria.jsx
============================================================
import { useState } from 'react';
import { useAuth } from '../context/AuthContext';
import { useNavigate } from 'react-router-dom';
import { KeyRound } from 'lucide-react';

export default function TrocarSenhaObrigatoria() {
  const { api, logout } = useAuth();
  const [senha, setSenha] = useState('');
  const [confirmar, setConfirmar] = useState('');
  const [loading, setLoading] = useState(false);
  const navigate = useNavigate();

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (senha !== confirmar) return alert('Senhas não conferem.');
    if (senha.length < 6) return alert('Mínimo 6 caracteres.');
    setLoading(true);
    try {
      await api.post('operadores/trocar-senha/', { nova_senha: senha });
      alert('Sucesso! Entre novamente.');
      logout();
      navigate('/');
    } catch (e) { alert('Erro ao alterar.'); } 
    finally { setLoading(false); }
  };

  return (
    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
      <div className="bg-white max-w-md w-full rounded-2xl shadow-xl overflow-hidden border border-slate-200 p-8">
        <div className="text-center mb-6">
            <KeyRound size={40} className="text-orange-600 mx-auto mb-2" />
            <h1 className="text-xl font-bold text-slate-800">Troca de Senha Obrigatória</h1>
        </div>
        <form onSubmit={handleSubmit} className="space-y-4">
            <input type="password" value={senha} onChange={e => setSenha(e.target.value)} className="w-full border p-3 rounded" placeholder="Nova Senha" required/>
            <input type="password" value={confirmar} onChange={e => setConfirmar(e.target.value)} className="w-full border p-3 rounded" placeholder="Confirmar Senha" required/>
            <button disabled={loading} className="w-full bg-slate-800 text-white font-bold py-3 rounded">{loading ? '...' : 'Atualizar Senha'}</button>
            <button type="button" onClick={()=>{logout(); navigate('/')}} className="w-full text-sm text-slate-400">Cancelar e Sair</button>
        </form>
      </div>
    </div>
  );
}

============================================================
ARQUIVO: clinica_core\asgi.py
============================================================
"""
ASGI config for clinica_core project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'clinica_core.settings')

application = get_asgi_application()


============================================================
ARQUIVO: clinica_core\settings.py
============================================================
"""
Django settings for clinica_core project.

Generated by 'django-admin startproject' using Django 6.0.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/6.0/ref/settings/
"""

from pathlib import Path
from datetime import timedelta

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/6.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-4$hry#!6n)m+l*gtzm^$iply^@5=7--+mo%9+&(&s0=rlo(jdj'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'rest_framework_simplejwt',
    'corsheaders',
    'usuarios',
    'pacientes',
    'profissionais',
    'agendamento',
    'agendas',
    'configuracoes',
]

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    )
}

CORS_ALLOWED_ORIGINS = [
    "http://localhost:5173",
    "http://localhost:3000",
]

ROOT_URLCONF = 'clinica_core.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'clinica_core.wsgi.application'


# Database
# https://docs.djangoproject.com/en/6.0/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/6.0/ref/settings/#auth-password-validators


AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/6.0/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/6.0/howto/static-files/

STATIC_URL = 'static/'


REST_FRAMEWORK = {
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 15,
    'DEFAULT_FILTER_BACKENDS': ['rest_framework.filters.SearchFilter', 'rest_framework.filters.OrderingFilter'],
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ),
    'DEFAULT_PERMISSION_CLASSES': (
        'rest_framework.permissions.IsAuthenticated',
    ),
}

# --- CONFIGURAÇÃO JWT (Aumentando o tempo de login) ---
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=120),  # O login vai durar 2 horas direto
    'REFRESH_TOKEN_LIFETIME': timedelta(days=1),      # O sistema pode renovar por 1 dia
    'ROTATE_REFRESH_TOKENS': False,
    'BLACKLIST_AFTER_ROTATION': True,
    'UPDATE_LAST_LOGIN': False,

    'ALGORITHM': 'HS256',
    'SIGNING_KEY': SECRET_KEY,
    'VERIFYING_KEY': None,
    'AUDIENCE': None,
    'ISSUER': None,
    'JWK_URL': None,
    'LEEWAY': 0,

    'AUTH_HEADER_TYPES': ('Bearer',),
    'AUTH_HEADER_NAME': 'HTTP_AUTHORIZATION',
    'USER_ID_FIELD': 'id',
    'USER_ID_CLAIM': 'user_id',
    'USER_AUTHENTICATION_RULE': 'rest_framework_simplejwt.authentication.default_user_authentication_rule',

    'AUTH_TOKEN_CLASSES': ('rest_framework_simplejwt.tokens.AccessToken',),
    'TOKEN_TYPE_CLAIM': 'token_type',
    'TOKEN_USER_CLASS': 'rest_framework_simplejwt.models.TokenUser',

    'JTI_CLAIM': 'jti',
}

============================================================
ARQUIVO: clinica_core\urls.py
============================================================
from django.contrib import admin
from django.urls import path, include
from rest_framework_simplejwt.views import (
    TokenObtainPairView,
    TokenRefreshView,
)

# --- ADICIONE ESTA IMPORTAÇÃO ---
from usuarios.views import MeView

urlpatterns = [
    path('admin/', admin.site.urls),
    
    # Rotas de Autenticação (Login)
    path('api/token/', TokenObtainPairView.as_view(), name='token_obtain_pair'),
    path('api/token/refresh/', TokenRefreshView.as_view(), name='token_refresh'),
    
    # --- ROTA CORRIGIDA (Direta) ---
    # Aponta direto para a View, garantindo que o endereço seja exatamente /api/me/
    path('api/me/', MeView.as_view(), name='me'),

    # Rotas dos Módulos
    path('api/pacientes/', include('pacientes.urls')),
    
    # Rota para criar operadores (api/operadores/novo/)
    path('api/operadores/', include('usuarios.urls')), 

    path('api/', include('profissionais.urls')),

    path('api/configuracoes/', include('configuracoes.urls')),

    path('api/agendamento/', include('agendamento.urls')), # Marcação de consulta
    path('api/agendas/', include('agendas.urls')),
]

============================================================
ARQUIVO: clinica_core\wsgi.py
============================================================
"""
WSGI config for clinica_core project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'clinica_core.settings')

application = get_wsgi_application()


============================================================
ARQUIVO: clinica_core\__init__.py
============================================================


============================================================
ARQUIVO: configuracoes\admin.py
============================================================
from django.contrib import admin

# Register your models here.


============================================================
ARQUIVO: configuracoes\apps.py
============================================================
from django.apps import AppConfig


class ConfiguracoesConfig(AppConfig):
    name = 'configuracoes'


============================================================
ARQUIVO: configuracoes\models.py
============================================================
from django.db import models

class Convenio(models.Model):
    nome = models.CharField(max_length=100, unique=True)
    percentual_desconto = models.DecimalField(max_digits=5, decimal_places=2, default=0.00)
    ativo = models.BooleanField(default=True)

    def __str__(self):
        return self.nome
    
    class Meta:
        ordering = ['nome']

class DadosClinica(models.Model):
    nome_fantasia = models.CharField(max_length=255)
    razao_social = models.CharField(max_length=255, blank=True, null=True)
    cnpj = models.CharField(max_length=18, blank=True, null=True)
    telefone = models.CharField(max_length=20, blank=True, null=True)
    email = models.EmailField(blank=True, null=True)
    
    # Endereço
    logradouro = models.CharField(max_length=255, blank=True, null=True)
    numero = models.CharField(max_length=20, blank=True, null=True)
    complemento = models.CharField(max_length=100, blank=True, null=True) # <-- Novo campo
    bairro = models.CharField(max_length=100, blank=True, null=True)
    cidade = models.CharField(max_length=100, blank=True, null=True)
    estado = models.CharField(max_length=2, blank=True, null=True)
    cep = models.CharField(max_length=10, blank=True, null=True)

    def save(self, *args, **kwargs):
        self.pk = 1 # Garante que só exista um registro
        super().save(*args, **kwargs)

    @classmethod
    def load(cls):
        obj, created = cls.objects.get_or_create(pk=1, defaults={'nome_fantasia': 'Minha Clínica'})
        return obj

============================================================
ARQUIVO: configuracoes\serializers.py
============================================================
from rest_framework import serializers
from .models import Convenio, DadosClinica

class ConvenioSerializer(serializers.ModelSerializer):
    class Meta:
        model = Convenio
        fields = '__all__'

class DadosClinicaSerializer(serializers.ModelSerializer):
    class Meta:
        model = DadosClinica
        fields = '__all__'

============================================================
ARQUIVO: configuracoes\tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARQUIVO: configuracoes\urls.py
============================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import ConvenioViewSet, DadosClinicaView

router = DefaultRouter()
router.register(r'convenios', ConvenioViewSet)

urlpatterns = [
    path('', include(router.urls)),
    path('clinica/', DadosClinicaView.as_view()),
]

============================================================
ARQUIVO: configuracoes\views.py
============================================================
from rest_framework import viewsets, permissions, filters, status
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework_simplejwt.authentication import JWTAuthentication
from .models import Convenio, DadosClinica
from .serializers import ConvenioSerializer, DadosClinicaSerializer

class ConvenioViewSet(viewsets.ModelViewSet):
    queryset = Convenio.objects.all().order_by('nome')
    serializer_class = ConvenioSerializer
    # Garante que a API exija o login
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [filters.SearchFilter]
    search_fields = ['nome']

class DadosClinicaView(APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        dados = DadosClinica.load()
        return Response(DadosClinicaSerializer(dados).data)

    def put(self, request):
        dados = DadosClinica.load()
        serializer = DadosClinicaSerializer(dados, data=request.data)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

============================================================
ARQUIVO: configuracoes\__init__.py
============================================================


============================================================
ARQUIVO: pacientes\admin.py
============================================================
from django.contrib import admin

# Register your models here.


============================================================
ARQUIVO: pacientes\apps.py
============================================================
from django.apps import AppConfig


class PacientesConfig(AppConfig):
    name = 'pacientes'


============================================================
ARQUIVO: pacientes\models.py
============================================================
from django.db import models

class Paciente(models.Model):
    SEXO_CHOICES = [
        ('Feminino', 'Feminino'),
        ('Masculino', 'Masculino'),
        ('Outro', 'Outro'),
    ]

    nome = models.CharField(max_length=255)
    # Novo Campo
    nome_mae = models.CharField(max_length=255, blank=True, null=True, verbose_name="Nome da Mãe")
    # Novo Campo
    sexo = models.CharField(max_length=20, choices=SEXO_CHOICES, blank=True, null=True)
    
    cpf = models.CharField(max_length=14, unique=True)
    data_nascimento = models.DateField()
    telefone = models.CharField(max_length=20, blank=True)
    
    # Endereço
    cep = models.CharField(max_length=9, blank=True)
    logradouro = models.CharField(max_length=255, blank=True)
    numero = models.CharField(max_length=20, blank=True)
    complemento = models.CharField(max_length=100, blank=True, null=True)
    bairro = models.CharField(max_length=100, blank=True)
    cidade = models.CharField(max_length=100, blank=True)
    estado = models.CharField(max_length=2, blank=True)

    historico_medico = models.TextField(blank=True)
    criado_em = models.DateTimeField(auto_now_add=True)
    atualizado_em = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.nome} ({self.cpf})"

============================================================
ARQUIVO: pacientes\serializers.py
============================================================
from rest_framework import serializers
from .models import Paciente

class PacienteSerializer(serializers.ModelSerializer):
    class Meta:
        model = Paciente
        fields = '__all__'

============================================================
ARQUIVO: pacientes\tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARQUIVO: pacientes\urls.py
============================================================
from django.urls import path
from .views import PacienteListCreateView, PacienteDetailView

urlpatterns = [
    # Esta linha garante que /api/pacientes/ funcione para o POST/GET padrão
    path('', PacienteListCreateView.as_view(), name='pacientes-list-create'),
    
    # Esta linha atende ao erro 404 do seu log (MarcarConsulta.jsx:80)
    path('lista/', PacienteListCreateView.as_view(), name='pacientes-list'),
    
    path('<int:pk>/', PacienteDetailView.as_view(), name='paciente-detail'),
]

============================================================
ARQUIVO: pacientes\views.py
============================================================
from rest_framework import generics, permissions, filters
from rest_framework_simplejwt.authentication import JWTAuthentication # <--- IMPORTANTE
from .models import Paciente
from .serializers import PacienteSerializer

class PacienteListCreateView(generics.ListCreateAPIView):
    queryset = Paciente.objects.all().order_by('-criado_em')
    serializer_class = PacienteSerializer
    
    # --- BLINDAGEM DE SEGURANÇA ---
    authentication_classes = [JWTAuthentication] # Força aceitar o Token
    permission_classes = [permissions.IsAuthenticated]
    
    filter_backends = [filters.SearchFilter]
    search_fields = ['nome', 'cpf', 'telefone', 'cidade']

class PacienteDetailView(generics.RetrieveUpdateDestroyAPIView):
    queryset = Paciente.objects.all()
    serializer_class = PacienteSerializer
    
    # --- BLINDAGEM DE SEGURANÇA ---
    authentication_classes = [JWTAuthentication] # Força aceitar o Token
    permission_classes = [permissions.IsAuthenticated]

============================================================
ARQUIVO: pacientes\__init__.py
============================================================


============================================================
ARQUIVO: profissionais\admin.py
============================================================
from django.contrib import admin

# Register your models here.


============================================================
ARQUIVO: profissionais\apps.py
============================================================
from django.apps import AppConfig


class ProfissionaisConfig(AppConfig):
    name = 'profissionais'


============================================================
ARQUIVO: profissionais\models.py
============================================================
from django.db import models

class Especialidade(models.Model):
    nome = models.CharField(max_length=100, unique=True)

    def __str__(self):
        return self.nome
    
    class Meta:
        verbose_name = "Especialidade"
        verbose_name_plural = "Especialidades"
        ordering = ['nome']

class Profissional(models.Model):
    nome = models.CharField(max_length=255)
    cpf = models.CharField(max_length=14, unique=True)
    data_nascimento = models.DateField()
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.nome
    
    class Meta:
        verbose_name = "Profissional"
        verbose_name_plural = "Profissionais"
        ordering = ['nome']

class ProfissionalEspecialidade(models.Model):
    """ Tabela intermediária para vincular Profissional <-> Especialidade com dados do Conselho """
    profissional = models.ForeignKey(Profissional, related_name='especialidades_vinculo', on_delete=models.CASCADE)
    especialidade = models.ForeignKey(Especialidade, on_delete=models.PROTECT)
    
    # --- NOVOS CAMPOS SOLICITADOS ---
    sigla_conselho = models.CharField(max_length=10)    # Ex: CRM, COREN, CRO, CRP
    registro_conselho = models.CharField(max_length=20) # Ex: 123456
    uf_conselho = models.CharField(max_length=2)        # Ex: SP
    
    class Meta:
        unique_together = ('profissional', 'especialidade')

============================================================
ARQUIVO: profissionais\serializers.py
============================================================
from rest_framework import serializers
from .models import Especialidade, Profissional, ProfissionalEspecialidade

class EspecialidadeSerializer(serializers.ModelSerializer):
    class Meta:
        model = Especialidade
        fields = ['id', 'nome']

class ProfissionalEspecialidadeSerializer(serializers.ModelSerializer):
    nome_especialidade = serializers.CharField(source='especialidade.nome', read_only=True)
    
    # CAMPO DE ESCRITA (Mantém como está)
    especialidade_id = serializers.PrimaryKeyRelatedField(
        queryset=Especialidade.objects.all(), source='especialidade', write_only=True
    )

    # --- NOVO CAMPO PARA CORRIGIR O ERRO ---
    # Esse campo garante que o ID da especialidade seja enviado para o frontend na leitura
    especialidade_leitura = serializers.PrimaryKeyRelatedField(source='especialidade', read_only=True)

    class Meta:
        model = ProfissionalEspecialidade
        # Adicione 'especialidade_leitura' na lista de fields
        fields = [
            'id', 
            'especialidade_id', 
            'especialidade_leitura', 
            'nome_especialidade', 
            'sigla_conselho', 
            'registro_conselho', 
            'uf_conselho'
        ]

class ProfissionalSerializer(serializers.ModelSerializer):
    # ... (o resto do arquivo continua igual)
    especialidades = ProfissionalEspecialidadeSerializer(source='especialidades_vinculo', many=True)

    class Meta:
        model = Profissional
        fields = ['id', 'nome', 'cpf', 'data_nascimento', 'especialidades']

    # ... (métodos create e update continuam iguais)
    def create(self, validated_data):
        especialidades_data = validated_data.pop('especialidades_vinculo')
        profissional = Profissional.objects.create(**validated_data)
        for spec in especialidades_data:
            ProfissionalEspecialidade.objects.create(profissional=profissional, **spec)
        return profissional

    def update(self, instance, validated_data):
        especialidades_data = validated_data.pop('especialidades_vinculo', None)
        instance.nome = validated_data.get('nome', instance.nome)
        instance.cpf = validated_data.get('cpf', instance.cpf)
        instance.data_nascimento = validated_data.get('data_nascimento', instance.data_nascimento)
        instance.save()
        if especialidades_data is not None:
            instance.especialidades_vinculo.all().delete()
            for spec in especialidades_data:
                ProfissionalEspecialidade.objects.create(profissional=instance, **spec)
        return instance

============================================================
ARQUIVO: profissionais\tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARQUIVO: profissionais\urls.py
============================================================
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import EspecialidadeViewSet, ProfissionalViewSet

router = DefaultRouter()
router.register(r'especialidades', EspecialidadeViewSet)
router.register(r'profissionais', ProfissionalViewSet)

urlpatterns = [
    path('', include(router.urls)),
]

============================================================
ARQUIVO: profissionais\views.py
============================================================
from rest_framework import viewsets, permissions, filters
from rest_framework_simplejwt.authentication import JWTAuthentication
from .models import Especialidade, Profissional
from .serializers import EspecialidadeSerializer, ProfissionalSerializer

class EspecialidadeViewSet(viewsets.ModelViewSet):
    queryset = Especialidade.objects.all()
    serializer_class = EspecialidadeSerializer
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [filters.SearchFilter]
    search_fields = ['nome']

class ProfissionalViewSet(viewsets.ModelViewSet):
    queryset = Profissional.objects.all()
    serializer_class = ProfissionalSerializer
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [filters.SearchFilter]
    search_fields = ['nome', 'cpf']

============================================================
ARQUIVO: profissionais\__init__.py
============================================================


============================================================
ARQUIVO: usuarios\admin.py
============================================================
from django.contrib import admin

# Register your models here.


============================================================
ARQUIVO: usuarios\apps.py
============================================================
from django.apps import AppConfig


class UsuariosConfig(AppConfig):
    name = 'usuarios'


============================================================
ARQUIVO: usuarios\models.py
============================================================
from django.db import models
from django.contrib.auth.models import User

class PerfilOperador(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='perfil')
    
    acesso_atendimento = models.BooleanField(default=False)
    acesso_agendamento = models.BooleanField(default=False)
    acesso_faturamento = models.BooleanField(default=False)
    force_password_change = models.BooleanField(default=True)

    def __str__(self):
        return f"Perfil de {self.user.username}"

class ConfiguracaoSistema(models.Model):
    itens_por_pagina = models.IntegerField(default=15)
    
    def save(self, *args, **kwargs):
        self.pk = 1
        super(ConfiguracaoSistema, self).save(*args, **kwargs)

    @classmethod
    def load(cls):
        obj, created = cls.objects.get_or_create(pk=1)
        return obj

============================================================
ARQUIVO: usuarios\serializers.py
============================================================
from rest_framework import serializers
from django.contrib.auth.models import User
from .models import PerfilOperador, ConfiguracaoSistema

# --- SERIALIZER DE CRIAÇÃO E EDIÇÃO ---
class OperadorSerializer(serializers.ModelSerializer):
    password = serializers.CharField(write_only=True, required=False) # required=False para permitir edição sem trocar a senha
    
    # Campos que vêm do Frontend (definimos como False padrão, mas o to_representation vai preencher na leitura)
    acesso_atendimento = serializers.BooleanField(default=False)
    acesso_agendamento = serializers.BooleanField(default=False)
    acesso_faturamento = serializers.BooleanField(default=False)
    force_password_change = serializers.BooleanField(default=True)

    class Meta:
        model = User
        fields = ['id', 'username', 'password', 'first_name', 'email', 'is_superuser', 
                  'acesso_atendimento', 'acesso_agendamento', 'acesso_faturamento', 
                  'force_password_change']

    # --- LÓGICA DE LEITURA (INJETA DADOS DO PERFIL) ---
    def to_representation(self, instance):
        """ Injeta os dados do Perfil quando o Frontend pede os dados do Operador """
        representation = super().to_representation(instance)
        
        if hasattr(instance, 'perfil'):
            representation['acesso_atendimento'] = instance.perfil.acesso_atendimento
            representation['acesso_agendamento'] = instance.perfil.acesso_agendamento
            representation['acesso_faturamento'] = instance.perfil.acesso_faturamento
            representation['force_password_change'] = instance.perfil.force_password_change
            
        return representation

    # --- LÓGICA DE CRIAÇÃO (CREATE) ---
    def create(self, validated_data):
        atendimento = validated_data.pop('acesso_atendimento', False)
        agendamento = validated_data.pop('acesso_agendamento', False)
        faturamento = validated_data.pop('acesso_faturamento', False)
        force_change = validated_data.pop('force_password_change', True)

        # Cria usuário com criptografia (create_user faz o hash automaticamente)
        user = User.objects.create_user(
            username=validated_data['username'],
            email=validated_data.get('email', ''),
            password=validated_data['password'],
            first_name=validated_data.get('first_name', '')
        )

        if validated_data.get('is_superuser', False):
            user.is_superuser = True
            user.is_staff = True
            user.save()

        PerfilOperador.objects.create(
            user=user,
            acesso_atendimento=atendimento,
            acesso_agendamento=agendamento,
            acesso_faturamento=faturamento,
            force_password_change=force_change
        )

        return user

    # --- LÓGICA DE ATUALIZAÇÃO (UPDATE - A CORREÇÃO ESTÁ AQUI) ---
    def update(self, instance, validated_data):
        # 1. Separa os campos que não pertencem ao Model User diretamente
        password = validated_data.pop('password', None)
        
        atendimento = validated_data.pop('acesso_atendimento', None)
        agendamento = validated_data.pop('acesso_agendamento', None)
        faturamento = validated_data.pop('acesso_faturamento', None)
        force_change = validated_data.pop('force_password_change', None)

        # 2. Atualiza os campos padrão do User (email, first_name, username, etc.)
        instance = super().update(instance, validated_data)

        # 3. Se enviou senha, criptografa corretamente
        if password:
            instance.set_password(password)
            instance.save()

        # 4. Atualiza o Perfil relacionado (permissões)
        if hasattr(instance, 'perfil'):
            perfil = instance.perfil
            if atendimento is not None:
                perfil.acesso_atendimento = atendimento
            if agendamento is not None:
                perfil.acesso_agendamento = agendamento
            if faturamento is not None:
                perfil.acesso_faturamento = faturamento
            if force_change is not None:
                perfil.force_password_change = force_change
            perfil.save()

        return instance

# --- SERIALIZER DE LISTAGEM (Leitura Segura) ---
class OperadorListSerializer(serializers.ModelSerializer):
    acesso_atendimento = serializers.BooleanField(source='perfil.acesso_atendimento', read_only=True)
    acesso_agendamento = serializers.BooleanField(source='perfil.acesso_agendamento', read_only=True)
    acesso_faturamento = serializers.BooleanField(source='perfil.acesso_faturamento', read_only=True)

    class Meta:
        model = User
        fields = ['id', 'username', 'first_name', 'email', 'is_superuser', 
                  'acesso_atendimento', 'acesso_agendamento', 'acesso_faturamento']

# --- SERIALIZER DE CONFIGURAÇÃO ---
class ConfiguracaoSerializer(serializers.ModelSerializer):
    class Meta:
        model = ConfiguracaoSistema
        fields = ['itens_por_pagina']

============================================================
ARQUIVO: usuarios\tests.py
============================================================
from django.test import TestCase

# Create your tests here.


============================================================
ARQUIVO: usuarios\urls.py
============================================================
from django.urls import path
from .views import (
    NovoOperadorView, 
    MeView, 
    ListarOperadoresView, 
    ConfiguracaoView, 
    TrocarSenhaView,
    DetalheOperadorView
)

urlpatterns = [
    path('novo/', NovoOperadorView.as_view()),
    path('me/', MeView.as_view()),
    path('listar/', ListarOperadoresView.as_view()),
    path('config/', ConfiguracaoView.as_view()),
    path('trocar-senha/', TrocarSenhaView.as_view()),
    path('<int:pk>/', DetalheOperadorView.as_view()),
]

============================================================
ARQUIVO: usuarios\views.py
============================================================
from rest_framework import generics, permissions, filters
from rest_framework.views import APIView
from rest_framework.response import Response
from django.contrib.auth.models import User
from rest_framework_simplejwt.authentication import JWTAuthentication

from .models import ConfiguracaoSistema
from .serializers import OperadorSerializer, OperadorListSerializer, ConfiguracaoSerializer

class NovoOperadorView(generics.CreateAPIView):
    queryset = User.objects.all()
    serializer_class = OperadorSerializer
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]

class DetalheOperadorView(generics.RetrieveUpdateDestroyAPIView):
    queryset = User.objects.all()
    serializer_class = OperadorSerializer
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated] # Ou IsAdminUser se preferir

    def update(self, request, *args, **kwargs):
        # Lógica especial para update: se a senha não vier, não muda
        partial = kwargs.pop('partial', False)
        instance = self.get_object()
        
        # Removemos a senha do request se ela vier vazia
        if 'password' in request.data and not request.data['password']:
            request.data._mutable = True
            request.data.pop('password')
            request.data._mutable = False
            
        serializer = self.get_serializer(instance, data=request.data, partial=partial)
        serializer.is_valid(raise_exception=True)
        self.perform_update(serializer)

        # Atualiza campos do Perfil Manualmente
        if hasattr(instance, 'perfil'):
            p = instance.perfil
            p.acesso_atendimento = request.data.get('acesso_atendimento', p.acesso_atendimento)
            p.acesso_agendamento = request.data.get('acesso_agendamento', p.acesso_agendamento)
            p.acesso_faturamento = request.data.get('acesso_faturamento', p.acesso_faturamento)
            p.force_password_change = request.data.get('force_password_change', p.force_password_change)
            p.save()

        return Response(serializer.data)

class MeView(APIView):
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        user = request.user
        try: perfil = user.perfil 
        except: perfil = None

        data = {
            "id": user.id,
            "username": user.username,
            "first_name": user.first_name,
            "is_superuser": user.is_superuser,
            "acesso_atendimento": perfil.acesso_atendimento if perfil else False,
            "acesso_agendamento": perfil.acesso_agendamento if perfil else False,
            "acesso_faturamento": perfil.acesso_faturamento if perfil else False,
            "force_password_change": perfil.force_password_change if perfil else False,
        }
        return Response(data)

class ListarOperadoresView(generics.ListAPIView):
    queryset = User.objects.all().order_by('first_name')
    serializer_class = OperadorListSerializer
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [filters.SearchFilter]
    search_fields = ['username', 'first_name', 'email']

class ConfiguracaoView(APIView):
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAdminUser]

    def get(self, request):
        try: config = ConfiguracaoSistema.load()
        except: config = ConfiguracaoSistema(itens_por_pagina=15)
        return Response(ConfiguracaoSerializer(config).data)

    def put(self, request):
        config = ConfiguracaoSistema.load()
        serializer = ConfiguracaoSerializer(config, data=request.data)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data)
        return Response(serializer.errors, status=400)

class TrocarSenhaView(APIView):
    authentication_classes = [JWTAuthentication]
    permission_classes = [permissions.IsAuthenticated]

    def post(self, request):
        nova_senha = request.data.get('nova_senha')
        if not nova_senha or len(nova_senha) < 6:
            return Response({'error': 'A senha deve ter no mínimo 6 caracteres.'}, status=400)

        user = request.user
        user.set_password(nova_senha)
        user.save()

        if hasattr(user, 'perfil'):
            user.perfil.force_password_change = False
            user.perfil.save()

        return Response({'message': 'Senha alterada com sucesso!'})

============================================================
ARQUIVO: usuarios\__init__.py
============================================================


